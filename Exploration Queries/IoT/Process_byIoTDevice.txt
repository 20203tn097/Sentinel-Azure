// Id: 55aa6764-cf5c-4360-8848-0583f0f18a65
// DisplayName: Most Frequent Command executions on The Device
// Description: Most Frequent Command executions on The Device
// InputEntityType: IoTDevice
// InputFields: [IoTDevice_DeviceId, IoTDevice_IoTHub]
// OutputEntityTypes: [NetworkConnection]
// DataConnector: #SecurityIoTRawEvent
let Process_byIoTDevice = (v_IotDevice_DeviceId:string, v_IoTDevice_IoTHub:string){
    SecurityIoTRawEvent 
    | where RawEventName == "ProcessCreate"
    | where AssociatedResourceId == parse_json(v_IoTDevice_IoTHub)["AzureResourceId"] and DeviceId == v_IotDevice_DeviceId
    | extend Process_CommandLine = tostring(parse_json(EventDetails)["CommandLine"])
    | summarize procCount = count() by Process_CommandLine
    | top 10 by procCount 
    | project-away procCount
    };
Process_byIoTDevice('<DeviceId>', '<IoTHub>')