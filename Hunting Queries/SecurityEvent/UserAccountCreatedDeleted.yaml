id: 6135a90e-ba30-4f36-9b6a-3a350050704b
name: Long lookback User Account Created and Deleted within 10mins
description: |
  'User account created and then deleted within 10 minutes across last 14 days'
requiredDataConnectors:
  - connectorId: SecurityEvents
    dataTypes:
      - SecurityEvent
  - connectorId: WindowsSecurityEvents
    dataTypes: 
      - SecurityEvents  
  - connectorId: WindowsForwardedEvents
    dataTypes:
      - WindowsEvent
tactics:
  - Persistence
  - PrivilegeEscalation
relevantTechniques:
  - T1098
  - T1078
query: |

  // TimeDelta is the difference between when the account was created and when it was deleted, default is set to 10min or less
  let timedelta = 10m;
  (union isfuzzy=true 
  (SecurityEvent 
  // A user account was created
  | where EventID == "4720"
  | where AccountType == "User"
  | project creationTime = TimeGenerated, CreateEventID = EventID, Activity, Computer, TargetUserName, UserPrincipalName, 
  AccountUsedToCreate = SubjectUserName, TargetSid, SubjectUserSid ),
   (WindowsEvent 
  // A user account was created
  | where EventID == "4720"
  | extend SubjectUserSid = tostring(EventData.SubjectUserSid)
  | extend AccountType=case(EventData.SubjectUserName endswith "$" or SubjectUserSid in ("S-1-5-18", "S-1-5-19", "S-1-5-20"), "Machine", isempty(SubjectUserSid), "", "User")
  | where AccountType == "User"
  | extend Activity="4720 - A user account was created"
  | extend TargetUserName = tostring(EventData.TargetUserName)
  | extend UserPrincipalName = tostring(EventData.UserPrincipalName)
  | extend SubjectUserName = tostring(EventData.SubjectUserName)
  | extend TargetSid = tostring(EventData.TargetSid)
  | project creationTime = TimeGenerated, CreateEventID = EventID, Activity, Computer, TargetUserName, UserPrincipalName, 
  AccountUsedToCreate = SubjectUserName, TargetSid, SubjectUserSid )
  | join kind= inner ( union isfuzzy=true 
     (SecurityEvent
     // A user account was deleted 
     | where EventID == "4726" 
  | where AccountType == "User"
  | project deletionTime = TimeGenerated, DeleteEventID = EventID, Activity, Computer, TargetUserName, UserPrincipalName, 
  AccountUsedToDelete = SubjectUserName, TargetSid, SubjectUserSid ),
     (WindowsEvent
     // A user account was deleted 
  | where EventID == "4726" 
  | extend SubjectUserSid = tostring(EventData.SubjectUserSid)
  | extend AccountType=case(EventData.SubjectUserName endswith "$" or SubjectUserSid in ("S-1-5-18", "S-1-5-19", "S-1-5-20"), "Machine", isempty(SubjectUserSid), "", "User")
  | where AccountType == "User"
  | extend Activity="4726 - A user account was deleted."
  | extend TargetUserName = tostring(EventData.TargetUserName)
  | extend UserPrincipalName = tostring(EventData.UserPrincipalName)
  | extend SubjectUserName = tostring(EventData.SubjectUserName)
  | extend TargetSid = tostring(EventData.TargetSid)
  | project deletionTime = TimeGenerated, DeleteEventID = EventID, Activity, Computer, TargetUserName, UserPrincipalName, 
  AccountUsedToDelete = SubjectUserName, TargetSid, SubjectUserSid )  
  ) on Computer, TargetUserName
  | where deletionTime - creationTime < timedelta
  | extend TimeDelta = deletionTime - creationTime
  | where tolong(TimeDelta) >= 0
  | project TimeDelta, creationTime, CreateEventID, Computer, TargetUserName, UserPrincipalName, AccountUsedToCreate, 
  deletionTime, DeleteEventID, AccountUsedToDelete
  | extend timestamp = creationTime, HostCustomEntity = Computer, AccountCustomEntity = UserPrincipalName
  