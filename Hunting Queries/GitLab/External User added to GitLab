id: c1544d8f-cbbd-4e35-8d32-5b9312279833
name: GitLab - External User Added to GitLab
description: |
  'This queries GitLab Application logs to list external user accounts (i.e.: account not in allow-listed domains) which have been added to GitLab users.'
severity: Medium
requiredDataConnectors:
   - connectorId: Syslog
    dataTypes:
      - Syslog
queryFrequency: 1h
queryPeriod: 1d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Credential Access
  - Persistence
query: |

// List of allow-listed domains
let allowedDomain = pack_array("mydomain.com");
GitLabAudit
| where AddAction == "user"
| project AuthorName, IPAddress, UserAdded = Entity_path
| join (GitLabApp 
| where Message contains "User" and Message contains " was created" 
| parse kind=regex Message with EventTime ": User \"" Username "\"" EmailAddress " was created"
| project UserAdded = tostring(Username), EmailAddress = substring(EmailAddress,2,strlen(EmailAddress)-3)) on UserAdded
| project  AuthorName, IPAddress, UserAdded, EmailAddress, DomainName = tostring(extract("@(.*)$", 1, EmailAddress))
| where allowedDomain !contains DomainName

entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: AuthorIPAddress
   - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: UserAdded
   - entityType: DNS
    fieldMappings:
      - identifier: DomainName
        columnName: DomainName        
version: 1.0.0
