id: 2f855e4a-ab6b-4469-a155-a0a8ffaaff8a
name: Potential Local Exploitation for Privilege Escalation
description: |
   'This query detects a process that runs under SYSTEM user's security context and was spawned by a process that was running under a lower security context indicating an exploitation for privilege escalation.
   Ref: https://attack.mitre.org/techniques/T1068/'
severity: High
requiredDataConnectors:
  - connectorId: SecurityEvents
    dataTypes:
      - SecurityEvent
tactics:
  - PrivilegeEscalation
relevantTechniques:
  - T1068
query: |
  Event
  | where EventLog == "Microsoft-Windows-Sysmon/Operational" and EventID==1
  | parse EventData with * 'IntegrityLevel">' IntegrityLevel "<" *
  | parse EventData with * 'ParentUser">' ParentUser "<" *
  | where IntegrityLevel in ("System") and not(ParentUser in ("NT AUTHORITY\\NETWORK SERVICE","-","NT AUTHORITY\\SYSTEM","NT AUTHORITY\\LOCAL SERVICE")) 
  | parse EventData with * 'Image">' Image "<" *
  | parse EventData with * 'ParentImage">' ParentImage "<" *
  | parse EventData with * 'CommandLine">' CommandLine "<" *
  | parse EventData with * 'ParentCommandLine">' ParentCommandLine "<" *
  | parse EventData with * 'ProcessGuid">' ProcessGuid "<" *
  | parse EventData with * 'ParentProcessGuid">' ParentProcessGuid "<" *
  | project EventID, Computer, ParentUser, ParentImage, ParentCommandLine, ParentProcessGuid, UserName, Image, CommandLine, ProcessGuid, IntegrityLevel
  entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: UserName
  - entityType: Host
    fieldMappings:
      - identifier: FullName
        columnName: Computer
  - entityType: File
    fieldMappings:
      - identifier: Name
        columnName: Image
version: 1.0.0
kind: Scheduled

