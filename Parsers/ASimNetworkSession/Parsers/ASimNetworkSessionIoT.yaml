Parser:
  Title: Network Session ASIM parser for Microsoft Defender for IoT 
  Version: '0.1'
  LastUpdated: Mar 8, 2021
Product:
  Name: Microsoft Defender for IoT
Normalization:
  Schema: NetworkSession
  Version: '0.2.3'
References:
  - Title: ASIM Network Session Schema
    Link: https://aka.ms/ASimNetworkSessionDoc
  - Title: ASIM
    Link: https://aka.ms/AboutASIM
Description: |
  This ASIM parser supports normalizing Microsoft Defender for IoT network logs to the ASIM Network Session normalized schema.
ParserName: ASimNetworkSessionIoT
EquivalentBuiltInParser: _ASim_NetworkSession_MicrosoftD4IoT
ParserParams:
  - Name: disabled
    Type: bool
    Default: false
ParserQuery: |
  let disabled=false;
  let parser = (disabled:bool=false) 
  {
    DefenderIoTRawEvent
    | where RawEventName == "NetworkConnectionData" // Was "NetworkConnectionDataEvent"
    | project-rename 
        DvcId = DeviceId,
        DvcSubscription = AzureSubscriptionId
    | extend 
        IsInternal = EventDetails.IsInternal,
        DstDvcId = EventDetails.Destination.DeviceId,
        DstMacAddr = EventDetails.Destination.MacAddress,
        SrcDvcId = EventDetails.Source.DeviceId,
        SrcMacAddr = EventDetails.Source.MacAddress
    //    '"additionalProperties":{' additionalProperties:string '}' *
    | extend
        EventProduct = 'Defender for IoT',
        EventResult = 'Success',
        EventSchema = 'NetworkSession',
        EventSchemaVersion='0.2.3',
        EventSeverity = 'Informational',
        EventType = 'L2NetworkSession',
        EventVendor = 'Microsoft'
    | extend // -- Aliases
        Dvc = DvcId 
    //| project-away EventDetails, AssociatedResourceId
  };
  parser (disabled)

