Parser:
  Title: Google Drive - File Event Parser
  Version: '0.1'
  LastUpdated: June 28, 2021
Product:
  Name: Google Drive
Normalization:
  Schema: FileEvent
  Version: '0.1.0'
References:
- Title: Using functions
  Link: https://docs.microsoft.com/azure/azure-monitor/log-query/function
- Title: Dns schema documentation
  Link: https://aka.ms/AzSentinelFileEventDoc
- Title: Drive Audit Activity Events
  Link: https://developers.google.com/admin-sdk/reports/v1/appendix/activity/drive
- Title: Connect your Google Workspace to Azure Sentinel
  Link: https://docs.microsoft.com/en-us/azure/sentinel/connect-google-workspace
Description: |
  This is a Query Parser that is used to map Google Drive Events (GSuite_ReportsAPI_drive_CL) to the Azure Sentinel Information Model FileEvent schema.
ParserName: vimFileEventGoogleDrive
ParserQuery: |
  let GoogleEvents=datatable(event_name_s:string, EventType:string)[
   // FileCreated/Modified/Deleted/Other
    // access, 
    'add_to_folder', 'FileCreated'
    //approval_canceled
    //approval_comment_added
    //approval_completed
    //approval_decisions_reset
    //approval_due_time_change
    //approval_requested
    //approval_reviewer_change
    // approval_reviewer_responded
    //'copy'
    ,'create'  , 'FileCreated'
    ,'delete'  , 'FileDeleted'
    ,'download', 'FileDownloaded'
    // drive_email_as_attachment
    ,'edit'    , 'FileModified'
    //label_applied
    //label_applied_on_creation
    //label_field_value_changed
    //label_removed
    //lock
    //move 
    //preview
    //print
    //remove_from_folder
    //rename
    //restore
    //sheets_importrange
    //trash
    //unlock
    //upload
    // view
    ];
  let GDrive=(){
    GSuite_ReportsAPI_drive_CL
    | extend
      EventProduct='GWorkspaceDrive'
      , EventCount = int(1)
      , EventResult = 'Success'
      , EventVendor ='Google'   
      , EventSchemaVersion = '0.1.0'
      , TimeGenerated=id_time_t
    | project-rename 
      EventOriginalUid=id_uniqueQualifier_s
      , EventStartTime=id_time_t 
    | project-rename 
      ActorUsername=actor_email_s  
    , ActorUserId=actor_profileId_s
    , SrcIpAddr=IPAddress
    , ActingAppId=originating_app_id_s
    | extend
    ActorUsernameType='upn'
    , ActorUserIdType='GProfileId'
    //
    // ***************** File
    // MISSING MANDATORY: TargetFileFullPath=??????
    , TargetFilename= doc_title_s// ? Not sure what this contains when changing file name. maybe in that case new_value_s is needed
    , TargetFilePath=destination_folder_title_s // This value only exists in context of moving file to from folder
    // MISSING MANDATORY: SrcFileFullPath=??????
    , SrcFileName=old_value_s
    , SrcFilePath=source_folder_title_s // This value only exists in context of moving file to from folder
    , SensitivityLabel=visibility_s
    |lookup GoogleEvents on event_name_s
    // *********************** Alias
    | extend 
        EventEndTime=EventStartTime 
        , User=ActorUsername
        File=TargetFilename;};
     GDrive