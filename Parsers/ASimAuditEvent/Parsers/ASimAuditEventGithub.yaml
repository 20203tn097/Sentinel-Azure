Parser:
  Title: ASIM Audit Event parser for Github
  Version: '0.1.0'
  LastUpdated: Mar 27, 2024
Product:
  Name: Github
Normalization:
  Schema: AuditEvent
  Version: '0.1.0'
References:
- Title: ASIM Audit Event Schema
  Link: https://aka.ms/ASimAuditEventDoc
- Title: ASIM
  Link: https:/aka.ms/AboutASIM
Description: |
  This ASIM parser supports filtering and normalizing Microsoft Github audit events in the GitHubAuditLogPolling_C.
ParserName: ASimAuditEventGithub
EquivalentBuiltInParser: _ASim_AuditEvent_Github
ParserParams:
  - Name: disabled
    Type: bool
    Default: false
ParserQuery: |
     let parser = (
     disabled:bool = false
     )
     {
      let parser = (
      starttime:datetime=datetime(null), 
      endtime:datetime=datetime(null), 
      username_has_any:dynamic = dynamic([]),
      targetappname_has_any:dynamic = dynamic([]),
      srcipaddr_has_any_prefix:dynamic = dynamic([]),
      srchostname_has_any:dynamic = dynamic([]),
      eventtype_in:dynamic = dynamic([]),
      eventresultdetails_in:dynamic = dynamic([]),
      eventresult:string = '*',
      disabled:bool=false
      )
      {
      let EventResultDetailslookup=datatable(EventOriginalResultDetails:string,EventResult:string, EventType:string, EventSeverity: string )
      ["user.device_verification_success","Success","Other","Informational",
      "user.device_verification_requested","NA","Other","Informational",
      "repo.change_merge_setting","Success","Other","Informational",
      "repo.set_default_workflow_permissions","Success","Set","Informational",
      "repo.set_workflow_permission_can_approve_pr","Success","Set","Informational",
      "user.device_verification_success","Success","Other","Informational",
      "user.device_verification_requested","Success","Other","Informational",
      "user.new_device_used","Success","Other","Informational",
      "user.audit_log_export","Success","Other","Informational",
      "org.add_member","Success","Create","Informational",
      "personal_access_token.create","Success","Create","Informational",
      "personal_access_token.access_revoked","Success","Disable","Informational",
      "personal_access_token.destroy","Success","Delete","Informational",
      "personal_access_token.access_granted","Success","Set","Informational",
      "oauth_authorization.create","Success","Create","Informational",
     "oauth_access.create","Success","Create","Informational",
     "oauth_access.regenerate","Success","Create","Informational",
     "personal_access_token.request_created","Success","Create","Informational",
     "account.plan_change","Success","Other","Informational",
     "actions_cache.delete","Success","Delete","Informational",
     "artifact.destroy","Success","Delete","Informational",
     "checks.delete_logs","Success","Delete","Informational",
     "environment.delete","Success","Delete","Informational",
     "environment.remove_actions_secret","Success","Delete","Informational",
     "environment.remove_protection_rule","Success","Delete","Informational",
     "project.create","Success","Create","Informational",
     "project.delete","Success","Delete","Informational",
     "public_key.create","Success","Create","Informational",
     "public_key.delete","Success","Delete","Informational",
     "repo.create","Success","Create","Informational",
     "repo.delete","Success","Delete","Informational",
     "security_key_remove","Success","Delete","Informational",
     "business.set_s_retention_limit","Success","Set","Informational",
     "business.set_default_workflow_permissions","Success","Set","Informational",
     "business.set_fork_pr_workflows_policy","Success","Set","Informational",
     "business.set_workflow_permission_can_approve_pr","Success","Set","Informational",
     "checks.auto_trigger_disabled","Success","Disable","Informational",
     "checks.auto_trigger_enabled","Success","Disable","Informational",
     "checks.delete_logs","Success","Delete","Informational",
     "codespaces.allow_permissions","Success","Other","Informational",
     "codespaces.create","Success","Create",    "Informational",
     "codespaces.destroy","Success","Delete","Informational",
     "copilot.cfb_seat_added","Success","Other","Informational",
     "copilot.cfb_seat_assignment_created","Success","Create", "Informational",
     "copilot.cfb_seat_cancelled","Success","Other","Informational",
     "copilot.cfb_seat_cancelled_by_staff","Success","Other", "Informational",
     "dependabot_alerts.disable","Success","Disable","Informational",
     "dependabot_alerts.enable","Success","Enable","Informational",
     "dependabot_alerts_new_repos.disable","Success","Disable","Informational",
     "dependabot_alerts_new_repos.enable","Success","Enable","Informational",
     "dependabot_repository_access.repositories_updated","Success","Other","Informational",
     "dependabot_security_updates.disable","Success","Disable","Informational",
     "dependabot_security_updates.enable","Success","Enable","Informational",
     "dependabot_security_updates_new_repos.disable","Success","Disable","Informational",
     "dependabot_security_updates_new_repos.enable","Success","Enable","Informational",
     "dependency_graph.disable","Success","Disable","Informational",
     "dependency_graph.enable", "Success","Enable","Informational",
     "dependency_graph_new_repos.disable","Success","Disable","Informational",
     "dependency_graph_new_repos.enable","Success","Enable","Informational",
     "environment.add_protection_rule","Success","Other","Informational",
     "environment.create_s_secret","Success","Create","Informational",
     "environment.create_s_variable","Success","Create","Informational",
     "environment.remove_s_secret","Success","Other","Informational",
     "environment.remove_s_variable","Success","Other","Informational",
     "environment.remove_protection_rule","Success","Other","Informational",
     "environment.update_s_variable","Success","Other","Informational",
     "environment.update_protection_rule","Success","Other","Informational",
     "environment.update_s_secret","Success","Other","Informational",
     "hook.config_changed","Success","Other","Informational",
     "integration.create","Success","Create","Informational",
     "integration.destroy","Success","Delete","Informational",
     "integration.manager_added","Success","Other","Informational",
     "integration.manager_removed","Success","Delete","Informational",
     "integration.remove_client_secret","Success","Delete","Informational",
     "integration.revoke_all_tokens","Success","Delete","Informational",
     "integration.revoke_tokens","Success","Delete","Informational",
     "integration.suspend","Success","Other","Informational",
     "integration.transfer","Success","Other","Informational",
     "integration.unsuspend","Success","Other","Informational",
     "integration_installation.create","Success","Create","Informational",
     "integration_installation.destroy","Success","Delete","Informational",
     "integration_installation.repositories_removed","Success","Delete","Informational",
     "integration_installation.suspend","Success","Other","Informational",
     "integration_installation.unsuspend","Success","Other","Informational",
     "integration_installation.version_updated","Success","Other","Informational",
     "oauth_application.create","Success","Create","Informational",
     "oauth_application.destroy","Success","Delete","Informational",
     "oauth_application.generate_client_secret,","Success","Other","Informational",
     "oauth_application.remove_client_secret","Success","Delete","Informational",
     "oauth_application.reset_secret,","Success","Other","Informational",
     "oauth_application.revoke_all_tokens,","Success","Other","Informational",
     "oauth_application.revoke_tokens,","Success","Other","Informational",
     "oauth_application.transfer,","Success","Other","Informational",
     "oauth_authorization.destroy","Success","Delete","Informational",
     "org.add_outside_collaborator,","Success","Other","Informational",
     "org.advanced_security_disabled_for_new_repos","Success","Disable","Informational",
     "org.advanced_security_disabled_on_all_repos","Success","Disable","Informational",
     "org.advanced_security_enabled_for_new_repos","Success","Disable","Informational",
     "org.advanced_security_enabled_on_all_repos","Success","Disable","Informational",
     "org.remove_member","Success","Delete","Informational",
     "org.set_s_fork_pr_approvals_policy","Success","Set","Informational",
     "org.set_s_private_fork_pr_approvals_policy","Success","Set","Informational",
     "org.set_s_retention_limit","Success","Set","Informational",
     "org.set_default_workflow_permissions","Success","Set","Informational",
     "org.set_fork_pr_workflows_policy","Success","Set","Informational",
     "org.set_workflow_permission_can_approve_pr","Success","Set","Informational",
     "org.update_member","Success","Other","Informational",
     "org.update_member_repository_creation_permission","Success","Other","Informational",
     "org.update_member_repository_invitation_permission","Success","Other","Informational",
     "pages_protected_domain.create","Success","Create","Informational",
     "pages_protected_domain.delete","Success","Delete","Informational",
     "pages_protected_domain.verify","Success","Other","Informational",
     "passkey.register","Success","Other","Informational",
     "passkey.remove","Success","Delete","Informational",
     "payment_method.create","Success","Create","Informational",
     "payment_method.remove","Success","Delete","Informational",
     "payment_method.update","Success","Other","Informational",
     "personal_access_token.credential_regenerated","Success","Other","Informational",
     "personal_access_token.credential_revoked","Success","Other","Informational",
     "personal_access_token.destroy","Success","Delete","Informational",
     "personal_access_token.request_cancelled","Success","Other","Informational",
     "personal_access_token.request_created","Success","Create","Informational",
     "personal_access_token.request_denied","Success","Other","Informational",
     "personal_access_token.update","Success","Other","Informational",
     "profile_picture.update","Success","Other","Informational",
     "project.access","Success","Other","Informational",
     "project.close","Success","Other","Informational",
     "project.link","Success","Other","Informational",
     "project.open","Success","Other","Informational",
     "project.rename","Success","Other","Informational",
     "project.unlink","Success","Other","Informational",
     "project.update_org_permission","Success","Other","Informational",
     "project.update_team_permission","Success","Other","Informational",
     "project.update_user_permission","Success","Other","Informational",
     "project_field.create","Success","Create","Informational",
     "project_field.delete","Success","Delete","Informational",
     "project_view.create","Success","Create","Informational",
     "project_view.delete","Success","Delete","Informational",
     "protected_branch.update_merge_queue_enforcement_level","Success","Other","Informational",
     "public_key.unverification_failure","Failure","Other","High",
     "public_key.unverify","Success","Other","Informational",
     "public_key.update","Success","Other","Informational",
     "public_key.verification_failure","Failure","Other","High",
     "public_key.verify","Success","Other","Informational",
     "repo.access","Success","Other","Informational",
     "repo.s_enabled","Success","Enable","Informational",
     "repo.add_member","Success","Other","Informational",
     "repo.add_topic","Success","Other","Informational",
     "repo.advanced_security_disabled","Success","Disable","Informational",
     "repo.advanced_security_enabled","Success","Enable","Informational",
     "repo.archived","Success","Other","Informational",
     "repo.code_scanning_analysis_deleted","Success","Delete","Informational",
     "repo.code_scanning_configuration_for_branch_deleted","Success","Delete","Informational",
     "repo.config.disable_collaborators_only","Success","Disable","Informational",
     "repo.config.disable_contributors_only","Success","Disable","Informational",
     "repo.config.disable_sockpuppet_disallowed","Success","Disable","Informational",
     "repo.config.enable_collaborators_only","Success","Enable","Informational",
     "repo.config.enable_contributors_only","Success","Enable","Informational",
     "repo.config.enable_sockpuppet_disallowed","Success","Enable","Informational",
     "repo.create_s_secret","Success","Create","Informational",
     "repo.create_s_variable","Success","Create","Informational",
     "repo.create_integration_secret","Success","Create","Informational",
     "repo.destroy","Success","Delete","Informational",
     "repo.pages_cname","Success","Other","Informational",
     "repo.pages_create","Success","Create","Informational",
     "repo.pages_destroy","Success","Delete","Informational",
     "repo.pages_https_redirect_disabled","Success","Disable","Informational",
     "repo.pages_https_redirect_enabled","Success","Enable","Informational",
     "repo.pages_private","Success","Other","Informational",
     "repo.pages_public","Success","Other","Informational",
     "repo.pages_soft_delete","Success","Delete","Informational",
     "repo.pages_soft_delete_restore","Success","Other","Informational",
     "repo.pages_source","Success","Other","Informational",
     "repo.register_self_hosted_runner","Success","Other","Informational",
     "repo.remove_s_secret","Success","Delete","Informational",
     "repo.remove_s_variable","Success","Delete","Informational",
     "repo.remove_integration_secret","Success","Delete","Informational",
     "repo.remove_member","Success","Delete","Informational",
     "repo.remove_self_hosted_runner","Success","Delete","Informational",
     "repo.remove_topic","Success","Delete","Informational",
     "repo.rename","Success","Other","Informational",
     "repo.set_s_fork_pr_approvals_policy","Success","Set","Informational",
     "repo.set_s_private_fork_pr_approvals_policy","Success","Set","Informational",
     "repo.set_s_retention_limit","Success","Set","Informational",
     "repo.set_fork_pr_workflows_policy","Success","Set","Informational",
     "repo.staff_unlock","Success","Other","Informational",
     "repo.temporary_access_granted","Success","Other","Informational",
     "repo.transfer","Success","Other","Informational",
     "repo.transfer_outgoing","Success","Other","Informational",
     "repo.transfer_start","Success","Other","Informational",
     "repo.unarchived","Success","Other","Informational",
     "repo.update_s_access_settings","Success","Other","Informational",
     "repo.update_s_secret","Success","Other","Informational",
     "repo.update_s_settings","Success","Other","Informational",
     "repo.update_s_variable","Success","Other","Informational",
     "pull_request.merge","Success","Other","Informational",
     "repo.update_default_branch","Success","Other","Informational",
     "repo.update_integration_secret","Success","Other","Informational",
     "repo.update_member","Success","Other","Informational",
     "repository_image.create","Success","Create","Informational",
     "repository_image.destroy","Success","Delete","Informational",
     "repository_invitation.accept","Success","Other","Informational",
     "repository_invitation.cancel","Success","Other","Informational",
     "repository_invitation.create","Success","Create","Informational",
     "repository_invitation.reject","Success","Other","Informational",
     "repository_ruleset.create","Success","Create","Informational",
     "repository_ruleset.destroy","Success","Delete","Informational",
     "repository_ruleset.update","Success","Other","Informational",
     "security_key.register","Success","Other","Informational",
     "security_key.remove","Success","Delete","Informational",
     "sponsors.agreement_sign","Success","Other","Informational",
     "sponsors.custom_amount_settings_change","Success","Other","Informational",
     "sponsors.fiscal_host_change","Success","Other","Informational",
     "sponsors.repo_funding_links_file_","Success","Other","Informational",
     "sponsors.sponsor_sponsorship_cancel","Success","Other","Informational",
     "sponsors.sponsor_sponsorship_create","Success","Create","Informational",
     "sponsors.sponsor_sponsorship_payment_complete","Success","Other","Informational",
     "sponsors.sponsor_sponsorship_preference_change","Success","Other","Informational",
     "sponsors.sponsor_sponsorship_tier_change","Success","Other","Informational",
     "sponsors.sponsored_developer_approve","Success","Other","Informational",
     "sponsors.sponsored_developer_create","Success","Create","Informational",
     "sponsors.sponsored_developer_disable","Success","Disable","Informational",
     "sponsors.sponsored_developer_profile_update","Success","Other","Informational",
     "sponsors.sponsored_developer_redraft","Success","Other","Informational",
     "sponsors.sponsored_developer_request_approval","Success","Other","Informational",
     "sponsors.sponsored_developer_tier_description_update","Success","Other","Informational",
     "sponsors.sponsored_developer_update_newsletter_send","Success","Other","Informational",
     "sponsors.sponsors_patreon_user_create","Success","Create","Informational",
     "sponsors.sponsors_patreon_user_destroy","Success","Delete","Informational",
     "sponsors.update_tier_repository","Success","Other","Informational",
     "sponsors.update_tier_welcome_message","Success","Other","Informational",
     "sponsors.waitlist_join","Success","Other","Informational",
     "sponsors.withdraw_agreement_signature","Success","Other","Informational",
     "successor_invitation.accept","Success","Other","Informational",
     "successor_invitation.cancel","Success","Other","Informational",
     "successor_invitation.create","Success","Create","Informational",
     "successor_invitation.decline","Success","Other","Informational",
     "successor_invitation.revoke","Success","Other","Informational",
     "trusted_device.register","Success","Other","Informational",
     "trusted_device.remove","Success","Delete","Informational",
     "workflows.approve_workflow_job","Success","Other","Informational",
     "workflows.delete_workflow_run","Success","Delete","Informational",
     "workflows.disable_workflow","Success","Disable","Informational",
     "workflows.enable_workflow","Success","Enable","Informational",
     "workflows.reject_workflow_job","Success","Other","Informational",
     "team.add_member","Success","Other","Informational",
     "pull_request.merge,","Success","Other","Informational",
     "hook.create","Success","Create","Informational",
     "team.create","Success","Create","Informational",
     "pull_request.create","Success","Create","Informational",
     "workflows.prepared_workflow_job","Success","Other","Informational",
     "workflows.created_workflow_run","Success","Create","Informational",
     "org.add_outside_collaborator","Success","Other","Informational",
     "org.invite_member","Success","Other","Informational",
     "workflows.completed_workflow_run","Success","Other","Informational",
     "pull_request_review.submit","Success","Other","Informational",
     ];
     let GithubAuditEvents=EventResultDetailslookup 
     |project EventOriginalResultDetails
     | summarize make_set(EventOriginalResultDetails); 
     GitHubAuditLogPolling_CL 
     | where action_s in (GithubAuditEvents)
     | extend TimeGenerated = todatetime(tostring(split(TimeGenerated, '.', 0)[0]))          
     |project 
     TimeGenerated=unixtime_milliseconds_todatetime(created_at_d),
     EventCount=int(1),
     EventSchema='AuditEvent',
     EventProduct='Github',
     EventVendor='Microsoft',
     EventSchemaVersion='0.1',
     EventStartTime=TimeGenerated,
     EventEndTime=TimeGenerated,     
     TargetUsername=actor_s,
     TargetAppName='Github',
     TargetAppType='SaaS application',
     EventOriginalUid= _document_id_s,     
     TargetUsernameType='simple',
     EventOriginalResultDetails=action_s,
     SrcIpAddr=actor_ip_s,
     SrcGeoCountry=actor_location_country_code_s,
     Operation=operation_type_s,     
     ObjectType='Other',
     HttpUserAgent=user_agent_s,
     Type                     
     |lookup EventResultDetailslookup on EventOriginalResultDetails
     |extend Object=EventType,
             ObjectType=case(EventOriginalResultDetails hasprefix "pull","repo_s",
                    EventOriginalResultDetails hasprefix "push","repo_s",
                    EventOriginalResultDetails hasprefix "repo","repo_s",
                    "Configuration Atom"),
             DvcAction=EventType,
             IpAddr=SrcIpAddr,
             Application=TargetAppName,
             User=TargetUsername
     };
     parser (disabled = disabled)