Parser:
  Title: Web Session ASIM parser for Windows IIS logs
  Version: '0.1'
  LastUpdated: Dec 13, 2022
Product:
  Name: Internet Information Services (IIS)
Normalization:
  Schema: WebSession
  Version: '0.2.5'
References:
- Title: ASIM Web Session Schema
  Link: https://aka.ms/ASimWebSessionDoc
- Title: ASIM
  Link: https:/aka.ms/AboutASIM
Description: |
  This ASIM parser supports normalizing IIS logs produced to the ASIM Web Session normalized schema.
ParserName: ASIMWebSessionIIS
EquivalentBuiltInParser: _ASIM_WebSession_IIS
ParserParams:
  - Name: disabled
    Type: bool
    Default: false
ParserQuery: |
  let parser = (disabled: bool = false)
        {
        W3CIISLog
        | extend
                EventResult = iff ( toint(scStatus) < 400, "Success", "Failure"),
                scStatus = toint(scStatus), 
                csUriQuery = iff(csUriQuery == "-", "", csUriQuery),
                csUserName = iff(csUserName == "-", "", csUserName),
                HttpVersion = iff((csVersion has "HTTP"), split(csVersion, "/")[1], "") // there is a limited chance that something connects over non-HTTP
        | project-rename 
                HttpHost = sSiteName,
                HttpRequestMethod = csMethod,
                HttpReferrer = csReferer,
                User = csUserName, //probably won't have this one often
                Dvc = Computer,
                EventResultDetails = scStatus,
                Dst = sIP,
                Src = cIP,
                UserAgent = csUserAgent,
                ThreatCategory = IndicatorThreatType,
                EventOriginalSeverity = Severity,
                SrcGeoCountry = RemoteIPCountry,
                SrcGeoLatitude = RemoteIPLatitude,
                SrcGeoLongitude = RemoteIPLongitude,
                ThreatOriginalConfidence = Confidence,
                ThreatIpAddr = MaliciousIP,
                ThreatIsActive = IsActive,
                ThreatFirstReportedTime = FirstReportedDateTime,
                ThreatLastReportedTime = LastReportedDateTime,
                EventReportUrl = ReportReferenceLink,
                EventOriginalSubType = scSubStatus
        | extend
                DstIpAddr = iff(csHost <> "", split(csHost, ":")[0], Dst),
                DstNatIpAddr = iff(csHost <> "", Dst, ""),
                EventType = 'WebServerSession',            
                EventVendor = 'Microsoft',
                EventSchemaVersion = '0.2.5',
                EventSchema = 'WebSession', 
                EventProduct = 'IIS',
                DvcOs = 'Windows',
                EventCount = int(1),
                SrcIpAddr = Src,
                IpAddr = Src,
                HttpUserAgent = UserAgent,
                HttpStatusCode = tostring(EventResultDetails),
                EventStartTime = TimeGenerated,
                EventEndTime = ( (TimeGenerated) + (TimeTaken * 1ms)), // TimeTaken field is in Milliseconds 
                EventSeverity = iff(EventResult == "Success", "Informational", "Low"),
                csUriQuery = tostring(csUriQuery),
                csUriStem = tostring(csUriStem),
                tempURLconstruct = iff(csUriQuery == "", csUriStem, strcat(csUriStem,"?",csUriQuery))
        | extend                
                Url = case( 
                           (tostring(sPort) has "80") and sPort == "80" and HttpHost == "Default Web Site", strcat("http://",tostring(Dst),tostring(tempURLconstruct)),
                           (tostring(sPort) has "80") and sPort <> "80" and HttpHost == "Default Web Site", strcat("http://",tostring(Dst),":",tostring(sPort),tostring(tempURLconstruct)),
                           (tostring(sPort) has "80") and sPort == "80" and HttpHost <> "Default Web Site", strcat("http://",tostring(HttpHost),tostring(tempURLconstruct)),
                           (tostring(sPort) has "80") and sPort <> "80" and HttpHost <> "Default Web Site", strcat("http://",tostring(HttpHost),":",tostring(sPort),tostring(tempURLconstruct)),
                           (tostring(sPort) has "443") and HttpHost == "Default Web Site" and sPort == "443" , strcat("https://",tostring(Dst),tostring(tempURLconstruct)), 
                           (tostring(sPort) has "443") and HttpHost == "Default Web Site" and sPort <> "443", strcat("https://",tostring(Dst),":",tostring(sPort),tostring(tempURLconstruct)), 
                           (tostring(sPort) has "443") and sPort == "443" and HttpHost <> "Default Web Site", strcat("http://",tostring(HttpHost),tostring(tempURLconstruct)),
                           (tostring(sPort) has "443") and sPort <> "443" and HttpHost <> "Default Web Site", strcat("http://",tostring(HttpHost),":",tostring(sPort),tostring(tempURLconstruct)),
                           strcat("http://",tostring(Src),":",tostring(sPort),tostring(tempURLconstruct)) 
                           ) // we guess the URLs based upon ports, might be incorrect.
        | project-away 
                AdditionalInformation,
                AzureDeploymentID,
                Date,
                Description,
                DvcOs,
                FileOffset,
                FileUri,
                MG, 
                ManagementGroupName,
                Role*,
                SourceSystem,
                TLPLevel,
                TenantId,
                TimeTaken,
                Time,
                cs*,
                sComputerName,
                sPort,
                sc*,
                tempURLconstruct,
                StorageAccount
      };
      parser  (disabled)
