Parser:
  Title: Web Session ASIM filtering parser for Windows IIS logs
  Version: '0.1'
  LastUpdated: Dec 21, 2022
Product:
  Name: Internet Information Services (IIS)
Normalization:
  Schema: WebSession
  Version: '0.2.5'
References:
- Title: ASIM Web Session Schema
  Link: https://aka.ms/ASimWebSessionDoc
- Title: ASIM
  Link: https:/aka.ms/AboutASIM
Description: |
  This ASIM parser supports filtering and normalizing IIS logs produced by the W3CIISLog, Internet Information Server (IIS) log on Windows computers using the Log Analytics agent. to the ASIM Web Session normalized schema. The parser supports IIS native log format.
ParserName: vimWebSessionIIS
EquivalentBuiltInParser: _Im_WebSession_IIS
ParserParams:
  - Name: starttime
    Type: datetime
    Default: datetime(null)
  - Name: endtime
    Type: datetime
    Default: datetime(null)
  - Name: srcipaddr_has_any_prefix
    Type: dynamic
    Default: dynamic([])
  - Name: ipaddr_has_any_prefix
    Type: dynamic
    Default: dynamic([])
  - Name: url_has_any
    Type: dynamic
    Default: dynamic([])
  - Name: httpuseragent_has_any
    Type: dynamic 
    Default: dynamic([])
  - Name: eventresultdetails_in
    Type: dynamic 
    Default: dynamic([])
  - Name: eventresult
    Type: string
    Default: '*'
  - Name: disabled
    Type: bool
    Default: false
ParserQuery: |
  let parser = (
    starttime:datetime=datetime(null), 
    endtime:datetime=datetime(null),
    srcipaddr_has_any_prefix:dynamic=dynamic([]), 
    ipaddr_has_any_prefix:dynamic=dynamic([]), 
    url_has_any:dynamic=dynamic([]),
    httpuseragent_has_any:dynamic=dynamic([]),
    eventresultdetails_in:dynamic=dynamic([]),
    eventresult:string='*',
    disabled:bool=false
   ){
   W3CIISLog
       // -- Pre filtering
    | where  
      (isnull(starttime) or TimeGenerated >= starttime) 
      and (isnull(endtime) or TimeGenerated <= endtime) 
      and (array_length(httpuseragent_has_any) == 0)
      and ((array_length(srcipaddr_has_any_prefix) == 0) or has_any_ipv4_prefix(cIP, srcipaddr_has_any_prefix) or has_any_ipv4_prefix (csHost, srcipaddr_has_any_prefix))
      and ((array_length(ipaddr_has_any_prefix) == 0) or has_any_ipv4_prefix(sIP, ipaddr_has_any_prefix))
    // -- Parse
    | extend
      EventResult = iff ( toint(scStatus) < 400, "Success", "Failure"),
      scStatus = toint(scStatus), 
      csUriQuery = iff(csUriQuery == "-", "", csUriQuery),
      csUserName = iff(csUserName == "-", "", csUserName),
      HttpVersion = iff((csVersion has "HTTP"), split(csVersion, "/")[1], "") // there is a limited chance that something connects over non-HTTP
    // -- Map
    | project-rename 
                HttpHost = sSiteName,
                HttpRequestMethod = csMethod,
                HttpReferrer = csReferer,
                User = csUserName, //probably won't have this one often
                Dvc = Computer,
                EventResultDetails = scStatus,
                Dst = sIP,
                Src = cIP,
                UserAgent = csUserAgent,
                ThreatCategory = IndicatorThreatType,
                EventOriginalSeverity = Severity,
                SrcGeoCountry = RemoteIPCountry,
                SrcGeoLatitude = RemoteIPLatitude,
                SrcGeoLongitude = RemoteIPLongitude,
                ThreatOriginalConfidence = Confidence,
                ThreatIpAddr = MaliciousIP,
                ThreatIsActive = IsActive,
                ThreatFirstReportedTime = FirstReportedDateTime,
                ThreatLastReportedTime = LastReportedDateTime,
                EventReportUrl = ReportReferenceLink
           | extend
                SrcUsername = User,
                DstNatIpAddr = iff(csHost <> "", Dst, ""),
                EventType = 'WebServerSession',            
                EventVendor = 'Microsoft',
                EventSchemaVersion = '0.2.5',
                EventSchema = 'WebSession', 
                EventProduct = 'IIS',
                DvcOs = 'Windows',
                EventCount = int(1),
                SrcIpAddr = Src,
                IpAddr = Src,
                HttpUserAgent = UserAgent,
                HttpStatusCode = tostring(EventResultDetails),
                EventStartTime = TimeGenerated,
                EventEndTime = ( (TimeGenerated) + (TimeTaken * 1ms)), // TimeTaken field is in Milliseconds 
                EventSeverity = iff(EventResult == "Success", "Informational", "Low"),
                csUriQuery = tostring(csUriQuery),
                csUriStem = tostring(csUriStem),
                tempURLconstruct = iff(csUriQuery == "", csUriStem, strcat(csUriStem,"?",csUriQuery)),
                sPort = tostring(sPort),
                HttpHost = iff ( HttpHost == "-", "", HttpHost),
                csHost = iff ( csHost == "-", "", csHost),  //remove empty values
                EventOriginalResultDetails = iff(scSubStatus <> "0", strcat (scStatus, ".", scSubStatus), scStatus)
        | extend 
                ipv6_parts = extract_all (@'^\[(.+)\](?:\:(\d+))?$',csHost)[0],
                ipv4_parts = extract_all (@'^(\d+\.\d+\.\d+\.\d+)(?:\:(\d+))?$',csHost)[0],
                host_parts = extract_all (@'^([^\\\d:]+)(?:\:(\d+))?$',csHost)[0]
        | extend         
                DstIpAddr = coalesce(ipv4_parts[0], ipv6_parts[0]),
                DstPortNumber = coalesce(ipv4_parts[1], ipv6_parts[1], host_parts[1]),
                HttpHost = coalesce (host_parts[0], HttpHost)
        | project-away ipv4_parts, ipv6_parts, host_parts              
        | extend 
      ASimMatchingIpAddr = case( 
        array_length(ipaddr_has_any_prefix) == 0             , "-",
        has_any_ipv4_prefix(DstIpAddr, ipaddr_has_any_prefix), "DstIpAddr",
        has_any_ipv4_prefix(SrcIpAddr, ipaddr_has_any_prefix), "SrcIpAddr"
                                                             , "No match"
            )
        | where 
        (
          (array_length(srcipaddr_has_any_prefix) == 0 or has_any_ipv4_prefix(SrcIpAddr, srcipaddr_has_any_prefix))
          and (ASimMatchingIpAddr != "No match")
        )
        | extend         
                DstIpAddr = coalesce(ipv4_parts[0], ipv6_parts[0]),
                DstPortNumber = coalesce(ipv4_parts[1], ipv6_parts[1], host_parts[1]),
                HttpHost = coalesce (host_parts[0], HttpHost)
        | project-away ipv4_parts, ipv6_parts, host_parts              
        | extend 
                schema = iff (sPort has "443", "https://", "http://"),
                port = iff (sPort in ("80", "443"), "", strcat (":", sPort)),
                host = case ( 
                HttpHost == "Default Web Site", Dst,
                HttpHost != "", HttpHost,
                Dst
               )
         | extend 
                 Url = strcat (schema, host, port, tempURLconstruct)
        | project-away schema, host, port, tempURLconstruct
        | where
             ((array_length(url_has_any) == 0) or (Url has_any (url_has_any)))
        | project-away 
                AdditionalInformation,
                AzureDeploymentID,
                Date,
                Description,
                DvcOs,
                FileOffset,
                FileUri,
                MG, 
                ManagementGroupName,
                Role*,
                SourceSystem,
                TLPLevel,
                TenantId,
                TimeTaken,
                Time,
                cs*,
                sComputerName,
                sPort,
                sc*,
                StorageAccount
  };        
  parser (starttime, endtime, srcipaddr_has_any_prefix, ipaddr_has_any_prefix, url_has_any, httpuseragent_has_any, eventresultdetails_in, eventresult, disabled)
