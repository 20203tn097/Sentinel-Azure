id: 1533e792-4baf-4a13-97de-ccf1b9d1815d
name: OMI Vulnerability Exploitation
description: |
  'Following the September 14th, 2021 release of three Elevation of Privilege (EoP) vulnerabilities (CVE-2021-38645, CVE-2021-38649, CVE-2021-38648) and one unauthenticated Remote Code Execution (RCE) vulnerability (CVE-2021-38647) in the Open Management Infrastructure (OMI) Framework.
This detection validate that any OMS-agent that is reporting to the Azure Sentinel workspace is updataed with the patch. The detection will go over the heartbeats received from all agents over the last day and will create alert for those agents who are not updated.'
severity: High
requiredDataConnectors:
queryFrequency: 1d
queryPeriod: 1d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
relevantTechniques:
  - T1190
query: |

  let OMIVulnerabilityPatchVersion = "OMIVulnerabilityPatchVersion:1.13.40-0";
Heartbeat
| where Category == "Direct Agent"
| parse strcat("Version:" , Version) with * "Version:" Major:long "." Minor:long "." Patch:long "-" *
| parse OMIVulnerabilityPatchVersion with * "OMIVulnerabilityPatchVersion:" OMIVersionMajor:long "." OMIVersionMinor:long "." OMIVersionPatch:long "-" *
| where Major <OMIVersionMajor or (Major==OMIVersionMajor and Minor <=OMIVersionMinor) or (Major==OMIVersionMajor and Minor==OMIVersionMinor and Patch<OMIVersionPatch) 
| project Version, Major,Minor,Patch, Computer

entityMappings:
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: Computer
version: 1.0.0
