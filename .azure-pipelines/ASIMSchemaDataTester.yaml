jobs:
- job: "ASIMSchemaDataTester"
  displayName: 'Run ASIM testers on "eco-connector-test" workspace'
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - script: |
      echo "Checking for ASIM files in the pull request..."

      # Set variables
      REPO="Azure/Azure-Sentinel"
      PR_ID=$(System.PullRequest.PullRequestNumber)
      GITHUB_TOKEN=$(Github_PAT_ASIM_Schema_Data_Tester)

      #echo "Repository: $REPO"
      #echo "Pull Request ID: $PR_ID"

      # Debugging: Print full API URL to verify correctness
      api_url="https://api.github.com/repos/$REPO/pulls/$PR_ID/files"
      echo "API URL: $api_url"

      # Fetch the list of changed files using GitHub REST API
      changed_files_json=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$api_url")

      # Print raw JSON response for debugging
      # echo "Raw JSON response: $changed_files_json"

      # Check if the request was successful
      if echo $changed_files_json | jq -e . >/dev/null 2>&1; then
        echo "Successfully fetched changed files."
      else
        echo "Failed to fetch changed files. Response:"
        echo $changed_files_json
        exit 1
      fi

      # Extract the list of filenames using jq
      changed_files=$(echo $changed_files_json | jq -r '.[].filename')

      # echo "Changed files: $changed_files"

      # Initialize the variable indicating if relevant files are found
      files_changed=false

      # Check each changed file against the specified paths
      for file in $changed_files; do
        if [[ $file == Parsers/ASimDns/Parsers/* ]] || \
          [[ $file == Parsers/ASimNetworkSession/Parsers/* ]] || \
          [[ $file == Parsers/ASimWebSession/Parsers/* ]] || \
          [[ $file == Parsers/ASimProcessEvent/Parsers/* ]] || \
          [[ $file == Parsers/ASimAuditEvent/Parsers/* ]] || \
          [[ $file == Parsers/ASimAuthentication/Parsers/* ]] || \
          [[ $file == Parsers/ASimFileEvent/Parsers/* ]] || \
          [[ $file == Parsers/ASimRegistryEvent/Parsers/* ]] || \
          [[ $file == Parsers/ASimUserManagement/Parsers/* ]] || \
          [[ $file == Parsers/ASimDhcpEvent/Parsers/* ]]; then
          echo "Found changes to ASIM parser file: $file in the pull request."
          files_changed=true
          break
        fi
      done

      # Output the result
      echo "##vso[task.setvariable variable=files_changed]$files_changed"
      echo "ASIM parser changes detected: $files_changed"
    displayName: 'Check for Changed Files in Specified Locations'
    env:
      Github_PAT_ASIM_Schema_Data_Tester: $(Github_PAT_ASIM_Schema_Data_Tester)

  - checkout: self
    persistCredentials: false
    fetchDepth: 0  # Fetch full repository history
    condition: eq(variables['files_changed'], true)

  - task: AzurePowerShell@5
    inputs:
      azureSubscription: 'ASIM-SchemaDataTester-ServiceConnection'
      ScriptType: 'InlineScript'
      Inline: |
        & ".script/tests/asimParsersTest/runAsimTesters.ps1"
      FailOnStandardError: false
      ErrorActionPreference: 'continue'
      azurePowerShellVersion: 'latest'
    condition: and(succeeded(), eq(variables['files_changed'], 'true'))
