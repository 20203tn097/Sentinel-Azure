jobs:
- job: "ASIMSchemaDataTester"
  displayName: 'Run ASIM testers on "eco-connector-test" workspace'
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - checkout: self  # This line checks out your code repository to the runner
    persistCredentials: false
    fetchDepth: 0  # Fetch all history for all branches
  - script: |
      jobs:
      - job: "ASIMSchemaDataTester"
        displayName: 'Run ASIM testers on "eco-connector-test" workspace'
        pool:
          vmImage: 'ubuntu-latest'
      
        steps:
        - script: |
        echo "Checking for changed files in the pull request..."
      
        # Set variables
        REPO=$(Build.Repository.Name)
        SOURCE_BRANCH=$(Build.SourceBranch)
        TARGET_BRANCH=$(Build.TargetBranch)
      
        echo "Repository: $REPO"
        echo "Source branch: $SOURCE_BRANCH"
        echo "Target branch: $TARGET_BRANCH"
      
        # Fetch the target branch
        git fetch origin $TARGET_BRANCH
      
        # Get the list of changed files between the source and target branches
        changed_files=$(git diff --name-only $TARGET_BRANCH...$SOURCE_BRANCH)
      
        echo "Changed files: $changed_files"
      
        # Initialize the variable indicating if relevant files are found
        files_changed=false
      
        # Check each changed file against the specified paths
        for file in $changed_files; do
          if [[ $file == Parsers/ASimDns/Parsers/* ]] || \
            [[ $file == Parsers/ASimNetworkSession/Parsers/* ]] || \
            [[ $file == Parsers/ASimWebSession/Parsers/* ]] || \
            [[ $file == Parsers/ASimProcessEvent/Parsers/* ]]; then
          echo "Found changed file $file in specified locations."
          files_changed=true
          break
        fi
          done
      
          # Set the pipeline variable
          echo "##vso[task.setvariable variable=filesChanged;isOutput=true]$files_changed"
    displayName: 'Check for Changed Files in Specified Locations'

  - script: |
      echo "No relevant files changed."
      exit 0
    displayName: 'Skip job if no relevant files changed'
    condition: and(succeeded(), eq(variables['filesChanged'], 'false'))

  - checkout: self
    persistCredentials: false
    fetchDepth: 0  # Fetch full repository history
    condition: and(succeeded(), eq(variables['filesChanged'], 'true'))

  - task: AzureCLI@2
    inputs:
      azureSubscription: 'ASIM-SchemaDataTester-ServiceConnection'  # name of your Azure service connection
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        set -e  # Exit on error
        echo "Running Azure CLI commands..."
        # Example command to list resource groups
        az group list
      addSpnToEnvironment: true  # Add SPN credentials to environment variables for use in subsequent steps
    condition: and(succeeded(), eq(variables['filesChanged'], 'true'))

  - script: |
      git config --local user.name "azure-pipelines[bot]"
      git config --local user.email "<>"
    displayName: 'Setup git config'
    condition: and(succeeded(), eq(variables['filesChanged'], 'true'))

  - script: |
      git merge origin/master
      Conflicts=$(git ls-files -u | wc -l)
      if [ "$Conflicts" -gt 0 ] ; then
        echo "There is a merge conflict. Aborting"
        git merge --abort
        exit 1
      fi
    displayName: 'Merge master into pull request branch'
    condition: and(succeeded(), eq(variables['filesChanged'], 'true'))

  - task: AzurePowerShell@5
    inputs:
      azureSubscription: 'ASIM-SchemaDataTester-ServiceConnection'
      ScriptType: 'InlineScript'
      Inline: |
        & ".script/tests/asimParsersTest/runAsimTesters.ps1"
      FailOnStandardError: false
      ErrorActionPreference: 'continue'
      azurePowerShellVersion: 'latest'
    condition: and(succeeded(), eq(variables['filesChanged'], 'true'))
