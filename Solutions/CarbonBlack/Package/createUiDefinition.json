{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "isWizard": false,
      "basics": {
        "description": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/vmwarecarbonblack_logo.svg\" width=\"75px\" height=\"75px\">\n\n**Important:** _This Microsoft Sentinel Solution is currently in public preview. This feature is provided without a service level agreement, and it's not recommended for production workloads. Certain features might not be supported or might have constrained capabilities. For more information, see [Supplemental Terms of Use for Microsoft Azure Previews](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)._\n\n**Note:** _There may be [known issues](https://aka.ms/sentinelsolutionsknownissues) pertaining to this Solution, please refer to them before installing._\n\n[VMWare Carbon Black](https://www.carbonblack.com/products/vmware-carbon-black-cloud-endpoint/) transforms your security with cloud native endpoint protection that adapts to your needs. VMWare Carbon Black provides an endpoint platform that helps you spot the minor fluctuations that hide malicious attacks and adapt prevention in response.\n\nMicrosoft Sentinel Solutions provide a consolidated way to acquire Microsoft Sentinel content like data connectors, workbooks, analytics, and automations in your workspace with a single deployment step.\n\n**Workbooks:** 1, **Analytic Rules:** 2, **Custom Azure Logic Apps Connectors:** 1, **Playbooks:** 3\n\n[Learn more about Microsoft Sentinel](https://aka.ms/azuresentinel) | [Learn more about Solutions](https://aka.ms/azuresentinelsolutionsdoc)",
        "subscription": {
          "resourceProviders": [
            "Microsoft.OperationsManagement/solutions",
            "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "Microsoft.Insights/workbooks"
          ]
        },
        "location": {
          "metadata": {
            "hidden": "Hiding location, we get it from the log analytics workspace"
          },
          "visible": false
        },
        "resourceGroup": {
          "allowExisting": true
        }
      }
    },
    "basics": [
      {
        "name": "getLAWorkspace",
        "type": "Microsoft.Solutions.ArmApiControl",
        "toolTip": "This filters by workspaces that exist in the Resource Group selected",
        "condition": "[greater(length(resourceGroup().name),0)]",
        "request": {
          "method": "GET",
          "path": "[concat(subscription().id,'/providers/Microsoft.OperationalInsights/workspaces?api-version=2020-08-01')]"
        }
      },
      {
        "name": "workspace",
        "type": "Microsoft.Common.DropDown",
        "label": "Workspace",
        "placeholder": "Select a workspace",
        "toolTip": "This dropdown only lists workspaces that exists in the Resource Group selected",
        "constraints": {
          "allowedValues": "[map(filter(basics('getLAWorkspace').value, (filter) => contains(filter.id, toLower(resourceGroup().name))), (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
          "required": true
        },
        "visible": true
      }
    ],
    "steps": [
      {
        "name": "prereq",
        "label": "Prerequisites",
        "subLabel": {
          "preValidation": "",
          "postValidation": "Done"
        },
        "bladeTitle": "Prerequisites",
        "elements": [
          {
            "name": "Prerequisites",
            "type": "Microsoft.Common.Section",
            "label": "Prerequisites",
            "elements": [
              {
                "name": "CarbonBlackPrequisites-heading",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "Before deploying this VMware Carbon Black Cloud Solution make sure you have:"
                }
              },
              {
                "name": "CarbonBlackServiceEndpoint-text1",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": " 1. Your Carbon Black Cloud API service endpoint. ",
                  "link": {
                  "label": "Learn more",
                  "uri": "https://developer.carbonblack.com/reference/carbon-black-cloud/authentication/#hostname"
                }
                }
              },
              {
                "name": "CarbonBlackOrgKey-text1",
                "type": "Microsoft.Common.TextBlock",
                "visible": true ,
                "options": {
                  "text": " 2. Your Carbon Black Cloud Org Key.",
                  "link": {
                    "label": "Learn more",
                    "uri": "https://community.carbonblack.com/t5/Knowledge-Base/Carbon-Black-Cloud-Where-is-the-Org-Key-Found/ta-p/80970"
                  }
                }
              },
              {
                "name": "CarbonBlackAPIKey-text1",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": " 3. Create a custom Access level with the following minimum access:",
                  "link":{
                    "label": "Learn more",
                    "uri": "https://developer.carbonblack.com/reference/carbon-black-cloud/authentication/#creating-a-custom-access-level"
                  }
                },
                "visible": true
              },
              {
                "name": "CarbonBlackAPIKey-text2",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": " * Device > General Information > 'device' allow permissions for 'READ'Device > Policy assignment > 'device.policy' allow permissions for 'UPDATE'"
                },
                "visible": true
              },
              {
                "name": "CarbonBlackAPIKey-text3",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": " * Device > Policy assignment > 'device.policy' allow permissions for 'UPDATE'"
                },
                "visible": true
              },
              {
                "name": "CarbonBlackAPIKey-text4",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": " * Device > Quarantine > 'device.quarantine' allow permissions for 'EXECUTE'"
                },
                "visible": true
              },
              {
                "name": "CarbonBlackAPIKey-text5",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": " * Search > Events > 'org.search.events', allow permission to CREATE to start a job, READ to get results, DELETE to cancel a search and UPDATE for watchlist actions."
                },
                "visible": true
              },
              {
                "name": "CarbonBlackAPIKey-text6",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": " * Alerts > General Information > 'org.alerts' allow permissions for 'READ'."
                },
                "visible": true
              },
              {
                "name": "CarbonBlackAPIKey-text7",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": " * Alerts > Dismiss > 'org.alerts.dismiss' allow permissions for 'EXECUTE'."
                },
                "visible": true
              },
              {
                "name": "CarbonBlackAPIKey-text8",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": " * Alerts > Notes > 'org.alerts.notes' allow permissions for 'CREATE', 'READ', and 'DELETE'."
                },
                "visible": true
              },
              {
                "name": "CarbonBlackAPIKey-text9",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "4. Create an API key and secret using the Access Level type 'Custom', and the Access Level you created.",
                  "link":{
                    "label": "Learn how to create a identify your Carbon Black Cloud API Base URL",
                    "uri": "https://developer.carbonblack.com/reference/carbon-black-cloud/authentication/#creating-an-api-key"
                  }
                },
                "visible": true
              },
              {
                "name": "CarbonBlackAPIKey-text9",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "5. (Optional) Create a Carbon Black device policy for which to move devices, when requested from the Microsoft Teams playbook.",
                  "link":{
                    "label": "Learn more",
                    "uri": "https://community.carbonblack.com/t5/Knowledge-Base/CB-Protection-How-to-Create-a-New-Policy-Based-on-an-Existing/ta-p/79995"
                  }
                },
                "visible": true
              }
              ,
              {
                "name": "CarbonBlackAPIKey-text9",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "6. (Optional) Identify the Microsoft Teams group and channel ids for the Microsoft Teams playbook.",
                  "link":{
                    "label": "Learn more",
                    "uri": "https://community.carbonblack.com/t5/Knowledge-Base/CB-Protection-How-to-Create-a-New-Policy-Based-on-an-Existing/ta-p/79995"
                  }
                },
                "visible": true
              }
            ]
          }
        ]
      },
      {
        "name": "analytics",
        "label": "Analytics",
        "subLabel": {
          "preValidation": "Configure the analytics",
          "postValidation": "Done"
        },
        "bladeTitle": "Analytics",
        "elements": [
          {
            "name": "analytics-text",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "This Microsoft Sentinel Solution installs analytic rules for VMWare Carbon Black to enable custom alert generation. These analytic rules will be deployed in disabled mode in the analytics rules gallery of your Azure Sentinel workspace. Configure and enable these rules in the analytic rules gallery after this Solution deploys.",
              "link": {
                "label": "Learn more",
                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-detect-threats-custom?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef"
              }
            }
          },
          {
            "name": "analytic1",
            "type": "Microsoft.Common.Section",
            "label": "Critical Threat Detected",
            "elements": [
              {
                "name": "analytic1-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "Creates an incident in the event a critical threat was identified on a Carbon Black managed endpoint."
                }
              }
            ]
          },
          {
            "name": "analytic2",
            "type": "Microsoft.Common.Section",
            "label": "Known Malware Detected",
            "elements": [
              {
                "name": "analytic2-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "Creates an incident when known malware is detected on a Carbon Black managed endpoint."
                }
              }
            ]
          }
        ]
      },
      {
        "name": "workbooks",
        "label": "Workbooks",
        "subLabel": {
          "preValidation": "Configure the workbooks",
          "postValidation": "Done"
        },
        "bladeTitle": "Workbooks",
        "elements": [
          {
            "name": "workbooks-text",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "This Microsoft Sentinel Solution installs workbooks. Workbooks provide a flexible canvas for data monitoring, analysis and the creation of rich visual reports within the Azure portal. They allow you to tap into one or many data sources from Microsoft Sentinel and combine them into unified interactive experiences.",
              "link": {
                "label": "Learn more",
                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-monitor-your-data"
              }
            }
          },
          {
            "name": "workbook1",
            "type": "Microsoft.Common.Section",
            "label": "VMWare Carbon Black",
            "elements": [
              {
                "name": "workbook1-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "Gain extensive insight into VMware Carbon Black Cloud - Endpoint Standard by analyzing, collecting and correlating Event logs. This workbook provides visibility into Carbon Black managed endpoints and identified threat events."
                }
              },
              {
                "name": "workbook1-name",
                "type": "Microsoft.Common.TextBox",
                "label": "Display Name",
                "defaultValue": "VMWare Carbon Black",
                "toolTip": "Display name for the workbook.",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Please enter a workbook name"
                }
              }
            ]
          }
        ]
      },
      {
        "name": "playbooks",
        "label": "Playbooks",
        "subLabel": {
          "preValidation": "Configure the playbooks",
          "postValidation": "Done"
        },
        "bladeTitle": "Playbooks",
        "elements": [
          {
            "name": "playbooks-text",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "This solution installs playbook resources. A security playbook is a collection of procedures that can be run from Microsoft Sentinel in response to an alert. A security playbook can help automate and orchestrate your response, and can be run manually or set to run automatically when specific alerts are triggered. Security playbooks in Microsoft Sentinel are based on Azure Logic Apps, which means that you get all the power, customizability, and built-in templates of Logic Apps. Each playbook is created for the specific subscription you choose, but when you look at the Playbooks page, you will see all the playbooks across any selected subscriptions.",
              "link": {
                "label": "Learn more",
                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-respond-threats-playbook?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef"
              }
            }
          },
          {
            "name": "playbook1",
            "type": "Microsoft.Common.Section",
            "label": "CarbonBlackConnector",
            "elements": [
              {
                "name": "playbook1-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "This custom connector connects the playbooks to the Carbon Black Cloud endpoint API for enrichment and device management. This works with and does not replace the VMware Carbon Black data connector in the Data Connectors gallery."
                }
              },
              {
                "name": "playbook1-CarbonBlack_CustomConnector_Name",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Connector Name",
                "defaultValue": "CarbonBlackConnector",
                "toolTip": "Please enter custom connector name",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Please enter custom connector name"
                }
              },
              {
                "name": "playbook1-ServiceEndpoint",
                "type": "Microsoft.Common.TextBox",
                "label": "Service EndPoint",
                "defaultValue": "https://{CarbonblackBaseURL}",
                "toolTip": "Enter the Carbon Black Cloud base URL (ex: https://defense.conferdeploy.net)",
                "constraints": {
                  "required": true,
                  "regex": "[\\w\\W]{1,256}$",
                  "validationMessage": "Enter the Carbon Black base URL (ex: https://defense.conferdeploy.net)"
                }
              }
            ]
          },
          {
            "name": "playbook2",
            "type": "Microsoft.Common.Section",
            "label": "CarbonBlack-TakeDeviceActionFromTeams",
            "elements": [
              {
                "name": "playbook2-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "This playbook creates an adaptive card in the specified Microsoft Teams channel. Users can choose to initiate a device quarantine, change device policy, or ignore the incident."
                }
              },
              {
                "name": "playbook2-Playbook_Name",
                "type": "Microsoft.Common.TextBox",
                "label": "Playbook Name",
                "defaultValue": "CarbonBlack-TakeDeviceActionFromTeams",
                "toolTip": "Enter Playbook Name",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Enter the Playbook Name"
                }
              },
              {
                "name": "playbook2-OrganizationKey",
                "type": "Microsoft.Common.TextBox",
                "label": "Organization Key",
                "defaultValue": "OrganizationKey",
                "toolTip": "Enter the Carbon Black Cloud Org Key",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Enter the Carbon Black Cloud Org Key"
                }
              },
              {
                "name": "playbook2-PolicyId",
                "type": "Microsoft.Common.TextBox",
                "label": "Policy Id",
                "defaultValue": "0",
                "toolTip": "Enter the Carbon Black Policy Id",
                "constraints": {
                  "required": true,
                  "regex": "[0-9]{1,256}$",
                  "validationMessage": "Enter the Carbon Black Policy Id"
                }
              },
              {
                "name": "playbook2-Teams_GroupId",
                "type": "Microsoft.Common.TextBox",
                "label": "Teams Group Id",
                "defaultValue": "TeamgroupId",
                "toolTip": "Enter the Microsoft Teams Group Id",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Enter the Microsoft Teams Group Id"
                }
              },
              {
                "name": "playbook2-Teams_ChannelId",
                "type": "Microsoft.Common.TextBox",
                "label": "Teams Channel Id",
                "defaultValue": "TeamChannelId",
                "toolTip": "Enter the Microsoft Teams Channel Id",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Enter the Microsoft Teams Channel Id"
                }
              }
            ]
          },
          {
            "name": "playbook3",
            "type": "Microsoft.Common.Section",
            "label": "CarbonBlack-DeviceEnrichment",
            "elements": [
              {
                "name": "playbook3-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "This playbook enriches Sentinel incidents with device information."
                }
              },
              {
                "name": "playbook3-Playbook_Name",
                "type": "Microsoft.Common.TextBox",
                "label": "Playbook Name",
                "defaultValue": "CarbonBlack-DeviceEnrichment",
                "toolTip": "Enter the playbook name",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Enter the playbook name"
                }
              }
            ]
          },
          {
            "name": "playbook4",
            "type": "Microsoft.Common.Section",
            "label": "CarbonBlack-QuarantineDevice",
            "elements": [
              {
                "name": "playbook4-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "This playbook automatically quarantines devices and enriches Sentinel incidents with device information."
                }
              },
              {
                "name": "playbook4-Playbook_Name",
                "type": "Microsoft.Common.TextBox",
                "label": "Playbook Name",
                "defaultValue": "CarbonBlack-QuarantineDevice",
                "toolTip": "Enter the playbook name",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Enter the playbook name"
                }
              }
            ]
          }
        ]
      },
      {
        "name": "Post-deployment Steps",
        "label": "Post-deployment steps",
        "subLabel": {
          "preValidation": "Deploy policy definitions",
          "postValidation": "Done"
        },
        "bladeTitle": "Post-deployment steps",
        "elements": [
          {
            "name": "policyDefs",
            "type": "Microsoft.Common.Section",
            "label": "Authorize playbook connections",
            "elements": [
              {
                "name": "Policy-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": " Authorize connections\n\nOnce the playbook is deployed, edit the Logic App and authorize each Carbon Black Cloud and Microsoft Teams connection.\n\nClick the connection resource:\n\n1. Click **change connection* or **create new** API connection.\n2. Assign a name to the connection.\n3. Type the API key as a combination {API Key}/{API ID}.\n4. Click Save.\n5. Repeat steps for other connections such as the Microsoft Teams connection and Carbon Black connector connection.\n\n**Note:**\n\n The API Key must be provided as a combination {API Key}/{API ID}."
                }
              }
            ],
            "visible": true
          }
        ]
      }
    ],
    "outputs": {
      "workspace-location": "[resourceGroup().location]",
      "location": "[location()]",
      "workspace": "[basics('workspace')]",
      "workbook1-name": "[steps('workbooks').workbook1.workbook1-name]",
      "CarbonBlack_CustomConnector_Name": "[steps('playbooks').playbook1.playbook1-CarbonBlack_CustomConnector_Name]",
      "Service EndPoint": "[steps('playbooks').playbook1.playbook1-ServiceEndpoint]",
      "CarbonBlack-TakeDeviceActionFromTeams_Playbook_Name": "[steps('playbooks').playbook2.playbook2-Playbook_Name]",
      "CarbonBlack-DeviceEnrichment_Playbook_Name": "[steps('playbooks').playbook3.playbook3-Playbook_Name]",
      "CarbonBlack-QuarantineDevice_Playbook_Name": "[steps('playbooks').playbook4.playbook4-Playbook_Name]",
      "OrganizationKey": "[steps('playbooks').playbook2.playbook2-OrganizationKey]",
      "PolicyId": "[steps('playbooks').playbook2.playbook2-PolicyId]",
      "Teams_GroupId": "[steps('playbooks').playbook2.playbook2-Teams_GroupId]",
      "Teams_ChannelId": "[steps('playbooks').playbook2.playbook2-Teams_ChannelId]"
    }
  }
}