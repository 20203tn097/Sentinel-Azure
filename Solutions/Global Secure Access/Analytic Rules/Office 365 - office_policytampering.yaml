id: fbd72eb8-087e-466b-bd54-1ca6ea08c6d3
name: Office Policy Tampering
description: |
  Identifies if any tampering is done to either audit log, ATP Safelink, SafeAttachment, AntiPhish, or Dlp policy. 
  An adversary may use this technique to evade detection or avoid other policy-based defenses.
  References: https://docs.microsoft.com/powershell/module/exchange/advanced-threat-protection/remove-antiphishrule?view=exchange-ps.
severity: Medium
status: Available 
requiredDataConnectors:
  - connectorId: AzureActiveDirectory
    dataTypes:
      - EnrichedMicrosoft365AuditLogs
queryFrequency: 1d
queryPeriod: 1d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Persistence
  - DefenseEvasion
relevantTechniques:
  - T1098
  - T1562
query: |
  let opList = dynamic(["Remove-AntiPhishRule", "Disable-AntiPhishRule", "Remove-SafeAttachmentRule", "Disable-SafeAttachmentRule", "Remove-SafeLinksRule", "Disable-SafeLinksRule", "Remove-DlpPolicy", "Disable-DlpPolicy", "Remove-AuditConfig", "Disable-AuditConfig"]);
  EnrichedMicrosoft365AuditLogs
  // Only admin or global-admin can disable/remove policy
  | where RecordType == "ExchangeAdmin"
  | where UserType in ("Admin", "DcAdmin")
  // Pass in interesting Operation list
  | where Operation in (opList)
  | extend ClientIPOnly = case(
      ClientIp has ".", tostring(split(ClientIp, ":")[0]),
      ClientIp has "[", tostring(trim_start(@'[[]', tostring(split(ClientIp, "]")[0]))),
      ClientIp
  )  
  | extend Port = case(
      ClientIp has ".", split(ClientIp, ":")[1],
      ClientIp has "[", tostring(split(ClientIp, "]:")[1]),
      ClientIp
  )
  | summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), OperationCount = count() by Operation, UserType, UserId, ClientIP = ClientIPOnly, Port, ResultStatus, AdditionalProperties
  | extend AccountName = tostring(split(UserId, "@")[0]), AccountUPNSuffix = tostring(split(UserId, "@")[1])
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: UserId
      - identifier: Name
        columnName: AccountName
      - identifier: UPNSuffix
        columnName: AccountUPNSuffix
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: ClientIP
version: 2.0.3
kind: Scheduled
