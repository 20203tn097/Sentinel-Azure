{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## Office 365 Enriched workbook\n---\n\nThe enriched Microsoft 365 logs provide information about Microsoft 365 workloads, so you can review network data and security events relevant to Microsoft 365 apps."
      },
      "name": "text - 2"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "ff8b2a55-1849-4848-acf8-eab5452e9f10",
            "version": "KqlParameterItem/1.0",
            "name": "LogAnalyticWorkspace",
            "label": "Log Analytic Workspace",
            "type": 5,
            "description": "The log analytic workspace in which to execute the queries",
            "isRequired": true,
            "query": "resources\r\n| where type == \"microsoft.operationalinsights/workspaces\"\r\n| project id",
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.operationalinsights/workspaces": true
              },
              "additionalResourceOptions": [
                "value::1"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::1",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "f15f34d8-8e2d-4c39-8dee-be2f979c86a8",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time Range",
            "type": 4,
            "isRequired": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                }
              ],
              "allowCustom": true
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": {
              "durationMs": 2592000000
            }
          },
          {
            "id": "8bab511b-53b3-4220-9d1c-372345b06728",
            "version": "KqlParameterItem/1.0",
            "name": "Users",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| summarize Count = count() by UserId_s\r\n| order by Count desc, UserId_s asc\r\n| project Value = UserId_s, Label = strcat(UserId_s, ' - ', Count, ' Logs'), Selected = false",
            "typeSettings": {
              "limitSelectTo": 20,
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "*",
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "value": [
              "value::all"
            ]
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 15"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "tabStyle": "bigger",
        "links": [
          {
            "id": "e841bafb-6437-4d29-84ac-ba16c5a6d901",
            "cellValue": "selTab",
            "linkTarget": "parameter",
            "linkLabel": "Overview",
            "subTarget": "Overview",
            "style": "link"
          },
          {
            "id": "ac5f2082-50bc-4739-bdf2-20c93b613671",
            "cellValue": "selTab",
            "linkTarget": "parameter",
            "linkLabel": "SharePoint/OneDrive Insights",
            "subTarget": "Threat",
            "style": "link"
          },
          {
            "id": "dc2778e7-739b-44ba-9ae4-c81901277f57",
            "cellValue": "selTab",
            "linkTarget": "parameter",
            "linkLabel": "Exchange Online Insights",
            "subTarget": "ThreatEXO",
            "style": "link"
          },
          {
            "id": "666111e2-54ff-4fa4-a648-11a5c8c0235b",
            "cellValue": "selTab",
            "linkTarget": "parameter",
            "linkLabel": "Teams Insights",
            "subTarget": "ThreatTeams",
            "style": "link"
          }
        ]
      },
      "name": "links - 7"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| where Workload_s in (\"Exchange\")\r\n| extend GeoInfo = geo_info_from_ip_address(SourceIP) // Assuming a function exists to pull geo info\r\n| extend \r\n    Country = tostring(GeoInfo.country), \r\n    State = tostring(GeoInfo.state), \r\n    City = tostring(GeoInfo.city), \r\n    Latitude = tostring(GeoInfo.latitude), \r\n    Longitude = tostring(GeoInfo.longitude)\r\n| project \r\n    UserId_s, \r\n    Location = strcat(City, ', ', State, ', ', Country), // Constructing a full location string\r\n    Latitude, \r\n    Longitude, \r\n    City, \r\n    State, \r\n    Country\r\n| summarize Count = count() by City, State, Country\r\n",
              "size": 0,
              "title": "Access by Location",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "CountryRegion",
                "locInfoColumn": "Country",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "Count",
                "sizeAggregation": "Sum",
                "labelSettings": "Country",
                "legendMetric": "Count",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "Count",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "turquoise"
                }
              }
            },
            "customWidth": "50",
            "name": "query - 0"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| where Workload_s in (\"Exchange\")\r\n| summarize count() by SourceIP, DeviceOperatingSystem_s | order by count_ desc",
              "size": 0,
              "title": "Access by Location and OS",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "50",
            "name": "query - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL | where Operation_s in (\"Set-AdminAuditLogConfig\", \"Set-OrganizationConfig\") \r\n| project Timestamp = TimeGenerated, UserID = UserId_s, ['Client IP'] = ClientIp_s,  Operation = Operation_s\r\n| summarize Count = count() by Timestamp, UserID, ['Client IP'],  Operation\r\n| project Timestamp, UserID, ['Client IP'],  Operation, Count\r\n| order by Count desc\r\n",
              "size": 0,
              "title": "Audit of Critical Configuration Changes",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "50",
            "name": "query - 2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL | where Operation_s in (\"Set-TransportRule\", \"Set-AtpPolicyForO365\", \"Set-MalwareFilterRule\") | project Timestamp = TimeGenerated, UserID = UserId_s, ['Client IP'] = ClientIp_s,  Operation = Operation_s\r\n| summarize Count = count() by Timestamp, UserID, ['Client IP'],  Operation\r\n| project Timestamp, UserID, ['Client IP'],  Operation, Count\r\n| order by Count desc\r\n",
              "size": 0,
              "title": "Changes in Email Security Policies",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "50",
            "name": "query - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL | where Operation_s in (\"Add-RoleGroupMember\", \"Remove-ManagementRoleAssignment\") | project Timestamp = TimeGenerated, UserID = UserId_s, ['Client IP'] = ClientIp_s,  Operation = Operation_s\r\n| summarize Count = count() by Timestamp, UserID, ['Client IP'],  Operation\r\n| project Timestamp, UserID, ['Client IP'],  Operation, Count\r\n| order by Count desc",
              "size": 0,
              "title": "Monitoring Role Group Membership Changes",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "50",
            "name": "query - 4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL | where Operation_s in (\"New-TenantAllowBlockListSpoofitems\", \"Remove-TenantAllowBlockListSpoofitems\") | project Timestamp = TimeGenerated, UserID = UserId_s, ['Client IP'] = ClientIp_s,  Operation = Operation_s\r\n| summarize Count = count() by Timestamp, UserID, ['Client IP'],  Operation\r\n| project Timestamp, UserID, ['Client IP'],  Operation, Count\r\n| order by Count desc\r\n",
              "size": 0,
              "title": "Spoofing Settings Management Activities",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "50",
            "name": "query - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL | where Operation_s in (\"New-SafeAttachmentPolicy\", \"Set-SafeAttachmentPolicy\", \"Set-SafeAttachmentRule\") | project Timestamp = TimeGenerated, UserID = UserId_s, ['Client IP'] = ClientIp_s,  Operation = Operation_s\r\n| summarize Count = count() by Timestamp, UserID, ['Client IP'],  Operation\r\n| project Timestamp, UserID, ['Client IP'],  Operation, Count\r\n| order by Count desc\r\n",
              "size": 0,
              "title": "Safe Attachments Policy Changes",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "50",
            "name": "query - 6"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selTab",
        "comparison": "isEqualTo",
        "value": "ThreatEXO"
      },
      "name": "group - 18"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "EnrichedMicrosoft365AuditLogsDemos_CL | where Workload_s == \"Exchange\" | where Operation_s in (\"Add-MailboxFolderPermission\", \"Add-RoleGroupMember\", \"New-TransportRule\", \"Remove-ManagementRoleAssignment\", \"Set-TransportRule\") | summarize Count = count(), Users = makeset(UserId_s) by Operation_s | order by Count desc",
        "size": 0,
        "title": "Permission changes and security policy updates",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.Operation_salinsights/workspaces"
      },
      "conditionalVisibility": {
        "parameterName": "seltab",
        "comparison": "isEqualTo",
        "value": "ThreatEXO"
      },
      "name": "query - 13"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| where Workload_s in (\"Teams\")\r\n| extend GeoInfo = geo_info_from_ip_address(SourceIP) // Assuming a function exists to pull geo info\r\n| extend \r\n    Country = tostring(GeoInfo.country), \r\n    State = tostring(GeoInfo.state), \r\n    City = tostring(GeoInfo.city), \r\n    Latitude = tostring(GeoInfo.latitude), \r\n    Longitude = tostring(GeoInfo.longitude)\r\n| project \r\n    UserId_s, \r\n    Location = strcat(City, ', ', State, ', ', Country), // Constructing a full location string\r\n    Latitude, \r\n    Longitude, \r\n    City, \r\n    State, \r\n    Country\r\n| summarize Count = count() by City, State, Country\r\n",
              "size": 0,
              "title": "Access by Location",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "CountryRegion",
                "locInfoColumn": "Country",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "Count",
                "sizeAggregation": "Sum",
                "labelSettings": "Country",
                "legendMetric": "Count",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "Count",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "turquoise"
                }
              }
            },
            "customWidth": "50",
            "name": "query - 0"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| where Workload_s in (\"Teams\")\r\n| summarize count() by SourceIP, DeviceOperatingSystem_s | order by count_ desc",
              "size": 0,
              "title": "Access by Location and OS",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "50",
            "name": "query - 1"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selTab",
        "comparison": "isEqualTo",
        "value": "ThreatTeams"
      },
      "name": "group - 10"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| where Workload_s in (\"OneDrive\", \"SharePoint\",\"SPO/OneDrive\")\r\n| extend GeoInfo = geo_info_from_ip_address(SourceIP) // Assuming a function exists to pull geo info\r\n| extend \r\n    Country = tostring(GeoInfo.country), \r\n    State = tostring(GeoInfo.state), \r\n    City = tostring(GeoInfo.city), \r\n    Latitude = tostring(GeoInfo.latitude), \r\n    Longitude = tostring(GeoInfo.longitude)\r\n| project \r\n    UserId_s, \r\n    Location = strcat(City, ', ', State, ', ', Country), // Constructing a full location string\r\n    Latitude, \r\n    Longitude, \r\n    City, \r\n    State, \r\n    Country\r\n| summarize Count = count() by City, State, Country\r\n",
              "size": 0,
              "title": "Access by location",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "CountryRegion",
                "locInfoColumn": "Country",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "Count",
                "sizeAggregation": "Sum",
                "labelSettings": "Country",
                "legendMetric": "Country",
                "numberOfMetrics": 19,
                "legendAggregation": "Count",
                "itemColorSettings": {
                  "nodeColorField": "Count",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "turquoise"
                }
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "selTab",
              "comparison": "isEqualTo",
              "value": "Threat"
            },
            "name": "query - 19"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| where Workload_s in (\"OneDrive\", \"SharePoint\",\"SPO/OneDrive\")\r\n| summarize count() by SourceIP, DeviceOperatingSystem_s | order by count_ desc",
              "size": 2,
              "title": "Access by Location and OS",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 19"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selTab",
        "comparison": "isEqualTo",
        "value": "Threat"
      },
      "name": "group - 20",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "EnrichedMicrosoft365AuditLogsDemos_CL | where Workload_s == \"Teams\" | where Operation_s in (\"MemberAdded\", \"MemberRemoved\", \"TeamDeleted\") | project Timestamp = TimeGenerated, UserID = UserId_s, ['Client IP'] = ClientIp_s,  Operation = Operation_s\r\n| summarize Count = count() by Timestamp, UserID, ['Client IP'],  Operation\r\n| project Timestamp, UserID, ['Client IP'],  Operation, Count\r\n| order by Count desc",
        "size": 0,
        "title": "Changes in team memberships ",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "conditionalVisibility": {
        "parameterName": "selTab",
        "comparison": "isEqualTo",
        "value": "ThreatTeams"
      },
      "customWidth": "50",
      "name": "query - 11"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let RiskyExtensions = dynamic([\"exe\", \"msi\", \"bat\", \"cmd\", \"com\", \"scr\", \"pif\", \"ps1\", \"vbs\", \"js\", \"jse\", \"wsf\", \"docm\", \"xlsm\", \"pptm\", \"dll\", \"ocx\", \"cpl\", \"app\", \"vb\", \"reg\", \"inf\", \"hta\"]);\r\n\r\nEnrichedMicrosoft365AuditLogsDemos_CL\r\n| where Workload_s in (\"SPO/OneDrive\")\r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| extend FileExtension = tostring(parse_json(AdditionalProperties_s).SourceFileExtension)\r\n| where FileExtension in (RiskyExtensions)\r\n| project Timestamp = TimeGenerated, UserID = UserId_s, ['Client IP'] = ClientIp_s, ['File Extension'] = FileExtension, Operation = Operation_s\r\n| summarize Count = count() by Timestamp, UserID, ['Client IP'], ['File Extension'], Operation\r\n| project Timestamp, UserID, ['Client IP'], ['File Extension'], Operation, Count",
              "size": 0,
              "title": "Risky File Operations",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Operation_sCount",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "blue"
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "selTab",
              "comparison": "isEqualTo",
              "value": "Threat"
            },
            "name": "query - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where Workload_s in (\"OneDrive\", \"SharePoint\",\"SPO/OneDrive\")\r\n| where Operation_s in (\"FileRecycled\", \"FileDownloaded\", \"FileUploaded\",\"FileCreated\",\"File Modified\")\r\n| project Timestamp = TimeGenerated, UserID = UserId_s, ['Client IP'] = ClientIp_s,  Operation = Operation_s\r\n| summarize Count = count() by Timestamp, UserID, ['Client IP'],  Operation\r\n| project Timestamp, UserID, ['Client IP'],  Operation, Count\r\n| order by Count desc",
              "size": 0,
              "title": "Bulk file events",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Operation_sCount",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "blue"
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "selTab",
              "comparison": "isEqualTo",
              "value": "Threat"
            },
            "name": "query - 8"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where Workload_s in (\"SPO/OneDrive\")\r\n| where Operation_s == \"FileDeletedFirstStageRecycleBin\"\r\n| project Timestamp = TimeGenerated, UserID = UserId_s, ['Client IP'] = ClientIp_s,  Operation = Operation_s\r\n| summarize Count = count() by bin(Timestamp, 1h), UserID, ['Client IP'],  Operation\r\n| project Timestamp, UserID, ['Client IP'],  Operation, Count\r\n| order by Count desc\r\n| where Count > 1\r\n",
              "size": 0,
              "title": " Bulk File Deletion Operations",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "FileDeletions",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "blue"
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "selTab",
              "comparison": "isEqualTo",
              "value": "Threat"
            },
            "name": "query - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baselinePeriod = 30d;\r\nlet detectionWindow = 1h;\r\nlet downloadThreshold = 5; // Threshold of downloads indicating potential exfiltration\r\nEnrichedMicrosoft365AuditLogsDemos_CL\r\n| where TimeGenerated >= ago(baselinePeriod)\r\n| where Workload_s in (\"OneDrive\", \"SharePoint\",\"SPO/OneDrive\")\r\n| where Operation_s == \"FileDownloaded\"\r\n| project Timestamp = TimeGenerated, UserID = UserId_s, ['Client IP'] = ClientIp_s,  Operation = Operation_s\r\n| summarize Count = count() by bin(Timestamp, detectionWindow), UserID, ['Client IP'],  Operation\r\n| project Timestamp, UserID, ['Client IP'],  Operation, Count\r\n| order by Count desc\r\n\r\n",
              "size": 0,
              "title": "Bulk File Download",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "DownloadCount",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "blue"
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "selTab",
              "comparison": "isEqualTo",
              "value": "Threat"
            },
            "name": "query - 4"
          }
        ]
      },
      "name": "group - 9"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| extend GeoInfo = geo_info_from_ip_address(SourceIP) // Assuming a function exists to pull geo info\r\n| extend \r\n    Country = tostring(GeoInfo.country), \r\n    State = tostring(GeoInfo.state), \r\n    City = tostring(GeoInfo.city), \r\n    Latitude = tostring(GeoInfo.latitude), \r\n    Longitude = tostring(GeoInfo.longitude)\r\n| project \r\n    UserId_s, \r\n    Location = strcat(City, ', ', State, ', ', Country), // Constructing a full location string\r\n    Latitude, \r\n    Longitude, \r\n    City, \r\n    State, \r\n    Country\r\n      | where tostring(Country) != \"\"\r\n| summarize Count = count() by City, State, Country\r\n\r\n\r\n",
              "size": 0,
              "title": "Access By Location",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{LogAnalyticWorkspace}"
              ],
              "visualization": "map",
              "mapSettings": {
                "locInfo": "CountryRegion",
                "locInfoColumn": "Country",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "Count",
                "sizeAggregation": "Sum",
                "minSize": 20,
                "labelSettings": "Country",
                "legendMetric": "Country",
                "numberOfMetrics": 8,
                "legendAggregation": "Count",
                "itemColorSettings": {
                  "nodeColorField": "Count",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "turquoise"
                }
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "selTab",
              "comparison": "isEqualTo",
              "value": "Overview"
            },
            "name": "query - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| summarize count() by TimeGenerated, User=UserId_s,SourceIP, DeviceOperatingSystem_s,Workload_s | order by TimeGenerated desc",
              "size": 0,
              "title": "Access By Location and OS",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "rowLimit": 1000,
                "filter": true
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "selTab",
              "comparison": "isEqualTo",
              "value": "Overview"
            },
            "name": "query - 1"
          }
        ]
      },
      "name": "group - 19"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let data = EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| project \r\n    Operation_s, \r\n    UserId_s, \r\n    Workload_s, \r\n    SourceIP, \r\n    DeviceId_g, \r\n    TimeGenerated, \r\n    Details = pack_all(),\r\n    OS = tostring(DeviceOperatingSystem_s)  // Adjust this line if the field name changes\r\n| extend Workload = tostring(Workload_s)  // Ensure workload is a string for processing\r\n| extend WorkloadStatus = case(\r\n    Workload == \"Exchange\", \"Exchange\",\r\n    Workload == \"Teams\", \"Teams\",\r\n    Workload == \"SPO/OneDrive\", \"SharePoint\",\r\n    \"Other\" // Default case if no workload matches\r\n  );\r\n\r\nlet appData = data\r\n| summarize TotalCount = count(), ExchangeCount = countif(WorkloadStatus == \"Exchange\"), TeamsCount = countif(WorkloadStatus == \"Teams\"), SharePointCount = countif(WorkloadStatus == \"SharePoint\"), OtherCount = countif(WorkloadStatus == \"Other\") by UserId_s\r\n| where UserId_s != ''\r\n| join kind=inner (\r\n    data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by UserId_s\r\n    | project-away TimeGenerated\r\n  ) on UserId_s\r\n| order by TotalCount desc, UserId_s asc\r\n| project UserId_s, TotalCount, ExchangeCount, TeamsCount, SharePointCount, OtherCount, Trend\r\n| serialize Id = row_number();\r\n\r\ndata\r\n| summarize TotalCount = count(), ExchangeCount = countif(WorkloadStatus == \"Exchange\"), TeamsCount = countif(WorkloadStatus == \"Teams\"), SharePointCount = countif(WorkloadStatus == \"SharePoint\"), OtherCount = countif(WorkloadStatus == \"Other\") by UserId_s, SourceIP = tostring(SourceIP)\r\n| join kind=inner (\r\n    data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by UserId_s, SourceIP\r\n    | project-away TimeGenerated\r\n  ) on UserId_s, SourceIP\r\n| order by TotalCount desc, UserId_s asc\r\n| project UserId_s, SourceIP, TotalCount, ExchangeCount, TeamsCount, SharePointCount, OtherCount, Trend\r\n| serialize Id = row_number(1000000)\r\n| join kind=inner (appData) on UserId_s\r\n| project Id, Name = SourceIP, Type = 'Client IP', ['Events Count'] = TotalCount, Trend, ['Exchange Events'] = ExchangeCount, ['Teams Events'] = TeamsCount, ['SharePoint Events'] = SharePointCount, ['Other Count'] = OtherCount, ParentId = Id1\r\n| union (\r\n    appData \r\n    | project Id, Name = UserId_s, Type = 'Operating System', ['Events Count'] = TotalCount, Trend, ['Exchange Events'] = ExchangeCount, ['Teams Events'] = TeamsCount, ['SharePoint Events'] = SharePointCount, ['Other Count'] = OtherCount, ParentId = -1\r\n  )\r\n| order by ['Events Count'] desc, Name asc",
        "size": 2,
        "title": "Activity Log",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Id",
              "formatter": 5
            },
            {
              "columnMatch": "Type",
              "formatter": 5
            },
            {
              "columnMatch": "Operation Count",
              "formatter": 8,
              "formatOptions": {
                "palette": "blue",
                "aggregation": "Count"
              }
            },
            {
              "columnMatch": "Trend",
              "formatter": 9,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "Exchange Count",
              "formatter": 8,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "Teams Count",
              "formatter": 8,
              "formatOptions": {
                "palette": "purple"
              }
            },
            {
              "columnMatch": "SharePoint Count",
              "formatter": 8,
              "formatOptions": {
                "palette": "turquoise"
              }
            },
            {
              "columnMatch": "Other Count",
              "formatter": 5
            },
            {
              "columnMatch": "ParentId",
              "formatter": 5
            },
            {
              "columnMatch": "Details",
              "formatter": 5,
              "formatOptions": {
                "linkTarget": "GenericDetails",
                "linkIsContextBlade": true
              }
            }
          ],
          "rowLimit": 1000,
          "filter": true,
          "hierarchySettings": {
            "idColumn": "Id",
            "parentColumn": "ParentId",
            "treeType": 0,
            "expanderColumn": "Name"
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "selTab",
        "comparison": "isEqualTo",
        "value": "Overview"
      },
      "name": "query - 6"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| extend \r\n    OS = coalesce(DeviceOperatingSystem_s, \"Unknown OS\"),\r\n    OSVersion = coalesce(tostring(DeviceOperatingSystemVersion_d), \"Unknown Version\"),\r\n    Device = coalesce(tostring(DeviceId_g), \"Unknown DeviceId\")\r\n| summarize DeviceCount = count() by OS, OSVersion, Device\r\n| order by DeviceCount desc\r\n\r\n\r\n",
              "size": 3,
              "title": "Devices accessing M365\t",
              "timeContextFromParameter": "TimeRange",
              "exportParameterName": "Parampie",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "selTab",
              "comparison": "isEqualTo",
              "value": "Overview"
            },
            "name": "query - 6"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EnrichedMicrosoft365AuditLogsDemos_CL\r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| extend \r\n    OS = coalesce(DeviceOperatingSystem_s, \"Unknown OS\"),\r\n    OSVersion = coalesce(tostring(DeviceOperatingSystemVersion_d), \"Unknown Version\"),\r\n    Device = coalesce(tostring(DeviceId_g), \"Unknown DeviceId\")\r\n| where OS == dynamic({Parampie}).label\r\n| summarize DeviceCount = count() by OS, OSVersion, Device\r\n| order by DeviceCount desc",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "hierarchySettings": {
                  "treeType": 1,
                  "groupBy": [
                    "OSVersion"
                  ],
                  "expandTopLevel": false
                }
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "selTab",
              "comparison": "isEqualTo",
              "value": "Overview"
            },
            "name": "query - 1"
          }
        ]
      },
      "name": "group - 19"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let BusinessHoursStart = 8; // 8 AM\r\nlet BusinessHoursEnd = 18; // 6 PM\r\n\r\nEnrichedMicrosoft365AuditLogsDemos_CL \r\n| where UserId_s in ({Users}) or '*' in ({Users})\r\n| extend HourOfDay = hourofday(TimeGenerated)\r\n| where HourOfDay < BusinessHoursStart or HourOfDay > BusinessHoursEnd\r\n| summarize OffHourActivities = count() by UserId_s, bin(TimeGenerated, 1d), Operation_s\r\n| order by OffHourActivities desc",
        "size": 0,
        "title": "Unusual After-Hours Activity",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "conditionalVisibility": {
        "parameterName": "selTab",
        "comparison": "isEqualTo",
        "value": "Overview"
      },
      "name": "query - 14"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "NetworkAccessDemo_CL\n| where trafficType_s == \"microsoft365\"\n| summarize Count = count() by bin(createdDateTime_t, 1h)\n| order by createdDateTime_t asc\n",
        "size": 0,
        "title": "Microsoft 365 Transactions",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "unstackedbar"
      },
      "conditionalVisibility": {
        "parameterName": "selTab",
        "comparison": "isEqualTo",
        "value": "Overview"
      },
      "name": "query - 2"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "NetworkAccessDemo_CL\r\n| where trafficType_s == \"microsoft365\" and tolower(action_s) == \"allow\"\r\n| summarize AvgReceivedMB = avg(receivedBytes_d) / (1024.0 * 1024.0), AvgSentMB = avg(sentBytes_d) / (1024.0 * 1024.0) by bin(createdDateTime_t, 1h)\r\n\r\n\r\n",
        "size": 0,
        "title": "Microsoft 365 Services bandwidth (MB)",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "timechart"
      },
      "conditionalVisibility": {
        "parameterName": "selTab",
        "comparison": "isEqualTo",
        "value": "Overview"
      },
      "name": "query - 3"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/a084787d-7368-4772-9043-6e0fdb1f08d9/resourceGroups/Logs/providers/Microsoft.OperationalInsights/workspaces/LA01"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}