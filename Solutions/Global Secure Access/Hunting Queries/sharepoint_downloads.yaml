id: e8ae1375-4640-430c-ae8e-2514d09c71eb
name: SharePointFileOperation via clientIP with previously unseen user agents
description: |
  'New user agents associated with a clientIP for SharePoint file uploads/downloads.'
requiredDataConnectors:
  - connectorId: AzureActiveDirectory
    dataTypes:
      - EnrichedMicrosoft365AuditLogs
tactics:
  - Exfiltration
relevantTechniques:
  - T1030
query: |
query: |
  let starttime = todatetime('{{StartTimeISO}}');
  let endtime = todatetime('{{EndTimeISO}}');
  let lookback = starttime - 14d;
  let historicalUA = EnrichedMicrosoft365AuditLogs
  | where RecordType == "SharePointFileOperation"
  | where Operation in ("FileDownloaded", "FileUploaded")
  | where TimeGenerated between(lookback..starttime)
  | summarize by ClientIp, UserAgent;
  let recentUA = EnrichedMicrosoft365AuditLogs
  | where RecordType == "SharePointFileOperation"
  | where Operation in ("FileDownloaded", "FileUploaded")
  | where TimeGenerated between(starttime..endtime)
  | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by ClientIp, UserAgent;
  recentUA | join kind=leftanti (
     historicalUA
  ) on ClientIp, UserAgent
  // Some EnrichedMicrosoft365AuditLogs records do not contain ClientIp information - exclude these for fewer results
  | where not(isempty(ClientIp))
  | extend IP_0_Address = ClientIp
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: ClientIP
version: 2.0.1