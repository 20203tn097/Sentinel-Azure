{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workflows_MndtThreatIntel_name": {
            "defaultValue": "Mandiant_Threat_Intelligence_Import",
            "type": "String"
        },
        "APIKey": {
            "type": "string",
            "metadata": {
                "description": "The value of your Mandiant API Key ID"
            }
        },
        "SecretKey": {
            "type": "secureString",
            "metadata": {
                "description": "The value of your Mandiant API Key Secret"
            }
        },
        "KeyVaultName": {
            "type": "string",
            "metadata": {
                "description": "The name of the Azure Key Vault to use for storing the API Secret Key"
            }
        },
        "IndicatorExpiration": {
            "type": "int",
            "minValue": 1,
            "defaultValue": 30,
            "metadata": {
                "description": "Defines the number of days after ingestion that an indicator will be valid"
            }
        },
        "MinimumConfidenceScore": {
            "type": "int",
            "minValue": 0,
            "maxValue": 100,
            "defaultValue": 80,
            "metadata": {
                "description": "Defines the minimum Indicator Confidence Score to ingest"
            }
        },
        "ExcludeOpen-SourceIntelligence": {
            "type": "bool",
            "defaultValue": true,
            "allowedValues": [true, false],
            "metadata": {
                "description": "Defines if open source indicators should be ingested"
            }
        },
        "LookbackInterval": {
            "type": "int",
            "minValue": -90,
            "maxValue": 0,
            "defaultValue": -30,
            "metadata": {
                "description": "Defines the number of days in the past to start ingesting indicators, based on an indicators last_updated date value"
            }
        },
        "ExecutionInterval": {
            "type": "int",
            "minValue": 1,
            "defaultValue": 6,
            "metadata": {
                "description": "Defines how often, in hours, to start an ingestion job"
            }
        },
        "DefaultAction": {
            "type": "string",
            "defaultValue": "alert",
            "allowedValues": ["alert", "block", "allow"],
            "metadata": {
                "description": "The action that Microsoft products should trigger when the indicator is matched in the system, either alert, or block"
            }
        },
        "TargetApplication": {
            "type": "string",
            "allowedValues": ["Azure Sentinel", "Microsoft Defender ATP"],
            "defaultValue": "Azure Sentinel",
            "metadata": {
                "description": "The Microsoft application to make indicators visible in, either Azure Sentinel or Microsoft Defender ATP"
            }
        },
        "IncludeUncategorized": {
            "type": "bool",
            "defaultValue": false,
            "allowedValues": [true, false],
            "metadata": {
                "description": "Defines if indicators without an attributed category are ingested or not"
            }
        },
        "HashType": {
            "type": "string",
            "defaultValue": "md5",
            "allowedValues": ["md5", "sha1", "sha256"],
            "metadata": {
                "description": "The hash type to use for indicators of type file, either md5, sha1, sha256"
            }
        },
        "IncludeIPv4": {
            "type": "bool",
            "defaultValue": true,
            "allowedValues": [true, false]
        },
        "IncludeFQDN": {
            "type": "bool",
            "defaultValue": true,
            "allowedValues": [true, false]
        },
        "IncludeURL": {
            "type": "bool",
            "defaultValue": true,
            "allowedValues": [true, false]
        },
        "IncludeFileHash": {
            "type": "bool",
            "defaultValue": true,
            "allowedValues": [true, false]
        },
        "StorageAccountName": {
            "type": "string"
        },
        "StorageContainerName": {
            "type": "string",
            "defaultValue": "mandiant-threat-intel"
        }
    },
    "variables": {},
    "resources": [
        {
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2019-05-01",
            "name": "[parameters('workflows_MndtThreatIntel_name')]",
            "location": "[resourceGroup().location]",
            "tags": {},
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        },
                        "API Key": {
                            "defaultValue": "[parameters('APIKey')]",
                            "type": "String"
                        },
                        "Default Indicator Action": {
                            "defaultValue": "[parameters('DefaultAction')]",
                            "type": "String"
                        },
                        "Exclude OSInt": {
                            "defaultValue": "[parameters('ExcludeOpen-SourceIntelligence')]",
                            "type": "Bool"
                        },
                        "Execution Interval": {
                            "defaultValue": "[parameters('ExecutionInterval')]",
                            "type": "Int"
                        },
                        "Expiration Days": {
                            "defaultValue": "[parameters('IndicatorExpiration')]",
                            "type": "Int"
                        },
                        "Hash Type": {
                            "defaultValue": "[parameters('HashType')]",
                            "type": "String"
                        },
                        "Ingest FQDN": {
                            "defaultValue": "[parameters('IncludeFQDN')]",
                            "type": "Bool"
                        },
                        "Ingest Hash": {
                            "defaultValue": "[parameters('IncludeFileHash')]",
                            "type": "Bool"
                        },
                        "Ingest IPv4": {
                            "defaultValue": "[parameters('IncludeIPv4')]",
                            "type": "Bool"
                        },
                        "Ingest URL": {
                            "defaultValue": "[parameters('IncludeURL')]",
                            "type": "Bool"
                        },
                        "Ingest Uncategorized": {
                            "defaultValue": "[parameters('IncludeUncategorized')]",
                            "type": "Bool"
                        },
                        "Lookback Days": {
                            "defaultValue": "[parameters('LookbackInterval')]",
                            "type": "Int"
                        },
                        "Minimum Confidence": {
                            "defaultValue": "[parameters('MinimumConfidenceScore')]",
                            "type": "Int"
                        },
                        "Passive Only": {
                            "defaultValue": false,
                            "type": "Bool"
                        },
                        "StorageContainerName": {
                            "defaultValue": "[parameters('StorageContainerName')]",
                            "type": "String"
                        },
                        "Secret Key Name": {
                            "defaultValue": "api-secret-key",
                            "type": "String"
                        },
                        "Target Product": {
                            "defaultValue": "[parameters('TargetApplication')]",
                            "type": "String"
                        }
                    },
                    "staticResults": {
                    },
                    "triggers": {
                        "Recurrence": {
                            "recurrence": {
                                "frequency": "Hour",
                                "interval": "@parameters('Execution Interval')"
                            },
                            "evaluatedRecurrence": {
                                "frequency": "Hour",
                                "interval": "@parameters('Execution Interval')"
                            },
                            "type": "Recurrence"
                        }
                    },
                    "actions": {
                        "1970Timestamp_in_Ticks": {
                            "inputs": "@ticks('1970-01-01T00:00:00Z')",
                            "runAfter": {
                                "UTCNow_in_Ticks": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Compose"
                        },
                        "Create_last-run_blob_if_it_doesnt_exist": {
                            "inputs": {
                                "body": "@variables('TMP_startTime')",
                                "headers": {
                                    "Content-Type": "text/plain",
                                    "ReadFileMetadataFromServer": true
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azureblobContainer']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "path": "/v2/datasets/@{encodeURIComponent(encodeURIComponent('AccountNameFromSettings'))}/files",
                                "queries": {
                                    "folderPath": "@{concat('/', parameters('StorageContainerName'))}",
                                    "name": "last-run.txt",
                                    "queryParametersSingleEncoded": true
                                }
                            },
                            "runAfter": {
                                "Update_last-run_blob_if_it_exists": [
                                    "Failed"
                                ]
                            },
                            "runtimeConfiguration": {
                                "contentTransfer": {
                                    "transferMode": "Chunked"
                                }
                            },
                            "type": "ApiConnection"
                        },
                        "Get_Last_Runtime": {
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azureblobContainer']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "/v2/datasets/@{encodeURIComponent(encodeURIComponent('AccountNameFromSettings'))}/files/@{encodeURIComponent(encodeURIComponent(concat('/', parameters('StorageContainerName'), '/last-run.txt')))}/content",
                                "queries": {
                                    "inferContentType": true
                                }
                            },
                            "metadata": {
                                "JTJmbWFuZGlhbnQtdGhyZWF0LWludGVsJTJmbGFzdC1ydW4=": "/mandiant-threat-intel/last-run",
                                "JTJmbWFuZGlhbnQtdGhyZWF0LWludGVsJTJmbGFzdC1ydW4udHh0": "/mandiant-threat-intel/last-run.txt"
                            },
                            "runAfter": {
                                "Initialize_variable_TMP_startTime": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection"
                        },
                        "HTTP_Get_Indicators": {
                            "inputs": {
                                "authentication": {
                                    "type": "Raw",
                                    "value": "Bearer @{variables('TMP_BearerToken')}"
                                },
                                "headers": {
                                    "Accept": "application/json",
                                    "X-App-Name": "MA-MSFT-AZURE-LOGIC-APP-v1.0.0"
                                },
                                "method": "GET",
                                "queries": {
                                    "exclude_osint": "@{parameters('Exclude OSInt')}",
                                    "gte_mscore": "@{parameters('Minimum Confidence')}",
                                    "limit": "1000",
                                    "start_epoch": "@{variables('TMP_lastRuntime')}"
                                },
                                "uri": "https://api.intelligence.mandiant.com/v4/indicator"
                            },
                            "runAfter": {
                                "Initialize_TMP_BearerToken": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Http"
                        },
                        "HTTP_Get_Initial_Token": {
                            "inputs": {
                                "authentication": {
                                    "password": "@body('Retrieve_API_Secret_Key')?['value']",
                                    "type": "Basic",
                                    "username": "@parameters('API Key')"
                                },
                                "body": "grant_type=client_credentials&scope=",
                                "headers": {
                                    "X-App-Name": "MA-MSFT-AZURE-LOGIC-APP-v1.0.0",
                                    "accept": "application/json",
                                    "content-type": "application/x-www-form-urlencoded"
                                },
                                "method": "POST",
                                "uri": "https://api.intelligence.mandiant.com/token"
                            },
                            "runAfter": {
                                "Initialize_TMP_tags": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Http"
                        },
                        "If_first_page_is_empty": {
                            "actions": {
                                "Set_pageEmpty": {
                                    "inputs": {
                                        "name": "CTRL_pageEmpty",
                                        "value": true
                                    },
                                    "runAfter": {},
                                    "type": "SetVariable"
                                }
                            },
                            "else": {
                                "actions": {
                                    "Set_nextPage": {
                                        "inputs": {
                                            "name": "CTRL_nextPage",
                                            "value": "@body('Parse_First_Indicator_Page')?['next']"
                                        },
                                        "runAfter": {},
                                        "type": "SetVariable"
                                    }
                                }
                            },
                            "expression": {
                                "or": [
                                    {
                                        "equals": [
                                            "@length(body('Parse_First_Indicator_Page')?['indicators'])",
                                            0
                                        ]
                                    },
                                    {
                                        "equals": [
                                            "@outputs('HTTP_Get_Indicators')['statusCode']",
                                            204
                                        ]
                                    },
                                    {
                                        "less": [
                                            "@length(body('Parse_First_Indicator_Page')?['indicators'])",
                                            1000
                                        ]
                                    }
                                ]
                            },
                            "runAfter": {
                                "Initialize_CTRL_pageEmpty": [
                                    "Succeeded"
                                ]
                            },
                            "type": "If"
                        },
                        "Initialize_CTRL_nextPage": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "CTRL_nextPage",
                                        "type": "string"
                                    }
                                ]
                            },
                            "runAfter": {
                                "Parse_First_Indicator_Page": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_CTRL_pageEmpty": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "CTRL_pageEmpty",
                                        "type": "boolean",
                                        "value": false
                                    }
                                ]
                            },
                            "runAfter": {
                                "Initialize_CTRL_nextPage": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_TMP_BearerToken": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TMP_BearerToken",
                                        "type": "string",
                                        "value": "@body('Parse_Initial_Bearer_Token')?['access_token']"
                                    }
                                ]
                            },
                            "runAfter": {
                                "Parse_Initial_Bearer_Token": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_TMP_IndicatorsBody": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TMP_IndicatorsBody",
                                        "type": "string"
                                    }
                                ]
                            },
                            "runAfter": {
                                "Initialize_TMP_selectedHash": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_TMP_associatedActors": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TMP_associatedActors",
                                        "type": "array",
                                        "value": []
                                    }
                                ]
                            },
                            "runAfter": {
                                "Initialize_allIndicators": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_TMP_diamondModel": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TMP_diamondModel",
                                        "type": "string",
                                        "value": "Unknown"
                                    }
                                ]
                            },
                            "runAfter": {
                                "Set_lastRuntime_from_Blob": [
                                    "Succeeded",
                                    "Skipped"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_TMP_killChain": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TMP_killChain",
                                        "type": "array",
                                        "value": []
                                    }
                                ]
                            },
                            "runAfter": {
                                "Initialize_TMP_malwareFamilies": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_TMP_malwareFamilies": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TMP_malwareFamilies",
                                        "type": "array",
                                        "value": []
                                    }
                                ]
                            },
                            "runAfter": {
                                "Initialize_TMP_associatedActors": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_TMP_selectedHash": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TMP_selectedHash",
                                        "type": "string"
                                    }
                                ]
                            },
                            "runAfter": {
                                "Initialize_TMP_threatType": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_TMP_severity": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TMP_severity",
                                        "type": "integer",
                                        "value": 0
                                    }
                                ]
                            },
                            "runAfter": {
                                "Initialize_TMP_killChain": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_TMP_tags": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TMP_TAGS",
                                        "type": "array",
                                        "value": []
                                    }
                                ]
                            },
                            "runAfter": {
                                "Initialize_TMP_diamondModel": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_TMP_threatType": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TMP_threatType",
                                        "type": "string",
                                        "value": "unset"
                                    }
                                ]
                            },
                            "runAfter": {
                                "Initialize_TMP_severity": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_allIndicators": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "allIndicators",
                                        "type": "array",
                                        "value": "@body('Parse_First_Indicator_Page')?['indicators']"
                                    }
                                ]
                            },
                            "runAfter": {
                                "If_first_page_is_empty": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_variable_TMP_lastRuntime": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TMP_lastRuntime",
                                        "type": "integer",
                                        "value": "@outputs('Timestamp_to_Epoch')"
                                    }
                                ]
                            },
                            "runAfter": {
                                "Timestamp_to_Epoch": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Initialize_variable_TMP_startTime": {
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TMP_startTime",
                                        "type": "integer",
                                        "value": "@div(sub(ticks(utcNow()), ticks('1970-01-01T00:00:00Z')), 10000000)"
                                    }
                                ]
                            },
                            "runAfter": {
                                "Initialize_variable_TMP_lastRuntime": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable"
                        },
                        "Parse_First_Indicator_Page": {
                            "inputs": {
                                "content": "@body('HTTP_Get_Indicators')",
                                "schema": {
                                    "properties": {
                                        "indicators": {
                                            "items": {
                                                "properties": {
                                                    "associated_hashes": {
                                                        "items": {
                                                            "properties": {
                                                                "id": {
                                                                    "type": "string"
                                                                },
                                                                "type": {
                                                                    "type": "string"
                                                                },
                                                                "value": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "required": [
                                                                "id",
                                                                "type",
                                                                "value"
                                                            ],
                                                            "type": "object"
                                                        },
                                                        "type": "array"
                                                    },
                                                    "attributed_associations": {
                                                        "items": {
                                                            "properties": {
                                                                "id": {
                                                                    "type": "string"
                                                                },
                                                                "name": {
                                                                    "type": "string"
                                                                },
                                                                "type": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "required": [
                                                                "id",
                                                                "name",
                                                                "type"
                                                            ],
                                                            "type": "object"
                                                        },
                                                        "type": "array"
                                                    },
                                                    "first_seen": {
                                                        "type": "string"
                                                    },
                                                    "id": {
                                                        "type": "string"
                                                    },
                                                    "is_exclusive": {
                                                        "type": "boolean"
                                                    },
                                                    "is_publishable": {
                                                        "type": "boolean"
                                                    },
                                                    "last_seen": {
                                                        "type": "string"
                                                    },
                                                    "last_updated": {
                                                        "type": "string"
                                                    },
                                                    "misp": {
                                                        "properties": {
                                                            "akamai": {
                                                                "type": "boolean"
                                                            },
                                                            "alexa": {
                                                                "type": "boolean"
                                                            },
                                                            "alexa_1M": {
                                                                "type": "boolean"
                                                            },
                                                            "amazon-aws": {
                                                                "type": "boolean"
                                                            },
                                                            "apple": {
                                                                "type": "boolean"
                                                            },
                                                            "automated-malware-analysis": {
                                                                "type": "boolean"
                                                            },
                                                            "bank-website": {
                                                                "type": "boolean"
                                                            },
                                                            "cisco_1M": {
                                                                "type": "boolean"
                                                            },
                                                            "cisco_top1000": {
                                                                "type": "boolean"
                                                            },
                                                            "cisco_top10k": {
                                                                "type": "boolean"
                                                            },
                                                            "cisco_top20k": {
                                                                "type": "boolean"
                                                            },
                                                            "cisco_top5k": {
                                                                "type": "boolean"
                                                            },
                                                            "cloudflare": {
                                                                "type": "boolean"
                                                            },
                                                            "common-contact-emails": {
                                                                "type": "boolean"
                                                            },
                                                            "common-ioc-false-positive": {
                                                                "type": "boolean"
                                                            },
                                                            "covid": {
                                                                "type": "boolean"
                                                            },
                                                            "covid-19-cyber-threat-coalition-whitelist": {
                                                                "type": "boolean"
                                                            },
                                                            "covid-19-krassi-whitelist": {
                                                                "type": "boolean"
                                                            },
                                                            "crl-hostname": {
                                                                "type": "boolean"
                                                            },
                                                            "crl-ip": {
                                                                "type": "boolean"
                                                            },
                                                            "dax30": {
                                                                "type": "boolean"
                                                            },
                                                            "disposable-email": {
                                                                "type": "boolean"
                                                            },
                                                            "dynamic-dns": {
                                                                "type": "boolean"
                                                            },
                                                            "eicar.com": {
                                                                "type": "boolean"
                                                            },
                                                            "empty-hashes": {
                                                                "type": "boolean"
                                                            },
                                                            "fastly": {
                                                                "type": "boolean"
                                                            },
                                                            "google": {
                                                                "type": "boolean"
                                                            },
                                                            "google-gcp": {
                                                                "type": "boolean"
                                                            },
                                                            "google-gmail-sending-ips": {
                                                                "type": "boolean"
                                                            },
                                                            "googlebot": {
                                                                "type": "boolean"
                                                            },
                                                            "ipv6-linklocal": {
                                                                "type": "boolean"
                                                            },
                                                            "majestic_million": {
                                                                "type": "boolean"
                                                            },
                                                            "majestic_million_1M": {
                                                                "type": "boolean"
                                                            },
                                                            "microsoft": {
                                                                "type": "boolean"
                                                            },
                                                            "microsoft-attack-simulator": {
                                                                "type": "boolean"
                                                            },
                                                            "microsoft-azure": {
                                                                "type": "boolean"
                                                            },
                                                            "microsoft-azure-china": {
                                                                "type": "boolean"
                                                            },
                                                            "microsoft-azure-germany": {
                                                                "type": "boolean"
                                                            },
                                                            "microsoft-azure-us-gov": {
                                                                "type": "boolean"
                                                            },
                                                            "microsoft-office365": {
                                                                "type": "boolean"
                                                            },
                                                            "microsoft-office365-cn": {
                                                                "type": "boolean"
                                                            },
                                                            "microsoft-office365-ip": {
                                                                "type": "boolean"
                                                            },
                                                            "microsoft-win10-connection-endpoints": {
                                                                "type": "boolean"
                                                            },
                                                            "moz-top500": {
                                                                "type": "boolean"
                                                            },
                                                            "mozilla-CA": {
                                                                "type": "boolean"
                                                            },
                                                            "mozilla-IntermediateCA": {
                                                                "type": "boolean"
                                                            },
                                                            "multicast": {
                                                                "type": "boolean"
                                                            },
                                                            "nioc-filehash": {
                                                                "type": "boolean"
                                                            },
                                                            "ovh-cluster": {
                                                                "type": "boolean"
                                                            },
                                                            "phone_numbers": {
                                                                "type": "boolean"
                                                            },
                                                            "public-dns-hostname": {
                                                                "type": "boolean"
                                                            },
                                                            "public-dns-v4": {
                                                                "type": "boolean"
                                                            },
                                                            "public-dns-v6": {
                                                                "type": "boolean"
                                                            },
                                                            "rfc1918": {
                                                                "type": "boolean"
                                                            },
                                                            "rfc3849": {
                                                                "type": "boolean"
                                                            },
                                                            "rfc5735": {
                                                                "type": "boolean"
                                                            },
                                                            "rfc6598": {
                                                                "type": "boolean"
                                                            },
                                                            "rfc6761": {
                                                                "type": "boolean"
                                                            },
                                                            "second-level-tlds": {
                                                                "type": "boolean"
                                                            },
                                                            "security-provider-blogpost": {
                                                                "type": "boolean"
                                                            },
                                                            "sinkholes": {
                                                                "type": "boolean"
                                                            },
                                                            "smtp-receiving-ips": {
                                                                "type": "boolean"
                                                            },
                                                            "smtp-sending-ips": {
                                                                "type": "boolean"
                                                            },
                                                            "stackpath": {
                                                                "type": "boolean"
                                                            },
                                                            "ti-falsepositives": {
                                                                "type": "boolean"
                                                            },
                                                            "tlds": {
                                                                "type": "boolean"
                                                            },
                                                            "tranco": {
                                                                "type": "boolean"
                                                            },
                                                            "tranco10k": {
                                                                "type": "boolean"
                                                            },
                                                            "university_domains": {
                                                                "type": "boolean"
                                                            },
                                                            "url-shortener": {
                                                                "type": "boolean"
                                                            },
                                                            "vpn-ipv4": {
                                                                "type": "boolean"
                                                            },
                                                            "vpn-ipv6": {
                                                                "type": "boolean"
                                                            },
                                                            "whats-my-ip": {
                                                                "type": "boolean"
                                                            },
                                                            "wikimedia": {
                                                                "type": "boolean"
                                                            }
                                                        },
                                                        "type": "object"
                                                    },
                                                    "mscore": {
                                                        "type": "integer"
                                                    },
                                                    "sources": {
                                                        "items": {
                                                            "properties": {
                                                                "category": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "first_seen": {
                                                                    "type": "string"
                                                                },
                                                                "last_seen": {
                                                                    "type": "string"
                                                                },
                                                                "osint": {
                                                                    "type": "boolean"
                                                                },
                                                                "source_name": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "required": [
                                                                "first_seen",
                                                                "last_seen",
                                                                "osint",
                                                                "category",
                                                                "source_name"
                                                            ],
                                                            "type": "object"
                                                        },
                                                        "type": "array"
                                                    },
                                                    "type": {
                                                        "type": "string"
                                                    },
                                                    "value": {
                                                        "type": "string"
                                                    }
                                                },
                                                "required": [
                                                    "first_seen",
                                                    "last_seen",
                                                    "sources",
                                                    "mscore",
                                                    "misp",
                                                    "id",
                                                    "type",
                                                    "value",
                                                    "is_publishable",
                                                    "last_updated"
                                                ],
                                                "type": "object"
                                            },
                                            "type": "array"
                                        },
                                        "next": {
                                            "type": "string"
                                        }
                                    },
                                    "type": "object"
                                }
                            },
                            "runAfter": {
                                "HTTP_Get_Indicators": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ParseJson"
                        },
                        "Parse_Initial_Bearer_Token": {
                            "inputs": {
                                "content": "@body('HTTP_Get_Initial_Token')",
                                "schema": {
                                    "properties": {
                                        "access_token": {
                                            "type": "string"
                                        },
                                        "expires_in": {
                                            "type": "integer"
                                        },
                                        "token_type": {
                                            "type": "string"
                                        }
                                    },
                                    "type": "object"
                                }
                            },
                            "runAfter": {
                                "HTTP_Get_Initial_Token": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ParseJson"
                        },
                        "Retrieve_API_Secret_Key": {
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "/secrets/@{encodeURIComponent(parameters('Secret Key Name'))}/value"
                            },
                            "runAfter": {},
                            "type": "ApiConnection"
                        },
                        "Set_lastRuntime_from_Blob": {
                            "inputs": {
                                "name": "TMP_lastRuntime",
                                "value": "@int(body('Get_Last_Runtime'))"
                            },
                            "runAfter": {
                                "Get_Last_Runtime": [
                                    "Succeeded"
                                ]
                            },
                            "type": "SetVariable"
                        },
                        "Timestamp_to_Epoch": {
                            "inputs": "@div(sub(outputs('UTCNow_in_Ticks'), outputs('1970Timestamp_in_Ticks')), 10000000)",
                            "runAfter": {
                                "1970Timestamp_in_Ticks": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Compose"
                        },
                        "UTCNow_in_Ticks": {
                            "inputs": "@ticks(addDays(utcNow(), parameters('Lookback Days')))",
                            "runAfter": {
                                "Retrieve_API_Secret_Key": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Compose"
                        },
                        "Until_the_current_page_is_empty": {
                            "actions": {
                                "For_each_indicator": {
                                    "actions": {
                                        "Condition": {
                                            "actions": {
                                                "Set_TMP_severity_0": {
                                                    "inputs": {
                                                        "name": "TMP_severity",
                                                        "value": 0
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "less": [
                                                            "@body('Parse_Indicator')?['mscore']",
                                                            40
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "KillChain_Exfil_Location": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Condition_Severity_1": {
                                            "actions": {
                                                "Set_TMP_severity_1": {
                                                    "inputs": {
                                                        "name": "TMP_severity",
                                                        "value": 1
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "greaterOrEquals": [
                                                            "@body('Parse_Indicator')?['mscore']",
                                                            40
                                                        ]
                                                    },
                                                    {
                                                        "less": [
                                                            "@body('Parse_Indicator')?['mscore']",
                                                            60
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Condition": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Condition_Severity_2": {
                                            "actions": {
                                                "Set_TMP_severity_2": {
                                                    "inputs": {
                                                        "name": "TMP_severity",
                                                        "value": 2
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "greaterOrEquals": [
                                                            "@body('Parse_Indicator')?['mscore']",
                                                            60
                                                        ]
                                                    },
                                                    {
                                                        "less": [
                                                            "@body('Parse_Indicator')?['mscore']",
                                                            80
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Condition_Severity_1": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Condition_Severity_3": {
                                            "actions": {
                                                "Set_TMP_severity_3": {
                                                    "inputs": {
                                                        "name": "TMP_severity",
                                                        "value": 3
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "lessOrEquals": [
                                                            "@body('Parse_Indicator')?['mscore']",
                                                            100
                                                        ]
                                                    },
                                                    {
                                                        "greaterOrEquals": [
                                                            "@body('Parse_Indicator')?['mscore']",
                                                            80
                                                        ]
                                                    },
                                                    {
                                                        "not": {
                                                            "equals": [
                                                                "@body('Parse_Indicator')?['attributed_associations']",
                                                                ""
                                                            ]
                                                        }
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Condition_Severity_2": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Condition_Severity_4": {
                                            "actions": {
                                                "Set_TMP_severity_4": {
                                                    "inputs": {
                                                        "name": "TMP_severity",
                                                        "value": 4
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "less": [
                                                            "@body('Parse_Indicator')?['mscore']",
                                                            100
                                                        ]
                                                    },
                                                    {
                                                        "greaterOrEquals": [
                                                            "@body('Parse_Indicator')?['mscore']",
                                                            80
                                                        ]
                                                    },
                                                    {
                                                        "not": {
                                                            "equals": [
                                                                "@body('Parse_Indicator')?['attributed_associations']",
                                                                ""
                                                            ]
                                                        }
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Condition_Severity_3": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Condition_Severity_5": {
                                            "actions": {
                                                "Set_TMP_severity_5": {
                                                    "inputs": {
                                                        "name": "TMP_severity",
                                                        "value": 5
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@body('Parse_Indicator')?['mscore']",
                                                            100
                                                        ]
                                                    },
                                                    {
                                                        "not": {
                                                            "equals": [
                                                                "@body('Parse_Indicator')?['attributed_associations']",
                                                                ""
                                                            ]
                                                        }
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Condition_Severity_4": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Erase_TMP_TAGS": {
                                            "inputs": {
                                                "name": "TMP_TAGS",
                                                "value": []
                                            },
                                            "runAfter": {
                                                "Unset_threatType": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable"
                                        },
                                        "Erase_TMP_selectedHash": {
                                            "inputs": {
                                                "name": "TMP_selectedHash",
                                                "value": "unset"
                                            },
                                            "runAfter": {
                                                "Erase_TMP_TAGS": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable"
                                        },
                                        "For_each_source": {
                                            "actions": {
                                                "For_each_category": {
                                                    "actions": {
                                                        "If_tag_is_not_already_in_TMP_TAGS": {
                                                            "actions": {
                                                                "Add_category_to_tags": {
                                                                    "inputs": {
                                                                        "name": "TMP_TAGS",
                                                                        "value": "@items('For_each_category')"
                                                                    },
                                                                    "runAfter": {},
                                                                    "type": "AppendToArrayVariable"
                                                                }
                                                            },
                                                            "expression": {
                                                                "and": [
                                                                    {
                                                                        "not": {
                                                                            "contains": [
                                                                                "@variables('TMP_TAGS')",
                                                                                "@items('For_each_category')"
                                                                            ]
                                                                        }
                                                                    }
                                                                ]
                                                            },
                                                            "runAfter": {},
                                                            "type": "If"
                                                        }
                                                    },
                                                    "foreach": "@items('For_each_source')?['category']",
                                                    "runAfter": {},
                                                    "type": "Foreach"
                                                }
                                            },
                                            "foreach": "@body('Parse_Indicator')?['sources']",
                                            "runAfter": {
                                                "If_Attributed_Associations_Is_Null": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Foreach"
                                        },
                                        "Get_Threat_Indicators": {
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['microsoftgraphsecurity']['connectionId']"
                                                    }
                                                },
                                                "method": "get",
                                                "path": "/beta/security/tiIndicators",
                                                "queries": {
                                                    "$count": "true",
                                                    "$filter": "externalId eq '@{concat('https://advantage.mandiant.com/indicator/', body('Parse_Indicator')?['id'])}'"
                                                }
                                            },
                                            "runAfter": {
                                                "Parse_Indicator": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection"
                                        },
                                        "If_Attributed_Associations_Is_Null": {
                                            "actions": {
                                                "Reset_associatedActors": {
                                                    "inputs": {
                                                        "name": "TMP_associatedActors",
                                                        "value": []
                                                    },
                                                    "runAfter": {
                                                        "Reset_malwareFamilies": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable"
                                                },
                                                "Reset_malwareFamilies": {
                                                    "inputs": {
                                                        "name": "TMP_malwareFamilies",
                                                        "value": []
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "else": {
                                                "actions": {
                                                    "For_each_attributed_association": {
                                                        "actions": {
                                                            "Parse_association": {
                                                                "inputs": {
                                                                    "content": "@item()",
                                                                    "schema": {
                                                                        "properties": {
                                                                            "id": {
                                                                                "type": "string"
                                                                            },
                                                                            "name": {
                                                                                "type": "string"
                                                                            },
                                                                            "type": {
                                                                                "type": "string"
                                                                            }
                                                                        },
                                                                        "type": "object"
                                                                    }
                                                                },
                                                                "runAfter": {},
                                                                "type": "ParseJson"
                                                            },
                                                            "Switch_association_type": {
                                                                "cases": {
                                                                    "Case_malware": {
                                                                        "actions": {
                                                                            "Append_to_malwareFamilies": {
                                                                                "inputs": {
                                                                                    "name": "TMP_malwareFamilies",
                                                                                    "value": "@body('Parse_association')?['name']"
                                                                                },
                                                                                "runAfter": {},
                                                                                "type": "AppendToArrayVariable"
                                                                            }
                                                                        },
                                                                        "case": "malware"
                                                                    },
                                                                    "Case_threat-actor": {
                                                                        "actions": {
                                                                            "Append_to_associatedActors": {
                                                                                "inputs": {
                                                                                    "name": "TMP_associatedActors",
                                                                                    "value": "@body('Parse_association')?['name']"
                                                                                },
                                                                                "runAfter": {},
                                                                                "type": "AppendToArrayVariable"
                                                                            }
                                                                        },
                                                                        "case": "threat-actor"
                                                                    }
                                                                },
                                                                "default": {
                                                                    "actions": {}
                                                                },
                                                                "expression": "@body('Parse_association')?['type']",
                                                                "runAfter": {
                                                                    "Parse_association": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Switch"
                                                            }
                                                        },
                                                        "foreach": "@body('Parse_Indicator')?['attributed_associations']",
                                                        "runAfter": {},
                                                        "type": "Foreach"
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@body('Parse_Indicator')?['attributed_associations']",
                                                            "@null"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Erase_TMP_selectedHash": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "If_botnet": {
                                            "actions": {
                                                "Set_variable": {
                                                    "inputs": {
                                                        "name": "TMP_threatType",
                                                        "value": "Botnet"
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "or": [
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "botnet"
                                                        ]
                                                    },
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "spambot"
                                                        ]
                                                    },
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "bot"
                                                        ]
                                                    },
                                                    {
                                                        "equals": [
                                                            "@variables('TMP_threatType')",
                                                            "unset"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "If_spyware": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "If_control-server": {
                                            "actions": {
                                                "Set_threatType_C2": {
                                                    "inputs": {
                                                        "name": "TMP_threatType",
                                                        "value": "C2"
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "control-server"
                                                        ]
                                                    },
                                                    {
                                                        "equals": [
                                                            "@variables('TMP_threatType')",
                                                            "unset"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Condition_Severity_5": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "If_indicator_exists": {
                                            "actions": {
                                                "For_each_found_indicator": {
                                                    "actions": {
                                                        "Update_tiIndicator": {
                                                            "inputs": {
                                                                "body": {
                                                                    "activityGroupNames": "@variables('TMP_associatedActors')",
                                                                    "confidence": "@body('Parse_Indicator')?['mscore']",
                                                                    "expirationDateTime": "@{addDays(utcNow(), parameters('Expiration Days'))}",
                                                                    "killChain": "@union(variables('TMP_killChain'),variables('TMP_killChain'))",
                                                                    "lastReportedDateTime": "@body('Parse_Indicator')?['last_seen']",
                                                                    "malwareFamilyNames": "@variables('TMP_malwareFamilies')",
                                                                    "severity": "@variables('TMP_severity')",
                                                                    "tags": "@union(variables('TMP_TAGS'),variables('TMP_TAGS'))",
                                                                    "targetProduct": "@parameters('Target Product')"
                                                                },
                                                                "host": {
                                                                    "connection": {
                                                                        "name": "@parameters('$connections')['microsoftgraphsecurity']['connectionId']"
                                                                    }
                                                                },
                                                                "method": "patch",
                                                                "path": "/beta/security/tiIndicators/@{encodeURIComponent(items('For_each_found_indicator')?['id'])}"
                                                            },
                                                            "runAfter": {},
                                                            "type": "ApiConnection"
                                                        }
                                                    },
                                                    "foreach": "@body('Get_Threat_Indicators')?['value']",
                                                    "runAfter": {},
                                                    "type": "Foreach"
                                                }
                                            },
                                            "else": {
                                                "actions": {
                                                    "If_categorized_or_ingest_uncategorized": {
                                                        "actions": {
                                                            "Hash_Selection": {
                                                                "actions": {
                                                                    "If_Associated_Hashes_Is_Empty": {
                                                                        "actions": {
                                                                            "For_each_associated_hash": {
                                                                                "actions": {
                                                                                    "If_hash_is_the_selected_type": {
                                                                                        "actions": {
                                                                                            "Set_TMP_selectedHash": {
                                                                                                "inputs": {
                                                                                                    "name": "TMP_selectedHash",
                                                                                                    "value": "@items('For_each_associated_hash')?['value']"
                                                                                                },
                                                                                                "runAfter": {},
                                                                                                "type": "SetVariable"
                                                                                            }
                                                                                        },
                                                                                        "expression": {
                                                                                            "and": [
                                                                                                {
                                                                                                    "equals": [
                                                                                                        "@parameters('Hash Type')",
                                                                                                        "@items('For_each_associated_hash')?['type']"
                                                                                                    ]
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        "runAfter": {},
                                                                                        "type": "If"
                                                                                    }
                                                                                },
                                                                                "foreach": "@body('Parse_Indicator')?['associated_hashes']",
                                                                                "runAfter": {},
                                                                                "type": "Foreach"
                                                                            }
                                                                        },
                                                                        "expression": {
                                                                            "and": [
                                                                                {
                                                                                    "not": {
                                                                                        "equals": [
                                                                                            "@body('Parse_Indicator')?['associated_hashes']",
                                                                                            "@null"
                                                                                        ]
                                                                                    }
                                                                                }
                                                                            ]
                                                                        },
                                                                        "runAfter": {},
                                                                        "type": "If"
                                                                    },
                                                                    "If_Hash_Type_is_MD5": {
                                                                        "actions": {
                                                                            "Set_MD5_Fallback_Value": {
                                                                                "inputs": {
                                                                                    "name": "TMP_selectedHash",
                                                                                    "value": "@body('Parse_Indicator')?['value']"
                                                                                },
                                                                                "runAfter": {},
                                                                                "type": "SetVariable"
                                                                            }
                                                                        },
                                                                        "expression": {
                                                                            "and": [
                                                                                {
                                                                                    "equals": [
                                                                                        "@parameters('Hash Type')",
                                                                                        "md5"
                                                                                    ]
                                                                                }
                                                                            ]
                                                                        },
                                                                        "runAfter": {
                                                                            "If_Associated_Hashes_Is_Empty": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "If"
                                                                    }
                                                                },
                                                                "expression": {
                                                                    "and": [
                                                                        {
                                                                            "equals": [
                                                                                "@body('Parse_Indicator')?['type']",
                                                                                "md5"
                                                                            ]
                                                                        }
                                                                    ]
                                                                },
                                                                "runAfter": {},
                                                                "type": "If"
                                                            },
                                                            "Switch_Indicator_Type": {
                                                                "cases": {
                                                                    "ipv4": {
                                                                        "actions": {
                                                                            "If_ingest_IPv4": {
                                                                                "actions": {
                                                                                    "Create_IPv4_Indicator": {
                                                                                        "inputs": {
                                                                                            "body": {
                                                                                                "action": "@parameters('Default Indicator Action')",
                                                                                                "activityGroupNames": "@variables('TMP_associatedActors')",
                                                                                                "confidence": "@body('Parse_Indicator')?['mscore']",
                                                                                                "description": "@{concat('Mandiant Indicator: ', body('Parse_Indicator')?['type'], ' ', body('Parse_Indicator')?['value'])}",
                                                                                                "diamondModel": "infrastructure",
                                                                                                "expirationDateTime": "@{addDays(utcNow(), parameters('Expiration Days'))}",
                                                                                                "externalId": "@{concat('https://advantage.mandiant.com/indicator/',body('Parse_Indicator')?['id'])}",
                                                                                                "killChain": "@union(variables('TMP_killChain'),variables('TMP_killChain'))",
                                                                                                "lastReportedDateTime": "@body('Parse_Indicator')?['last_seen']",
                                                                                                "malwareFamilyNames": "@variables('TMP_malwareFamilies')",
                                                                                                "networkIPv4": "@body('Parse_Indicator')?['value']",
                                                                                                "passiveOnly": "@parameters('Passive Only')",
                                                                                                "severity": "@variables('TMP_severity')",
                                                                                                "tags": "@variables('TMP_TAGS')",
                                                                                                "targetProduct": "@parameters('Target Product')",
                                                                                                "threatType": "@variables('TMP_threatType')",
                                                                                                "tlpLevel": "unknown"
                                                                                            },
                                                                                            "host": {
                                                                                                "connection": {
                                                                                                    "name": "@parameters('$connections')['microsoftgraphsecurity']['connectionId']"
                                                                                                }
                                                                                            },
                                                                                            "method": "post",
                                                                                            "path": "/beta/security/tiIndicators"
                                                                                        },
                                                                                        "runAfter": {
                                                                                            "Set_diamondModel_ipv4": [
                                                                                                "Succeeded"
                                                                                            ]
                                                                                        },
                                                                                        "type": "ApiConnection"
                                                                                    },
                                                                                    "Set_diamondModel_ipv4": {
                                                                                        "inputs": {
                                                                                            "name": "TMP_diamondModel",
                                                                                            "value": "infrastructure"
                                                                                        },
                                                                                        "runAfter": {},
                                                                                        "type": "SetVariable"
                                                                                    }
                                                                                },
                                                                                "expression": {
                                                                                    "and": [
                                                                                        {
                                                                                            "equals": [
                                                                                                "@parameters('Ingest IPv4')",
                                                                                                true
                                                                                            ]
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                "runAfter": {},
                                                                                "type": "If"
                                                                            }
                                                                        },
                                                                        "case": "ipv4"
                                                                    },
                                                                    "md5": {
                                                                        "actions": {
                                                                            "If_ingest_file_hash": {
                                                                                "actions": {
                                                                                    "Create_MD5_Indicator": {
                                                                                        "inputs": {
                                                                                            "body": {
                                                                                                "action": "@parameters('Default Indicator Action')",
                                                                                                "activityGroupNames": "@variables('TMP_associatedActors')",
                                                                                                "confidence": "@body('Parse_Indicator')?['mscore']",
                                                                                                "description": "@{concat('Mandiant Indicator: ', parameters('Hash Type'), ' ', body('Parse_Indicator')?['value'])}",
                                                                                                "diamondModel": "infrastructure",
                                                                                                "expirationDateTime": "@{addDays(utcNow(), parameters('Expiration Days'))}",
                                                                                                "externalId": "@{concat('https://advantage.mandiant.com/indicator/',body('Parse_Indicator')?['id'])}",
                                                                                                "fileHashType": "@parameters('Hash Type')",
                                                                                                "fileHashValue": "@variables('TMP_selectedHash')",
                                                                                                "killChain": "@union(variables('TMP_killChain'),variables('TMP_killChain'))",
                                                                                                "lastReportedDateTime": "@body('Parse_Indicator')?['last_seen']",
                                                                                                "malwareFamilyNames": "@variables('TMP_malwareFamilies')",
                                                                                                "passiveOnly": "@parameters('Passive Only')",
                                                                                                "severity": "@variables('TMP_severity')",
                                                                                                "tags": "@variables('TMP_TAGS')",
                                                                                                "targetProduct": "@parameters('Target Product')",
                                                                                                "threatType": "@variables('TMP_threatType')",
                                                                                                "tlpLevel": "unknown"
                                                                                            },
                                                                                            "host": {
                                                                                                "connection": {
                                                                                                    "name": "@parameters('$connections')['microsoftgraphsecurity']['connectionId']"
                                                                                                }
                                                                                            },
                                                                                            "method": "post",
                                                                                            "path": "/beta/security/tiIndicators"
                                                                                        },
                                                                                        "runAfter": {
                                                                                            "Set_diamondModel_md5": [
                                                                                                "Succeeded"
                                                                                            ]
                                                                                        },
                                                                                        "type": "ApiConnection"
                                                                                    },
                                                                                    "Set_diamondModel_md5": {
                                                                                        "inputs": {
                                                                                            "name": "TMP_diamondModel",
                                                                                            "value": "capability"
                                                                                        },
                                                                                        "runAfter": {},
                                                                                        "type": "SetVariable"
                                                                                    }
                                                                                },
                                                                                "expression": {
                                                                                    "and": [
                                                                                        {
                                                                                            "equals": [
                                                                                                "@parameters('Ingest Hash')",
                                                                                                true
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "not": {
                                                                                                "equals": [
                                                                                                    "@variables('TMP_selectedHash')",
                                                                                                    "unset"
                                                                                                ]
                                                                                            }
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                "runAfter": {},
                                                                                "type": "If"
                                                                            }
                                                                        },
                                                                        "case": "md5"
                                                                    },
                                                                    "fqdn": {
                                                                        "actions": {
                                                                            "If_ingest_FQDN": {
                                                                                "actions": {
                                                                                    "Create_FQDN_Indicator": {
                                                                                        "inputs": {
                                                                                            "body": {
                                                                                                "action": "@parameters('Default Indicator Action')",
                                                                                                "activityGroupNames": "@variables('TMP_associatedActors')",
                                                                                                "confidence": "@body('Parse_Indicator')?['mscore']",
                                                                                                "description": "@{concat('Mandiant Indicator: ', body('Parse_Indicator')?['type'], ' ', body('Parse_Indicator')?['value'])}",
                                                                                                "diamondModel": "infrastructure",
                                                                                                "domainName": "@body('Parse_Indicator')?['value']",
                                                                                                "expirationDateTime": "@{addDays(utcNow(), parameters('Expiration Days'))\n}",
                                                                                                "externalId": "@{concat('https://advantage.mandiant.com/indicator/',body('Parse_Indicator')?['id'])}",
                                                                                                "killChain": "@union(variables('TMP_killChain'),variables('TMP_killChain'))",
                                                                                                "lastReportedDateTime": "@body('Parse_Indicator')?['last_seen']",
                                                                                                "malwareFamilyNames": "@variables('TMP_malwareFamilies')",
                                                                                                "passiveOnly": "@parameters('Passive Only')",
                                                                                                "severity": "@variables('TMP_severity')",
                                                                                                "tags": "@variables('TMP_TAGS')",
                                                                                                "targetProduct": "@parameters('Target Product')",
                                                                                                "threatType": "@variables('TMP_threatType')",
                                                                                                "tlpLevel": "unknown"
                                                                                            },
                                                                                            "host": {
                                                                                                "connection": {
                                                                                                    "name": "@parameters('$connections')['microsoftgraphsecurity']['connectionId']"
                                                                                                }
                                                                                            },
                                                                                            "method": "post",
                                                                                            "path": "/beta/security/tiIndicators"
                                                                                        },
                                                                                        "runAfter": {
                                                                                            "Set_diamondModel_fqdn": [
                                                                                                "Succeeded"
                                                                                            ]
                                                                                        },
                                                                                        "type": "ApiConnection"
                                                                                    },
                                                                                    "Set_diamondModel_fqdn": {
                                                                                        "inputs": {
                                                                                            "name": "TMP_diamondModel",
                                                                                            "value": "infrastructure"
                                                                                        },
                                                                                        "runAfter": {},
                                                                                        "type": "SetVariable"
                                                                                    }
                                                                                },
                                                                                "expression": {
                                                                                    "and": [
                                                                                        {
                                                                                            "equals": [
                                                                                                "@parameters('Ingest FQDN')",
                                                                                                true
                                                                                            ]
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                "runAfter": {},
                                                                                "type": "If"
                                                                            }
                                                                        },
                                                                        "case": "fqdn"
                                                                    },
                                                                    "url": {
                                                                        "actions": {
                                                                            "If_ingest_URL": {
                                                                                "actions": {
                                                                                    "Create_URL_Indicator": {
                                                                                        "inputs": {
                                                                                            "body": {
                                                                                                "action": "@parameters('Default Indicator Action')",
                                                                                                "activityGroupNames": "@variables('TMP_associatedActors')",
                                                                                                "confidence": "@body('Parse_Indicator')?['mscore']",
                                                                                                "description": "@{concat('Mandiant Indicator: ', body('Parse_Indicator')?['type'], ' ', body('Parse_Indicator')?['value'])}",
                                                                                                "diamondModel": "infrastructure",
                                                                                                "expirationDateTime": "@{addDays(utcNow(), parameters('Expiration Days'))\n}",
                                                                                                "externalId": "@{concat('https://advantage.mandiant.com/indicator/',body('Parse_Indicator')?['id'])}",
                                                                                                "killChain": "@union(variables('TMP_killChain'),variables('TMP_killChain'))",
                                                                                                "lastReportedDateTime": "@body('Parse_Indicator')?['last_seen']",
                                                                                                "malwareFamilyNames": "@variables('TMP_malwareFamilies')",
                                                                                                "passiveOnly": "@parameters('Passive Only')",
                                                                                                "severity": "@variables('TMP_severity')",
                                                                                                "tags": "@variables('TMP_TAGS')",
                                                                                                "targetProduct": "@parameters('Target Product')",
                                                                                                "threatType": "@variables('TMP_threatType')",
                                                                                                "tlpLevel": "unknown",
                                                                                                "url": "@body('Parse_Indicator')?['value']"
                                                                                            },
                                                                                            "host": {
                                                                                                "connection": {
                                                                                                    "name": "@parameters('$connections')['microsoftgraphsecurity']['connectionId']"
                                                                                                }
                                                                                            },
                                                                                            "method": "post",
                                                                                            "path": "/beta/security/tiIndicators"
                                                                                        },
                                                                                        "runAfter": {
                                                                                            "Set_diamondModel_url": [
                                                                                                "Succeeded"
                                                                                            ]
                                                                                        },
                                                                                        "type": "ApiConnection"
                                                                                    },
                                                                                    "Set_diamondModel_url": {
                                                                                        "inputs": {
                                                                                            "name": "TMP_diamondModel",
                                                                                            "value": "infrastructure"
                                                                                        },
                                                                                        "runAfter": {},
                                                                                        "type": "SetVariable"
                                                                                    }
                                                                                },
                                                                                "expression": {
                                                                                    "and": [
                                                                                        {
                                                                                            "equals": [
                                                                                                "@parameters('Ingest URL')",
                                                                                                true
                                                                                            ]
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                "runAfter": {},
                                                                                "type": "If"
                                                                            }
                                                                        },
                                                                        "case": "url"
                                                                    }
                                                                },
                                                                "default": {
                                                                    "actions": {
                                                                        "Set_diamondModel_unknown": {
                                                                            "inputs": {
                                                                                "name": "TMP_diamondModel",
                                                                                "value": "unknown"
                                                                            },
                                                                            "runAfter": {},
                                                                            "type": "SetVariable"
                                                                        }
                                                                    }
                                                                },
                                                                "expression": "@body('Parse_Indicator')?['type']",
                                                                "runAfter": {
                                                                    "Hash_Selection": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Switch"
                                                            }
                                                        },
                                                        "expression": {
                                                            "or": [
                                                                {
                                                                    "equals": [
                                                                        "@parameters('Ingest Uncategorized')",
                                                                        true
                                                                    ]
                                                                },
                                                                {
                                                                    "greater": [
                                                                        "@length(variables('TMP_TAGS'))",
                                                                        0
                                                                    ]
                                                                }
                                                            ]
                                                        },
                                                        "runAfter": {},
                                                        "type": "If"
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@body('Get_Threat_Indicators')?['@odata.count']",
                                                            1
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "If_threatType_still_unknown": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "If_malware": {
                                            "actions": {
                                                "Set_threatType_Malware": {
                                                    "inputs": {
                                                        "name": "TMP_threatType",
                                                        "value": "Malware"
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "malware"
                                                        ]
                                                    },
                                                    {
                                                        "equals": [
                                                            "@variables('TMP_threatType')",
                                                            "unset"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "If_control-server": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "If_phishing": {
                                            "actions": {
                                                "Set_threatType_Phishing": {
                                                    "inputs": {
                                                        "name": "TMP_threatType",
                                                        "value": "Phishing"
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "phishing"
                                                        ]
                                                    },
                                                    {
                                                        "equals": [
                                                            "@variables('TMP_threatType')",
                                                            "unset"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "If_malware": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "If_proxy": {
                                            "actions": {
                                                "Set_threatType_Proxy": {
                                                    "inputs": {
                                                        "name": "TMP_threatType",
                                                        "value": "Proxy"
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "proxy"
                                                        ]
                                                    },
                                                    {
                                                        "equals": [
                                                            "@variables('TMP_threatType')",
                                                            "unset"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "If_phishing": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "If_spyware": {
                                            "actions": {
                                                "Set_threatType_PUA": {
                                                    "inputs": {
                                                        "name": "TMP_threatType",
                                                        "value": "PUA"
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "or": [
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "spyware"
                                                        ]
                                                    },
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "infostealer"
                                                        ]
                                                    },
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "loader"
                                                        ]
                                                    },
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "downloader"
                                                        ]
                                                    },
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "ransomware"
                                                        ]
                                                    },
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "dropper"
                                                        ]
                                                    },
                                                    {
                                                        "equals": [
                                                            "@variables('TMP_threatType')",
                                                            "unset"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "If_proxy": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "If_threatType_still_unknown": {
                                            "actions": {
                                                "Set_threatType_WatchList": {
                                                    "inputs": {
                                                        "name": "TMP_threatType",
                                                        "value": "WatchList"
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@variables('TMP_threatType')",
                                                            "unset"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "If_type_is_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "If_type_is_URL": {
                                            "actions": {
                                                "Set_threatType_MaliciousUrl": {
                                                    "inputs": {
                                                        "name": "TMP_threatType",
                                                        "value": "MaliciousUrl"
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@body('Parse_Indicator')?['type']",
                                                            "url"
                                                        ]
                                                    },
                                                    {
                                                        "equals": [
                                                            "@variables('TMP_threatType')",
                                                            "unset"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "If_botnet": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "KillChain_Control_Server": {
                                            "actions": {
                                                "Append_to_array_variable": {
                                                    "inputs": {
                                                        "name": "TMP_killChain",
                                                        "value": "C2"
                                                    },
                                                    "runAfter": {},
                                                    "type": "AppendToArrayVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "control-server"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "For_each_source": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "KillChain_Download_Location": {
                                            "actions": {
                                                "Append_to_array_variable_5": {
                                                    "inputs": {
                                                        "name": "TMP_killChain",
                                                        "value": "Delivery"
                                                    },
                                                    "runAfter": {},
                                                    "type": "AppendToArrayVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "download-location"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "KillChain_I-E-D": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "KillChain_Exfil_Location": {
                                            "actions": {
                                                "Append_to_array_variable_7": {
                                                    "inputs": {
                                                        "name": "TMP_killChain",
                                                        "value": "Actions"
                                                    },
                                                    "runAfter": {},
                                                    "type": "AppendToArrayVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "exfil_location"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "KillChain_Phishing": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "KillChain_I-E-D": {
                                            "actions": {
                                                "Append_to_array_variable_2": {
                                                    "inputs": {
                                                        "name": "TMP_killChain",
                                                        "value": "Installation"
                                                    },
                                                    "runAfter": {},
                                                    "type": "AppendToArrayVariable"
                                                },
                                                "Append_to_array_variable_3": {
                                                    "inputs": {
                                                        "name": "TMP_killChain",
                                                        "value": "Exploitation"
                                                    },
                                                    "runAfter": {
                                                        "Append_to_array_variable_2": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "AppendToArrayVariable"
                                                },
                                                "Append_to_array_variable_4": {
                                                    "inputs": {
                                                        "name": "TMP_killChain",
                                                        "value": "Delivery"
                                                    },
                                                    "runAfter": {
                                                        "Append_to_array_variable_3": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "AppendToArrayVariable"
                                                }
                                            },
                                            "expression": {
                                                "or": [
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "loader"
                                                        ]
                                                    },
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "exploit"
                                                        ]
                                                    },
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "downloader"
                                                        ]
                                                    },
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "dropper"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "KillChain_Control_Server": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "KillChain_Phishing": {
                                            "actions": {
                                                "Append_to_array_variable_6": {
                                                    "inputs": {
                                                        "name": "TMP_killChain",
                                                        "value": "Delivery"
                                                    },
                                                    "runAfter": {},
                                                    "type": "AppendToArrayVariable"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@variables('TMP_TAGS')",
                                                            "phishing"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "KillChain_Download_Location": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Parse_Indicator": {
                                            "inputs": {
                                                "content": "@items('For_each_indicator')",
                                                "schema": {
                                                    "properties": {
                                                        "associated_hashes": {
                                                            "items": {
                                                                "properties": {
                                                                    "id": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": {
                                                                        "type": "string"
                                                                    },
                                                                    "value": {
                                                                        "type": "string"
                                                                    }
                                                                },
                                                                "required": [
                                                                    "id",
                                                                    "type",
                                                                    "value"
                                                                ],
                                                                "type": "object"
                                                            },
                                                            "type": "array"
                                                        },
                                                        "first_seen": {
                                                            "type": "string"
                                                        },
                                                        "id": {
                                                            "type": "string"
                                                        },
                                                        "is_publishable": {
                                                            "type": "boolean"
                                                        },
                                                        "last_seen": {
                                                            "type": "string"
                                                        },
                                                        "last_updated": {
                                                            "type": "string"
                                                        },
                                                        "misp": {
                                                            "properties": {
                                                                "akamai": {
                                                                    "type": "boolean"
                                                                },
                                                                "alexa": {
                                                                    "type": "boolean"
                                                                },
                                                                "alexa_1M": {
                                                                    "type": "boolean"
                                                                },
                                                                "amazon-aws": {
                                                                    "type": "boolean"
                                                                },
                                                                "apple": {
                                                                    "type": "boolean"
                                                                },
                                                                "automated-malware-analysis": {
                                                                    "type": "boolean"
                                                                },
                                                                "bank-website": {
                                                                    "type": "boolean"
                                                                },
                                                                "cisco_1M": {
                                                                    "type": "boolean"
                                                                },
                                                                "cisco_top1000": {
                                                                    "type": "boolean"
                                                                },
                                                                "cisco_top10k": {
                                                                    "type": "boolean"
                                                                },
                                                                "cisco_top20k": {
                                                                    "type": "boolean"
                                                                },
                                                                "cisco_top5k": {
                                                                    "type": "boolean"
                                                                },
                                                                "cloudflare": {
                                                                    "type": "boolean"
                                                                },
                                                                "common-contact-emails": {
                                                                    "type": "boolean"
                                                                },
                                                                "common-ioc-false-positive": {
                                                                    "type": "boolean"
                                                                },
                                                                "covid": {
                                                                    "type": "boolean"
                                                                },
                                                                "covid-19-cyber-threat-coalition-whitelist": {
                                                                    "type": "boolean"
                                                                },
                                                                "covid-19-krassi-whitelist": {
                                                                    "type": "boolean"
                                                                },
                                                                "crl-hostname": {
                                                                    "type": "boolean"
                                                                },
                                                                "crl-ip": {
                                                                    "type": "boolean"
                                                                },
                                                                "dax30": {
                                                                    "type": "boolean"
                                                                },
                                                                "disposable-email": {
                                                                    "type": "boolean"
                                                                },
                                                                "dynamic-dns": {
                                                                    "type": "boolean"
                                                                },
                                                                "eicar.com": {
                                                                    "type": "boolean"
                                                                },
                                                                "empty-hashes": {
                                                                    "type": "boolean"
                                                                },
                                                                "fastly": {
                                                                    "type": "boolean"
                                                                },
                                                                "google": {
                                                                    "type": "boolean"
                                                                },
                                                                "google-gcp": {
                                                                    "type": "boolean"
                                                                },
                                                                "google-gmail-sending-ips": {
                                                                    "type": "boolean"
                                                                },
                                                                "googlebot": {
                                                                    "type": "boolean"
                                                                },
                                                                "ipv6-linklocal": {
                                                                    "type": "boolean"
                                                                },
                                                                "majestic_million": {
                                                                    "type": "boolean"
                                                                },
                                                                "majestic_million_1M": {
                                                                    "type": "boolean"
                                                                },
                                                                "microsoft": {
                                                                    "type": "boolean"
                                                                },
                                                                "microsoft-attack-simulator": {
                                                                    "type": "boolean"
                                                                },
                                                                "microsoft-azure": {
                                                                    "type": "boolean"
                                                                },
                                                                "microsoft-azure-china": {
                                                                    "type": "boolean"
                                                                },
                                                                "microsoft-azure-germany": {
                                                                    "type": "boolean"
                                                                },
                                                                "microsoft-azure-us-gov": {
                                                                    "type": "boolean"
                                                                },
                                                                "microsoft-office365": {
                                                                    "type": "boolean"
                                                                },
                                                                "microsoft-office365-cn": {
                                                                    "type": "boolean"
                                                                },
                                                                "microsoft-office365-ip": {
                                                                    "type": "boolean"
                                                                },
                                                                "microsoft-win10-connection-endpoints": {
                                                                    "type": "boolean"
                                                                },
                                                                "moz-top500": {
                                                                    "type": "boolean"
                                                                },
                                                                "mozilla-CA": {
                                                                    "type": "boolean"
                                                                },
                                                                "mozilla-IntermediateCA": {
                                                                    "type": "boolean"
                                                                },
                                                                "multicast": {
                                                                    "type": "boolean"
                                                                },
                                                                "nioc-filehash": {
                                                                    "type": "boolean"
                                                                },
                                                                "ovh-cluster": {
                                                                    "type": "boolean"
                                                                },
                                                                "phone_numbers": {
                                                                    "type": "boolean"
                                                                },
                                                                "public-dns-hostname": {
                                                                    "type": "boolean"
                                                                },
                                                                "public-dns-v4": {
                                                                    "type": "boolean"
                                                                },
                                                                "public-dns-v6": {
                                                                    "type": "boolean"
                                                                },
                                                                "rfc1918": {
                                                                    "type": "boolean"
                                                                },
                                                                "rfc3849": {
                                                                    "type": "boolean"
                                                                },
                                                                "rfc5735": {
                                                                    "type": "boolean"
                                                                },
                                                                "rfc6598": {
                                                                    "type": "boolean"
                                                                },
                                                                "rfc6761": {
                                                                    "type": "boolean"
                                                                },
                                                                "second-level-tlds": {
                                                                    "type": "boolean"
                                                                },
                                                                "security-provider-blogpost": {
                                                                    "type": "boolean"
                                                                },
                                                                "sinkholes": {
                                                                    "type": "boolean"
                                                                },
                                                                "smtp-receiving-ips": {
                                                                    "type": "boolean"
                                                                },
                                                                "smtp-sending-ips": {
                                                                    "type": "boolean"
                                                                },
                                                                "stackpath": {
                                                                    "type": "boolean"
                                                                },
                                                                "ti-falsepositives": {
                                                                    "type": "boolean"
                                                                },
                                                                "tlds": {
                                                                    "type": "boolean"
                                                                },
                                                                "tranco": {
                                                                    "type": "boolean"
                                                                },
                                                                "tranco10k": {
                                                                    "type": "boolean"
                                                                },
                                                                "university_domains": {
                                                                    "type": "boolean"
                                                                },
                                                                "url-shortener": {
                                                                    "type": "boolean"
                                                                },
                                                                "vpn-ipv4": {
                                                                    "type": "boolean"
                                                                },
                                                                "vpn-ipv6": {
                                                                    "type": "boolean"
                                                                },
                                                                "whats-my-ip": {
                                                                    "type": "boolean"
                                                                },
                                                                "wikimedia": {
                                                                    "type": "boolean"
                                                                }
                                                            },
                                                            "type": "object"
                                                        },
                                                        "mscore": {
                                                            "type": "integer"
                                                        },
                                                        "sources": {
                                                            "items": {
                                                                "properties": {
                                                                    "category": {
                                                                        "type": "array"
                                                                    },
                                                                    "first_seen": {
                                                                        "type": "string"
                                                                    },
                                                                    "last_seen": {
                                                                        "type": "string"
                                                                    },
                                                                    "osint": {
                                                                        "type": "boolean"
                                                                    },
                                                                    "source_name": {
                                                                        "type": "string"
                                                                    }
                                                                },
                                                                "required": [
                                                                    "first_seen",
                                                                    "last_seen",
                                                                    "osint",
                                                                    "category",
                                                                    "source_name"
                                                                ],
                                                                "type": "object"
                                                            },
                                                            "type": "array"
                                                        },
                                                        "type": {
                                                            "type": "string"
                                                        },
                                                        "value": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            },
                                            "runAfter": {},
                                            "type": "ParseJson"
                                        },
                                        "Unset_threatType": {
                                            "inputs": {
                                                "name": "TMP_threatType",
                                                "value": "unset"
                                            },
                                            "runAfter": {
                                                "Get_Threat_Indicators": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable"
                                        }
                                    },
                                    "foreach": "@variables('allIndicators')",
                                    "runAfter": {},
                                    "runtimeConfiguration": {
                                        "concurrency": {
                                            "repetitions": 1
                                        }
                                    },
                                    "type": "Foreach"
                                },
                                "If_CTRL_NextPage_is_Set": {
                                    "actions": {
                                        "HTTP_Get_next_indicator_page": {
                                            "inputs": {
                                                "authentication": {
                                                    "type": "Raw",
                                                    "value": "Bearer @{variables('TMP_BearerToken')}"
                                                },
                                                "headers": {
                                                    "Accept": "application/json",
                                                    "X-App-Name": "MA-MSFT-AZURE-LOGIC-APP-v1.0.0"
                                                },
                                                "method": "GET",
                                                "queries": {
                                                    "limit": "1000",
                                                    "next": "@variables('CTRL_nextPage')"
                                                },
                                                "uri": "https://api.intelligence.mandiant.com/v4/indicator"
                                            },
                                            "runAfter": {},
                                            "type": "Http"
                                        },
                                        "If_Unauthorized_Response": {
                                            "actions": {
                                                "HTTP_Refresh_Bearer_Token": {
                                                    "inputs": {
                                                        "authentication": {
                                                            "password": "@body('Retrieve_API_Secret_Key')?['value']",
                                                            "type": "Basic",
                                                            "username": "@parameters('API Key')"
                                                        },
                                                        "body": "grant_type=client_credentials&scope=",
                                                        "headers": {
                                                            "X-App-Name": "MA-MSFT-AZURE-LOGIC-APP-v1.0.0",
                                                            "accept": "application/json",
                                                            "content-type": "application/x-www-form-urlencoded"
                                                        },
                                                        "method": "POST",
                                                        "uri": "https://api.intelligence.mandiant.com/token"
                                                    },
                                                    "runAfter": {},
                                                    "type": "Http"
                                                },
                                                "HTTP_Retry_Get_Next_Page": {
                                                    "inputs": {
                                                        "authentication": {
                                                            "type": "Raw",
                                                            "value": "Bearer @{variables('TMP_BearerToken')}"
                                                        },
                                                        "headers": {
                                                            "Accept": "application/json",
                                                            "X-App-Name": "MA-MSFT-AZURE-LOGIC-APP-v1.0.0"
                                                        },
                                                        "method": "GET",
                                                        "queries": {
                                                            "limit": "1000",
                                                            "next": "@variables('CTRL_nextPage')"
                                                        },
                                                        "uri": "https://api.intelligence.mandiant.com/v4/indicator"
                                                    },
                                                    "runAfter": {
                                                        "Update_TMP_BearerToken": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Http"
                                                },
                                                "Parse_New_Bearer_Token": {
                                                    "inputs": {
                                                        "content": "@body('HTTP_Refresh_Bearer_Token')",
                                                        "schema": {
                                                            "properties": {
                                                                "access_token": {
                                                                    "type": "string"
                                                                },
                                                                "expires_in": {
                                                                    "type": "integer"
                                                                },
                                                                "token_type": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "HTTP_Refresh_Bearer_Token": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson"
                                                },
                                                "Set_TMP_IndicatorsBody_On_Retry": {
                                                    "inputs": {
                                                        "name": "TMP_IndicatorsBody",
                                                        "value": "@{body('HTTP_Retry_Get_Next_Page')}"
                                                    },
                                                    "runAfter": {
                                                        "HTTP_Retry_Get_Next_Page": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable"
                                                },
                                                "Update_TMP_BearerToken": {
                                                    "inputs": {
                                                        "name": "TMP_BearerToken",
                                                        "value": "@body('Parse_New_Bearer_Token')?['access_token']"
                                                    },
                                                    "runAfter": {
                                                        "Parse_New_Bearer_Token": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "else": {
                                                "actions": {
                                                    "Set_TMP_IndicatorsBody_On_Success": {
                                                        "inputs": {
                                                            "name": "TMP_IndicatorsBody",
                                                            "value": "@{body('HTTP_Get_next_indicator_page')}"
                                                        },
                                                        "runAfter": {},
                                                        "type": "SetVariable"
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@outputs('HTTP_Get_next_indicator_page')['statusCode']",
                                                            401
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "HTTP_Get_next_indicator_page": [
                                                    "Succeeded",
                                                    "Failed"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "If_current_page_is_empty": {
                                            "actions": {
                                                "Set_pageEmpty_again": {
                                                    "inputs": {
                                                        "name": "CTRL_pageEmpty",
                                                        "value": true
                                                    },
                                                    "runAfter": {},
                                                    "type": "SetVariable"
                                                }
                                            },
                                            "else": {
                                                "actions": {
                                                    "Update_CTRL_nextPage": {
                                                        "inputs": {
                                                            "name": "CTRL_nextPage",
                                                            "value": "@body('Parse_next_indicator_page')?['next']"
                                                        },
                                                        "runAfter": {},
                                                        "type": "SetVariable"
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "or": [
                                                    {
                                                        "equals": [
                                                            "@length(body('Parse_First_Indicator_Page')?['indicators'])",
                                                            0
                                                        ]
                                                    },
                                                    {
                                                        "less": [
                                                            "@length(body('Parse_First_Indicator_Page')?['indicators'])",
                                                            1000
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "If_page_has_contents": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "If_page_has_contents": {
                                            "actions": {
                                                "Parse_next_indicator_page": {
                                                    "inputs": {
                                                        "content": "@body('HTTP_Get_next_indicator_page')",
                                                        "schema": {
                                                            "properties": {
                                                                "indicators": {
                                                                    "items": {
                                                                        "properties": {
                                                                            "associated_hashes": {
                                                                                "items": {
                                                                                    "properties": {
                                                                                        "id": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "type": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "value": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "required": [
                                                                                        "id",
                                                                                        "type",
                                                                                        "value"
                                                                                    ],
                                                                                    "type": "object"
                                                                                },
                                                                                "type": "array"
                                                                            },
                                                                            "attributed_associations": {
                                                                                "items": {
                                                                                    "properties": {
                                                                                        "id": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "name": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "type": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "required": [
                                                                                        "id",
                                                                                        "name",
                                                                                        "type"
                                                                                    ],
                                                                                    "type": "object"
                                                                                },
                                                                                "type": "array"
                                                                            },
                                                                            "first_seen": {
                                                                                "type": "string"
                                                                            },
                                                                            "id": {
                                                                                "type": "string"
                                                                            },
                                                                            "is_exclusive": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "is_publishable": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "last_seen": {
                                                                                "type": "string"
                                                                            },
                                                                            "last_updated": {
                                                                                "type": "string"
                                                                            },
                                                                            "misp": {
                                                                                "properties": {
                                                                                    "akamai": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "alexa": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "alexa_1M": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "amazon-aws": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "apple": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "automated-malware-analysis": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "bank-website": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "cisco_1M": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "cisco_top1000": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "cisco_top10k": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "cisco_top20k": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "cisco_top5k": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "cloudflare": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "common-contact-emails": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "common-ioc-false-positive": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "covid": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "covid-19-cyber-threat-coalition-whitelist": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "covid-19-krassi-whitelist": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "crl-hostname": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "crl-ip": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "dax30": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "disposable-email": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "dynamic-dns": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "eicar.com": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "empty-hashes": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "fastly": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "google": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "google-gcp": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "google-gmail-sending-ips": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "googlebot": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "ipv6-linklocal": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "majestic_million": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "majestic_million_1M": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "microsoft": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "microsoft-attack-simulator": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "microsoft-azure": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "microsoft-azure-china": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "microsoft-azure-germany": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "microsoft-azure-us-gov": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "microsoft-office365": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "microsoft-office365-cn": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "microsoft-office365-ip": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "microsoft-win10-connection-endpoints": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "moz-top500": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "mozilla-CA": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "mozilla-IntermediateCA": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "multicast": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "nioc-filehash": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "ovh-cluster": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "phone_numbers": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "public-dns-hostname": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "public-dns-v4": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "public-dns-v6": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "rfc1918": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "rfc3849": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "rfc5735": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "rfc6598": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "rfc6761": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "second-level-tlds": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "security-provider-blogpost": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "sinkholes": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "smtp-receiving-ips": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "smtp-sending-ips": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "stackpath": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "ti-falsepositives": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "tlds": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "tranco": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "tranco10k": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "university_domains": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "url-shortener": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "vpn-ipv4": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "vpn-ipv6": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "whats-my-ip": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "wikimedia": {
                                                                                        "type": "boolean"
                                                                                    }
                                                                                },
                                                                                "type": "object"
                                                                            },
                                                                            "mscore": {
                                                                                "type": "integer"
                                                                            },
                                                                            "sources": {
                                                                                "items": {
                                                                                    "properties": {
                                                                                        "category": {
                                                                                            "items": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "type": "array"
                                                                                        },
                                                                                        "first_seen": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "last_seen": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "osint": {
                                                                                            "type": "boolean"
                                                                                        },
                                                                                        "source_name": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "required": [
                                                                                        "first_seen",
                                                                                        "last_seen",
                                                                                        "osint",
                                                                                        "category",
                                                                                        "source_name"
                                                                                    ],
                                                                                    "type": "object"
                                                                                },
                                                                                "type": "array"
                                                                            },
                                                                            "type": {
                                                                                "type": "string"
                                                                            },
                                                                            "value": {
                                                                                "type": "string"
                                                                            }
                                                                        },
                                                                        "required": [
                                                                            "first_seen",
                                                                            "last_seen",
                                                                            "sources",
                                                                            "mscore",
                                                                            "misp",
                                                                            "id",
                                                                            "type",
                                                                            "value",
                                                                            "is_publishable",
                                                                            "last_updated"
                                                                        ],
                                                                        "type": "object"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "next": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    },
                                                    "runAfter": {},
                                                    "type": "ParseJson"
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "greater": [
                                                            "@length(variables('TMP_IndicatorsBody'))",
                                                            0
                                                        ]
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "If_Unauthorized_Response": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Load_next_page_of_indicators": {
                                            "inputs": {
                                                "name": "allIndicators",
                                                "value": "@body('Parse_Indicator_Page')?['indicators']"
                                            },
                                            "runAfter": {
                                                "Parse_Indicator_Page": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable"
                                        },
                                        "Parse_Indicator_Page": {
                                            "inputs": {
                                                "content": "@variables('TMP_IndicatorsBody')",
                                                "schema": {
                                                    "properties": {
                                                        "indicators": {
                                                            "items": {
                                                                "properties": {
                                                                    "associated_hashes": {
                                                                        "items": {
                                                                            "properties": {
                                                                                "id": {
                                                                                    "type": "string"
                                                                                },
                                                                                "type": {
                                                                                    "type": "string"
                                                                                },
                                                                                "value": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "required": [
                                                                                "id",
                                                                                "type",
                                                                                "value"
                                                                            ],
                                                                            "type": "object"
                                                                        },
                                                                        "type": "array"
                                                                    },
                                                                    "attributed_associations": {
                                                                        "items": {
                                                                            "properties": {
                                                                                "id": {
                                                                                    "type": "string"
                                                                                },
                                                                                "name": {
                                                                                    "type": "string"
                                                                                },
                                                                                "type": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "required": [
                                                                                "id",
                                                                                "name",
                                                                                "type"
                                                                            ],
                                                                            "type": "object"
                                                                        },
                                                                        "type": "array"
                                                                    },
                                                                    "first_seen": {
                                                                        "type": "string"
                                                                    },
                                                                    "id": {
                                                                        "type": "string"
                                                                    },
                                                                    "is_exclusive": {
                                                                        "type": "boolean"
                                                                    },
                                                                    "is_publishable": {
                                                                        "type": "boolean"
                                                                    },
                                                                    "last_seen": {
                                                                        "type": "string"
                                                                    },
                                                                    "last_updated": {
                                                                        "type": "string"
                                                                    },
                                                                    "misp": {
                                                                        "properties": {
                                                                            "akamai": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "alexa": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "alexa_1M": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "amazon-aws": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "apple": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "automated-malware-analysis": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "bank-website": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "cisco_1M": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "cisco_top1000": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "cisco_top10k": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "cisco_top20k": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "cisco_top5k": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "cloudflare": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "common-contact-emails": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "common-ioc-false-positive": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "covid": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "covid-19-cyber-threat-coalition-whitelist": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "covid-19-krassi-whitelist": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "crl-hostname": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "crl-ip": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "dax30": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "disposable-email": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "dynamic-dns": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "eicar.com": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "empty-hashes": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "fastly": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "google": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "google-gcp": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "google-gmail-sending-ips": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "googlebot": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "ipv6-linklocal": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "majestic_million": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "majestic_million_1M": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "microsoft": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "microsoft-attack-simulator": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "microsoft-azure": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "microsoft-azure-china": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "microsoft-azure-germany": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "microsoft-azure-us-gov": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "microsoft-office365": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "microsoft-office365-cn": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "microsoft-office365-ip": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "microsoft-win10-connection-endpoints": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "moz-top500": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "mozilla-CA": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "mozilla-IntermediateCA": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "multicast": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "nioc-filehash": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "ovh-cluster": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "phone_numbers": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "public-dns-hostname": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "public-dns-v4": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "public-dns-v6": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "rfc1918": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "rfc3849": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "rfc5735": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "rfc6598": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "rfc6761": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "second-level-tlds": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "security-provider-blogpost": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "sinkholes": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "smtp-receiving-ips": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "smtp-sending-ips": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "stackpath": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "ti-falsepositives": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "tlds": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "tranco": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "tranco10k": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "university_domains": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "url-shortener": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "vpn-ipv4": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "vpn-ipv6": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "whats-my-ip": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "wikimedia": {
                                                                                "type": "boolean"
                                                                            }
                                                                        },
                                                                        "type": "object"
                                                                    },
                                                                    "mscore": {
                                                                        "type": "integer"
                                                                    },
                                                                    "sources": {
                                                                        "items": {
                                                                            "properties": {
                                                                                "category": {
                                                                                    "items": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "type": "array"
                                                                                },
                                                                                "first_seen": {
                                                                                    "type": "string"
                                                                                },
                                                                                "last_seen": {
                                                                                    "type": "string"
                                                                                },
                                                                                "osint": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "source_name": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "required": [
                                                                                "first_seen",
                                                                                "last_seen",
                                                                                "osint",
                                                                                "category",
                                                                                "source_name"
                                                                            ],
                                                                            "type": "object"
                                                                        },
                                                                        "type": "array"
                                                                    },
                                                                    "type": {
                                                                        "type": "string"
                                                                    },
                                                                    "value": {
                                                                        "type": "string"
                                                                    }
                                                                },
                                                                "required": [
                                                                    "first_seen",
                                                                    "last_seen",
                                                                    "sources",
                                                                    "mscore",
                                                                    "misp",
                                                                    "id",
                                                                    "type",
                                                                    "value",
                                                                    "is_publishable",
                                                                    "last_updated"
                                                                ],
                                                                "type": "object"
                                                            },
                                                            "type": "array"
                                                        },
                                                        "next": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            },
                                            "runAfter": {
                                                "If_current_page_is_empty": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson"
                                        }
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@variables('CTRL_nextPage')",
                                                    "@true"
                                                ]
                                            }
                                        ]
                                    },
                                    "runAfter": {
                                        "For_each_indicator": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "If"
                                }
                            },
                            "expression": "@equals(variables('CTRL_pageEmpty'), True)",
                            "limit": {
                                "count": 60,
                                "timeout": "PT1H"
                            },
                            "runAfter": {
                                "Initialize_TMP_IndicatorsBody": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Until"
                        },
                        "Update_last-run_blob_if_it_exists": {
                            "inputs": {
                                "body": "@variables('TMP_startTime')",
                                "headers": {
                                    "Content-Type": "text/plain",
                                    "ReadFileMetadataFromServer": true
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azureblobContainer']['connectionId']"
                                    }
                                },
                                "method": "put",
                                "path": "/v2/datasets/@{encodeURIComponent(encodeURIComponent('AccountNameFromSettings'))}/files/@{encodeURIComponent(encodeURIComponent(concat('/', parameters('StorageContainerName'), '/last-run.txt')))}"
                            },
                            "metadata": {
                                "JTJmbWFuZGlhbnQtdGhyZWF0LWludGVsJTJmbGFzdC1ydW4=": "/mandiant-threat-intel/last-run",
                                "JTJmbWFuZGlhbnQtdGhyZWF0LWludGVsJTJmbGFzdC1ydW4udHh0": "/mandiant-threat-intel/last-run.txt"
                            },
                            "runAfter": {
                                "Until_the_current_page_is_empty": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection"
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "$connections": {
                        "value": {
                            "microsoftgraphsecurity": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', concat(parameters('workflows_MndtThreatIntel_name'), '-microsoftgraphsecurity'))]",
                                "connectionName": "microsoftgraphsecurity",
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/microsoftgraphsecurity')]"
                            },
                            "azureblobContainer": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', concat(parameters('workflows_MndtThreatIntel_name'), '-azureblobContainer'))]",
                                "connectionName": "azureblob",
                                "id": "[concat(subscription().id, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azureblob')]"
                            },
                            "keyvault": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', concat(parameters('workflows_MndtThreatIntel_name'), '-keyvault'))]",
                                "connectionName": "keyvault",
                                "connectionProperties": {
                                    "authentication": {
                                        "type": "ManagedServiceIdentity"
                                    }
                                },
                                "id": "[concat(subscription().id, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/keyvault')]"
                            }
                        }
                    }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Web/connections', concat(parameters('workflows_MndtThreatIntel_name'), '-microsoftgraphsecurity'))]",
                "[resourceId('Microsoft.Web/connections', concat(parameters('workflows_MndtThreatIntel_name'), '-azureblobContainer'))]",
                "[resourceId('Microsoft.Web/connections', concat(parameters('workflows_MndtThreatIntel_name'), '-keyvault'))]"
            ]
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[concat(parameters('workflows_MndtThreatIntel_name'), '-microsoftgraphsecurity')]",
            "location": "[resourceGroup().location]",
            "kind": "V1",
            "properties": {
                "api": {
                    "name": "microsoftgraphsecurity",
                    "displayName": "Microsoft Graph Security",
                    "description": "The Microsoft Graph Security connector helps to connect different Microsoft and partner security products and services, using a unified schema, to streamline security operations, and improve threat protection, detection, and response capabilities. Learn more about integrating with the Microsoft Graph Security API at https://aka.ms/graphsecuritydocs",
                    "iconUri": "https://connectoricons-prod.azureedge.net/releases/v1.0.1583/1.0.1583.2865/microsoftgraphsecurity/icon.png",
                    "brandColor": "#0078D6",
                    "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/microsoftgraphsecurity')]",
                    "type": "Microsoft.Web/locations/managedApis"
                },
                "testLinks": []
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2021-02-01",
            "name": "[parameters('StorageAccountName')]",
            "location": "[resourceGroup().location]",
            "kind": "Storage",
            "sku": {
                "name": "Standard_LRS"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "2021-04-01",
            "name": "[concat(parameters('StorageAccountName'), '/default/', parameters('StorageContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('StorageAccountName'))]"
            ]
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[concat(parameters('workflows_MndtThreatIntel_name'), '-azureblobContainer')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "displayName": "BlobConnection",
                "api": {
                    "name": "azureblob",
                    "displayName": "Azure Blob Storage",
                    "description": "Microsoft Azure Storage provides a massively scalable, durable, and highly available storage for data on the cloud, and serves as the data storage solution for modern applications. Connect to Blob Storage to perform various operations such as create, update, get and delete on blobs in your Azure Storage account.",
                    "iconUri": "https://connectoricons-prod.azureedge.net/releases/v1.0.1586/1.0.1586.2912/azureblob/icon.png",
                    "brandColor": "#804998",
                    "type": "Microsoft.Web/locations/managedApis",
                    "id": "[concat(subscription().id, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azureblob')]"
                },
                "parameterValues": {
                    "accessKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('StorageAccountName')), '2022-05-01').keys[0].value]",
                    "accountName": "[parameters('StorageAccountName')]"
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('StorageAccountName'))]"
            ]
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[concat(parameters('workflows_MndtThreatIntel_name'), '-keyvault')]",
            "location": "[resourceGroup().location]",
            "kind": "V1",
            "properties": {
                "api": {
                    "name": "keyvault",
                    "displayName": "Azure Key Vault",
                    "description": "Azure Key Vault is a service to securely store and access secrets.",
                    "iconUri": "https://connectoricons-prod.azureedge.net/releases/v1.0.1574/1.0.1574.2782/keyvault/icon.png",
                    "brandColor": "#0079d6",
                    "id": "[concat(subscription().id, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/keyvault')]",
                    "type": "Microsoft.Web/locations/managedApis"
                },
                "parameterValueType": "Alternative",
                "testLinks": [],
                "alternativeParameterValues": {
                    "vaultName": "[parameters('KeyVaultName')]"
                }
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults",
            "apiVersion": "2021-11-01-preview",
            "name": "[parameters('KeyVaultName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "sku": {
                    "family": "A",
                    "name": "Standard"
                },
                "tenantId": "[subscription().tenantId]",
                "accessPolicies": [
                    {
                        "tenantId": "[reference(resourceId('Microsoft.Logic/workflows', parameters('workflows_MndtThreatIntel_name')), '2019-05-01', 'full').identity.tenantId]",
                        "objectId": "[reference(resourceId('Microsoft.Logic/workflows', parameters('workflows_MndtThreatIntel_name')), '2019-05-01', 'full').identity.principalId]",
                        "permissions": {
                            "secrets": [
                                "Get",
                                "List"
                            ]
                        }
                    }
                ],
                "publicNetworkAccess": "Enabled"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Logic/workflows', parameters('workflows_MndtThreatIntel_name'))]"
            ]
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "apiVersion": "2021-11-01-preview",
            "name": "[concat(parameters('KeyVaultName'), '/api-secret-key')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('KeyVaultName'))]"
            ],
            "properties": {
                "attributes": {
                    "enabled": true
                },
                "value": "[parameters('SecretKey')]"
            }
        }
    ]
}