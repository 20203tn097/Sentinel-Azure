{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "JCT - jct@flare.systems}",
    "comments": "Solution template for Flare"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "PlaybookName": {
      "defaultValue": "Flare-Leaked-Credentials-Playbook",
      "type": "string"
    }
  },
  "variables": {
    "solutionId": "flaresystmesinc1617114736428.flare-systems-firework-sentinel",
    "_solutionId": "[variables('solutionId')]",
    "email": "jct@flare.systems}",
    "_email": "[variables('email')]",
    "Playbooks": "Playbooks",
    "_Playbooks": "[variables('Playbooks')]",
    "AzureSentinelConnectionName": "FlareConnection",
    "o365ConnectionName": "o365-Flare-Playbook"
  },
  "resources": [
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('AzureSentinelConnectionName')]",
      "kind": "V1",
      "properties": {
        "displayName": "[variables('AzureSentinelConnectionName')]",
        "parameterValueType": "Alternative",
        "api": {
          "id": "de1da435-3153-4f5e-b709-7e00ab128089"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('o365ConnectionName')]",
      "location": "[variables('workspace-location-inline')]",
      "properties": {
        "displayName": "[parameters('PlaybookName')]",
        "api": {
          "id": "d77c0864-4c0d-4bd9-9baa-38acdfc56c26"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('PlaybookName')]",
      "location": "[variables('workspace-location-inline')]",
      "tags": {
        "LogicAppsCategory": "security",
        "hidden-SentinelTemplateName": "PlaybookName",
        "hidden-SentinelTemplateVersion": "1.0"
      },
      "identity": {
        "type": "SystemAssigned"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('o365ConnectionName'))]"
      ],
      "properties": {
        "state": "Disabled",
        "definition": {
          "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "actions": {
            "For_each": {
              "actions": {
                "For_each_2": {
                  "actions": {
                    "For_each_3": {
                      "actions": {
                        "Send_an_email_(V2)": {
                          "inputs": {
                            "body": {
                              "Body": "<p>Hello,<br>\n<br>\nThis is a message to warn you we believe a password you had been using has &nbsp;been leaked online, as part of a data breach.<br>\n<br>\nIf the following password is one you are still using commonly, we recommend changing it as soon as possible.<br>\n<br>\n@{items('For_each_3')['hash']}<br>\n<br>\nIn addition we want to remind you not to use your corporate email address to register to services outside of work.<br>\n<br>\nCordially,<br>\n<br>\nSecurity Team<br>\n</p>",
                              "Subject": "Possible compromised password",
                              "To": "blank@flare.systems"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['office365']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/v2/Mail"
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@items('For_each_2')['passwords']",
                      "type": "Foreach"
                    }
                  },
                  "foreach": "@body('Parse_JSON')",
                  "runAfter": {
                    "Parse_JSON": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Parse_JSON": {
                  "inputs": {
                    "content": "@items('For_each')",
                    "schema": {
                      "items": {
                        "properties": {
                          "name": {
                            "type": "string"
                          },
                          "passwords": {
                            "items": {
                              "properties": {
                                "extra": {
                                  "type": "object"
                                },
                                "hash": {
                                  "type": "string"
                                },
                                "hash_type": {
                                  "type": "string"
                                },
                                "id": {
                                  "type": "integer"
                                },
                                "imported_at": {
                                  "type": "string"
                                },
                                "source_id": {
                                  "type": "string"
                                },
                                "source_params": {
                                  "properties": {
                                    "line": {
                                      "type": "integer"
                                    }
                                  },
                                  "type": "object"
                                }
                              },
                              "required": [
                                "id",
                                "hash",
                                "hash_type",
                                "extra",
                                "domain",
                                "source_id",
                                "source_params",
                                "imported_at"
                              ],
                              "type": "object"
                            },
                            "type": "array"
                          }
                        },
                        "required": [
                          "name",
                          "passwords"
                        ],
                        "type": "object"
                      },
                      "type": "array"
                    }
                  },
                  "type": "ParseJson"
                }
              },
              "foreach": "@variables('leaks')['leaked_credentials']",
              "runAfter": {
                "Initialize_variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Initialize_variable": {
              "inputs": {
                "variables": [
                  {
                    "name": "leaks",
                    "type": "object",
                    "value": "@json(body('Parse_JSON_2')['Custom Details'])"
                  }
                ]
              },
              "runAfter": {
                "Parse_JSON_2": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Parse_JSON_2": {
              "inputs": {
                "content": "@triggerBody()?['ExtendedProperties']",
                "schema": {
                  "properties": {
                    "Analytic Rule Ids": {
                      "type": "string"
                    },
                    "Analytic Rule Name": {
                      "type": "string"
                    },
                    "Custom Details": {
                      "type": "string"
                    },
                    "Data Sources": {
                      "type": "string"
                    },
                    "Event Grouping": {
                      "type": "string"
                    },
                    "ProcessedBySentinel": {
                      "type": "string"
                    },
                    "Query": {
                      "type": "string"
                    },
                    "Query End Time UTC": {
                      "type": "string"
                    },
                    "Query Period": {
                      "type": "string"
                    },
                    "Query Start Time UTC": {
                      "type": "string"
                    },
                    "Search Query Results Overall Count": {
                      "type": "string"
                    },
                    "Trigger Operator": {
                      "type": "string"
                    },
                    "Trigger Threshold": {
                      "type": "string"
                    }
                  },
                  "type": "object"
                }
              },
              "type": "ParseJson"
            }
          },
          "contentVersion": "1.0.0.0",
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "connectionName": "[variables('AzureSentinelConnectionName')]",
                "id": "e16a135a-8102-4863-a2c1-c22157ad1339",
                "connectionProperties": {
                  "authentication": {
                    "type": "ManagedServiceIdentity"
                  }
                }
              },
              "office365": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('o365ConnectionName'))]",
                "connectionName": "[variables('o365ConnectionName')]",
                "id": "6d724cf2-7eee-47e5-87d3-b4efd0108d1a"
              }
            }
          }
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector1-name'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Flare",
          "publisher": "Flare",
          "descriptionMarkdown": "[Flare](https://flare.systems/platform/) connector allows you to receive data and intelligence from Flare on Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "Firework_CL",
              "baseQuery": "Firework_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "Firework_CL",
              "lastDataReceivedQuery": "Firework_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "Firework_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "Flare Activities -- All",
              "query": "Firework_CL\n | sort by TimeGenerated desc"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Required Flare permissions",
                "description": "only Flare organization administrators may configure the Microsoft Sentinel integration."
              }
            ]
          },
          "instructionSteps": [
            {
              "innerSteps": [
                {
                  "description": "As an organization administrator, authenticate on [Flare](https://app.flare.systems) and access the [team page](https://app.flare.systems#/team) to create a new alert channel."
                },
                {
                  "description": "Click on 'Create a new alert channel' and select 'Microsoft Sentinel'. Enter your Shared Key And WorkspaceID. Save the Alert Channel. \n For more help and details, see our [Azure configuration documentation](https://docs.microsoft.com/azure/sentinel/connect-data-sources).",
                  "instructions": [
                    {
                      "parameters": {
                        "fillWith": [
                          "WorkspaceId"
                        ],
                        "label": "Workspace ID",
                        "value": "{0}"
                      },
                      "type": "CopyableLabel"
                    },
                    {
                      "parameters": {
                        "fillWith": [
                          "PrimaryKey"
                        ],
                        "label": "Primary key",
                        "value": "{0} "
                      },
                      "type": "CopyableLabel"
                    }
                  ]
                }
              ],
              "title": "1. Creating an Alert Channel for Microsoft Sentinel"
            },
            {
              "innerSteps": [
                {
                  "description": "At this point, you may configure alerts to be sent to Microsoft Sentinel the same way that you would configure regular email alerts."
                },
                {
                  "description": "For a more detailed guide, refer to the Flare documentation."
                }
              ],
              "title": "2. Associating your alert channel to an alert feed"
            }
          ]
        }
      },
      "id": "3aac2a66-65be-4379-8313-4b0499b016b3"
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "2.0.2",
        "kind": "Solution",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Flare",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "JCT",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Flare",
          "email": "contact@flare.systems",
          "tier": "Partner",
          "link": "https://flare.systems/company/contact/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Playbook",
              "contentId": "[variables('_Playbooks')]",
              "version": "1.0.0"
            },
            {
              "kind": "DataConnector",
              "contentId": "8bdd1807-7d14-4b67-aac0-848dff02717b",
              "version": "2.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "73cf9a9a-0bc9-4b30-bad4-c6ba25293ff4",
              "version": "2.0.2"
            }
          ]
        },
        "firstPublishDate": "2021-10-20",
        "providers": [
          "Flare Systems"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
