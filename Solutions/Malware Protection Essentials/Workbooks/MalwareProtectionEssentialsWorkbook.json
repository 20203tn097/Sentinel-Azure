{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## Malware Protection Essentials (Preview)\n---\n\nThis wokbook provide details about Suspicious Malware Activities from File, Process and Registry events generated by EDR (Endpoint Detection and Response) solutions.\n\n\n"
      },
      "name": "text - 2"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "c470616d-5af0-483a-a595-28a684d878a1",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "value": {
              "durationMs": 86400000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "f0450560-ef16-4aa9-a3ad-7485dd909587",
            "version": "KqlParameterItem/1.0",
            "name": "Help",
            "type": 10,
            "isRequired": true,
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "jsonData": "[{ \"value\": \"Yes\", \"label\": \"Yes\"},\r\n {\"value\": \"No\", \"label\": \"No\", \"selected\":true }]",
            "label": "Show Help",
            "value": "Yes"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 2"
    },
    {
      "type": 1,
      "content": {
        "json": "\r\n|Overview|File|Process|Registry|\r\n|--------|------|-------|----|\r\n|Recent EDR Failed Scans|Files Created in Startup Folders|List of Suspicious Processes Created with Base64 CommandLine Argumnet|Startup Registry Creation/Moification|\r\n|Latest EDR Alerts|Top 10 Hosts where Files Created in Startup Folders|Top 10 Devices with Suspicious Process|Top 10 Devices with Most Startup Registry Modification|\r\n|Top 5 Users with Most Alerts|Top 10 Accounts to Create Files in Startup Folders|Top 10 Processes with Suspicious CommandLine|Top 10 Users with Most Startup Registry Modification|\r\n|Top 5 Hosts with Most Alerts|List of Scheduled Task Created with Encoded Command|List of Backup Deletion Acitivties using LOL Binaries|Windows Update Disabled Devices|\r\n|Host Count by DNS Suffix |Top 10 Hosts where Files Created in Startup Folders|Top 10 Devices with Most Backup Deletion Activity|Windows Firewall Allow Rule Addition Events|\r\n|Device Azure AD Join status|Top 10 Accounts to Create Files in Startup Folders|List of Processes Started from Unusual Locations|Top 10 Devices with Most Windows Firewall Allow Rule Addition|\r\n|Device Sensor Health ||Top 10 Devices where Processes Started from Unusual Locations|Top 10 Users to add Windows Firewall Allow Rule|\r\n|Count of Top Threats  ||||"
      },
      "conditionalVisibility": {
        "parameterName": "Help",
        "comparison": "isEqualTo",
        "value": "Yes"
      },
      "name": "text - 8"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "454d4e02-26ba-4195-ae30-94752bbf4603",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Threat Overview",
            "subTarget": "Overview",
            "preText": "Overview",
            "style": "link"
          },
          {
            "id": "3d902e84-3e5b-4631-85d1-c229ec2abf75",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "File Activity",
            "subTarget": "File",
            "style": "link"
          },
          {
            "id": "bbc20288-b398-4f63-b7a9-e3830213bb34",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Process Activity",
            "subTarget": "Process",
            "style": "link"
          },
          {
            "id": "edab4a44-8ca3-4ba1-bede-4186f4376d28",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Registry Activity",
            "subTarget": "Registry",
            "style": "link"
          }
        ]
      },
      "name": "links - 3"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let deviceScanCompleted = DeviceEvents\r\n| where ActionType == 'AntivirusScanCompleted'\r\n| project DeviceName;\r\nDeviceEvents\r\n| where ActionType == 'AntivirusScanFailed'\r\n| where DeviceName !in (deviceScanCompleted)\r\n| extend ParsedFields = parse_json(AdditionalFields)\r\n| extend ScanId = tostring(ParsedFields.ScanId)\r\n| extend ErrorCode = tostring(ParsedFields.ErrorCode)\r\n| extend ErrorDescription = tostring(ParsedFields.ErrorDescription)\r\n| project ScanFailedTimestamp=Timestamp, DeviceName, DeviceId, TenantId, ScanId, ErrorCode, ErrorDescription",
              "size": 0,
              "title": "Recent EDR Failed Scans {TimeRange}",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Type",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Last Log Received At",
                    "formatter": 6,
                    "dateFormat": {
                      "showUtcTime": null,
                      "formatName": "fullDateTimePattern"
                    }
                  }
                ],
                "filter": true
              }
            },
            "name": "Threat1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecurityAlert\n| where ProviderName == 'MDATP'\n| extend ThreatCategory = tostring(parse_json(ExtendedProperties)['MicrosoftDefenderAtp.Category'])\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n| project TimeGenerated, AlertSeverity, Hostname=CompromisedEntity , DisplayName, ThreatCategory, ThreatName\n| order by TimeGenerated",
              "size": 1,
              "title": "Latest EDR Alerts {TimeRange}",
              "timeContextFromParameter": "TimeRange",
              "showRefreshButton": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 25,
                "filter": true
              },
              "chartSettings": {
                "xAxis": "count_"
              }
            },
            "name": "Threat2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecurityAlert\r\n| where ProductName == 'Microsoft Defender Advanced Threat Protection'\r\n| extend ParsedEntities = parse_json(Entities)\r\n| extend UserPrincipalName = tostring(ParsedEntities[0].UserPrincipalName)\r\n| where isnotempty(UserPrincipalName)\r\n| summarize Count=count() by UserPrincipalName\r\n| order by Count\r\n| take 5",
              "size": 1,
              "title": "Top 5 Users with Most Alerts {TimeRange}",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "FileCount",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "red"
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "Threat3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecurityAlert\r\n| where ProviderName == 'MDATP'\r\n| project Hostname=CompromisedEntity\r\n| summarize AlertCount=count() by Hostname\r\n| order by AlertCount\r\n| take 5",
              "size": 1,
              "title": "Top 5 Hosts with Most Alerts {TimeRange}",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "FileCount",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "red"
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "Threat4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "DeviceInfo\r\n| where isnotempty(OSPlatform)\r\n| summarize arg_max(Timestamp, DeviceName) by DeviceId\r\n| extend DeviceMachineName = split(DeviceName, '.')[0]\r\n| extend DeviceDomain = substring(DeviceName, strlen(DeviceMachineName) + 1, strlen(DeviceName) - strlen(DeviceMachineName) - 1)\r\n| where isnotempty(DeviceDomain)\r\n| summarize count() by DeviceDomain",
              "size": 1,
              "title": "Host Count by DNS Suffix",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "gridSettings": {
                "filter": true
              },
              "chartSettings": {
                "showMetrics": false,
                "showLegend": true
              }
            },
            "customWidth": "30",
            "name": "Threat5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "DeviceInfo\r\n| where isnotempty(OSPlatform)\r\n| summarize arg_max(TimeGenerated, *) by DeviceId\r\n| summarize count() by tostring(IsAzureADJoined)",
              "size": 1,
              "title": "Azure AD Join Host Status",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "gridSettings": {
                "filter": true
              },
              "chartSettings": {
                "showMetrics": false,
                "showLegend": true
              }
            },
            "customWidth": "30",
            "name": "Threat6"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "DeviceInfo\r\n| where isnotempty(OSPlatform)\r\n| summarize arg_max(TimeGenerated, *) by DeviceId\r\n| summarize Count=count() by SensorHealthState",
              "size": 1,
              "title": "EDR Agent Health",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "gridSettings": {
                "filter": true
              },
              "chartSettings": {
                "showMetrics": false,
                "showLegend": true
              }
            },
            "customWidth": "30",
            "name": "Threat6"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecurityAlert\r\n| where ProductName == 'Microsoft Defender Advanced Threat Protection'\r\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\r\n| where isnotempty(ThreatName)\r\n| summarize Count = count() by ThreatName",
              "size": 0,
              "title": "Count of Top Threats {TimeRange}",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "ThreatCategory",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "ThreatCategory",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "Count",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "mapSettings": {
                "locInfo": "LatLong",
                "sizeSettings": "Count",
                "sizeAggregation": "Sum",
                "legendMetric": "Count",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "type": "heatmap",
                  "colorAggregation": "Sum",
                  "nodeColorField": "Count",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "name": "Threat7"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Overview"
      },
      "name": "groupOverview"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let startupRegistryList = dynamic([\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServicesOnce',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServicesOnce',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServices',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServices',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Userinit',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows'\r\n    ]);\r\n  imRegistry\r\n  | where EventType in ('RegistryValueSet', 'RegistryKeyCreated') and RegistryKey has_any (startupRegistryList)\r\n  | project\r\n      TimeGenerated,\r\n      DvcHostname,\r\n      ActorUsername,\r\n      ActorUsernameType,\r\n      ActingProcessId,\r\n      ActingProcessName,\r\n      ActingProcessCommandLine,\r\n      RegistryKey,\r\n      RegistryValue,\r\n      RegistryValueType,\r\n      RegistryValueData",
              "size": 0,
              "title": "Startup Registry Creation/Moification {TimeRange}",
              "noDataMessage": "No Data for given Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "filter": true
              }
            },
            "name": "RegistryActivity-Startup1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let startupRegistryList = dynamic([\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServicesOnce',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServicesOnce',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServices',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServices',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Userinit',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows'\r\n    ]);\r\n  imRegistry\r\n  | where EventType in ('RegistryValueSet', 'RegistryKeyCreated') and RegistryKey has_any (startupRegistryList)\r\n  | project\r\n      TimeGenerated,\r\n      DvcHostname,\r\n      ActorUsername,\r\n      ActorUsernameType,\r\n      ActingProcessId,\r\n      ActingProcessName,\r\n      ActingProcessCommandLine,\r\n      RegistryKey,\r\n      RegistryValue,\r\n      RegistryValueType,\r\n      RegistryValueData\r\n| summarize Count=count() by DvcHostname\r\n| take 10",
              "size": 0,
              "title": "Top 10 Devices with Most Startup Registry Modification {TimeRange}",
              "noDataMessage": "No Data for given Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "customWidth": "50",
            "name": "RegistryActivity-Startup2",
            "styleSettings": {
              "maxWidth": "50%"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let startupRegistryList = dynamic([\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServicesOnce',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServicesOnce',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServices',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServices',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Userinit',\r\n      'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell',\r\n      'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows',\r\n      'HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows Advanced Threat Protection'\r\n    ]);\r\n  imRegistry\r\n  | where EventType in ('RegistryValueSet', 'RegistryKeyCreated') and RegistryKey has_any (startupRegistryList)\r\n  | project\r\n      TimeGenerated,\r\n      DvcHostname,\r\n      ActorUsername,\r\n      ActorUsernameType,\r\n      ActingProcessId,\r\n      ActingProcessName,\r\n      ActingProcessCommandLine,\r\n      RegistryKey,\r\n      RegistryValue,\r\n      RegistryValueType,\r\n      RegistryValueData\r\n| summarize Count=count() by ActorUsername\r\n| take 10",
              "size": 0,
              "title": "Top 10 Users with Most Startup Registry Modification {TimeRange}",
              "noDataMessage": "No Data for given TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "customWidth": "50",
            "name": "RegistryActivity-Startup3",
            "styleSettings": {
              "maxWidth": "50%"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "  let windowsUpdateRegistryList = dynamic([\r\n    'HKEY_LOCAL_MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\Windows\\\\WindowsUpdate',\r\n    'HKEY_LOCAL_MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\Windows\\\\WindowsUpdate\\\\AU'\r\n    ]);\r\n  imRegistry\r\n  | where EventType in ('RegistryValueSet', 'RegistryKeyCreated') \r\n  | where RegistryKey has_any (windowsUpdateRegistryList) \r\n  | where RegistryValue has_any ('AUOptions', 'NoAutoUpdate') and RegistryValueData == '1'\r\n  | project\r\n      TimeGenerated,\r\n      DvcHostname,\r\n      ActorUsername,\r\n      ActorUsernameType,\r\n      ActingProcessId,\r\n      ActingProcessName,\r\n      ActingProcessCommandLine,\r\n      RegistryKey,\r\n      RegistryValue,\r\n      RegistryValueType,\r\n      RegistryValueData",
              "size": 0,
              "title": "Windows Update Disabled Devices {TimeRange}",
              "noDataMessage": "No Data for given Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "RegistryActivity-WindowsUpdate1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "  let firewallRegistryList = dynamic([\r\n        'HKEY_LOCAL_MACHINE\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\SharedAccess\\\\Parameters\\\\FirewallPolicy\\\\RestrictedServices\\\\Static\\\\System',\r\n        'HKEY_LOCAL_MACHINE\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\SharedAccess\\\\Parameters\\\\FirewallPolicy\\\\RestrictedServices\\\\Configurable\\\\System',\r\n        'HKEY_LOCAL_MACHINE\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\SharedAccess\\\\Defaults\\\\FirewallPolicy\\\\FirewallRules',\r\n        'HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\WindowsFirewall'\r\n    ]);\r\n  imRegistry\r\n  | where EventType in ('RegistryValueSet', 'RegistryKeyCreated') \r\n  | where RegistryKey has_any (firewallRegistryList) and RegistryValueData has_all ('Action=Allow', 'Active=TRUE')\r\n  | project\r\n      TimeGenerated,\r\n      DvcHostname,\r\n      ActorUsername,\r\n      ActorUsernameType,\r\n      ActingProcessId,\r\n      ActingProcessName,\r\n      ActingProcessCommandLine,\r\n      RegistryKey,\r\n      RegistryValue,\r\n      RegistryValueType,\r\n      RegistryValueData",
              "size": 0,
              "title": "Windows Firewall Allow Rule Addition Events {TimeRange}",
              "noDataMessage": "No Data for given Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "RegistryActivity-WindowsFirewall1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "  let firewallRegistryList = dynamic([\r\n        'HKEY_LOCAL_MACHINE\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\SharedAccess\\\\Parameters\\\\FirewallPolicy\\\\RestrictedServices\\\\Static\\\\System',\r\n        'HKEY_LOCAL_MACHINE\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\SharedAccess\\\\Parameters\\\\FirewallPolicy\\\\RestrictedServices\\\\Configurable\\\\System',\r\n        'HKEY_LOCAL_MACHINE\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\SharedAccess\\\\Defaults\\\\FirewallPolicy\\\\FirewallRules',\r\n        'HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\WindowsFirewall'\r\n    ]);\r\n  imRegistry\r\n  | where EventType in ('RegistryValueSet', 'RegistryKeyCreated') \r\n  | where RegistryKey has_any (firewallRegistryList) and RegistryValueData has_all ('Action=Allow', 'Active=TRUE')\r\n  | project\r\n      TimeGenerated,\r\n      DvcHostname,\r\n      ActorUsername,\r\n      ActorUsernameType,\r\n      ActingProcessId,\r\n      ActingProcessName,\r\n      ActingProcessCommandLine,\r\n      RegistryKey,\r\n      RegistryValue,\r\n      RegistryValueType,\r\n      RegistryValueData\r\n| summarize Count=count() by DvcHostname\r\n| take 10",
              "size": 0,
              "title": "Top 10 Devices with Most Windows Firewall Allow Rule Addition {TimeRange}",
              "noDataMessage": "No Data for given Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "customWidth": "50",
            "name": "RegistryActivity-WindowsFirewall2",
            "styleSettings": {
              "maxWidth": "50%"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "  let firewallRegistryList = dynamic([\r\n        'HKEY_LOCAL_MACHINE\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\SharedAccess\\\\Parameters\\\\FirewallPolicy\\\\RestrictedServices\\\\Static\\\\System',\r\n        'HKEY_LOCAL_MACHINE\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\SharedAccess\\\\Parameters\\\\FirewallPolicy\\\\RestrictedServices\\\\Configurable\\\\System',\r\n        'HKEY_LOCAL_MACHINE\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\SharedAccess\\\\Defaults\\\\FirewallPolicy\\\\FirewallRules',\r\n        'HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\WindowsFirewall'\r\n    ]);\r\n  imRegistry\r\n  | where EventType in ('RegistryValueSet', 'RegistryKeyCreated') \r\n  | where RegistryKey has_any (firewallRegistryList) and RegistryValueData has_all ('Action=Allow', 'Active=TRUE')\r\n  | project\r\n      TimeGenerated,\r\n      DvcHostname,\r\n      ActorUsername,\r\n      ActorUsernameType,\r\n      ActingProcessId,\r\n      ActingProcessName,\r\n      ActingProcessCommandLine,\r\n      RegistryKey,\r\n      RegistryValue,\r\n      RegistryValueType,\r\n      RegistryValueData\r\n| summarize Count=count() by ActorUsername\r\n| take 10",
              "size": 0,
              "title": "Top 10 Users to add Windows Firewall Allow Rule {TimeRange}",
              "noDataMessage": "No Data for given Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "customWidth": "50",
            "name": "RegistryActivity-WindowsFirewall2 - Copy",
            "styleSettings": {
              "maxWidth": "50%"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Registry"
      },
      "name": "groupRegistry"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "imProcessEvent\r\n  | where EventType == 'ProcessCreated'\r\n  | extend CommandLineArgs = todynamic(array_slice(split(CommandLine, \" \"), 1, -1))\r\n  | where strlen(CommandLineArgs) > 0\r\n  | mv-apply CommandLineArgs on \r\n      (\r\n      where CommandLineArgs contains \"base64\"\r\n      )\r\n  | project\r\n      TimeGenerated,\r\n      DvcHostname,\r\n      DvcIpAddr,\r\n      DvcDomain,\r\n      TargetUsername,\r\n      TargetProcessName,\r\n      CommandLine",
              "size": 0,
              "title": "List of Suspicious Processes Created with Base64 CommandLine Argumnet {TimeRange}",
              "noDataMessage": "No Data for this Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "ProcessActivity-SuspiciousProcess1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "imProcessEvent\r\n| where EventType == 'ProcessCreated'\r\n| extend CommandLineArgs = todynamic(array_slice(split(CommandLine, \" \"), 1, -1))\r\n| where strlen(CommandLineArgs) > 0\r\n| mv-apply CommandLineArgs on \r\n    (\r\n    where CommandLineArgs contains \"base64\"\r\n    )\r\n| project\r\n    TimeGenerated,\r\n    DvcHostname,\r\n    DvcIpAddr,\r\n    DvcDomain,\r\n    TargetUsername,\r\n    TargetProcessName,\r\n    CommandLine\r\n| summarize Count=count() by DvcHostname\r\n| top 10 by Count ",
              "size": 0,
              "title": "Top 10 Devices with Suspicious Process {TimeRange}",
              "noDataMessage": "No Data for this Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "customWidth": "50",
            "name": "ProcessActivity-SuspiciousProcess2",
            "styleSettings": {
              "margin": "50",
              "padding": "50"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "imProcessEvent\r\n| where EventType == 'ProcessCreated'\r\n| extend CommandLineArgs = todynamic(array_slice(split(CommandLine, \" \"), 1, -1))\r\n| where strlen(CommandLineArgs) > 0\r\n| mv-apply CommandLineArgs on \r\n    (\r\n    where CommandLineArgs contains \"base64\"\r\n    )\r\n| project\r\n    TimeGenerated,\r\n    DvcHostname,\r\n    DvcIpAddr,\r\n    DvcDomain,\r\n    TargetUsername,\r\n    TargetProcessName,\r\n    CommandLine\r\n| summarize Count=count() by TargetProcessName\r\n| top 10 by Count ",
              "size": 0,
              "title": "Top 10 Processes with Suspicious CommandLine {TimeRange}",
              "noDataMessage": "No Data for this Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "customWidth": "50",
            "name": "RegistryActivity-SuspiciousProcess3",
            "styleSettings": {
              "margin": "50",
              "padding": "50"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": " imProcessEvent\r\n  | where TargetProcessFilename has_any ('vssadmin.exe', 'wbadmin.exe', 'wmic.exe')\r\n  | where CommandLine has_all ('delete', 'shadow')\r\n  | union isfuzzy=True \r\n      (imProcess\r\n      | where TargetProcessFilename =~ 'bcedit.exe'\r\n      | where CommandLine has_all ('/set', 'recoveryenabled no')\r\n      )\r\n  | project\r\n      TimeGenerated,\r\n      DvcHostname,\r\n      DvcIpAddr,\r\n      DvcDomain,\r\n      TargetUsername,\r\n      TargetProcessName,\r\n      CommandLine,\r\n      ParentProcessName",
              "size": 0,
              "title": "List of Backup Deletion Acitivties using LOL Binaries {TimeRange}",
              "noDataMessage": "No Data for this Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "ProcessActivity-BackupDeletion1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "imProcessEvent\r\n| where TargetProcessFilename has_any ('vssadmin.exe', 'wbadmin.exe', 'wmic.exe')\r\n| where CommandLine has_all ('delete', 'shadow')\r\n| union isfuzzy=True \r\n    (imProcess\r\n    | where TargetProcessFilename =~ 'bcedit.exe'\r\n    | where CommandLine has_all ('/set', 'recoveryenabled no')\r\n    )\r\n| project\r\n    TimeGenerated,\r\n    DvcHostname,\r\n    DvcIpAddr,\r\n    DvcDomain,\r\n    TargetUsername,\r\n    TargetProcessName,\r\n    CommandLine,\r\n    ParentProcessName\r\n| summarize Count=count() by DvcHostname\r\n| top 10 by Count ",
              "size": 0,
              "title": "Top 10 Devices with Most Backup Deletion Activity {TimeRange}",
              "noDataMessage": "No Data for this Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "name": "ProcessActivity-BackupDeletion2",
            "styleSettings": {
              "margin": "50",
              "padding": "50"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let fileLocations = dynamic([\r\n      '\\\\AppData\\\\Local\\\\Temp\\\\',\r\n      '\\\\Recycle Bin\\\\'\r\n      ]);\r\nimProcessEvent\r\n| where EventType == 'ProcessCreated' and TargetProcessName has_any (fileLocations)\r\n| project\r\n      TimeGenerated,\r\n      TargetUsername,\r\n      TargetProcessName,\r\n      CommandLine,\r\n      ParentProcessName,\r\n      DvcHostname,\r\n      DvcIpAddr,\r\n      DvcDomain",
              "size": 0,
              "title": "List of Processes Started from Unusual Locations {TimeRange}",
              "noDataMessage": "No Data for this Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "ProcessActivity-MaliciousProcessLocation1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let fileLocations = dynamic([\r\n      '\\\\AppData\\\\Local\\\\Temp\\\\',\r\n      '\\\\Recycle Bin\\\\'\r\n      ]);\r\nimProcessEvent\r\n| where EventType == 'ProcessCreated' and TargetProcessName has_any (fileLocations)\r\n| project\r\n      TimeGenerated,\r\n      TargetUsername,\r\n      TargetProcessName,\r\n      CommandLine,\r\n      ParentProcessName,\r\n      DvcHostname,\r\n      DvcIpAddr,\r\n      DvcDomain\r\n| summarize Count=count() by DvcHostname\r\n| top 10 by Count",
              "size": 0,
              "title": "Top 10 Devices where Processes Started from Unusual Locations {TimeRange}",
              "noDataMessage": "No Data for this Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "name": "ProcessActivity-MaliciousProcessLocation2"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Process"
      },
      "name": "groupProcess"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "  // List of startup folders to monitor\r\n  let startupFolderList = dynamic([\r\n      '\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\',\r\n      '\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\',\r\n      '/etc/init.d/',\r\n      '/etc/rc.d/',\r\n      '/etc/cron.d/'\r\n    ]);\r\n  imFileEvent\r\n  | where ActionType == 'FileCreated'\r\n  | where FolderPath has_any (startupFolderList)\r\n  | project FileName, FilePath, DvcHostname, DvcDomain, User, DvcId, TenantId, Process, CommandLine",
              "size": 0,
              "title": "Files Created in Startup Folders {TimeRange}",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "FileActivity-Startup1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "  // List of startup folders to monitor\r\n  let startupFolderList = dynamic([\r\n      '\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\',\r\n      '\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\',\r\n      '/etc/init.d/',\r\n      '/etc/rc.d/',\r\n      '/etc/cron.d/'\r\n    ]);\r\n  imFileEvent\r\n  | where ActionType == 'FileCreated'\r\n  | where FolderPath has_any (startupFolderList)\r\n  | project FileName, FilePath, DvcHostname, DvcId, TenantId, Process, CommandLine\r\n  | summarize Count=count() by DvcHostname\r\n  | top 10 by Count",
              "size": 0,
              "title": "Top 10 Hosts where Files Created in Startup Folders {TimeRange}",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "unstackedbar"
            },
            "customWidth": "50",
            "name": "FileActivity-Startup2",
            "styleSettings": {
              "maxWidth": "50%"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "  // List of startup folders to monitor\r\n  let startupFolderList = dynamic([\r\n      '\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\',\r\n      '\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\',\r\n      '/etc/init.d/',\r\n      '/etc/rc.d/',\r\n      '/etc/cron.d/'\r\n    ]);\r\n  imFileEvent\r\n  | where ActionType == 'FileCreated'\r\n  | where FolderPath has_any (startupFolderList)\r\n  | project FileName, FilePath, DvcHostname, DvcId, TenantId, Process, CommandLine, ActorUsername\r\n  | summarize Count=count() by ActorUsername\r\n  | top 10 by Count",
              "size": 0,
              "title": "Top 10 Accounts to Create Files in Startup Folders {TimeRange}",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "customWidth": "50",
            "name": "FileActivity-Startup3",
            "styleSettings": {
              "maxWidth": "50%"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "imFileEvent\r\n| where EventType in ('FileCreated', 'FileModified')\r\n| where FilePath has '\\\\Windows\\\\System32\\\\Tasks'\r\n| extend CommandLineArgs = todynamic(array_slice(split(CommandLine, \" \"), 1, -1))\r\n  | where strlen(CommandLineArgs) > 0\r\n  | mv-apply CommandLineArgs on \r\n      (\r\n      where CommandLineArgs contains \"base64\"\r\n      )\r\n| project TimeGenerated, DvcHostname, DvcDomain, User, Process, CommandLine, FileName, FilePath\r\n",
              "size": 0,
              "title": "List of Scheduled Task Created with Encoded Command {TimeRange}",
              "noDataMessage": "No Data for Given Time Range",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "FileActivity-ScheduledTask1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "imFileEvent\r\n| where EventType in ('FileCreated', 'FileModified')\r\n| where FilePath has '\\\\Windows\\\\System32\\\\Tasks'\r\n| extend CommandLineArgs = todynamic(array_slice(split(CommandLine, \" \"), 1, -1))\r\n  | where strlen(CommandLineArgs) > 0\r\n  | mv-apply CommandLineArgs on \r\n      (\r\n      where CommandLineArgs contains \"base64\"\r\n      )\r\n| project TimeGenerated, DvcHostname, DvcDomain, User, Process, CommandLine, FileName, FilePath\r\n| summarize Count=count() by Process\r\n| top 10 by Count",
              "size": 0,
              "title": "Top 10 Processes Creating Scheduled Task with Encoded Command {TimeRange}",
              "noDataMessage": "No Data for given Time Range",
              "timeContext": {
                "durationMs": 86400000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "customWidth": "50",
            "name": "FileActivity-ScheduledTask2",
            "styleSettings": {
              "maxWidth": "50"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "imFileEvent\r\n| where EventType in ('FileCreated', 'FileModified')\r\n| where FilePath has '\\\\Windows\\\\System32\\\\Tasks'\r\n| extend CommandLineArgs = todynamic(array_slice(split(CommandLine, \" \"), 1, -1))\r\n  | where strlen(CommandLineArgs) > 0\r\n  | mv-apply CommandLineArgs on \r\n      (\r\n      where CommandLineArgs contains \"base64\"\r\n      )\r\n| project TimeGenerated, DvcHostname, DvcDomain, User, Process, CommandLine, FileName, FilePath\r\n| summarize Count=count() by User\r\n| top 10 by Count",
              "size": 0,
              "title": "Top 10 Users Creating Scheduled Task with Encoded Command{TimeRange}",
              "noDataMessage": "No Data for given Time Range",
              "timeContext": {
                "durationMs": 86400000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "customWidth": "50",
            "name": "FileActivity-ScheduledTask3",
            "styleSettings": {
              "maxWidth": "50"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "File"
      },
      "name": "groupFile"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}