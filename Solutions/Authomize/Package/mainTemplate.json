{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Authomize - support@authomize.com",
    "comments": "Solution template for Authomize ITDR Solution"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    }
  },
  "variables": {
    "solutionId": ".",
    "_solutionId": "[variables('solutionId')]",
    "email": "support@authomize.com",
    "_email": "[variables('email')]",
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "AuthomizeWorkbook": "AuthomizeWorkbook",
    "_AuthomizeWorkbook": "[variables('AuthomizeWorkbook')]",
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "parserVersion1": "1.0.0",
    "parserContentId1": "Admin_SaaS_account_detected-Parser",
    "_parserContentId1": "[variables('parserContentId1')]",
    "huntingQueryVersion1": "1.0.0",
    "huntingQuerycontentId1": "bf03796a-3ed7-440f-bfc3-0c702cf762a9",
    "_huntingQuerycontentId1": "[variables('huntingQuerycontentId1')]",
    "huntingQueryVersion2": "1.0.0",
    "huntingQuerycontentId2": "ab80b41c-23e5-4264-ac23-806aad2a57af",
    "_huntingQuerycontentId2": "[variables('huntingQuerycontentId2')]",
    "huntingQueryVersion3": "1.0.0",
    "huntingQuerycontentId3": "fad675f5-b743-40c6-873d-019de93f18db",
    "_huntingQuerycontentId3": "[variables('huntingQuerycontentId3')]",
    "huntingQueryVersion4": "1.0.0",
    "huntingQuerycontentId4": "485e7cab-131e-40ce-9482-791e681b7967",
    "_huntingQuerycontentId4": "[variables('huntingQuerycontentId4')]",
    "huntingQueryVersion5": "1.0.0",
    "huntingQuerycontentId5": "7457a420-8c28-4ce2-a55e-d050e5a6bc4f",
    "_huntingQuerycontentId5": "[variables('huntingQuerycontentId5')]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2021-08-01",
      "metadata": {},
      "properties": {
        "displayName": "[parameters('workbook1-name')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<a href=\\\"https://www.authomize.com/\\\" target=\\\"_blank\\\">\\n<img width=\\\"211\\\" src=\\\"https://www.authomize.com/wp-content/themes/authomize/img/automize logo_horizontal authomize logo on white.svg\\\"/>\\n</a>\\n# Authomize ITDR\\n---\"},\"name\":\"text - 2\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=_TableName Authomize_v2_CL\\n| where TimeGenerated > ago(5d)\\n| summarize Count=count() by TimeGenerated\\n| render barchart\\n\",\"size\":1,\"title\":\"Event Processing from Authomize tenant\",\"color\":\"green\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"chartSettings\":{\"group\":\"TimeGenerated\"}},\"name\":\"Check Events\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=_TableName Authomize_v2_CL\\n| summarize Count=count() by Category\",\"size\":0,\"title\":\"Event Category\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Category\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Category\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"mapSettings\":{\"locInfo\":\"LatLong\"}},\"name\":\"query - 7\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Events to Process\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=_TableName Authomize_v2_CL\\n| summarize Count=count() by severity_s\\n| render piechart\",\"size\":2,\"title\":\"Events by Severity\",\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"severity_s\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"showLegend\":true,\"ySettings\":{\"numberFormatSettings\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"customWidth\":\"50\",\"name\":\"query - 3\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=_TableName Authomize_v2_CL\\n| extend Policy = policy_name_s\\n| extend Severity = severity_s\\n| extend Description = description_s\\n| extend Recommendation = recommendation_s\\n| extend URL = url_s\\n| extend Tactics = tactics_s\\n//| where policy_name_s contains tostring(this_event)\\n| project  Policy, Severity, Description, Recommendation, URL, Category, Tactics\",\"size\":2,\"title\":\"Events\",\"timeContext\":{\"durationMs\":259200000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"URL\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}},{\"columnMatch\":\"url_s\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}}],\"rowLimit\":1000}},\"customWidth\":\"50\",\"name\":\"query - 6\",\"styleSettings\":{\"maxWidth\":\"50\",\"showBorder\":true}}]},\"name\":\"EventsToProcess\"},{\"type\":1,\"content\":{\"json\":\"# Select an Event Type\"},\"name\":\"text - 5\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Events Grouped\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=_TableName Authomize_v2_CL\\n| extend Event_Type = policy_name_s\\n| summarize Count = count() by Event_Type\",\"size\":0,\"timeContext\":{\"durationMs\":604800000},\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"Event_Type\",\"parameterName\":\"theEventType\"}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"Grouped Events\",\"styleSettings\":{\"maxWidth\":\"50\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let the_Event=dynamic({theEventType});\\nunion withsource=_TableName Authomize_v2_CL\\n| extend Severity = severity_s\\n| extend Description = description_s\\n| extend Recommendation = recommendation_s\\n| extend URL = url_s\\n| where policy_name_s contains tostring(the_Event)\\n| project Severity, Description, Recommendation, URL, Category\",\"size\":0,\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"URL\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}}]}},\"customWidth\":\"50\",\"name\":\"query - 5\",\"styleSettings\":{\"maxWidth\":\"50\"}}]},\"name\":\"MultiSelect\",\"styleSettings\":{\"showBorder\":true}}],\"styleSettings\":{\"paddingStyle\":\"narrow\",\"spacingStyle\":\"narrow\"},\"fromTemplateId\":\"sentinel-AuthomizeWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2021-06-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Authomize ITDR Solution Hunting Query 1",
          "location": "[parameters('workspace-location')]",
          "properties": {
            "eTag": "*",
            "displayName": "Lateral Movement Risk - Role Chain Length",
            "category": "Hunting Queries",
            "query": "Authomize_v2_CL\n| extend EventID = id_s, Policy = policy_name_s, Severity = severity_s,Description = description_s,Recommendation = recommendation_s,URL = url_s,Tactics = tactics_s\n| where Policy has \"Chain of 3 or more roles\"\n| project EventID, Policy, Severity, Description, Recommendation, URL, Category, Tactics\n| extend CloudApplication_0_Name = Policy\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "detects chains of more than 3 roles in the account, this is a misconfiguration that can enable lateral movement."
              },
              {
                "name": "tactics",
                "value": "PrivilegeEscalation"
              },
              {
                "name": "techniques",
                "value": "T1089"
              }
            ]
          },
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ]
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Authomize ITDR Solution Hunting Query 2",
          "location": "[parameters('workspace-location')]",
          "properties": {
            "eTag": "*",
            "displayName": "IaaS admin detected",
            "category": "Hunting Queries",
            "query": "Authomize_v2_CL\n| extend EventID = id_s, Policy = policy_name_s, Severity = severity_s,Description = description_s,Recommendation = recommendation_s,URL = url_s,Tactics = tactics_s\n| where Policy has \"IaaS admin detected\"\n| project EventID, Policy, Severity, Description, Recommendation, URL, Category, Tactics\n| extend CloudApplication_0_Name = Policy\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "detects admin users in AWS or Azure."
              },
              {
                "name": "tactics",
                "value": "PrivilegeEscalation"
              },
              {
                "name": "techniques",
                "value": "T1089"
              }
            ]
          },
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ]
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Authomize ITDR Solution Hunting Query 3",
          "location": "[parameters('workspace-location')]",
          "properties": {
            "eTag": "*",
            "displayName": "IaaS shadow admin detected",
            "category": "Hunting Queries",
            "query": "Authomize_v2_CL\n| extend EventID = id_s, Policy = policy_name_s, Severity = severity_s,Description = description_s,Recommendation = recommendation_s,URL = url_s,Tactics = tactics_s\n| where Policy has \"IaaS shadow admin detected\"\n| project EventID, Policy, Severity, Description, Recommendation, URL, Category, Tactics\n| extend CloudApplication_0_Name = Policy\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "detects shadow admin users in AWS or Azure."
              },
              {
                "name": "tactics",
                "value": "PrivilegeEscalation"
              },
              {
                "name": "techniques",
                "value": "T1089"
              }
            ]
          },
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ]
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Authomize ITDR Solution Hunting Query 4",
          "location": "[parameters('workspace-location')]",
          "properties": {
            "eTag": "*",
            "displayName": "Password Exfiltration over SCIM application",
            "category": "Hunting Queries",
            "query": "Authomize_v2_CL\n| extend EventID = id_s, Policy = policy_name_s, Severity = severity_s,Description = description_s,Recommendation = recommendation_s,URL = url_s,Tactics = tactics_s\n| where Policy has \"Password Exfiltration over SCIM\"\n| project EventID, Policy, Severity, Description, Recommendation, URL, Category, Tactics\n| extend CloudApplication_0_Name = Policy\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "detects suspicious sync events that occurred to applications using SCIM for user provisioning."
              },
              {
                "name": "tactics",
                "value": "CredentialAccess"
              },
              {
                "name": "techniques",
                "value": "T1555,T1040,T1552,T1555.003,T1552.005"
              }
            ]
          },
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ]
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Authomize ITDR Solution Hunting Query 5",
          "location": "[parameters('workspace-location')]",
          "properties": {
            "eTag": "*",
            "displayName": "Privileged Machines Exposed to the Internet",
            "category": "Hunting Queries",
            "query": "Authomize_v2_CL\n| extend EventID = id_s, Policy = policy_name_s, Severity = severity_s,Description = description_s,Recommendation = recommendation_s,URL = url_s,Tactics = tactics_s\n| where Policy has \"Privileged Machines Exposed to the Internet\"\n| project EventID, Policy, Severity, Description, Recommendation, URL, Category, Tactics\n| extend CloudApplication_0_Name = Policy\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "detects AWS instances which are exposed to the internet and can assume privileged roles. This is a default definition by Authomize and can be updated using the edit model."
              },
              {
                "name": "tactics",
                "value": "Discovery"
              },
              {
                "name": "techniques",
                "value": "T1613"
              }
            ]
          },
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ]
        }
      ]
    }
  ],
  "outputs": {}
}
