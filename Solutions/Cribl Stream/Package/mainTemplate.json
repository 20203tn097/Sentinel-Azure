{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Cribl - tap@cribl.io",
    "comments": "Solution template for Cribl Stream"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "email": "tap@cribl.io",
    "_email": "[variables('email')]",
    "_solutionName": "Azure Sentinel Solution for Cribl Stream",
    "_solutionVersion": "1.0.0",
    "solutionId": "azure-sentinel-solution-criblstream",
    "_solutionId": "[variables('solutionId')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",    
    "uiConfigId1": "CriblStream",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "CriblStream",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1'))))]",
    "dataConnectorVersion1": "1.0.0",
    "_dataConnectorcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentId1'),'-', variables('dataConnectorVersion1'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "properties": {
        "description": "Cribl Stream connector with template",
        "displayName": "Cril Stream template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('dataConnectorTemplateSpecName1'),'/',variables('dataConnectorVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('dataConnectorTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "Cribl Stream connector with template version 1.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "StaticUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "Cribl Stream",
                  "publisher": "Any",
                  "descriptionMarkdown": "Common Event Format (CEF) is an industry standard format on top of Syslog messages, used by many security vendors to allow event interoperability among different platforms. By connecting your CEF logs to Microsoft Sentinel, you can take advantage of search & correlation, alerting, and threat intelligence enrichment for each log. For more information, see the [Microsoft Sentinel documentation](https://go.microsoft.com/fwlink/p/?linkid=2223902&wt.mc_id=sentinel_dataconnectordocs_content_cnl_csasci).",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "\nCommonSecurityLog​ \n| where DeviceVendor !in (\"Cisco\",\"Check Point\",\"Palo Alto Networks\",\"Fortinet\",\"F5\",\"Barracuda\",\"ExtraHop\",\"OneIdentity\",\"Zscaler\", \"ForgeRock Inc\", \"CyberArk\", \"illusive\", \"Vectra Networks\", \"Citrix\")\n"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "\nCommonSecurityLog​ \n| where DeviceVendor !in (\"Cisco\",\"Check Point\",\"Palo Alto Networks\",\"Fortinet\",\"F5\",\"Barracuda\",\"ExtraHop\",\"OneIdentity\",\"Zscaler\", \"ForgeRock Inc\", \"CyberArk\", \"illusive\", \"Vectra Networks\", \"Citrix\")\n\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "\nCommonSecurityLog​ \n| where DeviceVendor !in (\"Cisco\",\"Check Point\",\"Palo Alto Networks\",\"Fortinet\",\"F5\",\"Barracuda\",\"ExtraHop\",\"OneIdentity\",\"Zscaler\", \"ForgeRock Inc\", \"CyberArk\", \"illusive\", \"Vectra Networks\", \"Citrix\")\n\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cribl Stream",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Cribl",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Community",
                  "name": "Cribl",
                  "link": "https://cribl.io/support",
                  "email": "support@cribl.io"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Cribl Stream",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Cribl",
          "email": "[variables('_email')]"
        },
        "support": {
          "tier": "Cribl",
          "name": "Cribl Stream",
          "link": "https://cribl.io/support",
          "email": "support@cribl.io"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Cribl Stream connector with template version 1.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "StaticUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "Cribl Stream Connection.",
                  "publisher": "Any",
                  "descriptionMarkdown": "Cribl Stream connection for collecting data into Micorsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "\nCommonSecurityLog​ \n| where DeviceVendor !in (\"Cisco\",\"Check Point\",\"Palo Alto Networks\",\"Fortinet\",\"F5\",\"Barracuda\",\"ExtraHop\",\"OneIdentity\",\"Zscaler\", \"ForgeRock Inc\", \"CyberArk\", \"illusive\", \"Vectra Networks\", \"Citrix\")\n"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "\nCommonSecurityLog​ \n| where DeviceVendor !in (\"Cisco\",\"Check Point\",\"Palo Alto Networks\",\"Fortinet\",\"F5\",\"Barracuda\",\"ExtraHop\",\"OneIdentity\",\"Zscaler\", \"ForgeRock Inc\", \"CyberArk\", \"illusive\", \"Vectra Networks\", \"Citrix\")\n\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(3d)"
                      ]
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "\nCommonSecurityLog​ \n| where DeviceVendor !in (\"Cisco\",\"Check Point\",\"Palo Alto Networks\",\"Fortinet\",\"F5\",\"Barracuda\",\"ExtraHop\",\"OneIdentity\",\"Zscaler\", \"ForgeRock Inc\", \"CyberArk\", \"illusive\", \"Vectra Networks\", \"Citrix\")\n\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2023-04-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cribl Stream",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Cribl",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Community",
                  "name": "Cribl",
                  "link": "https://cribl.io/support",
                  "email": "support@cribl.io"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "1.0.0",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "contentKind": "DataConnector",
        "displayName": "Cribl Stream",
        "contentProductId": "[variables('_dataConnectorcontentProductId1')]",
        "id": "[variables('_dataConnectorcontentProductId1')]",
        "version": "[variables('dataConnectorVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Cribl Stream",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Cribl",
          "email": "[variables('_email')]"
        },
        "support": {
          "tier": "Community",
          "name": "Cribl",
          "link": "https://cribl.io/support",
          "email": "support@cribl.io"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "StaticUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Cribl Stream",
          "publisher": "Any",
          "descriptionMarkdown": "Common Event Format (CEF) is an industry standard format on top of Syslog messages, used by many security vendors to allow event interoperability among different platforms. By connecting your CEF logs to Microsoft Sentinel, you can take advantage of search & correlation, alerting, and threat intelligence enrichment for each log. For more information, see the [Microsoft Sentinel documentation](https://go.microsoft.com/fwlink/p/?linkid=2223902&wt.mc_id=sentinel_dataconnectordocs_content_cnl_csasci).",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "CommonSecurityLog",
              "baseQuery": "\nCommonSecurityLog​ \n| where DeviceVendor !in (\"Cisco\",\"Check Point\",\"Palo Alto Networks\",\"Fortinet\",\"F5\",\"Barracuda\",\"ExtraHop\",\"OneIdentity\",\"Zscaler\", \"ForgeRock Inc\", \"CyberArk\", \"illusive\", \"Vectra Networks\", \"Citrix\")\n"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "\nCommonSecurityLog​ \n| where DeviceVendor !in (\"Cisco\",\"Check Point\",\"Palo Alto Networks\",\"Fortinet\",\"F5\",\"Barracuda\",\"ExtraHop\",\"OneIdentity\",\"Zscaler\", \"ForgeRock Inc\", \"CyberArk\", \"illusive\", \"Vectra Networks\", \"Citrix\")\n\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "\nCommonSecurityLog​ \n| where DeviceVendor !in (\"Cisco\",\"Check Point\",\"Palo Alto Networks\",\"Fortinet\",\"F5\",\"Barracuda\",\"ExtraHop\",\"OneIdentity\",\"Zscaler\", \"ForgeRock Inc\", \"CyberArk\", \"illusive\", \"Vectra Networks\", \"Citrix\")\n\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(3d)"
              ]
            }
          ],
          "id": "[variables('_uiConfigId1')]"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "1.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "1.0.0",
        "displayName": "Cribl Stream",
        "publisherDisplayName": "Microsoft Sentinel, Cribl",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Cribl%20Stream/ReleaseNotes.md\">\">Release Notes</a></p>\n<p>• There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Cribl-Logo.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Cribl Stream",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Cribl",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Cribl",
          "email": "support@cribl.io",
          "tier": "Community",
          "link": "https://cribl.io/support"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
                        {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            }
          ]
        },
        "firstPublishDate": "2024-07-18",
        "providers": [
          "Cribl"
        ],
        "categories": {
          "domains": [
            "Security"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}