{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "connections_keyvault_name": {
      "defaultValue": "keyvault",
      "type": "String",
      "metadata": {
        "description": "TODO"
      }
    },
    "connections_service_now_name": {
      "defaultValue": "service-now",
      "type": "String",
      "metadata": {
        "description": "TODO"
      }
    },
    "workflows_UploadLogs_API_name": {
      "defaultValue": "UploadLogs_API",
      "type": "String",
      "metadata": {
        "description": "TODO"
      }
    },
    "connections_azuresentinel_name": {
      "defaultValue": "azuresentinel",
      "type": "String",
      "metadata": {
        "description": "TODO"
      }
    },
    "workflows_UpdateSeviceNow_Alert_name": {
      "defaultValue": "UpdateSeviceNow-Alert",
      "type": "String",
      "metadata": {
        "description": "TODO"
      }
    },
    "components_TestServiceNowConnection_name": {
      "defaultValue": "ServiceNowConnection",
      "type": "String",
      "metadata": {
        "description": "TODO"
      }
    },
    "components_Create_Sentinel_Incidents_name": {
      "defaultValue": "Create-Sentinel-Incidents",
      "type": "String",
      "metadata": {
        "description": "TODO"
      }
    },
    "connections_azureloganalyticsdatacollector_name": {
      "defaultValue": "azureloganalyticsdatacollector",
      "type": "String",
      "metadata": {
        "description": "TODO"
      }
    },
    "actionGroups_Application_Insights_Smart_Detection_name": {
      "defaultValue": "Application Insights Smart Detection",
      "type": "String",
      "metadata": {
        "description": "TODO"
      }
    },
    "iso8601": {
      "defaultValue": "[dateTimeToEpoch(dateTimeAdd(utcNow(), 'P1Y'))]",
      "type": "int",
      "metadata": {
        "description": "TODO"
      }
    }
  },
  "variables": {
    "solutionId": "praas.misa_mss",
    "_solutionId": "[variables('solutionId')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "uiConfigId1": "PRAAS",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "vaultName": "[toLower( concat( 'PRAAS-KV-', parameters('iso8601') ) )]",
    "tenantID": "[subscription().tenantId]"
  },
  "resources": [
    {
      "type": "microsoft.insights/actionGroups",
      "apiVersion": "2023-01-01",
      "name": "[parameters('actionGroups_Application_Insights_Smart_Detection_name')]",
      "location": "Global",
      "properties": {
        "groupShortName": "SmartDetect",
        "enabled": true,
        "emailReceivers": [],
        "smsReceivers": [],
        "webhookReceivers": [],
        "eventHubReceivers": [],
        "itsmReceivers": [],
        "azureAppPushReceivers": [],
        "automationRunbookReceivers": [],
        "voiceReceivers": [],
        "logicAppReceivers": [],
        "azureFunctionReceivers": [],
        "armRoleReceivers": [
          {
            "name": "Monitoring Contributor",
            "roleId": "749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "useCommonAlertSchema": true
          },
          {
            "name": "Monitoring Reader",
            "roleId": "43d0d8ad-25c7-4714-9337-8ba259a9fe05",
            "useCommonAlertSchema": true
          }
        ]
      }
    },
    {
      "type": "microsoft.insights/components",
      "apiVersion": "2020-02-02",
      "name": "[parameters('components_Create_Sentinel_Incidents_name')]",
      "location": "[parameters('workspace-location')]",
      "kind": "web",
      "properties": {
        "Application_Type": "web",
        "Flow_Type": "Bluefield",
        "Request_Source": "rest",
        "RetentionInDays": 90,
        "WorkspaceResourceId": "[variables('workspaceResourceId')]",
        "IngestionMode": "LogAnalytics",
        "publicNetworkAccessForIngestion": "Enabled",
        "publicNetworkAccessForQuery": "Enabled"
      }
    },
    {
      "type": "microsoft.insights/components",
      "apiVersion": "2020-02-02",
      "name": "[parameters('components_TestServiceNowConnection_name')]",
      "location": "[parameters('workspace-location')]",
      "kind": "web",
      "properties": {
        "Application_Type": "web",
        "Flow_Type": "Bluefield",
        "Request_Source": "rest",
        "RetentionInDays": 90,
        "WorkspaceResourceId": "[variables('workspaceResourceId')]",
        "IngestionMode": "LogAnalytics",
        "publicNetworkAccessForIngestion": "Enabled",
        "publicNetworkAccessForQuery": "Enabled"
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-02-01",
      "name": "[variables('vaultName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "sku": {
          "family": "A",
          "name": "Standard"
        },
        "tenantId": "[variables('tenantID')]",
        "accessPolicies": [
          {
            "tenantId": "[variables('tenantID')]",
            "objectId": "[reference(resourceId('Microsoft.Logic/workflows', parameters('workflows_UploadLogs_API_name')), '2019-05-01', 'full').identity.principalId]",
            "permissions": {
              "certificates": [],
              "keys": [],
              "secrets": [
                "get",
                "list"
              ]
            }
          }
        ],
        "enableSoftDelete": true,
        "softDeleteRetentionInDays": 90,
        "enableRbacAuthorization": false,
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.OperationsManagement/solutions",
      "apiVersion": "2015-11-01-preview",
      "name": "[concat( 'SecurityInsights(', parameters('workspace'), ')' )]",
      "location": "[parameters('workspace-location')]",
      "plan": {
        "name": "[concat( 'SecurityInsights(', parameters('workspace'), ')' )]",
        "promotionCode": "",
        "product": "OMSGallery/SecurityInsights",
        "publisher": "Microsoft"
      },
      "properties": {
        "WorkspaceResourceId": "[variables('workspaceResourceId')]"
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[parameters('connections_azureloganalyticsdatacollector_name')]",
      "location": "[parameters('workspace-location')]",
      "kind": "V1",
      "properties": {
        "displayName": "Log analytics data connector",
        "statuses": [
          {
            "status": "Connected"
          }
        ],
        "customParameterValues": {},
        "nonSecretParameterValues": {
          "username": "d1ac7e9d-e3d1-4abc-8c3f-06defa8f496b"
        },
        "createdTime": "2023-03-07T21:30:33.532543Z",
        "changedTime": "2023-05-05T04:46:55.936036Z",
        "api": {
          "name": "[parameters('connections_azureloganalyticsdatacollector_name')]",
          "displayName": "Azure Log Analytics Data Collector",
          "description": "Azure Log Analytics Data Collector will send data to any Azure Log Analytics workspace.",
          "iconUri": "[concat('https://connectoricons-prod.azureedge.net/releases/v1.0.1623/1.0.1623.3210/', parameters('connections_azureloganalyticsdatacollector_name'), '/icon.png')]",
          "brandColor": "#0072C6",
          "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('location'), '/managedApis/', parameters('connections_azureloganalyticsdatacollector_name'))]",
          "type": "Microsoft.Web/locations/managedApis"
        },
        "parameterValueSet": {
          "name": "oauthMI",
          "values": {}
        },
        "testLinks": []
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[parameters('connections_azuresentinel_name')]",
      "location": "[parameters('workspace-location')]",
      "kind": "V1",
      "properties": {
        "displayName": "[parameters('connections_azuresentinel_name')]",
        "statuses": [
          {
            "status": "Connected"
          }
        ],
        "customParameterValues": {},
        "nonSecretParameterValues": {
          "token:TenantId": "[variables('tenantID')]",
          "token:grantType": "code"
        },
        "createdTime": "2023-03-10T00:58:17.251232Z",
        "changedTime": "2023-05-08T00:09:12.8135336Z",
        "api": {
          "name": "azuresentinel",
          "displayName": "Microsoft Sentinel",
          "description": "Cloud-native SIEM with built-in AI so you can focus on what matters most",
          "iconUri": "https://connectoricons-prod.azureedge.net/releases/v1.0.1631/1.0.1631.3268/azuresentinel/icon.png",
          "brandColor": "#0072C6",
          "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('location'), '/managedApis/azuresentinel')]",
          "type": "Microsoft.Web/locations/managedApis"
        },
        "parameterValueSet": {
          "name": "oauthMI",
          "values": {}
        },
        "testLinks": []
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[parameters('connections_keyvault_name')]",
      "location": "[parameters('workspace-location')]",
      "kind": "V1",
      "properties": {
        "displayName": "UploadLogs_API",
        "statuses": [
          {
            "status": "Ready"
          }
        ],
        "customParameterValues": {},
        "createdTime": "2023-03-26T21:03:24.3705089Z",
        "changedTime": "2023-05-05T05:08:38.4615691Z",
        "api": {
          "name": "[parameters('connections_keyvault_name')]",
          "displayName": "Azure Key Vault",
          "description": "Azure Key Vault is a service to securely store and access secrets.",
          "iconUri": "[concat('https://connectoricons-prod.azureedge.net/releases/v1.0.1623/1.0.1623.3210/', parameters('connections_keyvault_name'), '/icon.png')]",
          "brandColor": "#0079d6",
          "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('location'), '/managedApis/', parameters('connections_keyvault_name'))]",
          "type": "Microsoft.Web/locations/managedApis"
        },
        "parameterValueSet": {
          "name": "oauthMI",
          "values": {
            "vaultName": {
              "value": "[variables('vaultName')]"
            }
          }
        },
        "testLinks": []
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[parameters('connections_service_now_name')]",
      "location": "[parameters('workspace-location')]",
      "kind": "V1",
      "properties": {
        "displayName": "ServiceNow",
        "statuses": [
          {
            "status": "Connected"
          }
        ],
        "customParameterValues": {},
        "nonSecretParameterValues": {
          "instance": "[concat('https://nebbiatechnologiesindiapvtltddemo2.', parameters('connections_service_now_name'), '.com')]",
          "username": "albert"
        },
        "createdTime": "2023-04-17T22:16:48.5584201Z",
        "changedTime": "2023-05-05T04:46:55.9391625Z",
        "api": {
          "name": "[parameters('connections_service_now_name')]",
          "displayName": "ServiceNow",
          "description": "ServiceNow improves service levels, energizes employees, and enables your enterprise to work at lightspeed. Create, read and update records stored within ServiceNow including Incidents, Questions, Users and more.",
          "iconUri": "[concat('https://connectoricons-prod.azureedge.net/releases/v1.0.1544/1.0.1544.2640/', parameters('connections_service_now_name'), '/icon.png')]",
          "brandColor": "#D1232B",
          "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('location'), '/managedApis/', parameters('connections_service_now_name'))]",
          "type": "Microsoft.Web/locations/managedApis"
        },
        "testLinks": [
          {
            "requestUri": "[concat('https://management.azure.com:443/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/connections/', parameters('connections_service_now_name'), '/extensions/proxy/api/now/doc/table/schema?api-version=2016-06-01')]",
            "method": "get"
          }
        ]
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/degradationindependencyduration')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "degradationindependencyduration",
          "DisplayName": "Degradation in dependency duration",
          "Description": "Smart Detection rules notify you of performance anomaly issues.",
          "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": false,
          "SupportsEmailNotifications": true
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/degradationindependencyduration')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "degradationindependencyduration",
          "DisplayName": "Degradation in dependency duration",
          "Description": "Smart Detection rules notify you of performance anomaly issues.",
          "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": false,
          "SupportsEmailNotifications": true
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/degradationinserverresponsetime')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "degradationinserverresponsetime",
          "DisplayName": "Degradation in server response time",
          "Description": "Smart Detection rules notify you of performance anomaly issues.",
          "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": false,
          "SupportsEmailNotifications": true
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/degradationinserverresponsetime')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "degradationinserverresponsetime",
          "DisplayName": "Degradation in server response time",
          "Description": "Smart Detection rules notify you of performance anomaly issues.",
          "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": false,
          "SupportsEmailNotifications": true
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/digestMailConfiguration')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "digestMailConfiguration",
          "DisplayName": "Digest Mail Configuration",
          "Description": "This rule describes the digest mail preferences",
          "HelpUrl": "www.homail.com",
          "IsHidden": true,
          "IsEnabledByDefault": true,
          "IsInPreview": false,
          "SupportsEmailNotifications": true
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/digestMailConfiguration')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "digestMailConfiguration",
          "DisplayName": "Digest Mail Configuration",
          "Description": "This rule describes the digest mail preferences",
          "HelpUrl": "www.homail.com",
          "IsHidden": true,
          "IsEnabledByDefault": true,
          "IsInPreview": false,
          "SupportsEmailNotifications": true
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/extension_billingdatavolumedailyspikeextension')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "extension_billingdatavolumedailyspikeextension",
          "DisplayName": "Abnormal rise in daily data volume (preview)",
          "Description": "This detection rule automatically analyzes the billing data generated by your application, and can warn you about an unusual increase in your application's billing costs",
          "HelpUrl": "https://github.com/Microsoft/ApplicationInsights-Home/tree/master/SmartDetection/billing-data-volume-daily-spike.md",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/extension_billingdatavolumedailyspikeextension')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "extension_billingdatavolumedailyspikeextension",
          "DisplayName": "Abnormal rise in daily data volume (preview)",
          "Description": "This detection rule automatically analyzes the billing data generated by your application, and can warn you about an unusual increase in your application's billing costs",
          "HelpUrl": "https://github.com/Microsoft/ApplicationInsights-Home/tree/master/SmartDetection/billing-data-volume-daily-spike.md",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/extension_canaryextension')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "extension_canaryextension",
          "DisplayName": "Canary extension",
          "Description": "Canary extension",
          "HelpUrl": "https://github.com/Microsoft/ApplicationInsights-Home/blob/master/SmartDetection/",
          "IsHidden": true,
          "IsEnabledByDefault": true,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/extension_canaryextension')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "extension_canaryextension",
          "DisplayName": "Canary extension",
          "Description": "Canary extension",
          "HelpUrl": "https://github.com/Microsoft/ApplicationInsights-Home/blob/master/SmartDetection/",
          "IsHidden": true,
          "IsEnabledByDefault": true,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/extension_exceptionchangeextension')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "extension_exceptionchangeextension",
          "DisplayName": "Abnormal rise in exception volume (preview)",
          "Description": "This detection rule automatically analyzes the exceptions thrown in your application, and can warn you about unusual patterns in your exception telemetry.",
          "HelpUrl": "https://github.com/Microsoft/ApplicationInsights-Home/blob/master/SmartDetection/abnormal-rise-in-exception-volume.md",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/extension_exceptionchangeextension')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "extension_exceptionchangeextension",
          "DisplayName": "Abnormal rise in exception volume (preview)",
          "Description": "This detection rule automatically analyzes the exceptions thrown in your application, and can warn you about unusual patterns in your exception telemetry.",
          "HelpUrl": "https://github.com/Microsoft/ApplicationInsights-Home/blob/master/SmartDetection/abnormal-rise-in-exception-volume.md",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/extension_memoryleakextension')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "extension_memoryleakextension",
          "DisplayName": "Potential memory leak detected (preview)",
          "Description": "This detection rule automatically analyzes the memory consumption of each process in your application, and can warn you about potential memory leaks or increased memory consumption.",
          "HelpUrl": "https://github.com/Microsoft/ApplicationInsights-Home/tree/master/SmartDetection/memory-leak.md",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/extension_memoryleakextension')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "extension_memoryleakextension",
          "DisplayName": "Potential memory leak detected (preview)",
          "Description": "This detection rule automatically analyzes the memory consumption of each process in your application, and can warn you about potential memory leaks or increased memory consumption.",
          "HelpUrl": "https://github.com/Microsoft/ApplicationInsights-Home/tree/master/SmartDetection/memory-leak.md",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/extension_securityextensionspackage')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "extension_securityextensionspackage",
          "DisplayName": "Potential security issue detected (preview)",
          "Description": "This detection rule automatically analyzes the telemetry generated by your application and detects potential security issues.",
          "HelpUrl": "https://github.com/Microsoft/ApplicationInsights-Home/blob/master/SmartDetection/application-security-detection-pack.md",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/extension_securityextensionspackage')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "extension_securityextensionspackage",
          "DisplayName": "Potential security issue detected (preview)",
          "Description": "This detection rule automatically analyzes the telemetry generated by your application and detects potential security issues.",
          "HelpUrl": "https://github.com/Microsoft/ApplicationInsights-Home/blob/master/SmartDetection/application-security-detection-pack.md",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/extension_traceseveritydetector')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "extension_traceseveritydetector",
          "DisplayName": "Degradation in trace severity ratio (preview)",
          "Description": "This detection rule automatically analyzes the trace logs emitted from your application, and can warn you about unusual patterns in the severity of your trace telemetry.",
          "HelpUrl": "https://github.com/Microsoft/ApplicationInsights-Home/blob/master/SmartDetection/degradation-in-trace-severity-ratio.md",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/extension_traceseveritydetector')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "extension_traceseveritydetector",
          "DisplayName": "Degradation in trace severity ratio (preview)",
          "Description": "This detection rule automatically analyzes the trace logs emitted from your application, and can warn you about unusual patterns in the severity of your trace telemetry.",
          "HelpUrl": "https://github.com/Microsoft/ApplicationInsights-Home/blob/master/SmartDetection/degradation-in-trace-severity-ratio.md",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/longdependencyduration')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "longdependencyduration",
          "DisplayName": "Long dependency duration",
          "Description": "Smart Detection rules notify you of performance anomaly issues.",
          "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": false,
          "SupportsEmailNotifications": true
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/longdependencyduration')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "longdependencyduration",
          "DisplayName": "Long dependency duration",
          "Description": "Smart Detection rules notify you of performance anomaly issues.",
          "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": false,
          "SupportsEmailNotifications": true
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/migrationToAlertRulesCompleted')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "migrationToAlertRulesCompleted",
          "DisplayName": "Migration To Alert Rules Completed",
          "Description": "A configuration that controls the migration state of Smart Detection to Smart Alerts",
          "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
          "IsHidden": true,
          "IsEnabledByDefault": false,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": false,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/migrationToAlertRulesCompleted')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "migrationToAlertRulesCompleted",
          "DisplayName": "Migration To Alert Rules Completed",
          "Description": "A configuration that controls the migration state of Smart Detection to Smart Alerts",
          "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
          "IsHidden": true,
          "IsEnabledByDefault": false,
          "IsInPreview": true,
          "SupportsEmailNotifications": false
        },
        "enabled": false,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/slowpageloadtime')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "slowpageloadtime",
          "DisplayName": "Slow page load time",
          "Description": "Smart Detection rules notify you of performance anomaly issues.",
          "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": false,
          "SupportsEmailNotifications": true
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/slowpageloadtime')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "slowpageloadtime",
          "DisplayName": "Slow page load time",
          "Description": "Smart Detection rules notify you of performance anomaly issues.",
          "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": false,
          "SupportsEmailNotifications": true
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_Create_Sentinel_Incidents_name'), '/slowserverresponsetime')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_Create_Sentinel_Incidents_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "slowserverresponsetime",
          "DisplayName": "Slow server response time",
          "Description": "Smart Detection rules notify you of performance anomaly issues.",
          "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": false,
          "SupportsEmailNotifications": true
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "microsoft.insights/components/ProactiveDetectionConfigs",
      "apiVersion": "2018-05-01-preview",
      "name": "[concat(parameters('components_TestServiceNowConnection_name'), '/slowserverresponsetime')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('microsoft.insights/components', parameters('components_TestServiceNowConnection_name'))]"
      ],
      "properties": {
        "ruleDefinitions": {
          "Name": "slowserverresponsetime",
          "DisplayName": "Slow server response time",
          "Description": "Smart Detection rules notify you of performance anomaly issues.",
          "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
          "IsHidden": false,
          "IsEnabledByDefault": true,
          "IsInPreview": false,
          "SupportsEmailNotifications": true
        },
        "enabled": true,
        "sendEmailsToSubscriptionOwners": true,
        "customEmails": []
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-02-01",
      "name": "[concat(variables('vaultName'), '/ID-TenantID')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('vaultName'))]"
      ],
      "properties": {
        "contentType": "Tenant ID of Customer",
        "value": "[variables('tenantID')]",
        "attributes": {
          "enabled": true
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "apiVersion": "2022-10-01",
      "name": "[concat(parameters('workspace'), '/Printers_CL')]",
      "dependsOn": [
        "[resourceId('Microsoft.OperationsManagement/solutions', concat( 'SecurityInsights(', parameters('workspace'), ')' ))]"
      ],
      "properties": {
        "totalRetentionInDays": 30,
        "plan": "Analytics",
        "schema": {
          "name": "Printers_CL",
          "columns": [
            {
              "name": "Severity_s",
              "type": "string"
            },
            {
              "name": "PrinterName_s",
              "type": "string"
            },
            {
              "name": "PrinterIP_s",
              "type": "string"
            },
            {
              "name": "PrinterSerial_s",
              "type": "string"
            },
            {
              "name": "PrinterModel_s",
              "type": "string"
            },
            {
              "name": "Severity_g",
              "type": "guid"
            },
            {
              "name": "Operation_s",
              "type": "string"
            },
            {
              "name": "Details_s",
              "type": "string"
            },
            {
              "name": "Title_s",
              "type": "string"
            },
            {
              "name": "TenantID_g",
              "type": "guid"
            },
            {
              "name": "ServiceNow_ID_s",
              "type": "string"
            },
            {
              "name": "Raise_Log_s",
              "type": "string"
            },
            {
              "name": "Raise_Alert_s",
              "type": "string"
            },
            {
              "name": "Raise_Incident_s",
              "type": "string"
            },
            {
              "name": "snowsysid_g",
              "type": "guid"
            }
          ],
          "standardColumns": [
            {
              "isDefaultDisplay": false,
              "isHidden": false,
              "name": "TenantId",
              "type": "guid"
            },
            {
              "isDefaultDisplay": false,
              "isHidden": false,
              "name": "SourceSystem",
              "type": "string"
            },
            {
              "isDefaultDisplay": false,
              "isHidden": false,
              "name": "MG",
              "type": "guid"
            },
            {
              "isDefaultDisplay": false,
              "isHidden": false,
              "name": "ManagementGroupName",
              "type": "string"
            },
            {
              "isDefaultDisplay": false,
              "isHidden": false,
              "name": "TimeGenerated",
              "type": "datetime"
            },
            {
              "isDefaultDisplay": false,
              "isHidden": false,
              "name": "Computer",
              "type": "string"
            },
            {
              "isDefaultDisplay": false,
              "isHidden": false,
              "name": "RawData",
              "type": "string"
            }
          ]
        },
        "retentionInDays": 30
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('workflows_UpdateSeviceNow_Alert_name')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', parameters('connections_azuresentinel_name'))]",
        "[resourceId('Microsoft.Web/connections', parameters('connections_service_now_name'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "defaultValue": {},
              "type": "Object"
            }
          },
          "triggers": {
            "Microsoft_Sentinel_alert": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "CheckSnowSysIdNotEmpty": {
              "actions": {
                "ComposeSnowSysIdWithoutBrackets": {
                  "runAfter": {},
                  "type": "Compose",
                  "inputs": "@replace(substring(outputs('ComposeSnowSysId'), 2, sub(length(outputs('ComposeSnowSysId')),4)),'-','')"
                },
                "UpdateServiceNowRecord": {
                  "runAfter": {
                    "ComposeSnowSysIdWithoutBrackets": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "x_ntip_sentinel_se_alert_id": "@{triggerBody()?['SystemAlertId']}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['service-now']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/api/now/v2/table/@{encodeURIComponent('sn_vul_vulnerable_item')}/@{encodeURIComponent(outputs('ComposeSnowSysIdWithoutBrackets'))}",
                    "queries": {
                      "sysparm_display_value": false,
                      "sysparm_exclude_reference_link": true
                    }
                  }
                }
              },
              "runAfter": {
                "ComposeSnowSysId": [
                  "Succeeded"
                ]
              },
              "expression": {
                "and": [
                  {
                    "equals": [
                      "@empty(outputs('ComposeSnowSysId'))",
                      "@false"
                    ]
                  }
                ]
              },
              "type": "If"
            },
            "ComposeSnowSysId": {
              "runAfter": {
                "Remove_brackets_from_ServiceNowID": [
                  "Succeeded"
                ]
              },
              "type": "Compose",
              "inputs": "@string(body('Parse_Custom_Details')?['ServiceNowSystemID'])"
            },
            "Convert_SeviceNowID_to_string": {
              "runAfter": {
                "Parse_Custom_Details": [
                  "Succeeded"
                ]
              },
              "type": "Compose",
              "inputs": "@string(body('Parse_Custom_Details')?['ServiceNowID'])"
            },
            "Parse_Custom_Details": {
              "runAfter": {
                "Parse_Extended_Properties": [
                  "Succeeded"
                ]
              },
              "type": "ParseJson",
              "inputs": {
                "content": "@body('Parse_Extended_Properties')?['Custom Details']",
                "schema": {
                  "properties": {
                    "Details": {
                      "items": {
                        "type": "string"
                      },
                      "type": "array"
                    },
                    "RaiseAlert": {
                      "items": {
                        "type": "string"
                      },
                      "type": "array"
                    },
                    "RaiseIncident": {
                      "items": {
                        "type": "string"
                      },
                      "type": "array"
                    },
                    "RaiseLog": {
                      "items": {
                        "type": "string"
                      },
                      "type": "array"
                    },
                    "ServiceNowID": {
                      "items": {
                        "type": "string"
                      },
                      "type": "array"
                    },
                    "ServiceNowSystemID": {
                      "items": {
                        "type": "string"
                      },
                      "type": "array"
                    },
                    "Title": {
                      "items": {
                        "type": "string"
                      },
                      "type": "array"
                    }
                  },
                  "type": "object"
                }
              }
            },
            "Parse_Extended_Properties": {
              "runAfter": {},
              "type": "ParseJson",
              "inputs": {
                "content": "@triggerBody()?['ExtendedProperties']",
                "schema": {
                  "properties": {
                    "Alert generation status": {
                      "type": "string"
                    },
                    "Analytic Rule Ids": {
                      "type": "string"
                    },
                    "Analytic Rule Name": {
                      "type": "string"
                    },
                    "Correlation Id": {
                      "type": "string"
                    },
                    "Custom Details": {
                      "type": "string"
                    },
                    "Data Sources": {
                      "type": "string"
                    },
                    "Event Grouping": {
                      "type": "string"
                    },
                    "OriginalQuery": {
                      "type": "string"
                    },
                    "ProcessedBySentinel": {
                      "type": "string"
                    },
                    "Query": {
                      "type": "string"
                    },
                    "Query End Time UTC": {
                      "type": "string"
                    },
                    "Query Period": {
                      "type": "string"
                    },
                    "Query Start Time UTC": {
                      "type": "string"
                    },
                    "Search Query Results Overall Count": {
                      "type": "string"
                    },
                    "Trigger Operator": {
                      "type": "string"
                    },
                    "Trigger Threshold": {
                      "type": "string"
                    }
                  },
                  "type": "object"
                }
              }
            },
            "Remove_brackets_from_ServiceNowID": {
              "runAfter": {
                "Convert_SeviceNowID_to_string": [
                  "Succeeded"
                ]
              },
              "type": "Compose",
              "inputs": "@substring(outputs('Convert_SeviceNowID_to_string'), 2, sub(length(outputs('Convert_SeviceNowID_to_string')),4))"
            }
          },
          "outputs": {}
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', parameters('connections_azuresentinel_name'))]",
                "connectionName": "azuresentinel",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('location'), '/managedApis/azuresentinel')]"
              },
              "service-now": {
                "connectionId": "[resourceId('Microsoft.Web/connections', parameters('connections_service_now_name'))]",
                "connectionName": "service-now",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('location'), '/managedApis/service-now')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('workflows_UploadLogs_API_name')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', parameters('connections_azureloganalyticsdatacollector_name'))]",
        "[resourceId('Microsoft.Web/connections', parameters('connections_azuresentinel_name'))]",
        "[resourceId('Microsoft.Web/connections', parameters('connections_keyvault_name'))]"
      ],
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "accessControl": {
          "triggers": {
            "openAuthenticationPolicies": {
              "policies": {
                "adfpolicy": {
                  "type": "AAD",
                  "claims": [
                    {
                      "name": "iss",
                      "value": "[toLower( concat( 'https://login.microsoftonline.com/', variables('tenantID'), '/v2.0'))]"
                    }
                  ]
                }
              }
            }
          }
        },
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "defaultValue": {},
              "type": "Object"
            }
          },
          "triggers": {
            "manual": {
              "type": "Request",
              "kind": "Http",
              "inputs": {
                "schema": {
                  "properties": {
                    "Details": {
                      "type": "string"
                    },
                    "Operation": {
                      "type": "string"
                    },
                    "PrinterIP": {
                      "type": "string"
                    },
                    "PrinterModel": {
                      "type": "string"
                    },
                    "PrinterName": {
                      "type": "string"
                    },
                    "PrinterSerial": {
                      "type": "string"
                    },
                    "Raise Alert": {
                      "type": "string"
                    },
                    "Raise Incident": {
                      "type": "string"
                    },
                    "Raise Log": {
                      "type": "string"
                    },
                    "ServiceNow ID": {
                      "type": "string"
                    },
                    "Severity": {
                      "type": "string"
                    },
                    "TenantID": {
                      "type": "string"
                    },
                    "Title": {
                      "type": "string"
                    },
                    "snowsysid": {
                      "type": "string"
                    }
                  },
                  "type": "object"
                }
              },
              "operationOptions": "IncludeAuthorizationHeadersInOutputs"
            }
          },
          "actions": {
            "Condition_2": {
              "actions": {
                "Check_for_Add_operation": {
                  "actions": {
                    "Condition": {
                      "actions": {
                        "Raise_Log": {
                          "runAfter": {},
                          "type": "ApiConnection",
                          "inputs": {
                            "body": "{\n        \"Operation\": \"Add\",\n        \"Details\": \"The Canon TR150 print driver through 3.71.2.10 is vulnerable to a privilege escalation issue. During the add printer process, a local attacker can overwrite CNMurGE.dll and, if timed properly, the overwritten DLL will be loaded into a SYSTEM process resulting in escalation of privileges. This occurs because the driver drops a world-writable DLL into a CanonBJ %PROGRAMDATA% location that gets loaded by printisolationhost (a system process).\",\n        \"Title\": \"CVE-2021-38085\",\n        \"ServiceNow ID\": \"VIT0011868\",\n        \"Raise Log\": \"true\",\n        \"Raise Alert\": \"true\",\n        \"Raise Incident\": \"false\",\n        \"snowsysid\": \"b3bf5c261b6a29107f66a9f36b4bcb03\",\n\t\t\"PrinterName\": \"Main Office MFD\",\n        \"PrinterIP\": \"192.168.0.123\",\n        \"PrinterSerial\": \"ASX29867561guyy\",\n        \"PrinterModel\": \"Deskjet 5179\",\n        \"Severity\": \"Medium\"\n    }",
                            "headers": {
                              "Log-Type": "Printers"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/api/logs"
                          }
                        },
                        "Scope": {
                          "actions": {
                            "Set_variable_3": {
                              "runAfter": {},
                              "type": "SetVariable",
                              "inputs": {
                                "name": "ResponseCode",
                                "value": "201"
                              }
                            },
                            "Set_variable_4": {
                              "runAfter": {
                                "Set_variable_3": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "ResponseMessage",
                                "value": "Log raised"
                              }
                            }
                          },
                          "runAfter": {
                            "Raise_Log": [
                              "Succeeded"
                            ]
                          },
                          "type": "Scope"
                        }
                      },
                      "runAfter": {},
                      "else": {
                        "actions": {
                          "Scope_2": {
                            "actions": {
                              "Set_variable_5": {
                                "runAfter": {},
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "ResponseCode",
                                  "value": "200"
                                }
                              },
                              "Set_variable_6": {
                                "runAfter": {
                                  "Set_variable_5": [
                                    "Succeeded"
                                  ]
                                },
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "ResponseMessage",
                                  "value": "No log raised"
                                }
                              }
                            },
                            "runAfter": {},
                            "type": "Scope"
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "equals": [
                              "@triggerBody()?['Raise Log']",
                              "true"
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    }
                  },
                  "runAfter": {},
                  "else": {
                    "actions": {
                      "Check_for_update_operation": {
                        "actions": {
                          "Add_alert_to_incident": {
                            "runAfter": {
                              "Create_incident": [
                                "Succeeded"
                              ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                              "body": {
                                "incidentArmId": "@body('Create_incident')?['id']",
                                "relatedResourceId": "@triggerBody()?['AlertID']"
                              },
                              "host": {
                                "connection": {
                                  "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                }
                              },
                              "method": "post",
                              "path": "/Incidents/Relation/Create"
                            }
                          },
                          "Create_incident": {
                            "runAfter": {},
                            "type": "ApiConnection",
                            "inputs": {
                              "body": {
                                "description": "@triggerBody()?['Details']",
                                "severity": "Medium",
                                "status": "New",
                                "title": "@triggerBody()?['Title']"
                              },
                              "host": {
                                "connection": {
                                  "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                }
                              },
                              "method": "put",
                              "path": "/Incidents/subscriptions/@{encodeURIComponent(subscription().subscriptionId)}/resourceGroups/@{encodeURIComponent(resourceGroup().id)}/workspaces/@{encodeURIComponent('workspace')}"
                            }
                          },
                          "Responsecode": {
                            "runAfter": {
                              "Add_alert_to_incident": [
                                "Succeeded"
                              ]
                            },
                            "type": "SetVariable",
                            "inputs": {
                              "name": "ResponseCode",
                              "value": "201"
                            }
                          },
                          "Set_variable_8": {
                            "runAfter": {
                              "Responsecode": [
                                "Succeeded"
                              ]
                            },
                            "type": "SetVariable",
                            "inputs": {
                              "name": "ResponseMessage",
                              "value": "Incident created: @{body('Create_incident')?['id']}\nIssure Linked: @{body('Add_alert_to_incident')?['id']}"
                            }
                          }
                        },
                        "runAfter": {},
                        "else": {
                          "actions": {
                            "Condition_3": {
                              "actions": {
                                "Set_Response_Code": {
                                  "runAfter": {
                                    "Update_incident": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "ResponseCode",
                                    "value": "201"
                                  }
                                },
                                "Set_variable_7": {
                                  "runAfter": {
                                    "Set_Response_Code": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "ResponseMessage",
                                    "value": "Incident Closed"
                                  }
                                },
                                "Update_incident": {
                                  "runAfter": {},
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "classification": {
                                        "ClassificationAndReason": "BenignPositive - SuspiciousButExpected",
                                        "ClassificationReasonText": "@triggerBody()?['Reason']"
                                      },
                                      "incidentArmId": "@triggerBody()?['IncidentARMID']",
                                      "status": "Closed"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "put",
                                    "path": "/Incidents"
                                  }
                                }
                              },
                              "runAfter": {},
                              "expression": {
                                "and": [
                                  {
                                    "equals": [
                                      "@triggerBody()?['Operation']",
                                      "Close"
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            }
                          }
                        },
                        "expression": {
                          "and": [
                            {
                              "equals": [
                                "@triggerBody()?['Operation']",
                                "AddIncident"
                              ]
                            }
                          ]
                        },
                        "type": "If"
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "equals": [
                          "@triggerBody()?['Operation']",
                          "Add"
                        ]
                      }
                    ]
                  },
                  "type": "If"
                }
              },
              "runAfter": {
                "Get_secret": [
                  "Succeeded"
                ]
              },
              "else": {
                "actions": {
                  "Set_Response_Variables": {
                    "actions": {
                      "Set_variable": {
                        "runAfter": {},
                        "type": "SetVariable",
                        "inputs": {
                          "name": "ResponseCode",
                          "value": "403"
                        }
                      },
                      "Set_variable_2": {
                        "runAfter": {
                          "Set_variable": [
                            "Succeeded"
                          ]
                        },
                        "type": "SetVariable",
                        "inputs": {
                          "name": "ResponseMessage",
                          "value": "TenantID does not match. "
                        }
                      }
                    },
                    "runAfter": {},
                    "type": "Scope"
                  }
                }
              },
              "expression": {
                "and": [
                  {
                    "equals": [
                      "@triggerBody()?['TenantID']",
                      "@body('Get_secret')?['value']"
                    ]
                  }
                ]
              },
              "type": "If"
            },
            "Get_secret": {
              "runAfter": {
                "Init_-_ResponseJSON": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection",
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['keyvault']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/secrets/@{encodeURIComponent('ID-TenantID')}/value"
              }
            },
            "Init_-_ResponseCode": {
              "runAfter": {},
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "ResponseCode",
                    "type": "string"
                  }
                ]
              }
            },
            "Init_-_ResponseJSON": {
              "runAfter": {
                "Init_-_ResponseMessage": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "ResponseJSON",
                    "type": "string",
                    "value": "@{triggerBody()}"
                  }
                ]
              }
            },
            "Init_-_ResponseMessage": {
              "runAfter": {
                "Init_-_ResponseCode": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "ResponseMessage",
                    "type": "string"
                  }
                ]
              }
            },
            "Response": {
              "runAfter": {
                "Condition_2": [
                  "Succeeded"
                ]
              },
              "type": "Response",
              "kind": "Http",
              "inputs": {
                "body": "@variables('ResponseMessage')",
                "statusCode": "@variables('ResponseCode')"
              }
            }
          },
          "outputs": {}
        },
        "parameters": {
          "$connections": {
            "value": {
              "azureloganalyticsdatacollector": {
                "connectionId": "[resourceId('Microsoft.Web/connections', parameters('connections_azureloganalyticsdatacollector_name'))]",
                "connectionName": "azureloganalyticsdatacollector",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('location'), '/managedApis/azureloganalyticsdatacollector')]"
              },
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', parameters('connections_azuresentinel_name'))]",
                "connectionName": "azuresentinel",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('location'), '/managedApis/azuresentinel')]"
              },
              "keyvault": {
                "connectionId": "[resourceId('Microsoft.Web/connections', parameters('connections_keyvault_name'))]",
                "connectionName": "keyvault",
                "connectionProperties": {
                  "authentication": {
                    "type": "ManagedServiceIdentity"
                  }
                },
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('location'), '/managedApis/keyvault')]"
              }
            }
          }
        }
      }
    }
  ],
  "outputs": {}
}