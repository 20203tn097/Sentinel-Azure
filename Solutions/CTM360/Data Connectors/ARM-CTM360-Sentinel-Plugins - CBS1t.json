{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "defaultValue": "",
            "type": "String"
        }
    },
    "resources": [
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',guid(subscription().subscriptionId))]",
            "kind": "APIPolling",
            "properties": {
                "connectorUiConfig": {
                    "title": "CBS Intergration - (1 Time Polling CCP)",
                    "id": "CBSPollingID1t",
                    "publisher": "CTM360",
                    "descriptionMarkdown": "CBS Data Connector",
                    "graphQueriesTableName": "CBSLogPolling_1_CL",
                    "graphQueries": [
                        {
                            "metricName": "Total data received",
                            "legend": "CBS log events",
                            "baseQuery": "{{graphQueriesTableName}}"
                        }
                    ],
                    "sampleQueries": [
                        {
                            "description": "All logs",
                            "query": "{{graphQueriesTableName}}\n | take 10"
                        }
                    ],
                    "dataTypes": [
                        {
                            "name": "{{graphQueriesTableName}}",
                            "lastDataReceivedQuery": "{{graphQueriesTableName}}\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                        }
                    ],
                    "connectivityCriteria": [
                        {
                            "type": "SentinelKindsV2",
                            "value": [
                                "APIPolling"
                            ]
                        }
                    ],
                    "availability": {
                        "status": 1,
                        "isPreview": false
                    },
                    "permissions": {
                        "resourceProvider": [
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces",
                                "permissionsDisplayText": "read and write permissions are required.",
                                "providerDisplayName": "Workspace",
                                "scope": "Workspace",
                                "requiredPermissions": {
                                    "action": true,
                                    "write": true,
                                    "read": true,
                                    "delete": true
                                }
                            }
                        ],
                        "customs": [
                            {
                                "name": "CBS API Key",
                                "description": "Through the API integration, you have the capability to retrieve all the issues related to your CBS organizations via a RESTful interface.This process is set to run every 30 minutes. It is crucial to disable it promptly after inserting new data into the database. Failure to do so may result in data duplication, making it difficult to remove from the database."
                            }
                        ]
                    },
                    "instructionSteps": [
                        {
                            "title": "Establish a connection between the CBS Log and Microsoft Sentinel.",
                            "description": "Connecting the CBS Log to Microsoft Sentinel enables seamless and secure data integration, allowing you to efficiently manage and analyze log information within the powerful capabilities of Microsoft Sentinel. This integration enhances your organization's ability to detect and respond to security threats, collect valuable insights, and streamline your overall cybersecurity operations. It provides a bridge between your CBS Log and Microsoft Sentinel, ensuring that critical data is readily available for threat detection, incident response, and comprehensive security monitoring.",
                            "instructions": [
                                {
                                    "parameters": {
                                        "enable": "true",
                                        "userRequestPlaceHoldersInput": [
                                            {
                                                "displayText": "date_from  in format same like dd-MM-yyyy HH:mm",
                                                "requestObjectKey": "queryParameters.date_from",
                                                "placeHolderName": "{{PlaceHolder1}}",
                                                "placeHolderValue": "01-01-1970 00:00"
                                            },
                                            {
                                                "displayText": "date_to  in format same like dd-MM-yyyy HH:mm",
                                                "requestObjectKey": "queryParameters.date_to",
                                                "placeHolderName": "{{PlaceHolder2}}",
                                                "placeHolderValue": "01-01-2023 00:00"
                                            }
                                        ]
                                    },
                                    "type": "APIKey"
                                }
                            ]
                        }
                    ]
                },
                "pollingConfig": {
                    "auth": {
                        "authType": "APIKey",
                        "APIKeyName": "api-key",
                        "IsAPIKeyInPostPayload": false
                    },
                    "request": {
                        "apiEndpoint": "https://cbs.ctm360.com/api/v2/incidents",
                        "rateLimitQPS": 2,
                        "httpMethod": "Get",
                        "queryTimeFormat": "dd-MM-yyyy HH:mm",
                        "retryCount": 3,
                        "queryWindowInMin": 30,
                        "timeoutInSeconds": 120,
                        "queryParameters": {
                            "date_from": "'{{PlaceHolder1}}'",
                            "date_to": "'{{PlaceHolder2}}'",
                            "FROM_MIRCROSOFT_SENTINEL": true
                        },
                        "headers": {
                            "Accept": "application/json"
                        }
                    },
                    "response": {
                        "eventsJsonPaths": [
                            "$.incident_list[*]"
                        ]
                    }
                }
            },
            "id": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',guid(subscription().subscriptionId))]"
        }
    ]
}