{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "isWizard": false,
      "basics": {
        "description": "<img src=\"https://raw.githubusercontent.com/johnpcmatic/Azure-Sentinel/pcm-sentinel/Solutions/PCMatic%20SuperShield/Logo/pcmatic-green-outline.png\" width=\"200px\" height=\"45px\">\n\n**Important:** _This Microsoft Sentinel Solution is currently in public preview. This feature is provided without a service level agreement, and it's not recommended for production workloads. Certain features might not be supported or might have constrained capabilities. For more information, see [Supplemental Terms of Use for Microsoft Azure Previews](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)._\n\n**Note:** _There may be [known issues](https://aka.ms/sentinelsolutionsknownissues) pertaining to this Solution, please refer to them before installing._\n\nThis PC Matic SuperShield Sentinel solution provides the capability to ingest [PC Matic SuperShield](https://www.pcmatic.com/pro/) process activity events with Microsoft Sentinel. It helps you gain visibility into what applications and processes are being executed on your endpoints, and which of those are blocked by SuperShield.\n\nMicrosoft Sentinel Solutions provide a consolidated way to acquire Microsoft Sentinel content like data connectors, workbooks, analytics, and automations in your workspace with a single deployment step.\n\n**Key Vaults:** 1, **Playbooks:** 2, **Workbooks:** 1, **Data Connectors:** 1, **Parsers:** 1, **Analytic Rules:** 3\n\n[Learn more about Microsoft Sentinel](https://aka.ms/azuresentinel) | [Learn more about Solutions](https://aka.ms/azuresentinelsolutionsdoc)\n\n**Required:** If you do not have an existing Sentinel Workspace, please create one by going to Microsoft Sentinel and clicking on the \"Create\" tab. Follow the wizard to create a new Sentinel Workspace."
      }
    },
    "basics": [
      {
        "name": "basics",
        "type": "Microsoft.Solutions.ArmApiControl",
        "toolTip": "This filters by workspaces that exist in the Resource Group selected",
        "condition": "[greater(length(resourceGroup().name),0)]",
        "request": {
          "method": "GET",
          "path": "[concat(subscription().id,'/providers/Microsoft.OperationalInsights/workspaces?api-version=2020-08-01')]"
        }
      },
      {
        "name": "workspace",
        "type": "Microsoft.Common.DropDown",
        "label": "Workspace",
        "placeholder": "Select a workspace",
        "toolTip": "Please select your Sentinel workspace. If you do not see the workspace listed here, please make sure you have selected the correct Resource Group and you have created a Sentinel workspace in that group.",
        "constraints": {
          "allowedValues": "[map(filter(basics('basics').value, (filter) => contains(toLower(filter.id), toLower(resourceGroup().name))), (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
          "required": true
        },
        "visible": true
      }
    ],
    "steps": [
        {
          "name": "keyvault",
          "label": "Key Vault",
          "bladeTitle": "Key Vault",
          "elements": [
            {
              "name": "alerts-text",
              "type": "Microsoft.Common.TextBlock",
              "options": {
                "text": "The Azure Key Vault created here will be used to store your PC Matic API credentials. The credentials are used by PC Matic's custom Logic Apps to communicate with PC Matic servers."
              }
            },
            {
                "name": "keyvault_name",
                "type": "Microsoft.Common.TextBox",
                "label": "Key Vault Name",
                "defaultValue": "",
                "toolTip": "Specifies the name of the key vault to be created, e.g., 'SSKeyVault'.",
                "constraints": {
                    "required": true,
                    "regex": "^[a-zA-Z0-9]{6,}$",
                    "validationMessage": "Alphanumeric characters and at least 6 characters long"
                },
                "visible": true
            },
            {
                "name": "keyvault_secret_name",
                "type": "Microsoft.Common.TextBox",
                "label": "API Secret Name",
                "defaultValue": "",
                "toolTip": "Specifies the name of the secret that you want to create, e.g., 'ApiSecret'.",
                "constraints": {
                    "required": true,
                    "regex": "^[a-zA-Z0-9]{6,}$",
                    "validationMessage": "Alphanumeric characters and at least 6 characters long"
                },
                "visible": true
            },
            {
                "name": "keyvault_secret_username",
                "type": "Microsoft.Common.TextBox",
                "label": "API Username",
                "defaultValue": "",
                "toolTip": "The API username created in the PC Matic portal.",
                "constraints": {
                    "required": true,
                    "regex": "(?=^.{1,150}$)^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\\.[a-zA-Z0-9-]+)$",
                    "validationMessage": "Please enter a valid email address"
                },
                "visible": true
            },
            {
                "name": "keyvault_secret_password",
                "type": "Microsoft.Common.PasswordBox",
                "label": {
                    "password": "API Password",
                    "confirmPassword": "Confirm password"
                },
                "toolTip": "The API password created in the PC Matic portal.",
                "constraints": {
                    "required": true,
                    "regex": ".{12,}$",
                    "validationMessage": "Alphanumeric characters and at least 3 characters long"
                },
                "visible": true
            }
        ]
      },
      {
        "name": "alerts",
        "label": "Logic App Alerts",
        "bladeTitle": "Logic App Alerts",
        "elements": [
          {
            "name": "alerts-text",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "Logic App Alerts will send an email notification in the event that a Logic App run fails or returns an error. Please enter a vaild email address below."
            }
          },
          {
              "name": "alert_email",
              "type": "Microsoft.Common.TextBox",
              "label": "Alert Email",
              "defaultValue": "",
              "toolTip": "A vaild email address to receive Logic App failure alerts",
              "constraints": {
                  "required": true,
                    "regex": "(?=^.{1,150}$)^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\\.[a-zA-Z0-9-]+)$",
                    "validationMessage": "Valid email address"
              },
              "visible": true
          }
        ]
      },
      {
        "name": "addition-details",
        "label": "Additional Details",
        "bladeTitle": "Additional Details",
        "elements": [
          {
            "name": "section1",
            "type": "Microsoft.Common.Section",
            "label": "Data Connectors",
            "elements": [
              {
                "name": "dataconnectors1-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "PC Matic SuperShield activity can be ingested using the built-in Common Event Format (CEF) log data connector. Configure the CEF connector, then log into your PC Matic Pro/MSP account to configure PC Matic syslog forwarding. Use the IP address for the Linux VM with the Linux agent installed as the Syslog Server Address.",
                  "link": {
                    "label": "View screenshot",
                    "uri": "https://raw.githubusercontent.com/johnpcmatic/Azure-Sentinel/pcm-sentinel/Solutions/PCMatic%20SuperShield/assets/syslog.png"
                  }
                }
              },
              {
                "name": "dataconnectors-parser-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "These queries and workbooks are dependent on a parser based on a Kusto Function to work as expected. Follow the steps to use this Kusto functions alias **SuperShieldActivity** in queries and workbooks.",
                  "link": {
                    "label": "Click here for the Kusto function",
                    "uri": "https://raw.githubusercontent.com/johnpcmatic/Azure-Sentinel/pcm-sentinel/Solutions/PCMatic%20SuperShield/Parsers/PCMSS.txt"
                  }
                }
              },
              {
                "name": "dataconnectors-link1",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "link": {
                    "label": "Learn more about normalized format",
                    "uri": "https://docs.microsoft.com/azure/sentinel/normalization-schema"
                  }
                }
              },
              {
                "name": "dataconnectors-link2",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "link": {
                    "label": "Learn more about connecting data sources",
                    "uri": "https://docs.microsoft.com/azure/sentinel/connect-data-sources"
                  }
                }
              }
            ],
            "visible": true
          },
          {
            "name": "section2",
            "type": "Microsoft.Common.Section",
            "label": "Analytics",
            "elements": [
              {
                "name": "analytics-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "This Microsoft Sentinel Solution installs custom analytic rules for PCMatic SuperShield. These rules will generate incidents based on your SuperShield Process Activity.",
                  "link": {
                    "label": "Learn more",
                    "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-detect-threats-custom?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef"
                  }
                }
              },
              {
                "name": "analytic1-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "**Known Bad Process** - Identifies processes known to be bad and blocked by SuperShield. Severity: High"
                }
              },
              {
                "name": "analytic2-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "**Unknown Process** - Identifies unknown processes blocked by SuperShield. Severity: Medium"
                }
              },
              {
                "name": "analytic3-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "**Allowed Process** - Identifies processes allowed by SuperShield. Severity: Low"
                }
              }
            ]
          },
          {
            "name": "section3",
            "type": "Microsoft.Common.Section",
            "label": "Logic Apps",
            "elements": [
              {

                "name": "playbooks-text1",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "This solution installs two Logic Apps to communicate with PC Matic: **BlockAllowProcess** and **RemoveProcess**. These logic apps are triggered from the Incident Overview workbook.",
                  "link": {
                    "label": "Learn more",
                    "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-respond-threats-playbook?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef"
                  }
                }
              }
            ]
          },
          {
            "name": "section4",
            "type": "Microsoft.Common.Section",
            "label": "Workbook",
            "elements": [
              {
                "name": "workbook-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "This solution installs a custom Incident Overview workbook that will be used to block/allow processes, or to remove those processes from your black/whitelists."
                }
              }
            ]
          }
        ]
      }
    ],
  
    "outputs": {
      "workspace": "[basics('basics').workspace]",
      "keyvault_name": "[steps('keyvault').keyvault_name]",
      "keyvault_secret_name": "[steps('keyvault').keyvault_secret_name]",
      "keyvault_secret_username": "[steps('keyvault').keyvault_secret_username]",
      "keyvault_secret_password": "[steps('keyvault').keyvault_secret_password]",
      "alert_email": "[steps('alerts').alert_email]",
      "location": "[location()]"
    }
  },
  
  "outputs": {
    "workspace": "[basics('basics').workspace]",
    "keyvault_name": "[steps('keyvault').keyvault_name]",
    "keyvault_secret_name": "[steps('keyvault').keyvault_secret_name]",
    "keyvault_secret_username": "[steps('keyvault').keyvault_secret_username]",
    "keyvault_secret_password": "[steps('keyvault').keyvault_secret_password]",
    "alert_email": "[steps('alerts').alert_email]",
    "location": "[location()]"
  }
}
