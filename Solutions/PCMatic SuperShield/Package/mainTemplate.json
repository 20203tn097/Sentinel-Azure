{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "John Farley - john@pcmatic.com",
    "comments": "Solution template for PCMatic SuperShield"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic3-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    }
  },
  "variables": {
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "PCMSS_Parser": "PCMSS_Parser",
    "_PCMSS_Parser": "[variables('PCMSS_Parser')]",
    "KnownBadProcess_AnalyticalRules": "KnownBadProcess_AnalyticalRules",
    "_KnownBadProcess_AnalyticalRules": "[variables('KnownBadProcess_AnalyticalRules')]",
    "UnknownProcess_AnalyticalRules": "UnknownProcess_AnalyticalRules",
    "_UnknownProcess_AnalyticalRules": "[variables('UnknownProcess_AnalyticalRules')]",
    "AllowedProcess_AnalyticalRules": "AllowedProcess_AnalyticalRules",
    "_AllowedProcess_AnalyticalRules": "[variables('AllowedProcess_AnalyticalRules')]",
    "sourceId": "pcmatic.pcmatic-supershield",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "PCMatic SuperShield Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "PCMatic SuperShield Data Parser",
            "category": "Samples",
            "functionAlias": "PCMSS",
            "query": "\nCommonSecurityLog\n| where DeviceVendor == 'PCMatic'\n| extend Category = extract(@'cat=(.*?);', 1, AdditionalExtensions)\n| extend Severity = extract(@'Severity=(.*?);', 1, AdditionalExtensions, typeof(int))\n| extend Host = extract(@'Host=(.*?);', 1, AdditionalExtensions)\n| extend DeviceExternalID = extract(@'deviceExternalID=(.*?);', 1, AdditionalExtensions)\n| extend GroupName = extract(@'groupName=(.*?);', 1, AdditionalExtensions)\n| extend GroupID = extract(@'groupID=(.*?);', 1, AdditionalExtensions)\n| extend CompanyName = extract(@'companyName=(.*?);', 1, AdditionalExtensions)\n| extend CompanyID = extract(@'companyID=(.*?);', 1, AdditionalExtensions)\n| extend AccountID = extract(@'accountID=(.*?);', 1, AdditionalExtensions)\n| extend ParentPath = extract(@'parentPath=(.*?);', 1, AdditionalExtensions)\n| extend MD5 = extract(@'md5=(.*?);', 1, AdditionalExtensions)\n| extend FileHash = extract(@'filehash=(.*?);', 1, AdditionalExtensions)\n| extend IsUnknown = extract(@'isUnknown=(.*?);', 1, AdditionalExtensions)\n| extend IsScript = extract(@'isScript=(.*?);', 1, AdditionalExtensions)\n| extend UserDecided = extract(@'userDecided=(.*?);', 1, AdditionalExtensions)\n| extend UserDecidedDesc = extract(@'userDecidedDesc=(.*?);', 1, AdditionalExtensions)\n| extend CmdLineArgs = extract(@'cmdLineArgs=(.*?);', 1, AdditionalExtensions)\n| extend Vendor = extract(@'vendor=(.*?);', 1, AdditionalExtensions)\n| extend Product = extract(@'product=(.*?);', 1, AdditionalExtensions)\n| extend ProductDescription = extract(@'productDescription=(.*?);', 1, AdditionalExtensions)\n| extend ProductVersion = extract(@'productVersion=(.*?);', 1, AdditionalExtensions)\n| extend FileCopyright = extract(@'fileCopyright=(.*?);', 1, AdditionalExtensions)\n| extend IsSigned = extract(@'isSigned=(.*?);', 1, AdditionalExtensions)\n| extend DigitalSigAuthority = extract(@'digitalSigAuthority=(.*?);', 1, AdditionalExtensions)\n| extend DigitalSigVendor = extract(@'digitalSigVendor=(.*?);', 1, AdditionalExtensions)\n| extend OS = extract(@'os=(.*?);', 1, AdditionalExtensions)\n| extend OSArch = extract(@'osArch=(.*?);', 1, AdditionalExtensions)\n| extend OSPlatform = extract(@'osPlatform=(.*?);', 1, AdditionalExtensions)\n| extend OSRelease = extract(@'osRelease=(.*?);', 1, AdditionalExtensions)\n| extend OSKernel = extract(@'osKernel=(.*?);', 1, AdditionalExtensions)\n| extend ProtectionMode = extract(@'protectionMode=(.*)', 1, AdditionalExtensions)\n| extend ProcessName = extract(@'processName=(.*)', 1, AdditionalExtensions)\n| order by TimeGenerated desc\n;",
            "version": 1
          }
        }
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Identifies known bad processes blocked by SuperShield",
        "displayName": "PCMatic SuperShield Known Bad Processes",
        "enabled": false,
        "query": "SuperShieldActivity\n| where Severity == 0\n| where IsUnknown == 0 or IsUnknown == \"false\"\n",
        "queryFrequency": "PT5M",
        "queryPeriod": "PT10M",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Execution"
        ],
        "entityMappings": [
          {
            "entityType": "FileHash",
            "fieldMappings": [
              {
                "columnName": "FileHash",
                "identifier": "Value"
              }
            ]
          },
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "DeviceAddress",
                "identifier": "Address"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "columnName": "Host",
                "identifier": "HostName"
              }
            ]
          },
          {
            "entityType": "File",
            "fieldMappings": [
              {
                "columnName": "FileName",
                "identifier": "Name"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Identifies unknown processes blocked by SuperShield",
        "displayName": "PCMatic SuperShield Unknown Process",
        "enabled": false,
        "query": "SuperShieldActivity\n| where TimeGenerated >= ago(5m)\n| where Severity == 0\n| where IsUnknown == 1\n",
        "queryFrequency": "PT1M",
        "queryPeriod": "PT5M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Execution"
        ],
        "entityMappings": [
          {
            "entityType": "FileHash",
            "fieldMappings": [
              {
                "columnName": "FileHash",
                "identifier": "Value"
              }
            ]
          },
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "DeviceAddress",
                "identifier": "Address"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "columnName": "Host",
                "identifier": "HostName"
              }
            ]
          },
          {
            "entityType": "File",
            "fieldMappings": [
              {
                "columnName": "FileName",
                "identifier": "Name"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic3-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Identifies processes allowed by SuperShield",
        "displayName": "PCMatic SuperShield Allowed Process",
        "enabled": false,
        "query": "SuperShieldActivity\n| where TimeGenerated >= ago(5m)\n| where Severity > 1\n",
        "queryFrequency": "PT1M",
        "queryPeriod": "PT5M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Execution"
        ],
        "entityMappings": [
          {
            "entityType": "FileHash",
            "fieldMappings": [
              {
                "columnName": "FileHash",
                "identifier": "Value"
              }
            ]
          },
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "DeviceAddress",
                "identifier": "Address"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "columnName": "Host",
                "identifier": "HostName"
              }
            ]
          },
          {
            "entityType": "File",
            "fieldMappings": [
              {
                "columnName": "FileName",
                "identifier": "Name"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "version": "1.0.0",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "PCMatic SuperShield",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "John Farley",
          "email": "john@pcmatic.com"
        },
        "support": {
          "name": "PC Matic",
          "email": "support@pcmatic.com",
          "tier": "PC Matic",
          "link": "https://www.pcmatic.com/support/#/business-support-form"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Parser",
              "contentId": "[variables('_PCMSS_Parser')]",
              "version": "1.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_KnownBadProcess_AnalyticalRules')]",
              "version": "1.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_UnknownProcess_AnalyticalRules')]",
              "version": "1.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_AllowedProcess_AnalyticalRules')]",
              "version": "1.0.0"
            }
          ]
        },
        "firstPublishDate": "2022-05-16",
        "lastPublishDate": "2022-05-16",
        "providers": [
          "PC Matic"
        ],
        "categories": {
          "domains": [
            "Security - Vulnerability Management"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
