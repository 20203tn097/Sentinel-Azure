{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "John Farley - john@pcmatic.com",
    "comments": "Solution template for PCMatic SuperShield"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "connector1-name": {
      "type": "string",
      "defaultValue": "2162dc94-7aab-4342-bcca-905e7cca7d9c"
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "playbook1-PlaybookName": {
      "defaultValue": "AllowProcess",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook2-PlaybookName": {
      "defaultValue": "BlockProcess",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    }
  },
  "variables": {
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "PCMSS_Parser": "PCMSS_Parser",
    "_PCMSS_Parser": "[variables('PCMSS_Parser')]",
    "connector1-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connector1-name'))]",
    "_connector1-source": "[variables('connector1-source')]",
    "PCMSSConnector": "PCMSSConnector",
    "_PCMSSConnector": "[variables('PCMSSConnector')]",
    "BlockedProcesses_AnalyticalRules": "BlockedProcesses_AnalyticalRules",
    "_BlockedProcesses_AnalyticalRules": "[variables('BlockedProcesses_AnalyticalRules')]",
    "playbook1-AllowProcess": "playbook1-AllowProcess",
    "_playbook1-AllowProcess": "[variables('playbook1-AllowProcess')]",
    "playbook1-MicrosoftSentinelConnectionName": "[concat('MicrosoftSentinel-', parameters('playbook1-PlaybookName'))]",
    "playbook-1-connection-2": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/Azuresentinel')]",
    "_playbook-1-connection-2": "[variables('playbook-1-connection-2')]",
    "playbook2-BlockProcess": "playbook2-BlockProcess",
    "_playbook2-BlockProcess": "[variables('playbook2-BlockProcess')]",
    "playbook2-MicrosoftSentinelConnectionName": "[concat('MicrosoftSentinel-', parameters('playbook2-PlaybookName'))]",
    "sourceId": "pcmatic.pcmatic-supershield",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "PCMatic SuperShield Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "PCMatic SuperShield Data Parser",
            "category": "Samples",
            "functionAlias": "PCMSS",
            "query": "\nCommonSecurityLog\n| where DeviceVendor == 'PCMatic'\n| extend Category = extract(@'cat=(.*?);', 1, AdditionalExtensions)\n| extend Severity = extract(@'Severity=(.*?);', 1, AdditionalExtensions, typeof(int))\n| extend Host = extract(@'Host=(.*?);', 1, AdditionalExtensions)\n| extend DeviceExternalID = extract(@'deviceExternalID=(.*?);', 1, AdditionalExtensions)\n| extend GroupName = extract(@'groupName=(.*?);', 1, AdditionalExtensions)\n| extend GroupID = extract(@'groupID=(.*?);', 1, AdditionalExtensions)\n| extend ParentPath = extract(@'parentPath=(.*?);', 1, AdditionalExtensions)\n| extend MD5 = extract(@'md5=(.*?);', 1, AdditionalExtensions)\n| extend FileHash = extract(@'filehash=(.*?);', 1, AdditionalExtensions)\n| extend IsUnknown = extract(@'isUnknown=(.*?);', 1, AdditionalExtensions)\n| extend IsScript = extract(@'isScript=(.*?);', 1, AdditionalExtensions)\n| extend UserDecided = extract(@'userDecided=(.*?);', 1, AdditionalExtensions)\n| extend UserDecidedDesc = extract(@'userDecidedDesc=(.*?);', 1, AdditionalExtensions)\n| extend CmdLineArgs = extract(@'cmdLineArgs=(.*?);', 1, AdditionalExtensions)\n| extend Vendor = extract(@'vendor=(.*?);', 1, AdditionalExtensions)\n| extend Product = extract(@'product=(.*?);', 1, AdditionalExtensions)\n| extend ProductVersion = extract(@'productVersion=(.*?);', 1, AdditionalExtensions)\n| extend FileCopyright = extract(@'fileCopyright=(.*?);', 1, AdditionalExtensions)\n| extend IsSigned = extract(@'isSigned=(.*?);', 1, AdditionalExtensions)\n| extend DigitalSigAuthority = extract(@'digitalSigAuthority=(.*?);', 1, AdditionalExtensions)\n| extend DigitalSigVendor = extract(@'digitalSigVendor=(.*?);', 1, AdditionalExtensions)\n| extend OS = extract(@'os=(.*?);', 1, AdditionalExtensions)\n| extend OSArch = extract(@'osArch=(.*?);', 1, AdditionalExtensions)\n| extend OSPlatform = extract(@'osPlatform=(.*?);', 1, AdditionalExtensions)\n| extend OSRelease = extract(@'osRelease=(.*?);', 1, AdditionalExtensions)\n| extend OSKernel = extract(@'osKernel=(.*?);', 1, AdditionalExtensions)\n| extend ProtectionMode = extract(@'protectionMode=(.*)', 1, AdditionalExtensions)\n| order by TimeGenerated desc\n;",
            "version": 1
          }
        }
      ]
    },
    {
      "id": "[variables('_connector1-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector1-name'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "PC Matic SuperShield",
          "publisher": "PC Matic",
          "descriptionMarkdown": "The PC Matic SuperShield data connector provides the capability to ingest [PC Matic SuperShield](https://www.pcmatic.com/pro/) process activity events with Microsoft Sentinel. It helps you gain visibility into what applications and processes are being executed on your endpoints, and which of those are blocked by SuperShield.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "SuperShieldActivity",
              "baseQuery": "SuperShieldActivity"
            }
          ],
          "sampleQueries": [
            {
              "description": "Top 10 Reporting Devices",
              "query": "SuperShieldActivity\n | summarize count() by FileHash\n | top 10 by count_"
            }
          ],
          "dataTypes": [
            {
              "name": "SuperShieldActivity",
              "lastDataReceivedQuery": "SuperShieldActivity\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "SuperShieldActivity\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "write permission is required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "delete": true
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected. [Follow these steps](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Parsers/PCMaticSuperShield/PCMSS.txt) to create the Kusto Functions alias, **SuperShieldActivity**"
            },
            {
              "description": "Typically, you should install the agent on a different computer from the one on which the logs are generated.\n\n>  Syslog logs are collected only from **Linux** agents.",
              "instructions": [
                {
                  "parameters": {
                    "title": "Choose where to install the agent:",
                    "instructionSteps": [
                      {
                        "title": "Install agent on Azure Linux Virtual Machine",
                        "description": "Select the machine to install the agent on and then click **Connect**.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxVirtualMachine"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      },
                      {
                        "title": "Install agent on a non-Azure Linux Machine",
                        "description": "Download the agent on the relevant machine and follow the instructions.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxNonAzure"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ],
              "title": "1. Install and onboard the agent for Linux"
            },
            {
              "description": "Configure the facilities you want to collect and their severities.\n\n1.  Under workspace advanced settings **Configuration**, select **Data** and then **Syslog**.\n2.  Select **Apply below configuration to my machines** and select the facilities and severities.\n3.  Click **Save**.",
              "instructions": [
                {
                  "parameters": {
                    "linkType": "OpenSyslogSettings"
                  },
                  "type": "InstallAgent"
                }
              ],
              "title": "2. Configure the logs to be collected"
            },
            {
              "description": "[Follow these instructions](https://www.cisco.com/c/en/us/td/docs/security/ise/2-7/admin_guide/b_ise_27_admin_guide/b_ISE_admin_27_maintain_monitor.html#ID58) to configure remote syslog collection locations in your PC Matic SuperShield deployment.",
              "title": "3. Configure SuperShield Remote Syslog Collection Locations"
            }
          ],
          "additionalRequirementBanner": "This data connector depends on a parser based on Kusto Function to work as expected. Follow the steps to use this Kusto Function alias **SuperShieldActivity** in queries and workbooks. [Follow steps to get this Kusto Function>](https://aka.ms/sentinel-ciscoise-parser)"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Identifies processes blocked by SuperShield",
        "displayName": "PCMatic SuperShield Blocked Processes",
        "enabled": false,
        "query": "SuperShieldActivity\n| where Severity == 0\n| summarize Incidents = count() by FileHash, FileName, Host, DeviceAddress\n",
        "queryFrequency": null,
        "queryPeriod": null,
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": null,
        "triggerThreshold": null,
        "tactics": [
          "Execution"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "FileHash",
                "identifier": "Value"
              }
            ],
            "entityType": "FileHash"
          },
          {
            "fieldMappings": [
              {
                "columnName": "DeviceAddress",
                "identifier": "Address"
              }
            ],
            "entityType": "IP"
          },
          {
            "fieldMappings": [
              {
                "columnName": "Host",
                "identifier": "HostName"
              }
            ],
            "entityType": "Host"
          },
          {
            "fieldMappings": [
              {
                "columnName": "FileName",
                "identifier": "Name"
              }
            ],
            "entityType": "File"
          }
        ]
      }
    },
    {
      "properties": {
        "provisioningState": "Succeeded",
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "Microsoft_Sentinel_incident": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel_1']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              }
            }
          },
          "actions": {
            "HTTP": {
              "type": "Http",
              "inputs": {
                "body": {
                  "action": "allow",
                  "data": "@triggerBody()?['object']?['properties']?['relatedEntities']"
                },
                "method": "POST",
                "uri": "https://psmss-test-api.herokuapp.com"
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel_1": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-MicrosoftSentinelConnectionName'))]",
                "connectionName": "[variables('playbook1-MicrosoftSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/Azuresentinel')]"
              }
            }
          }
        }
      },
      "name": "[parameters('playbook1-PlaybookName')]",
      "type": "Microsoft.Logic/workflows",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "pcmatic": "block_process"
      },
      "apiVersion": "2017-07-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook1-MicrosoftSentinelConnectionName'))]"
      ]
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook1-MicrosoftSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "kind": "V1",
      "properties": {
        "displayName": "[variables('playbook1-MicrosoftSentinelConnectionName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "properties": {
        "provisioningState": "Succeeded",
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "Microsoft_Sentinel_incident": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel_1']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              }
            }
          },
          "actions": {
            "HTTP": {
              "type": "Http",
              "inputs": {
                "body": {
                  "action": "block",
                  "data": "@triggerBody()?['object']?['properties']?['relatedEntities']"
                },
                "method": "POST",
                "uri": "https://psmss-test-api.herokuapp.com"
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel_1": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook2-MicrosoftSentinelConnectionName'))]",
                "connectionName": "[variables('playbook2-MicrosoftSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/Azuresentinel')]"
              }
            }
          }
        }
      },
      "name": "[parameters('playbook2-PlaybookName')]",
      "type": "Microsoft.Logic/workflows",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "pcmatic": "block_process"
      },
      "apiVersion": "2017-07-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook2-MicrosoftSentinelConnectionName'))]"
      ]
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook2-MicrosoftSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "kind": "V1",
      "properties": {
        "displayName": "[variables('playbook2-MicrosoftSentinelConnectionName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "version": "1.0.0",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "PCMatic SuperShield",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "John Farley",
          "email": "john@pcmatic.com"
        },
        "support": {
          "name": "PC Matic",
          "email": "support@pcmatic.com",
          "tier": "PC Matic",
          "link": "https://www.pcmatic.com/support/#/business-support-form"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Parser",
              "contentId": "[variables('_PCMSS_Parser')]",
              "version": "1.0.0"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_PCMSSConnector')]",
              "version": "1.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_BlockedProcesses_AnalyticalRules')]",
              "version": "1.0.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_playbook1-AllowProcess')]",
              "version": "1.0.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_playbook2-BlockProcess')]",
              "version": "1.0.0"
            }
          ]
        },
        "firstPublishDate": "2022-05-16",
        "lastPublishDate": "2022-05-16",
        "providers": [
          "PC Matic"
        ],
        "categories": {
          "domains": [
            "Security - Vulnerability Management"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
