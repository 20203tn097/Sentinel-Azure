id: 00907853-c08c-49ad-b92e-b1df491b843f
name: Excessive Windows Discovery and Execution Processes - Potential Malware Installation
description: |
  'This package utilizes a list of commonly abused LOLB which an attacker or malware would execute in quick succession. The presence of multiple executions of the programs within the list can be indicative of an infection or malicious activity occurring on a victim host. To reduce false positives, distinct counts per process name can be utilized to ensure over 5 unique processes from the list were executed versus just checking more than 6 events were generated on the host.'
requiredDataConnectors:
  - connectorId: SecurityEvent
    dataTypes:
      - SecurityEvent
query: |
  SecurityEvent
  | where NewProcessName has_any (
    "arp.exe",
    "at.exe",
    "attrib.exe",
    "cscript.exe",
    "dsquery.exe",
    "hostname.exe",
    "ipconfig.exe",
    "mimikatz.exe",
    "nbtstat.exe",
    "net.exe",
    "netsh.exe",
    "nslookup.exe",
    "ping.exe",
    "quser.exe",
    "qwinsta.exe",
    "reg.exe",
    "runas.exe",
    "sc.exe",
    "schtasks.exe",
    "ssh.exe",
    "systeminfo.exe",
    "taskkill.exe",
    "telnet.exe",
    "tracert.exe",
    "wscript.exe",
    "xcopy.exe",
    "pscp.exe",
    "copy.exe",
    "robocopy.exe",
    "certutil.exe",
    "vssadmin.exe",
    "powershell.exe",
    "wevtutil.exe",
    "psexec.exe",
    "bcedit.exe",
    "wbadmin.exe",
    "icacls.exe",
    "diskpart.exe",
    "ver.exe",
    "netstat.exe",
    "tasklist.exe",
    "route.exe",
    "driverquery.exe"
  )
  | summarize firstEvent=min(TimeGenerated), lastEvent=max(TimeGenerated), uniqueProcesses=dcount(NewProcessName), eventIds=make_set(tostring(EventID)), processPaths=make_set(NewProcessName), processCommandLines=make_set(CommandLine), parentProcessPaths=make_set(ParentProcessName), processIds=make_set(NewProcessId), parentprocessIds=make_set(ProcessId), eventData=make_set(EventData), count() by SourceComputerId, Computer| order by firstEvent
  | where uniqueProcesses > 4