{
    "version": "Notebook/1.0",
    "items": [
        {
            "type": 1,
            "content": {
                "json": "SAP\u00ae Monitors- Alerts and Performance\n---\nThis workbook uses the SAP\u00ae Alerts (RZ20) data\nUse the parameters below to select subscription scope, timerange and relevant SAP systems."
            },
            "name": "text - 2"
        },
        {
            "type": 9,
            "content": {
                "version": "KqlParameterItem/1.0",
                "parameters": [
                    {
                        "id": "9a199167-2dde-49dd-8f01-23e9d1fa8151",
                        "version": "KqlParameterItem/1.0",
                        "name": "InternalWSs",
                        "type": 1,
                        "isRequired": true,
                        "query": "SecurityIncident\r\n| take 1\r\n| parse IncidentUrl with * \"/workspaces/\" Workspace \"/\" *\r\n| project Workspace",
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 604800000
                        },
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                        "id": "7806fefd-432f-4828-9756-8c0be5c08d07",
                        "version": "KqlParameterItem/1.0",
                        "name": "InternalSub",
                        "type": 1,
                        "isRequired": true,
                        "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| where name contains \"{InternalWSs}\"\r\n| take 10\r\n| project subscriptionId",
                        "crossComponentResources": [
                            "value::selected"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                            "durationMs": 0
                        },
                        "timeContextFromParameter": "TimeRange",
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    },
                    {
                        "id": "55d3ab63-6e1f-4d02-8d9e-2225526689c7",
                        "version": "KqlParameterItem/1.0",
                        "name": "Subscription",
                        "label": "Subscriptions",
                        "type": 6,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| extend selected= iff(name contains \"{InternalWSs}\", true, false) \r\n| project subscriptionId, selected\r\n| summarize selected= max(selected) by subscriptionId\r\n",
                        "crossComponentResources": [
                            "value::all"
                        ],
                        "typeSettings": {
                            "additionalResourceOptions": [
                                "value::50"
                            ],
                            "showDefault": false
                        },
                        "timeContext": {
                            "durationMs": 0
                        },
                        "timeContextFromParameter": "TimeRange",
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    },
                    {
                        "id": "4a62c5aa-0c4c-439a-9977-41cd19a40933",
                        "version": "KqlParameterItem/1.0",
                        "name": "SAPWorkspace",
                        "label": "SAP Workspace",
                        "type": 5,
                        "isRequired": true,
                        "isGlobal": true,
                        "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| project value =id, label = name, selected = iff(name =~ '{InternalWSs}', true, false)\r\n| order by selected desc\r\n",
                        "crossComponentResources": [
                            "value::all"
                        ],
                        "typeSettings": {
                            "resourceTypeFilter": {
                                "microsoft.securityinsightsarg/sentinel": true,
                                "microsoft.operationalinsights/workspaces": true
                            },
                            "additionalResourceOptions": [],
                            "showDefault": false
                        },
                        "timeContext": {
                            "durationMs": 0
                        },
                        "timeContextFromParameter": "TimeRange",
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                    }
                ],
                "style": "above",
                "doNotRunWhenHidden": true,
                "queryType": 0,
                "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "100",
            "name": "Select relevant workspaces"
        },
        {
            "type": 9,
            "content": {
                "version": "KqlParameterItem/1.0",
                "parameters": [
                    {
                        "id": "a2f453a3-836c-4e70-8840-45a27f6ac30f",
                        "version": "KqlParameterItem/1.0",
                        "name": "TimeRange",
                        "label": "Time Range",
                        "type": 4,
                        "description": "Select the time range that will be used for the query's",
                        "isRequired": true,
                        "typeSettings": {
                            "selectableValues": [
                                {
                                    "durationMs": 14400000
                                },
                                {
                                    "durationMs": 43200000
                                },
                                {
                                    "durationMs": 86400000
                                },
                                {
                                    "durationMs": 172800000
                                },
                                {
                                    "durationMs": 259200000
                                },
                                {
                                    "durationMs": 604800000
                                },
                                {
                                    "durationMs": 1209600000
                                },
                                {
                                    "durationMs": 2592000000
                                },
                                {
                                    "durationMs": 5184000000
                                },
                                {
                                    "durationMs": 7776000000
                                }
                            ],
                            "allowCustom": false
                        },
                        "value": {
                            "durationMs": 14400000
                        }
                    },
                    {
                        "id": "4c106c4f-59b7-40bc-a501-cd6d463ba585",
                        "version": "KqlParameterItem/1.0",
                        "name": "SystemRoles",
                        "label": "System Roles",
                        "type": 10,
                        "isRequired": true,
                        "isGlobal": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "let EmptySystems= datatable ( SystemID: string, SystemID_s:string , SystemUsage: string, SystemRole: string, Count: long  )['All Systems', 'All Systems', 'All System Usage', 'All System Roles', 1];\r\nlet AuditSystems = union isfuzzy= true *ABAPAuditLog_CL, (union Xal* | project-rename SystemID_s= MTSYSID_s), (EmptySystems| project SystemID, SystemID_s) | summarize by SystemID= SystemID_s;\r\nAuditSystems\r\n| lookup kind=inner (SAPSystems() | union isfuzzy=true EmptySystems) on SystemID\r\n| extend ranked= array_sum(to_utf8(SystemRole))\r\n| summarize Ranked= any(ranked) by SystemRole\r\n| order by Ranked desc\r\n| serialize Rank = row_number()\r\n| project value= SystemRole, label= strcat('\ud83d\udc8e', SystemRole), selected= iff(Rank==1, true, false)\r\n",
                        "crossComponentResources": [
                            "{SAPWorkspace}"
                        ],
                        "typeSettings": {
                            "additionalResourceOptions": [],
                            "showDefault": false
                        },
                        "timeContext": {
                            "durationMs": 0
                        },
                        "timeContextFromParameter": "TimeRange",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                        "id": "1a31d436-bb4b-469f-94a8-5ad9aa018edd",
                        "version": "KqlParameterItem/1.0",
                        "name": "SystemUsage",
                        "label": "System Usage",
                        "type": 10,
                        "isRequired": true,
                        "isGlobal": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "let EmptySystems= datatable ( SystemID: string, SystemID_s:string , SystemUsage: string, SystemRole: string, Count: long  )['All Systems', 'All Systems', 'All Usage Types', 'All System Roles', 1];\r\nlet AuditSystems = union isfuzzy= true *ABAPAuditLog_CL, (union Xal* | project-rename SystemID_s= MTSYSID_s), (EmptySystems| project SystemID, SystemID_s, SystemUsage) | summarize by SystemID= SystemID_s, SystemUsage;\r\nAuditSystems\r\n| lookup (SAPSystems(SelectedSystemRoles=dynamic(\"{SystemRoles}\"))) on SystemID\r\n| extend SystemUsage= strcat(SystemUsage, SystemUsage1)\r\n| extend ranked= array_sum(to_utf8(SystemUsage))\r\n| summarize Ranked= any(ranked) by SystemUsage\r\n| where isnotempty(SystemUsage)\r\n| order by Ranked desc\r\n| serialize Rank = row_number()\r\n//| where isnotempty(SystemUsage) or SystemID == 'All Systems'\r\n| project value= SystemUsage, label= strcat('\ud83c\udf10', SystemUsage), selected= iff(Rank==1, true, false)\r\n\r\n",
                        "crossComponentResources": [
                            "{SAPWorkspace}"
                        ],
                        "typeSettings": {
                            "additionalResourceOptions": [],
                            "showDefault": false
                        },
                        "timeContext": {
                            "durationMs": 0
                        },
                        "timeContextFromParameter": "TimeRange",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                        "id": "b5ed6d2c-e44f-48ac-a535-af6f2d7ab53d",
                        "version": "KqlParameterItem/1.0",
                        "name": "Systems",
                        "type": 2,
                        "isRequired": true,
                        "isGlobal": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "let EmptySystems= datatable ( SystemID: string, SystemID_s:string , SystemUsage: string, SystemRole: string, Count: long  )['All Systems', 'All Systems', 'All System Usage', 'All System Roles', 1];\r\nlet AuditSystems = union isfuzzy= true ABAPAuditLog_CL, (union Xal* | project-rename SystemID_s= MTSYSID_s), (EmptySystems| project SystemID, SystemID_s, SystemRole) | summarize SystemRole= any(SystemRole) by SystemID= SystemID_s\r\n| extend ranked= array_sum(to_utf8(SystemID));\r\nAuditSystems\r\n| lookup (SAPSystems(SelectedSystemRoles=dynamic(\"{SystemRoles}\"), SelectedSystemUsage=dynamic(\"{SystemUsage}\")) ) on SystemID\r\n//| extend SystemRole = strcat(SystemRole, SystemRole1)\r\n| extend SystemRole = SystemRole1\r\n| where isnotempty(SystemRole)\r\n| summarize Ranked= any(ranked) by SystemID, SystemRole, SystemUsage\r\n| order by Ranked desc\r\n| serialize Rank = row_number()\r\n| project value= SystemID, label= strcat('\ud83d\udee1\ufe0f', SystemID)\r\n//, selected= iff(Rank==1, true, false)\r\n//| project value, label, Selected= true\r\n\r\n\r\n\r\n",
                        "crossComponentResources": [
                            "{SAPWorkspace}"
                        ],
                        "typeSettings": {
                            "additionalResourceOptions": [
                                "value::all"
                            ],
                            "selectAllValue": "All Systems",
                            "showDefault": false
                        },
                        "timeContext": {
                            "durationMs": 0
                        },
                        "timeContextFromParameter": "TimeRange",
                        "defaultValue": "value::all",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces",
                        "value": [
                            "value::all"
                        ]
                    },
                    {
                        "id": "e336fafe-2ebd-4198-b60d-90ce89fd9944",
                        "version": "KqlParameterItem/1.0",
                        "name": "OnlyShowCurrentMonitors",
                        "label": "Show Monitors",
                        "type": 10,
                        "isRequired": true,
                        "isGlobal": true,
                        "typeSettings": {
                            "additionalResourceOptions": [],
                            "showDefault": false
                        },
                        "jsonData": "[ {\"value\": \"false\", \"label\": \"Active monitors\", \"selected\": true}, {\"value\": \"true\", \"label\": \"All monitors\"}]"
                    }
                ],
                "style": "above",
                "doNotRunWhenHidden": true,
                "queryType": 0,
                "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - Copy"
        },
        {
            "type": 3,
            "content": {
                "version": "KqlItem/1.0",
                "query": "SAPSystems(SelectedSystemRoles=dynamic(\"{SystemRoles}\")\r\n, SelectedSystems=todynamic(\"[{Systems}]\")\r\n, SelectedSystemUsage= dynamic(\"{SystemUsage}\")) \r\n| project SystemID\r\n| summarize Systems= makeset(SystemID,50)\r\n| project text= strcat(\"\", \"Selected SAP Systems: \", translate('\"[]', ' ', tostring(Systems)))\r\n",
                "size": 4,
                "timeContextFromParameter": "TimeRange",
                "queryType": 0,
                "resourceType": "microsoft.operationalinsights/workspaces",
                "visualization": "card",
                "textSettings": {
                    "style": "markdown"
                }
            },
            "conditionalVisibility": {
                "parameterName": "Systems",
                "comparison": "isNotEqualTo",
                "value": "'All Systems'"
            },
            "name": "query - 10"
        },
        {
            "type": 11,
            "content": {
                "version": "LinkItem/1.0",
                "style": "tabs",
                "tabStyle": "bigger",
                "links": [
                    {
                        "id": "a997c6cd-4d82-4fd5-b128-a16fbfd0e421",
                        "cellValue": "MainTabSelected",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83d\udcc9 Performance Indicators",
                        "subTarget": "Performance",
                        "preText": "Audit log alerts",
                        "style": "link",
                        "icon": "Sev2"
                    },
                    {
                        "id": "3a13be26-b92f-43fb-ac8b-593fadff36e6",
                        "cellValue": "MainTabSelected",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83d\udcc9 Alerts",
                        "subTarget": "Alerts",
                        "preText": "Logon analysis",
                        "style": "link",
                        "icon": "Sev2",
                        "tabWidth": "200"
                    },
                    {
                        "id": "c8f34134-31b2-415b-8ea5-2fcbf465b2c4",
                        "cellValue": "MainTabSelected",
                        "linkTarget": "parameter",
                        "linkLabel": "\ud83d\udcc9 Monitoring Tree",
                        "subTarget": "MonitoringTree",
                        "style": "link"
                    }
                ]
            },
            "customWidth": "100",
            "name": "tabs main"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\"{SystemRoles}\")\r\n, SelectedSystems=todynamic(\"[{Systems}]\")\r\n, SelectedSystemUsage= dynamic(\"{SystemUsage}\")) | project SystemID;\r\n//SelectedSystems\r\nSAPXalPerformance\r\n| where SystemID in(SelectedSystems)\r\n| union (SAPXalMonitorSetsTree | where {OnlyShowCurrentMonitors} | summarize by MonitorSetName , TimeGenerated= now())\r\n| make-series TrendList = count()-1 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, 1h) by MonitorSetName\r\n| extend Count= array_sum(TrendList)",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "showRefreshButton": true,
                            "exportMultipleValues": true,
                            "exportedParameters": [
                                {
                                    "fieldName": "MonitorSetName",
                                    "parameterName": "MonitorSetNames",
                                    "parameterType": 1,
                                    "quote": "'"
                                }
                            ],
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "tiles",
                            "gridSettings": {
                                "filter": true
                            },
                            "tileSettings": {
                                "titleContent": {
                                    "columnMatch": "MonitorSetName",
                                    "formatter": 1
                                },
                                "leftContent": {
                                    "columnMatch": "Count",
                                    "formatter": 12,
                                    "formatOptions": {
                                        "palette": "blue"
                                    },
                                    "numberFormat": {
                                        "unit": 17,
                                        "options": {
                                            "style": "decimal",
                                            "maximumFractionDigits": 2,
                                            "maximumSignificantDigits": 3
                                        }
                                    }
                                },
                                "secondaryContent": {
                                    "columnMatch": "TrendList",
                                    "formatter": 9,
                                    "formatOptions": {
                                        "palette": "coldHot"
                                    }
                                },
                                "showBorder": false,
                                "sortCriteriaField": "Count",
                                "sortOrderField": 2,
                                "size": "auto"
                            },
                            "graphSettings": {
                                "type": 0,
                                "topContent": {
                                    "columnMatch": "MonitorSetName",
                                    "formatter": 1
                                },
                                "centerContent": {
                                    "columnMatch": "Count",
                                    "formatter": 1,
                                    "numberFormat": {
                                        "unit": 17,
                                        "options": {
                                            "maximumSignificantDigits": 3,
                                            "maximumFractionDigits": 2
                                        }
                                    }
                                },
                                "nodeIdField": "MonitorName",
                                "sourceIdField": "MonitorSetName",
                                "targetIdField": "MonitorName",
                                "graphOrientation": 2,
                                "showOrientationToggles": true,
                                "edgeLabel": "MonitorName",
                                "nodeSize": null,
                                "staticNodeSize": 100,
                                "colorSettings": null,
                                "hivesMargin": 5
                            }
                        },
                        "name": "MonitoringSetsAndNames"
                    },
                    {
                        "type": 9,
                        "content": {
                            "version": "KqlParameterItem/1.0",
                            "parameters": [
                                {
                                    "id": "fea87446-d53e-4cef-a72c-d8cd9a3e81d5",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "MonitorNames",
                                    "label": "Monitors",
                                    "type": 2,
                                    "isGlobal": true,
                                    "multiSelect": true,
                                    "quote": "'",
                                    "delimiter": ",",
                                    "query": "let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\"{SystemRoles}\")\r\n, SelectedSystems=todynamic(\"[{Systems}]\")\r\n, SelectedSystemUsage= dynamic(\"{SystemUsage}\")) | project SystemID;\r\nSAPXalPerformance\r\n| where SystemID in(SelectedSystems)\r\n| where MonitorSetName in (todynamic(\"[{MonitorSetNames}]\")) or tostring(\"{MonitorSetNames}\")== \"\"\r\n| where ReverseOrder ==1\r\n| summarize Count= count() by value= MonitorName\r\n| order by Count desc\r\n| extend display= strcat(\"\ud83d\udcfa \", value, \" (\", Count,\")\" )\r\n| project value, display;",
                                    "typeSettings": {
                                        "additionalResourceOptions": [
                                            "value::all"
                                        ],
                                        "selectAllValue": "All Monitors",
                                        "showDefault": false
                                    },
                                    "timeContext": {
                                        "durationMs": 0
                                    },
                                    "timeContextFromParameter": "TimeRange",
                                    "defaultValue": "value::all",
                                    "queryType": 0,
                                    "resourceType": "microsoft.operationalinsights/workspaces",
                                    "value": [
                                        "value::all"
                                    ]
                                },
                                {
                                    "id": "8e0be7b9-2b76-459c-afa3-f4834b457f52",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "OnlyShowLastValues",
                                    "label": "Values",
                                    "type": 2,
                                    "isRequired": true,
                                    "isGlobal": true,
                                    "typeSettings": {
                                        "additionalResourceOptions": [],
                                        "showDefault": false
                                    },
                                    "jsonData": "[{\"value\": \"true\", \"label\": \"Most recent values\", \"selected\": true}, {\"value\": \"false\", \"label\": \"Include history\"}]",
                                    "timeContext": {
                                        "durationMs": 86400000
                                    }
                                }
                            ],
                            "style": "above",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces"
                        },
                        "name": "parameters - 2"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\"{SystemRoles}\")\r\n, SelectedSystems=todynamic(\"[{Systems}]\")\r\n, SelectedSystemUsage= dynamic(\"{SystemUsage}\")) | project SystemID;\r\nlet OnlyShowLastValues= tostring(\"{OnlyShowLastValues}\");\r\nSAPXalPerformance\r\n| take 1 | project SystemID\r\n| project SelectedMonitors= strcat(\"Selected monitors: \",replace_string(tostring(\"{MonitorNames}\"), \"'\",\" \"))",
                            "size": 4,
                            "timeContext": {
                                "durationMs": 86400000
                            },
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "card",
                            "textSettings": {
                                "style": "header"
                            }
                        },
                        "conditionalVisibility": {
                            "parameterName": "MonitorNames",
                            "comparison": "isNotEqualTo",
                            "value": "'All Monitors'"
                        },
                        "name": "query - 3"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\"{SystemRoles}\")\r\n, SelectedSystems=todynamic(\"[{Systems}]\")\r\n, SelectedSystemUsage= dynamic(\"{SystemUsage}\")) | project SystemID;\r\nlet OnlyShowLastValues= tostring(\"{OnlyShowLastValues}\");\r\nlet Performance= SAPXalPerformance\r\n| where SystemID in(SelectedSystems)\r\n| where MonitorSetName in (todynamic(\"[{MonitorSetNames}]\")) or tostring(\"{MonitorSetNames}\")== \"\"\r\n| where MonitorName in (todynamic(\"[{MonitorNames}]\")) or tostring(\"{MonitorNames}\")== \"'All Monitors'\";\r\n\r\nPerformance \r\n| where ReverseOrder == 1 or OnlyShowLastValues == \"false\"\r\n| extend LastReported= iff(ReverseOrder == 1, \"Most Recent\", \"History\")\r\n| project-reorder Color, LastReported, MonitorSetName, MonitorName, MonitoringTypeName, ObjectName, SystemID, UpdatedOn\r\n\r\n",
                            "size": 2,
                            "timeContextFromParameter": "TimeRange",
                            "showExportToExcel": true,
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Color",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Green",
                                                    "representation": "success",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Yellow",
                                                    "representation": "2",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Red",
                                                    "representation": "3",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "{0}{1}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Group",
                                        "formatter": 1
                                    }
                                ],
                                "rowLimit": 1000,
                                "filter": true,
                                "sortBy": [
                                    {
                                        "itemKey": "LastReported",
                                        "sortOrder": 1
                                    }
                                ]
                            },
                            "sortBy": [
                                {
                                    "itemKey": "LastReported",
                                    "sortOrder": 1
                                }
                            ]
                        },
                        "name": "query - 1"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "MainTabSelected",
                "comparison": "isEqualTo",
                "value": "Performance"
            },
            "name": "PerformanceGroup"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\"{SystemRoles}\")\r\n, SelectedSystems=todynamic(\"[{Systems}]\")\r\n, SelectedSystemUsage= dynamic(\"{SystemUsage}\")) | project SystemID;\r\n//SelectedSystems\r\nSAPXalAlerts\r\n| where SystemID in(SelectedSystems)\r\n| union (SAPXalMonitorSetsTree | where {OnlyShowCurrentMonitors} | summarize by MonitorSetName , TimeGenerated= now())\r\n| make-series TrendList = count()-1 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, 41h) by MonitorSetName\r\n| extend Count= array_sum(TrendList)\r\n",
                            "size": 0,
                            "timeContextFromParameter": "TimeRange",
                            "showRefreshButton": true,
                            "exportMultipleValues": true,
                            "exportedParameters": [
                                {
                                    "fieldName": "MonitorSetName",
                                    "parameterName": "MonitorSetNames",
                                    "parameterType": 1,
                                    "quote": "'"
                                }
                            ],
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "tiles",
                            "gridSettings": {
                                "filter": true
                            },
                            "tileSettings": {
                                "titleContent": {
                                    "columnMatch": "MonitorSetName",
                                    "formatter": 1
                                },
                                "subtitleContent": {
                                    "columnMatch": "MonitorName",
                                    "formatter": 1
                                },
                                "leftContent": {
                                    "columnMatch": "Count",
                                    "formatter": 12,
                                    "formatOptions": {
                                        "palette": "blue"
                                    },
                                    "numberFormat": {
                                        "unit": 17,
                                        "options": {
                                            "style": "decimal",
                                            "maximumFractionDigits": 2,
                                            "maximumSignificantDigits": 3
                                        }
                                    }
                                },
                                "secondaryContent": {
                                    "columnMatch": "TrendList",
                                    "formatter": 9,
                                    "formatOptions": {
                                        "palette": "coldHot"
                                    }
                                },
                                "showBorder": false,
                                "sortCriteriaField": "Count",
                                "sortOrderField": 2,
                                "size": "auto"
                            },
                            "graphSettings": {
                                "type": 0,
                                "topContent": {
                                    "columnMatch": "MonitorSetName",
                                    "formatter": 1
                                },
                                "centerContent": {
                                    "columnMatch": "Count",
                                    "formatter": 1,
                                    "numberFormat": {
                                        "unit": 17,
                                        "options": {
                                            "maximumSignificantDigits": 3,
                                            "maximumFractionDigits": 2
                                        }
                                    }
                                },
                                "nodeIdField": "MonitorName",
                                "sourceIdField": "MonitorSetName",
                                "targetIdField": "MonitorName",
                                "graphOrientation": 2,
                                "showOrientationToggles": true,
                                "edgeLabel": "MonitorName",
                                "nodeSize": null,
                                "staticNodeSize": 100,
                                "colorSettings": null,
                                "hivesMargin": 5
                            }
                        },
                        "name": "MonitoringSetsAndNames"
                    },
                    {
                        "type": 9,
                        "content": {
                            "version": "KqlParameterItem/1.0",
                            "parameters": [
                                {
                                    "id": "fea87446-d53e-4cef-a72c-d8cd9a3e81d5",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "MonitorNames",
                                    "label": "Monitors",
                                    "type": 2,
                                    "isGlobal": true,
                                    "multiSelect": true,
                                    "quote": "'",
                                    "delimiter": ",",
                                    "query": "let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\"{SystemRoles}\")\r\n, SelectedSystems=todynamic(\"[{Systems}]\")\r\n, SelectedSystemUsage= dynamic(\"{SystemUsage}\")) | project SystemID;\r\nSAPXalAlerts\r\n| where SystemID in(SelectedSystems)\r\n| where MonitorSetName in (todynamic(\"[{MonitorSetNames}]\")) or tostring(\"{MonitorSetNames}\")== \"\"\r\n| summarize Count= count() by value= MonitorName\r\n| order by Count desc\r\n| extend display= strcat(\"\ud83d\udcfa \", value, \" (\", Count,\")\" )\r\n| project value, display;",
                                    "typeSettings": {
                                        "additionalResourceOptions": [
                                            "value::all"
                                        ],
                                        "selectAllValue": "All Monitors",
                                        "showDefault": false
                                    },
                                    "timeContext": {
                                        "durationMs": 604800000
                                    },
                                    "timeContextFromParameter": "TimeRange",
                                    "defaultValue": "value::all",
                                    "queryType": 0,
                                    "resourceType": "microsoft.operationalinsights/workspaces"
                                }
                            ],
                            "style": "above",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces"
                        },
                        "name": "parameters - 2"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\"{SystemRoles}\")\r\n, SelectedSystems=todynamic(\"[{Systems}]\")\r\n, SelectedSystemUsage= dynamic(\"{SystemUsage}\")) | project SystemID;\r\n//SelectedSystems\r\nSAPXalAlerts\r\n| where SystemID in(SelectedSystems)\r\n| where MonitorSetName in (todynamic(\"[{MonitorSetNames}]\")) or tostring(\"{MonitorSetNames}\")== \"\"\r\n| where MonitorName in (todynamic(\"[{MonitorNames}]\")) or tostring(\"{MonitorNames}\")== \"'All Monitors'\"\r\n| project-reorder MonitorSetName, MonitorName, Color, Severity, STATUS, AlertCompletionStatus\r\n",
                            "size": 2,
                            "timeContextFromParameter": "TimeRange",
                            "showExportToExcel": true,
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Color",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Red",
                                                    "representation": "failed",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Yellow",
                                                    "representation": "2",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "thresholdValue": "Green",
                                                    "representation": "success",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "{0}{1}"
                                                }
                                            ]
                                        }
                                    }
                                ],
                                "filter": true,
                                "sortBy": [
                                    {
                                        "itemKey": "AlertCompletionStatus",
                                        "sortOrder": 1
                                    }
                                ]
                            },
                            "sortBy": [
                                {
                                    "itemKey": "AlertCompletionStatus",
                                    "sortOrder": 1
                                }
                            ]
                        },
                        "name": "query - 1"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "MainTabSelected",
                "comparison": "isEqualTo",
                "value": "Alerts"
            },
            "name": "AlertGroup"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\"{SystemRoles}\")\r\n, SelectedSystems=todynamic(\"[{Systems}]\")\r\n, SelectedSystemUsage= dynamic(\"{SystemUsage}\")) | project SystemID;\r\nlet XalUnion= (SAPXalAlerts | where SystemID in(SelectedSystems)\r\n| summarize Alerts= count(), AlertColor=max(VALUE) by MonitorSetName, MonitorName, SystemID\r\n| extend Source= \"Alerts\") \r\n| union (SAPXalPerformance \r\n| where SystemID in(SelectedSystems)\r\n| where ReverseOrder == 1\r\n| summarize Performance= count(), PerfColor= max(RelevantAlertStatus) by MonitorName, MonitorSetName, SystemID, MonitoringTypeName, ObjectName\r\n| extend Source= \"Performance\")\r\n| union (SAPXalMonitorSetsTree | where {OnlyShowCurrentMonitors} | summarize by MonitorSetName , MonitorName, Source= \"Tree\");\r\nXalUnion \r\n| summarize Alerts= sum(Alerts), Performance=sum(Performance), AlertColor=max(AlertColor), PerfColor= max(PerfColor) by MonitorSetName , MonitorName, SystemID\r\n| project-reorder MonitorSetName , MonitorName, SystemID, Alerts, AlertColor, Performance, PerfColor\r\n| order by Performance desc\r\n",
                            "size": 2,
                            "title": "Alerts & current performance indicators",
                            "timeContextFromParameter": "TimeRange",
                            "showExportToExcel": true,
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Monitor Set Name",
                                        "formatter": 1
                                    },
                                    {
                                        "columnMatch": "MonitorSetName",
                                        "formatter": 5
                                    },
                                    {
                                        "columnMatch": "MonitorName",
                                        "formatter": 5
                                    },
                                    {
                                        "columnMatch": "Alerts",
                                        "formatter": 0,
                                        "formatOptions": {
                                            "aggregation": "Sum"
                                        }
                                    },
                                    {
                                        "columnMatch": "AlertColor",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "3",
                                                    "representation": "4",
                                                    "text": ""
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "2",
                                                    "representation": "2",
                                                    "text": ""
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "1",
                                                    "representation": "success",
                                                    "text": ""
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "Blank",
                                                    "text": ""
                                                }
                                            ],
                                            "aggregation": "Max"
                                        }
                                    },
                                    {
                                        "columnMatch": "Performance",
                                        "formatter": 0,
                                        "formatOptions": {
                                            "aggregation": "Sum"
                                        }
                                    },
                                    {
                                        "columnMatch": "PerfColor",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "3",
                                                    "representation": "4",
                                                    "text": ""
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "2",
                                                    "representation": "2",
                                                    "text": ""
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "1",
                                                    "representation": "success",
                                                    "text": ""
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "Blank",
                                                    "text": ""
                                                }
                                            ],
                                            "aggregation": "Max"
                                        }
                                    }
                                ],
                                "rowLimit": 10000,
                                "filter": true,
                                "hierarchySettings": {
                                    "treeType": 1,
                                    "groupBy": [
                                        "MonitorSetName",
                                        "MonitorName"
                                    ],
                                    "expandTopLevel": false
                                },
                                "labelSettings": [
                                    {
                                        "columnId": "MonitorSetName",
                                        "label": "Monitor Set Name"
                                    },
                                    {
                                        "columnId": "MonitorName",
                                        "label": "Monitor Name"
                                    },
                                    {
                                        "columnId": "SystemID",
                                        "label": "System ID"
                                    },
                                    {
                                        "columnId": "Alerts",
                                        "label": "Alert Count"
                                    },
                                    {
                                        "columnId": "AlertColor",
                                        "label": "Alert Highest Severity"
                                    },
                                    {
                                        "columnId": "Performance",
                                        "label": "Performance"
                                    },
                                    {
                                        "columnId": "PerfColor",
                                        "label": "latest Performance State"
                                    }
                                ]
                            },
                            "sortBy": [],
                            "tileSettings": {
                                "titleContent": {
                                    "columnMatch": "MonitorName",
                                    "formatter": 1
                                },
                                "leftContent": {
                                    "columnMatch": "Performance",
                                    "formatter": 12,
                                    "formatOptions": {
                                        "palette": "greenRed"
                                    },
                                    "numberFormat": {
                                        "unit": 17,
                                        "options": {
                                            "style": "decimal",
                                            "maximumFractionDigits": 2,
                                            "maximumSignificantDigits": 3
                                        }
                                    }
                                },
                                "rightContent": {
                                    "columnMatch": "Alerts",
                                    "formatter": 12,
                                    "formatOptions": {
                                        "palette": "blue"
                                    },
                                    "tooltipFormat": {
                                        "tooltip": "\\{0}"
                                    }
                                },
                                "secondaryContent": {
                                    "columnMatch": "Text"
                                },
                                "showBorder": false,
                                "sortCriteriaField": "Total",
                                "sortOrderField": 2,
                                "size": "auto"
                            },
                            "graphSettings": {
                                "type": 2,
                                "topContent": {
                                    "columnMatch": "MonitorSetName",
                                    "formatter": 1
                                },
                                "centerContent": {
                                    "columnMatch": "Alerts",
                                    "formatter": 1,
                                    "numberFormat": {
                                        "unit": 17,
                                        "options": {
                                            "maximumSignificantDigits": 3,
                                            "maximumFractionDigits": 2
                                        }
                                    }
                                },
                                "hivesContent": {
                                    "columnMatch": "MonitorSetName",
                                    "formatter": 1
                                },
                                "nodeIdField": "MonitorName",
                                "sourceIdField": "MonitorSetName",
                                "targetIdField": "MonitorName",
                                "graphOrientation": 3,
                                "showOrientationToggles": false,
                                "nodeSize": null,
                                "staticNodeSize": 100,
                                "colorSettings": null,
                                "groupByField": "MonitorSetName",
                                "hivesMargin": 5
                            }
                        },
                        "name": "query - 1"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "MainTabSelected",
                "comparison": "isEqualTo",
                "value": "MonitoringTree"
            },
            "name": "MonitoringTreeGroup"
        }
    ],
    "fallbackResourceIds": [
        "/subscriptions/de5fb112-5d5d-42d4-a9ea-5f3b1359c6a6/resourcegroups/tamirk-rg/providers/microsoft.operationalinsights/workspaces/tamir-sap-log-analytics-ws"
    ],
    "fromTemplateId": "sentinel-SAP-Monitors-AlertsandPerformance",
    "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}