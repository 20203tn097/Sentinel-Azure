{
    "properties": {
        "category": "SAPFunctions",
        "displayName": "SAPAuditLogConfiguration",
        "query": "// optional parameters can look like this\r\n// let SelectedSystems =  dynamic([\"All Systems\"]);\r\n// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);\r\n// let SelectedSeverities=  dynamic([\"High\", \"Medium\"]);\r\n// // let SelectedRuleTypes = dynamic([\"All RuleTypes\"]);\r\n// // let SelectedRuleTypes= dynamic([\"AnomaliesOnly\"]);\r\n// let SelectedRuleTypes= dynamic([\"Deterministic\"]);\r\n// // let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);\r\n// // let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\r\n// // let SelectedSeverities =  dynamic([\"All Severities\"]);\r\n\r\nlet Configuration = materialize (_GetWatchlist('SAP_Dynamic_Audit_Log_Monitor_Configuration') \r\n    | summarize arg_max(LastUpdatedTimeUTC, *) by SearchKey\r\n    | where (SelectedSeverities has ProductionSeverity or SelectedSeverities has NonProdSeverity or tostring(SelectedSeverities) == '[\"All Severities\"]')\r\n    | where (SelectedRuleTypes has RuleType or tostring(SelectedRuleTypes) == '[\"All RuleTypes\"]')\r\n    | extend DummyJoinField = 1);\r\n\r\nlet Systems = materialize (_GetWatchlist('SAP - Systems') \r\n    | where SearchKey in (SelectedSystems) or tostring(SelectedSystems) == '[\"All Systems\"]'\r\n    | where SystemRole in (SelectedSystemRoles) or tostring(SelectedSystemRoles) == '[\"All System Roles\"]'\r\n    | project-keep SearchKey, SystemRole, SystemUsage\r\n    | extend DummyJoinField = 1);\r\n\r\n\r\nlet SystemConfigurations =  Configuration\r\n    | join kind= inner Systems\r\n        on $left.DummyJoinField == $right.DummyJoinField;\r\n\r\n\r\nSystemConfigurations\r\n| project-rename SystemID = SearchKey1\r\n// | extend IsProd = iff((SystemRole == \"Production\" or ConsiderAsProd has SystemID) and not(ConsiderAsNonProd has SystemID), true, false)\r\n| extend IsProd = iff(SystemRole == \"Production\" , true, false)\r\n| extend Severity = iff(IsProd, ProductionSeverity, NonProdSeverity)\r\n| extend Threshold = tolong( iff(IsProd, ProductionThreshold, NonProdThreshold))\r\n| where (SelectedSeverities has Severity or  tostring(SelectedSeverities) == '[\"All Severities\"]')\r\n| extend BagOfDetails = bag_pack('MessageID', MessageID, 'Tactics', Tactics, 'SystemID', SystemID, 'Severity', Severity, 'DestinationEmail', DestinationEmail, 'TeamsChannelID', TeamsChannelID)\r\n// remove spaces\r\n| extend RolesTagsToExclude = replace_string(RolesTagsToExclude, ' ', '')\r\n\r\n\r\n| project-keep CategoryName\r\n, MessageID\r\n, MessageText\r\n, Tactics\r\n, SystemID\r\n, SystemRole\r\n, SystemUsage\r\n, DetailedDescription\r\n, Severity\r\n, DestinationEmail\t\r\n, TeamsChannelID\r\n, IsProd\r\n, BagOfDetails\r\n, Threshold\r\n, RolesTagsToExclude\r\n, RuleType\r\n// , VariablesDataTypes\r\n\r\n\r\n",
        "functionAlias": "SAPAuditLogConfiguration",
        "functionParameters": "SelectedSystems:dynamic = dynamic([\"All Systems\"]), SelectedSystemRoles:dynamic = dynamic([\"All System Roles\"]), SelectedSeverities:dynamic = dynamic([\"High\", \"Medium\"]), SelectedRuleTypes:dynamic = dynamic([\"All RuleTypes\"])",
        "version": 2,
        "etag": "*"
    },
    "name": "SAPAuditLogConfiguration",
    "type": "savedSearches",
    "apiVersion": "2022-10-01"
}