{
    "properties": {
        "category": "SAPFunctions",
        "displayName": "SAPAuditLogConfigRecommend",
        "query": "// This query aims to give configuration recommendations related to the handling of the anomaly detection rules \r\n// performed on the SAP audit log\r\nlet LearningTime = 14d;\r\n// get anomalies from the last 14 days\r\nlet MaterAnoms= materialize(SAPAuditLogAnomalies(DetectingTime= 0h, LearningTime= LearningTime));\r\nlet UserRolesProfiles= SAPUsersAssignments() \r\n| summarize DirectRoles= make_set_if(DirectRoles, isnotempty( DirectRoles), 50) , ChildRoles= make_set_if(ChildRoles, isnotempty( ChildRoles),20), Profiles= make_set_if(Profiles, array_length(Profiles) > 0, 50) by User, SystemID, ClientID= Client\r\n| extend Roles= array_concat(DirectRoles, ChildRoles); \r\n// overview of all anomalies\r\nlet AnomalyCount= MaterAnoms\r\n    | summarize Count= count() * 1.00\r\n    | extend\r\n        Issue= strcat(\"Total Anomalies counted within the last \", format_timespan(LearningTime, 'd'), ' days'),\r\n        Recommendation= '',\r\n        Sort= 100;\r\n// daily average\r\nlet DailyAnomalyCount= MaterAnoms\r\n    | summarize Count= count() * (1d / LearningTime)\r\n    | extend\r\n        Issue= iff(Count > 10, strcat(\"Daily average anomaly count of \", toint(Count), \" is too high\"), strcat(\"Expected daily incident count is \", toint(Count))),\r\n        Recommendation= 'Consider the recommendations below to further configure your SAP audit log alerting',\r\n        Sort= 90;\r\nlet NoiseThreshold= max_of(toscalar(DailyAnomalyCount\r\n    | project Count) / 10, 10);\r\n//  Recommended tags to be added\r\nlet RecommendedTagsToAdd= MaterAnoms\r\n    | where isempty(RolesTagsToExclude)\r\n    | summarize Count= count() * 1.00 by MessageID\r\n    | where Count > NoiseThreshold\r\n    | extend\r\n        Issue= 'Noisey MessageIDs- add tags',\r\n        Recommendation= strcat(\"Create Tags for MessageID \", MessageID, \" using the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist\"),\r\n        Sort= 80;\r\n// recommended users to assign with tags\r\nlet RecommendedTagsPerUser= MaterAnoms\r\n    | where isnotempty(RolesTagsToExclude) and tostring(RolesTagsToExclude)!= '[\"nan\"]'\r\n    | summarize\r\n        Count= count() * 1.00,\r\n        Values= make_set_if(RolesTagsToExclude, isnotempty(RolesTagsToExclude) or tostring(RolesTagsToExclude)!= '[\"nan\"]', 50)\r\n        by User\r\n    | where Count > NoiseThreshold\r\n    | extend\r\n        Issue= 'Noisey Users',\r\n        Recommendation= strcat(\"Add the tags \", tostring(Values), \" to user \", User, \" using the SAP_User_Config watchlist\"),\r\n        Sort= 70;\r\n// recommended profiles to add to Message IDs\r\nlet RecommendedProfilesToAdd= MaterAnoms \r\n    | join kind= inner UserRolesProfiles on User, SystemID, ClientID\r\n    | where array_length(Profiles) > 0\r\n    | summarize\r\n        Count= count() * 1.00,\r\n        Values= make_set(Profiles, 50)\r\n        by MessageID\r\n    | where Count > NoiseThreshold\r\n    | extend\r\n        Issue= 'Noisey MessageIDs- add profiles',\r\n        Recommendation= strcat(\"Add the Profiles \", tostring(Values),\" as RolesTagsToExclude next to MessageID  \", MessageID, \" in the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist\"),\r\n        Sort= 60;\r\n// recommended Roles to add to Message IDs\r\nlet RecommendedRolesToAdd= MaterAnoms \r\n    | join kind= inner UserRolesProfiles on User, SystemID, ClientID\r\n    | where array_length(Roles) > 0\r\n    | summarize\r\n        Count= count() * 1.00,\r\n        Values= make_set(Roles, 50)\r\n        by MessageID\r\n    | where Count > NoiseThreshold\r\n    | extend\r\n        Issue= 'Noisey MessageIDs- add roles',\r\n        Recommendation= strcat(\"Add the Roles \", tostring(Values),\" as RolesTagsToExclude next to MessageID \", MessageID, \" in the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist\"),\r\n        Sort= 50;\r\n// query\r\nunion AnomalyCount, DailyAnomalyCount, RecommendedTagsPerUser, RecommendedTagsToAdd, RecommendedProfilesToAdd, RecommendedRolesToAdd\r\n| order by Sort, Count desc  \r\n| project IncidentCount= toint(Count), Issue, Recommendation",
        "functionAlias": "SAPAuditLogConfigRecommend",
        "version": 2,
        "etag": "*"
    },
    "name": "SAPAuditLogConfigRecommend",
    "type": "savedSearches",
    "apiVersion": "2022-10-01"
}