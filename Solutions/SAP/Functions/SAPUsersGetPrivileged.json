{
    "properties": {
        "category": "SAPFunctions",
        "displayName": "SAPUsersGetPrivileged",
        "query": "let AuditTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\r\nlet availableSystems= SAPAuditLog\r\n| where TimeGenerated > ago(AuditTimeAgo)\r\n| summarize by SystemID, Client= ClientID\r\n| extend dummy ='';\r\n\r\n// Get Relevant Users from WatchList\r\nlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');\r\nlet FixedUsers = datatable(User: string, Client: string, SystemID: string) [\"DDIC\", \"XXX\",\"001\"];\r\n\r\nlet fixedProfiles = datatable(Profile: string) [\"SAP_ALL\", \"SAP_NEW\"];\r\n\r\nlet fixedRoles = datatable(Role: string) ['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];\r\n\r\nlet SensProfiles = _GetWatchlist('SAP - Sensitive Profiles')\r\n    | union isfuzzy=true fixedProfiles\r\n    | summarize by Profile;\r\n\r\nlet SensRoles = _GetWatchlist('SAP - Sensitive Roles')\r\n    | union isfuzzy=true fixedRoles\r\n    | summarize by Role;\r\n\r\nlet PrivUserdByMD = SAPUsersAssignments()\r\n| project User, ChildRoles, DirectRoles, Profiles, Client, SystemID\r\n| mv-expand ChildRoles, DirectRoles, Profiles\r\n| where DirectRoles in (SensRoles) or ChildRoles in (SensRoles) or Profiles in (SensProfiles)\r\n| summarize by User, Client, SystemID;\r\n\r\n// cross join watchlist users with available systems and clients\r\nlet FixedUPriv = ((PrivelegedUsers\r\n    | union isfuzzy=true  FixedUsers \r\n    | summarize by User\r\n    | extend dummy = '') \r\n    | join kind= fullouter availableSystems\r\n        on $left.dummy == $right.dummy);\r\n\r\nFixedUPriv\r\n| union isfuzzy=true PrivUserdByMD, FixedUsers\r\n| summarize by User, Client, SystemID",
        "functionAlias": "SAPUsersGetPrivileged",
        "version": 2,
        "etag": "*"
    },
    "name": "SAPUsersGetPrivileged",
    "type": "savedSearches",
    "apiVersion": "2022-10-01"
}