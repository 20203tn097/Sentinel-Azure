{
    "properties": {
        "category": "SAPFunctions",
        "displayName": "SAPUsersHeader",
        "query": "// // optional parameters can look like this\r\n// let SelectedSystems =  dynamic([\"All Systems\"]);\r\n// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);\r\n// let SelectedUsers = dynamic([\"All Users\"]);\r\n// let SelectedUser = \"All Users\";\r\n// // let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);\r\n// // let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\r\n// // let SelectedUsers = dynamic([\"DEVELOPER\",\"DDIC\"]); \r\n// // let SelectedUser = \"DDIC\";\r\n\r\nlet UserMDLookBack = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\r\nlet UserHeaderAuditLookBack = totimespan(toscalar(SAPGetParameters('UserHeaderAuditLookBack')| project-keep ValueLow));\r\n\r\nlet Now = now();\r\nlet Systems = materialize (_GetWatchlist('SAP - Systems') \r\n    | where SearchKey in (SelectedSystems) or tostring(SelectedSystems) == '[\"All Systems\"]'\r\n    | where SystemRole in (SelectedSystemRoles) or tostring(SelectedSystemRoles) == '[\"All System Roles\"]' \r\n    | project-keep SystemID, SystemRole, SystemUsage);\r\n\r\nlet AuditEvents= materialize(SAPAuditLog() \r\n| where TimeGenerated > ago(UserHeaderAuditLookBack)\r\n| summarize  TimeGenerated= arg_max(TimeGenerated, User, ClientID, SystemID, TerminalIPv6, Email) by User, ClientID, SystemID, TerminalIPv6, Email\r\n| lookup kind=inner Systems on SystemID\r\n| project-rename Client= ClientID);\r\n\r\nlet LastKnownIPs = AuditEvents | where isnotempty(TerminalIPv6)| summarize LastUsedOn= arg_max(TimeGenerated, *) by User, Client, SystemID | project LastKnownIP= TerminalIPv6, User, Client, SystemID;\r\n\r\nlet KnownIPsAndEmails = AuditEvents\r\n| summarize Count= count() by User, Client, SystemID, TerminalIPv6, Email| order by Count desc\r\n| summarize KnownEmails= make_set_if(Email,isnotempty( Email), 10), KnownIPs = make_set_if(TerminalIPv6, isnotempty(TerminalIPv6), 10) \r\nby User, SystemID, Client\r\n| extend PrimaryEmail = KnownEmails[0], PrimaryIP= KnownIPs[0];\r\n\r\n// query\r\nSystems | join kind= inner \r\n// get logon Data (Kernel-Side Use)\r\n(SAP_USR02 | where TimeGenerated > ago(UserMDLookBack) \r\n| where (BNAME in (SelectedUsers) or tostring( SelectedUsers) == '[\"All Users\"]') and (BNAME == SelectedUser or SelectedUser == \"All Users\")\r\n| summarize arg_max(TimeGenerated, *) by BNAME, MANDT, SystemID )\r\non SystemID\r\n\r\n// get User Name/Address Key Assignment\r\n| join kind=leftouter hint.strategy=shuffle \r\n(SAP_USR21 | where TimeGenerated > ago(UserMDLookBack) | summarize arg_max(TimeGenerated, *) by BNAME, MANDT, SystemID)\r\non BNAME, MANDT, SystemID\r\n| project-rename CLIENT= MANDT\r\n\r\n// get E-Mail Addresses \r\n| join kind= leftouter hint.strategy=shuffle \r\n(SAP_ADR6 | where TimeGenerated > ago(UserMDLookBack) \r\n| summarize arg_max(TimeGenerated, CONSNUMBER ) by CLIENT, DATE_FROM, ADDRNUMBER, PERSNUMBER, SystemID, SMTP_ADDR)\r\n on ADDRNUMBER, PERSNUMBER, SystemID, CLIENT\r\n| project-rename User= BNAME, Client= CLIENT\r\n| lookup KnownIPsAndEmails on User, SystemID, Client\r\n| lookup LastKnownIPs on User, SystemID, Client\r\n\r\n| extend LastSeen = todatetime(strcat(TRDAT, LTIME))\r\n| extend LastSeenDaysAgo = datetime_diff('Day', Now, LastSeen)\r\n| project \r\n// TimeGenerated,\r\nUser,\r\nEmail = SMTP_ADDR,\r\nUserType = USTYP,\r\nTimezone = TZONE,\r\nLockedStatus = UFLAG,\r\nLastSeen,\r\nLastSeenDaysAgo,\r\nPrimaryIP,\r\nLastKnownIP,\r\nPrimaryEmail,\r\nKnownIPs,\r\nKnownEmails,\r\nClient,\r\nSystemID,\r\nSystemRole,\r\nSystemUsage",
        "functionAlias": "SAPUsersHeader",
        "functionParameters": "SelectedSystemRoles:dynamic = dynamic([\"All System Roles\"]), SelectedSystems:dynamic = dynamic([\"All Systems\"]), SelectedUsers:dynamic = dynamic([\"All Users\"]), SelectedUser:string = \"All Users\"",
        "version": 2,
        "etag": "*"
    },
    "name": "SAPUsersHeader",
    "type": "savedSearches",
    "apiVersion": "2022-10-01"
}