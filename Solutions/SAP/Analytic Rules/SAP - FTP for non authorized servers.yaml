alertDetailsOverride: null
customDetails:
    SAP_User: User
description: "Identifies FTP connection for non authorized server.\nMaintain new Watchlist,\
    \ similar to SAPFTP_SERVERS \nSource Action: Create a new FTP connection e.g.\
    \ by using Function Module FTP_CONNECT.\n\n*Data Sources: SAPcon -  Audit Log*"
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: bd39a2f0-2eaa-41e6-a071-70c42e42dd21
kind: Scheduled
name: SAP - FTP for non authorized servers
query: "// Define variables\r\nlet AuditClasses = dynamic(['DU8']); // Message of\
    \ Successfull FTP Connection\r\nlet FTPSafeConnections = _GetWatchlist(\"SAP -\
    \ FTP Servers\");\r\nlet fixedConnections = datatable(Client: string, Description:\
    \ string,\r\nFTP_Server_Name: string, FTP_Server_Port: string)\r\n    // Maintain\
    \ these if WatchList is not available    \r\n    [100, \"description\", \"http://ourorgftpserver.com/\"\
    , 22]\r\n;\r\nlet UnitedConnections = toscalar(union kind=outer isfuzzy=true FTPSafeConnections,\
    \ fixedConnections | summarize Connections = make_set(FTP_Server_Name));\r\n//\
    \ Query logic\r\nSAPAuditLog\r\n| where MessageID in (AuditClasses)\r\n| where\
    \ TerminalIPv6 !in (UnitedConnections) // The IP is unknown\r\n| project TimeGenerated,\
    \ Instance ,User, SystemID, ClientID, Email, TerminalIPv6, Host"
queryFrequency: 6h
queryPeriod: 6h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
severity: Medium
tactics:
- Discovery
- InitialAccess
- CommandAndControl
triggerOperator: gt
triggerThreshold: 0
version: 2.0.15
