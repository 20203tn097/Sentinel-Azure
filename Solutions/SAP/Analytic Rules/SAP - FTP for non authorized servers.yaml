alertDetailsOverride: null
customDetails:
    SAP_User: User
description: |
    Identifies FTP connection for non authorized server.
    Maintain new Watchlist, similar to SAPFTP_SERVERS
    Source Action: Create a new FTP connection e.g. by using Function Module FTP_CONNECT.

    *Data Sources: SAPcon -  Audit Log*
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: bd39a2f0-2eaa-41e6-a071-70c42e42dd21
kind: Scheduled
name: SAP - FTP for non authorized servers
query: |
    // Define variables
    let AuditClasses = dynamic(['DU8']); // Message of Successfull FTP Connection
    let FTPSafeConnections = _GetWatchlist("SAP - FTP Servers");
    let fixedConnections = datatable(Client: string, Description: string,
    FTP_Server_Name: string, FTP_Server_Port: string)
        // Maintain these if WatchList is not available
        [100, "description", "http://ourorgftpserver.com/", 22]
    ;
    let UnitedConnections = toscalar(union kind=outer isfuzzy=true FTPSafeConnections, fixedConnections | summarize Connections = make_set(FTP_Server_Name));
    // Query logic
    SAPAuditLog
    | where MessageID in (AuditClasses)
    | extend TerminalIPv6 = Variable1
    | where TerminalIPv6 !in (UnitedConnections) // The IP is unknown
    | project TimeGenerated, Instance ,User, SystemID, ClientID, Email, TerminalIPv6, Host
queryFrequency: 6h
queryPeriod: 6h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
severity: Medium
tactics:
- Discovery
- InitialAccess
- CommandAndControl
triggerOperator: gt
triggerThreshold: 0
version: 2.0.19
