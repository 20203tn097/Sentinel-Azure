alertDetailsOverride: null
customDetails:
    SAP_User: User
description: 'Identifies execution of a sensitive function module using RFC.


    Source Action: Execute a function module using RFC.


    **Recommended for Production only**


    Function Modules should be maintained in watchlist "SAP - Sensitive Function Modules"


    *Data Sources: SAPcon -  Audit Log*'
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: 8e8a95c5-7f78-435e-9e6a-7e29c0b831c1
kind: Scheduled
name: SAP - RFC Execution of a Sensitive Function Module
query: "let Role = \"Production\";\r\nlet AuditClasses = dynamic(['AUK']); // Audit\
    \ Log Classes - Successful RFC call &C (function group = &A)\r\nlet allSystemRoles\
    \ = dynamic(['Sandbox', 'Developement', 'QualityAssurance', 'Training', 'Production']);\
    \ // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP', 'CRM', 'BW',\
    \ 'Solman', 'Gateway', 'Enterprise Portal']); // Available System Usages\r\n//\
    \ Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\
    \nlet fixedSID = datatable(SystemID: string, SystemRole: string, SystemUsage:\
    \ string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"\
    S4H\", \"Production\", \"ERP\",\r\n    \"XXX\", \"Sandbox\", \"BW\"]\r\n; \r\n\
    // Get Relevant Function Modules\r\nlet SensitiveFM = _GetWatchlist('SAP - Sensitive\
    \ Function Modules');\r\nlet fixedFM = datatable(FunctionModule: string)\r\n \
    \   // Maintain these if WatchList is not available    \r\n    [\"RSAU_CLEAR_AUDIT_LOG\"\
    ]\r\n; \r\nlet UnitedSystems = union systemID, fixedSID\r\n| where SystemRole\
    \ == Role // Recommended  is Production only\r\n| summarize by SystemID;\r\n//|\
    \ where SystemRole in (allSystemRoles); // Use this for all system roles\r\nlet\
    \ UnitedSensitive =  union SensitiveFM, fixedFM\r\n| summarize by FunctionModule;\r\
    \nSAPAuditLog \r\n| where MessageID in (AuditClasses)\r\n| project-rename FunctionModule\
    \ = Variable3, FunctionGroup = Variable1\r\n| where SystemID in (UnitedSystems)\
    \ // The systemID is in this list\r\n| where FunctionModule in (UnitedSensitive)\
    \ // Function module is sensitive\r\n| order by TimeGenerated asc\r\n| project\
    \ TimeGenerated,Instance ,User, SystemID, ClientID, MessageText, FunctionGroup,\
    \ FunctionModule, MessageID, Email, TerminalIPv6, Host"
queryFrequency: 2h
queryPeriod: 2h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
severity: High
tactics:
- Execution
- LateralMovement
- Discovery
triggerOperator: gt
triggerThreshold: 0
version: 2.0.15
