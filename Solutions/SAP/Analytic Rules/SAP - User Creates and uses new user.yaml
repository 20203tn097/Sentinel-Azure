alertDetailsOverride: null
customDetails:
    SAP_User: UserActing
    SAP_UserCreated: UserCreated
description: 'Identifies a user creating and using other users.


    Source Action: Create a user using SU01. Login using the newly created user from
    the same IP.


    *Data Sources: SAPcon -  Audit Log*'
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: UserActingEmail
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
-   entityType: Account
    fieldMappings:
    -   columnName: UserCreatedEmail
        identifier: FullName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: 12509d03-0206-4b85-84b9-6d2349afa42b
kind: Scheduled
name: SAP - User Creates and uses new user
query: "// Define Variables\r\nlet MinutesThreshold = 15; // Difference by minutes\
    \ between Create and Connect\r\nlet AuditUserCreated = dynamic(['AU7']); // Message\
    \ of create user\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect\
    \ with user\r\n// Query Logic\r\nlet UserCreated = // Get users created\r\nSAPAuditLog\r\
    \n| where MessageID in (AuditUserCreated)\r\n| project-rename UserCreationTimeGenerated\
    \ = TimeGenerated, UserCreated = Variable1;\r\nSAPAuditLog // Get users connections\r\
    \n| where MessageID in (AuditLogIn)\r\n| lookup kind=inner UserCreated on TerminalIPv6,$left.User\
    \ == $right.UserCreated, SystemID, ClientID // Lookup of user created to user\
    \ log in\r\n| where abs(datetime_diff('Minute', TimeGenerated, UserCreationTimeGenerated))\
    \ <= MinutesThreshold // Connect after creation\r\n| summarize by TimeGenerated,\
    \ Instance ,SystemID, ClientID, UserActing = User1, UserActingEmail= Email1, UserCreated\
    \ = User, UserCreatedEmail= Email, TerminalIPv6, Host"
queryFrequency: 1h
queryPeriod: 1h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
severity: High
tactics:
- Discovery
- InitialAccess
triggerOperator: gt
triggerThreshold: 0
version: 2.0.15
