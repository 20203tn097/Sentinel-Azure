alertDetailsOverride: null
customDetails:
    SAP_User: User
description: |
    Identifies Dialog logon of a sensitive privileged user.

    Source Action: Logon to the backend system using SAP* or anoter privileged user.

    Priveleged users should be maintained in "SAP - Privileged Users" Watchlist

    This rule requires a fresh full reload of the SAP user master data to be performed daily.
    *Data Sources: SAPcon -  Audit Log*
    *Data Sources: SAPcon -  User MD*
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: 97d13311-748b-4016-b095-9100ab00e4db
kind: Scheduled
name: SAP - Sensitive Privileged User Logged in
query: |
    // Define Variables
    // time span for audit events
    let AuditTimeAgo= 75m;
    // Audit Log Classes - Dialog Logon Successful
    let AuditClassesSuccess = dynamic(['AU1']);
    let AuditClassesFail = dynamic(['BU1']);
    let AuditRFCSuccess = dynamic(['AU5']);
    let AuditRFCFail = dynamic(['AU6']);
    let LogonTypes = dynamic(['A','H', 'R', 'S']); // Dialog / HTTP
    // Query logic
    SAPAuditLog
    | where TimeGenerated > ago(AuditTimeAgo)
    | where (MessageID in (AuditClassesSuccess) and Variable1 in (LogonTypes)) or // Success login
    MessageID in (AuditClassesFail) or // Failed login
    (MessageID in (AuditRFCSuccess) and Variable1 in (LogonTypes)) or // Success RFC login
    MessageID in (AuditRFCFail) // Failed RFC login
    |join (SAPUsersGetPrivileged())
    on $left.ClientID == $right.Client
    , $left.SystemID == $right.SystemID
    , $left.User == $right.User
    | project-rename LogonType = Variable1
    | project TimeGenerated, Instance ,SystemID, ClientID, LogonType, User, MessageText,
    Email, TerminalIPv6, Host
queryFrequency: 1h
queryPeriod: 2d
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
    - SAPUsersGetPrivileged
severity: High
tactics:
- InitialAccess
- CredentialAccess
triggerOperator: gt
triggerThreshold: 0
version: 2.0.19
