id: 263ea651-10c8-48a6-a5ac-2c9fc0655ebc
name: SAP - New ICF Services
description: |
    'Identifies creation of ICF Services.
    Source Action: Create a service using SICF.
    *Data Sources: SAPcon - Table Data Log*'
severity: High
requiredDataConnectors:
 -  connectorId: SAP
    dataTypes:
     - SAPUsersHeader
queryFrequency: 2h
queryPeriod: 2d
triggerOperator: gt
triggerThreshold: 0
tactics:
 - CommandAndControl
 - Persistence
 - LateralMovement
query: |
    // New ICF Services
    let TimeAgo= 2h;
    SAPTableDataLog
    | where TableName == "ICFSERVLOC"
    | where TimeGenerated > TimeAgo
    | where TableField == "ICF_NAME" // Service name
    | where OldValue == "" and NewValue != "" // New value is inserted in name -> new service
    | order by TimeGenerated desc
    | lookup SAPUsersHeader() on SystemID, $left.UserName== $right.User
    | extend TerminalIPv6= iff(isnotempty( LastKnownIP), LastKnownIP, PrimaryIP)
    | project TimeGenerated, Service = NewValue, PrimaryIP, PrimaryEmail, KnownIPs, KnownEmails, LastKnownIP, User= UserName, Host, SystemID, Client, Instance
    | extend Dummy= ''
alertDetailsOverride:
    alertDisplayNameFormat: (Preview) SAP - High - New ICF Services created by {{User}}
        in system {{SystemID}}
    alertDescriptionFormat: |
        Identifies creation of ICF Services.
        Source Action: Create a service using SICF.
        *Data Sources: SAPcon - Table Data Log*
    alertTacticsColumnName: Dummy
    alertSeverityColumnName: Dummy
customDetails:
    SAP_User: User
entityMappings:
 -  entityType: Account
    fieldMappings:
     -  identifier: FullName
        columnName: PrimaryEmail
 -  entityType: CloudApplication
    fieldMappings:
     -  identifier: Name
        columnName: SystemID
     -  identifier: AppId
        columnName: Client
     -  identifier: InstanceName
        columnName: Instance
 -  entityType: IP
    fieldMappings:
     -  identifier: Address
        columnName: LastKnownIP
eventGroupingSettings:
    aggregationKind: SingleAlert
kind: Scheduled
version: 2.0.19
