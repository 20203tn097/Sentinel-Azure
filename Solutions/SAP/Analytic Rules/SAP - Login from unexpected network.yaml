id: 978e1cc8-f891-41c7-83b8-b21762a2ebb7
name: SAP - Login from unexpected network
description: |
    'Identifies logons from an unexpected network.
    Source Action: Logon to the backend system from an IP address which is not assigned to one of the netwroks.
    Networks should be maintained in watchlist "SAP - Networks"
    *Data Sources: SAPcon -  Audit Log*'
severity: High
requiredDataConnectors:
 -   connectorId: SAP
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
 - InitialAccess
query: |
    let AuditClasses = dynamic(['AU1','AU5']); // Audit Log Classes - Dialog Logon Successful, RFC Logon Successful
    // Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Call
    let DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']);
    let Networks = _GetWatchlist('SAP - Networks');
    let fixedNetworks = datatable(Network: string)['111.68.128.0/17']; // Maintain these if watchlist is not available
    let allNetworks = union Networks, fixedNetworks
        | summarize by Network;
    SAPAuditLog
    // Add audit classes
    | where MessageID in (AuditClasses)
    | where Variable1 in (DialogLogonTypes) // Is a dialog logon type from the list
    | where isnotempty(TerminalIPv6) // There is a Ipv6 address
    | evaluate ipv4_lookup(allNetworks, TerminalIPv6, Network, return_unmatched = true)
    // Similar to regular lookup, by ipv4 address, unmatched is like left join
    | where isempty(Network) // Network is not familiar
    // Details
    | project TimeGenerated, SystemID, ClientID, User, TransactionCode, MessageText, Email , TerminalIPv6, Host
customDetails:
    SAP_User: User
entityMappings:
 -  entityType: Account
    fieldMappings:
     -  identifier: FullName
        columnName: Email
 -  entityType: IP
    fieldMappings:
     -  identifier: Address
        columnName: TerminalIPv6
 -  entityType: Host
    fieldMappings:
     -  identifier: FullName
        columnName: Host
 -  entityType: CloudApplication
    fieldMappings:
     -  identifier: Name
        columnName: SystemID
     -  identifier: AppId
        columnName: ClientID
eventGroupingSettings:
    aggregationKind: SingleAlert
kind: Scheduled
version: 2.0.31
