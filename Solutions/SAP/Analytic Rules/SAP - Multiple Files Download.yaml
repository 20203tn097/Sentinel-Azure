alertDetailsOverride: null
customDetails:
    SAP_User: User
description: |
    Identifies multiple files downloads for a user within a specific timerange.

    Source Action: Download multiple files while using SAPGui to Excel/Lists etc.

    *Data Sources: SAPcon -  Audit Log*
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
eventGroupingSettings:
    aggregationKind: AlertPerResult
id: 4285d707-f969-4a8c-801f-e9c6a328d884
kind: Scheduled
name: SAP - Multiple Files Download
query: |
    // Define variables
    let NumberOfDownloads = 10; // Number of downloads of user as threshold
    let HoursBucket = 2h; // How much time between buckets
    let AuditClasses = dynamic(["AUY"]); // Relevant message
    // Query logic
    SAPAuditLog // Get all downloads
    | where MessageID in (AuditClasses)
    | summarize DownloadsByUser = count() by bin(TimeGenerated, HoursBucket), SystemID, ClientID, User, TerminalIPv6, Email, Host
    | where DownloadsByUser >= NumberOfDownloads // User downloaded more than threshold
    | project SystemID, ClientID, User, Email, TerminalIPv6, Host,DownloadsByUser
queryFrequency: 12h
queryPeriod: 12h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
severity: Medium
tactics:
- Collection
- Exfiltration
- CredentialAccess
triggerOperator: gt
triggerThreshold: 0
version: 2.0.19
