alertDetailsOverride:
    alertDescriptionFormat: |
        Identifies creation of ICF Handlers.
        Source Action: Assign a new handler to a service using SICF.
        *Data Sources: SAPcon - Table Data Log*
    alertDisplayNameFormat: SAP - High - New Handlers for  ICF Service {{Service}}
        created by {{User}} in System {{SystemID}}
    alertSeverityColumnName: Dummy
    alertTacticsColumnName: Dummy
customDetails:
    SAP_User: User
description: |
    Identifies creation of ICF Handlers.
    Source Action: Assign a new handler to a service using SICF.
    *Data Sources: SAPcon - Table Data Log*
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: PrimaryEmail
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: Client
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: 45ae0492-fe7d-4ba8-addd-ca984ea30bc1
kind: Scheduled
name: SAP - New ICF Service Handlers
query: |
    // New ICF Service Handlers
    let TimeAgo= 2h;
    SAPTableDataLog
    | where TimeGenerated > TimeAgo
    | where TableName == "ICFHANDLER"
    | where TableField == "ICF_NAME" // Service name
    | where OldValue == "" and NewValue != "" // New value is inserted in name -> new service
    | order by TimeGenerated desc
    | project-rename Service = NewValue
    | lookup SAPUsersHeader() on SystemID, $left.UserName== $right.User
    | extend TerminalIPv6= iff(isnotempty( LastKnownIP), LastKnownIP, PrimaryIP)
    | project TimeGenerated, Service, PrimaryIP, PrimaryEmail, KnownIPs, KnownEmails, LastKnownIP, User= UserName, Host, SystemID, Client, Instance
    | extend Dummy= ''
queryFrequency: 2h
queryPeriod: 2h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPUsersHeader
    - SAPTableDataLog
severity: High
tactics:
- Persistence
- LateralMovement
- CommandAndControl
triggerOperator: gt
triggerThreshold: 0
version: 2.0.19
