alertDetailsOverride: null
customDetails:
    UserThatWasUnlocked: UserThatWasUnlocked
    UserWhoUnlocked: UserWhoUnlocked
description: |
    A user unlocked another, and then used the other's user credentials.

    Source Action: Unlock a user using SU01. Login using the unlocked user from the same IP.

    *Data Sources: SAPcon -  Audit Log*
    *Data Sources: SAPcon -  Change Documents Log*
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: EmailWhoUnlocked
        identifier: FullName
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
-   entityType: Account
    fieldMappings:
    -   columnName: EmailThatWasUnLocked
        identifier: FullName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: 7224ad22-e2cf-459d-9359-62310555e716
kind: Scheduled
name: SAP - User Unlocks and uses other users
query: |
    // Define variables
    let MinutesThreshold = 30; // Difference by minutes between Unlock and Connect
    let AuditUserUnlocked = dynamic(['AUA']); // Message of unlock user
    let AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user
    // Get users which were unlocked
    let UsersUnlocked = SAPAuditLog
    | where MessageID in (AuditUserUnlocked)
    | project-rename UserUnlockTimeGenerated = TimeGenerated, UserThatWasUnlocked = Variable1, EmailWhoUnlocked = Email, UserWhoUnlocked= User
    | project-keep UserUnlockTimeGenerated, UserThatWasUnlocked, EmailWhoUnlocked, SystemID, ClientID, TerminalIPv6, Instance, Host, UserWhoUnlocked;
    // Query Logic
    let ActionUsers = SAPAuditLog | project-keep MessageID, User, Email, SystemID, TimeGenerated, ClientID, TerminalIPv6// Get users connections
    | project-rename UserAction = User, EmailAction= Email
    | where MessageID in (AuditLogIn);
     // check if the locked was user was unlocked and then used from the same IP address
    //  as the unlocker
    UsersUnlocked | join kind=inner ActionUsers on
    TerminalIPv6, SystemID, ClientID, $left.UserThatWasUnlocked==$right.UserAction
    | where abs(datetime_diff('Minute', TimeGenerated, UserUnlockTimeGenerated)) <= MinutesThreshold // Connect after unlock
    | summarize Count=count(), TimeGenerated= max(TimeGenerated) by Instance ,SystemID, ClientID, UserWhoUnlocked , UserThatWasUnlocked, EmailWhoUnlocked, EmailThatWasUnLocked= EmailAction, TerminalIPv6, Host
queryFrequency: 1h
queryPeriod: 1h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
severity: High
tactics:
- InitialAccess
- Discovery
- LateralMovement
triggerOperator: gt
triggerThreshold: 0
version: 2.0.19
