alertDetailsOverride: null
customDetails:
    SAP_User: User
description: |
    Identifies testing of a function module.

    Source Action: Test a function module using  SE37 / SE80.

    **Recommended for Production only**

    *Data Sources: SAPcon -  Audit Log*
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: 7e6cb00d-d7cb-4411-837f-6e62c2fab6e7
kind: Scheduled
name: SAP - Function Module tested
query: |
    let Role = 'Production';
    let ProgramName = 'RS_TESTFRAME_CALL';
    let AuditClasses = dynamic(['AUW']); // Audit Log Classes - Report Started
    let allSystemRoles = dynamic(['Sandbox', 'Developement', 'QualityAssurance', 'Training', 'Production']); // Available System Roles
    let allSystemUsage = dynamic (['ERP', 'CRM', 'BW', 'Solman', 'Gateway', 'Enterprise Portal']); // Available System Usages
    // Get Relevant Systems from WatchList
    let systemID = _GetWatchlist('SAP - Systems');
    let fixedSID = datatable(SystemID: string, SystemRole: string, SystemUsage: string)
        // Maintain these if WatchList is not available
        ["S4H", "Production", "ERP",
        "XXX", "Sandbox", "BW"]
    ;
    let UnitedSystem =
    union systemID, fixedSID
    | summarize by SystemID, SystemRole, SystemUsage
    | where SystemRole == Role; // Reccommended is Production only
    //| where SystemRole in (allSystemRoles); // Use this for all system roles
    SAPAuditLog
    | where MessageID in (AuditClasses)
    | where ABAPProgramName == ProgramName
    | project-rename SystemIDTemp = SystemID
    | project-rename SystemID= SystemIDTemp
    | project-rename SystemID= SystemID
    | lookup kind = inner (UnitedSystem) on SystemID
    | order by TimeGenerated asc
    | project TimeGenerated, Instance ,User, SystemID, ClientID, MessageText, MessageID,
    Email, TerminalIPv6, Host
queryFrequency: 6h
queryPeriod: 6h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
severity: High
tactics:
- Collection
- DefenseEvasion
- LateralMovement
triggerOperator: gt
triggerThreshold: 0
version: 2.0.19
