id: e35db198-2146-446c-8eb7-a77b6344f1d7
name: 'SAP - (Preview) New trusted RFC connection capture-replay vulnerability in
    SAP NetWeaver [CVE-2023-0014] '
description: 'SAP NetWeaver ABAP Server and ABAP Platform creates information about
    system identity in an ambiguous format. <br/> This may be exploited by malicious
    users to obtain illegitimate access to the system. <br/> Read SAP note 3281854
    - FAQ for Security Note 3089413 for more details. This alert rule helps to identify
    newly added trusted RFC relationships.'
severity: High
requiredDataConnectors:
  - connectorId: SAP
    dataTypes:
     - SAPSystems
queryFrequency: 1h
queryPeriod: 12h
triggerOperator: gt
triggerThreshold: 0
tactics:
 - CredentialAccess
query: |+
    //  a per SAP note https://launchpad.support.sap.com/#/notes/3089413
    let TimeAgo= 1h;
    let Vulnerability= 'SAP - [CVE-2023-0014] Capture-replay vulnerability in a ';
    // CONFIGURATION OPTION- determine which system roles are relevant for this alert
    let SelectedSystemRoles =  dynamic(["All System Roles"]); //can also do// let SelectedSystemRoles =  dynamic(["Production", "UAT"]);
    let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)
        | project SystemID= SearchKey, SystemRole, SystemUsage
        | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');
    SAPTableDataLog
    | where TimeGenerated > ago(TimeAgo * 2)
    | where ingestion_time() > ago(TimeAgo)
    | where isempty(OldValue)
    | where TableName == "RFCTRUST" or TableName == "RFCSYSACL"
    | join kind = inner SelectedSystems on SystemID
    | extend row= bag_pack(TableField, NewValue)
    | summarize
        TimeStarted= any(TimeGenerated),
        SystemRole= any(SystemRole),
        BagRow= make_bag(row)
        by SystemID, DBLogID, LogKey, TableName
    | evaluate bag_unpack(BagRow)
    | extend
        RFCSYSID= column_ifexists('RFCSYSID', ''),
        RFCTRUSTID= column_ifexists('RFCTRUSTID', '')
    | where isnotempty(RFCSYSID) or isnotempty(RFCTRUSTID)
    | extend AlertName = iff(TableName == 'RFCTRUST', strcat('New trusting system added for ', SystemRole, ' system ', SystemID), strcat('New system added as trusted for ', SystemRole, ' system ', SystemID))
    | extend AlertDescription= strcat(iff(TableName == 'RFCTRUST', strcat('System ', RFCSYSID, ' is now trusting system ', RFCTRUSTID), strcat('System ', SystemID, ' is now being trusted by system ', RFCSYSID)), '. <br/> see  ', Vulnerability)
    | extend OtherSystem= iff(TableName == 'RFCTRUST', RFCTRUSTID, RFCSYSID)
    | extend ExtendedLink= 'https://www.cve.org/CVERecord?id=CVE-2023-0014' , Dummy= ''

alertDetailsOverride:
    alertDisplayNameFormat: 'SAP - {{AlertName}} [CVE-2023-0014] '
    alertDescriptionFormat: '{{AlertDescription}}'
    alertTacticsColumnName: Dummy
    alertSeverityColumnName: Dummy
customDetails: null
entityMappings:
 -  entityType: CloudApplication
    fieldMappings:
     -  identifier: Name
        columnName: SystemID
 -  entityType: CloudApplication
    fieldMappings:
     -  identifier: Name
        columnName: OtherSystem
eventGroupingSettings:
    aggregationKind: AlertPerResult
kind: Scheduled
version: 2.0.49
