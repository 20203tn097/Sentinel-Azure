alertDetailsOverride: null
customDetails:
    SAP_User: User
description: |
    Identifies dialog logon (Type AUM) attempts by priviledged users (See Function SAPUsersGetPrivileged) on SAP system .
    Source Action: Attempt to login from the same IP to several systems/clients within the scheduled time interval.

    *Data Sources: SAPcon -  Audit Log*
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SysetmID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
eventGroupingSettings:
    aggregationKind: SingleAlert
id: db123b5e-bcc2-43a5-9e13-8ac1e1a3c530
kind: Scheduled
name: SAP - Dialog logon attempt from a privileged user
query: |
    // SAP - High- Dialog logon attempt from a privileged user
    // time span for audit events
    let AuditTimeAgo= 6h;
    // Define variables
    let AuditClasses = dynamic(['AUM']);//Dialog only
    let perIPLimit = 1;
    // Query logic
    SAPAuditLog
    | where TimeGenerated > ago(AuditTimeAgo)
    | where MessageID in (AuditClasses)
    | extend DetailsBy = pack("User", User, "Email", Email, "SystemID", SystemID, "ClientID", ClientID)
    | summarize LoginbyIPAttempts = count(), Details = make_set(DetailsBy), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated)
        by TerminalIPv6
    // Check if number of login attempts per IP is higher than limit
    | where LoginbyIPAttempts > perIPLimit
    | mv-expand Details
    | evaluate bag_unpack(Details, "Details_")
    | project
        StartTime, EndTime,  TerminalIPv6,
        Email = column_ifexists("Details_Email", ""), User = column_ifexists("Details_User", ""),
        SysetmID = column_ifexists("Details_SystemID", ""),
       ClientID = column_ifexists("Details_ClientID", "")
    | join (SAPUsersGetPrivileged | project User ) on $left.User == $right.User
queryFrequency: 6h
queryPeriod: 2d
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
    - SAPUsersGetPrivileged
severity: High
tactics:
- CredentialAccess
triggerOperator: gt
triggerThreshold: 0
version: 2.0.19
