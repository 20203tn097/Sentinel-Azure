alertDetailsOverride: null
customDetails:
    SAP_User: User
description: 'Identifies dialog logon (Type AUM) attempts by priviledged users (See
    Function SAPUsersGetPrivileged) on SAP system .

    Source Action: Attempt to login from the same IP to several systems/clients within
    the scheduled time interval.


    *Data Sources: SAPcon -  Audit Log*'
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SysetmID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
eventGroupingSettings:
    aggregationKind: SingleAlert
id: db123b5e-bcc2-43a5-9e13-8ac1e1a3c530
kind: Scheduled
name: SAP - Dialog logon attempt from a privileged user
query: "// SAP - High- Dialog logon attempt from a privileged user\r\n// time span\
    \ for audit events\r\nlet AuditTimeAgo= 6h;\r\n// Define variables\r\nlet AuditClasses\
    \ = dynamic(['AUM']);//Dialog only\r\nlet perIPLimit = 1;\r\n// Query logic\r\n\
    SAPAuditLog \r\n| where TimeGenerated > ago(AuditTimeAgo)\r\n| where MessageID\
    \ in (AuditClasses)\r\n| extend DetailsBy = pack(\"User\", User, \"Email\", Email,\
    \ \"SystemID\", SystemID, \"ClientID\", ClientID)\r\n| summarize LoginbyIPAttempts\
    \ = count(), Details = make_set(DetailsBy), StartTime = min(TimeGenerated), EndTime\
    \ = max(TimeGenerated) \r\n    by TerminalIPv6\r\n// Check if number of login\
    \ attempts per IP is higher than limit\r\n| where LoginbyIPAttempts > perIPLimit\
    \ \r\n| mv-expand Details\r\n| evaluate bag_unpack(Details, \"Details_\")\r\n\
    | project \r\n    StartTime, EndTime,  TerminalIPv6,\r\n    Email = column_ifexists(\"\
    Details_Email\", \"\"), User = column_ifexists(\"Details_User\", \"\"),\r\n  \
    \  SysetmID = column_ifexists(\"Details_SystemID\", \"\"),\r\n   ClientID = column_ifexists(\"\
    Details_ClientID\", \"\")\r\n| join (SAPUsersGetPrivileged | project User ) on\
    \ $left.User == $right.User"
queryFrequency: 6h
queryPeriod: 2d
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
    - SAPUsersGetPrivileged
severity: High
tactics:
- CredentialAccess
triggerOperator: gt
triggerThreshold: 0
version: 2.0.15
