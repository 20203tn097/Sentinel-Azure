alertDetailsOverride: null
customDetails:
    SAP_User: User
description: 'Identifies logon of the same user from several terminals within scheduled
    time interval.


    Source Action: Logon using the same user thorugh different IP''s.


    *Data Sources: SAPcon -  Audit Log*'
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: IPs
        identifier: Address
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: 0079fee8-1ebf-4721-92c2-ac1861a79626
kind: Scheduled
name: SAP - Multiple Logons by User
query: "// Define variables\r\n// Audit Log Classes - Dialog Logon Successful, RFC\
    \ Logon Successful\r\nlet AuditClasses = dynamic(['AU1','AU5']);\r\n// Dialog\
    \ / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API\
    \ Call\r\nlet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u',\
    \ ' ']);\r\nlet excUsers = _GetWatchlist('SAP - Excluded Users'); // Users that\
    \ should be removed from query\r\nlet fixedExcUsers = datatable(User:string)\r\
    \n// Maintain these if WatchList is not available    \r\n    [\"SYSWF\"]\r\n;\
    \ \r\nlet UnitedExcUsers =\r\ntoscalar(union excUsers, fixedExcUsers\r\n| summarize\
    \ Users = make_set(User));\r\nlet IPThreshold = 1;\r\n// Query Logic\r\nSAPAuditLog\
    \ \r\n| where MessageID in (AuditClasses)\r\n| where Variable1 in (DialogLogonTypes)\r\
    \n| where User !in (UnitedExcUsers)\r\n| summarize CountIP = dcount(TerminalIPv6),\
    \ IPs = make_set(TerminalIPv6), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated)\
    \ by SystemID, ClientID, User, Email, Instance\r\n| where CountIP > IPThreshold\
    \ // Count of IP logins from the user is higher than threshold\r\n| mv-expand\
    \ IPs to typeof(string ) // Show for each IP\r\n| project SystemID, ClientID,\
    \ User, StartTime, EndTime,\r\n    Email, IPs, Instance"
queryFrequency: 1h
queryPeriod: 1h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
severity: Medium
tactics:
- CredentialAccess
- InitialAccess
- Collection
triggerOperator: gt
triggerThreshold: 0
version: 2.0.15
