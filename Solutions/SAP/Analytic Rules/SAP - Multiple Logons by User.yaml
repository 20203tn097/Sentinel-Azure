alertDetailsOverride: null
customDetails:
    SAP_User: User
description: |
    Identifies logon of the same user from several terminals within scheduled time interval.

    Source Action: Logon using the same user thorugh different IP's.

    *Data Sources: SAPcon -  Audit Log*
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: IPs
        identifier: Address
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: 0079fee8-1ebf-4721-92c2-ac1861a79626
kind: Scheduled
name: SAP - Multiple Logons by User
query: |
    // Define variables
    // Audit Log Classes - Dialog Logon Successful, RFC Logon Successful
    let AuditClasses = dynamic(['AU1','AU5']);
    // Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Call
    let DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']);
    let excUsers = _GetWatchlist('SAP - Excluded Users'); // Users that should be removed from query
    let fixedExcUsers = datatable(User:string)
    // Maintain these if WatchList is not available
        ["SYSWF"]
    ;
    let UnitedExcUsers =
    toscalar(union excUsers, fixedExcUsers
    | summarize Users = make_set(User));
    let IPThreshold = 1;
    // Query Logic
    SAPAuditLog
    | where MessageID in (AuditClasses)
    | where Variable1 in (DialogLogonTypes)
    | where User !in (UnitedExcUsers)
    | summarize CountIP = dcount(TerminalIPv6), IPs = make_set(TerminalIPv6), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by SystemID, ClientID, User, Email, Instance
    | where CountIP > IPThreshold // Count of IP logins from the user is higher than threshold
    | mv-expand IPs to typeof(string ) // Show for each IP
    | project SystemID, ClientID, User, StartTime, EndTime,
        Email, IPs, Instance
queryFrequency: 1h
queryPeriod: 1h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
severity: Medium
tactics:
- CredentialAccess
- InitialAccess
- Collection
triggerOperator: gt
triggerThreshold: 0
version: 2.0.19
