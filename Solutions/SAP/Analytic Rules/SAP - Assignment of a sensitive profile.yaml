alertDetailsOverride: null
customDetails:
    SAP_User: User
description: |
    Identifies new assignments of a sensitive profile to a user.

    Source Action: Assign a profile to a User using SU01.

    Sensitive profiles should be maintained in watchlist "SAP - Sensitive Profiles"

    *Data Sources: SAPcon -  Change Documents Log*
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: Email
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: 4e228f1a-55cc-4abc-8ef4-5e385b60f9c0
kind: Scheduled
name: SAP - Assignment of a sensitive profile
query: |
    // Define Variables
    // Audit Log Classes - Authorizations for user changed
    let Identity = 'IDENTITY';
    let ProfileChangeDoc = 'SUSR_UST04';
    let Insert = "I";
    let logsThreshold = 3600; // 3600 seconds
    let AuditClasses = dynamic(['AUB']); // Authorizations for user &A changed.
    // Maintain these if WatchList is not available
    let SensitiveProfiles =  _GetWatchlist('SAP - Sensitive Profiles');
    let fixedProfile = datatable(Profile:string)['SAP_ALL','SAP_NEW'];
    // Maintain these if System doesn't have CR's
    let fixedChangeDocs = datatable(User : string, ObjectClass : string, TableName : string, TypeofChange_Item : string , ChangedTableKey : string, ObjectID : string, TimeGenerated : datetime, ValueNew : string, SystemID : string)[];
    let ChangeDocs =
    union isfuzzy=true table("SAPChangeDocsLog"), fixedChangeDocs;
    let IdentityChangeDocuments =
    // Identity Change documents which represents profiles assignment
        ChangeDocs
        | where ObjectClass == Identity // Identity
        and TableName == ProfileChangeDoc // Profile Change Doc
        and TypeofChange_Item == Insert // Insert
        | extend Profile = ChangedTableKey
        | extend UserAssigned = ObjectID;
    let UnitedProfiles =
    toscalar(union fixedProfile, SensitiveProfiles
    | summarize Profiles = make_list(Profile));
    // Query logic
    SAPAuditLog
    | where MessageID in (AuditClasses)
    | summarize by TimeGenerated, TerminalIPv6, User, Host, Email
    | lookup kind = leftouter (IdentityChangeDocuments) on User
    | where Profile in (UnitedProfiles)
    | project-rename  TimeGenAudit = TimeGenerated1
    | where abs(datetime_diff('second',TimeGenerated,TimeGenAudit)) <= logsThreshold
    or isnull(TimeGenAudit)
    | project
    // Details
    TimeGenerated, Instance , SystemID, ClientID, Profile, User,  UserAssigned,
    Email, TerminalIPv6, Host
queryFrequency: 12h
queryPeriod: 12h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
    - SAPChangeDocsLog
severity: Medium
tactics:
- PrivilegeEscalation
triggerOperator: gt
triggerThreshold: 0
version: 2.0.19
