alertDetailsOverride: null
customDetails:
    SAP_User: User
description: |
    Identifies multiple spools for a user within a specific timerange.

    Source Action: Create and execute multiple Spool Jobs from any type by a user. (SP01)

    *Data Sources: SAPcon -  Spool Log*
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: dfbcb26d-7b53-41f8-9647-1e158722a80e
kind: Scheduled
name: SAP - Multiple Spool Executions
query: |
    // Define variables
    let AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user
    let NumberOfRequests = 3; // Number of requests as threshold
    let HoursBucket = 2h; // // How much time between buckets
    // Query logic
    let LastLogin =
    SAPAuditLog
    | where MessageID in (AuditLogIn)
    | summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID, ClientID, User, Instance; // Get last connection date for user
    SAPSpoolLog // Get all spool requests
    | summarize UserRequests = count() by bin(TimeGenerated, HoursBucket), SystemID, ClientID, User, Instance
    | where UserRequests >= NumberOfRequests // User requested to print more than threshold
    | lookup kind=inner LastLogin on User // Check IP of last login
    | project TimeGenerated, Instance, SystemID, ClientID, User, Email, TerminalIPv6, Host, UserRequests
queryFrequency: 12h
queryPeriod: 12h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
    - SAPSpoolLog
severity: Medium
tactics:
- CredentialAccess
- Collection
- Exfiltration
triggerOperator: gt
triggerThreshold: 0
version: 2.0.19
