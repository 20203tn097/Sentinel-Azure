id: dfbcb26d-7b53-41f8-9647-1e158722a80e
name: SAP - Multiple Spool Executions
description: |-
  'Identifies multiple spools for a user within a specific timerange.

  Source Action: Create and execute multiple Spool Jobs from any type by a user. (SP01)

  *Data Sources: SAPcon -  Spool Log*
  '
severity: Medium
requiredDataConnectors:
- connectorId: SAP
  dataTypes:
  - SAPSpoolLog
  - SAPAuditLog
queryFrequency: 12h
queryPeriod: 12h
triggerOperator: gt
triggerThreshold: 0
tactics:
- CredentialAccess
- Collection
- Exfiltration
relevantTechniques: ''
query: |-
  // Define variables
  let AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user
  let NumberOfRequests = 3; // Number of requests as threshold
  let HoursBucket = 2h; // // How much time between buckets
  // Query logic
  let LastLogin =
  SAPAuditLog
  | where MessageID in (AuditLogIn)
  | summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID, ClientID, User, Instance; // Get last connection date for user
  SAPSpoolLog // Get all spool requests
  | summarize UserRequests = count() by bin(TimeGenerated, HoursBucket), SystemID, ClientID, User, Instance
  | where UserRequests >= NumberOfRequests // User requested to print more than threshold
  | lookup kind=inner LastLogin on User // Check IP of last login
  | project TimeGenerated, Instance, SystemID, ClientID, User, Email, TerminalIPv6, Host, UserRequests
  | extend AlertRuleUniqueName = 'multiplespoolexecutions'
alertDetailsOverride: null
customDetails:
  SAP_User: User
  AlertRuleUniqueName: AlertRuleUniqueName
entityMappings:
- entityType: Account
  fieldMappings:
  - identifier: FullName
    columnName: Email
- entityType: IP
  fieldMappings:
  - identifier: Address
    columnName: TerminalIPv6
- entityType: Host
  fieldMappings:
  - identifier: FullName
    columnName: Host
- entityType: CloudApplication
  fieldMappings:
  - identifier: Name
    columnName: SystemID
  - identifier: AppId
    columnName: ClientID
  - identifier: InstanceName
    columnName: Instance
eventGroupingSettings:
  aggregationKind: SingleAlert
kind: Scheduled
version: 2.0.19
