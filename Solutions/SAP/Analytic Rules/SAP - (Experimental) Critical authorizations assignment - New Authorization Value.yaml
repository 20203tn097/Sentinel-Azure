alertDetailsOverride: null
customDetails:
    SAP_User: User
    SAP_UserAssigned: UserAssigned
description: 'Identifies assignment of a critical authorization object value to a
    new user.

    Source Action: Assign a new authorization object / update existing one in a role
    using PFCG.


    Critical authorization objects should be maintained in watchlist ""SAP - Critical
    Authorization Objects""


    *Data Sources: SAPcon -  Change Documents Log*

    *Data Sources: SAPcon -  User MD*'
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
-   entityType: Account
    fieldMappings:
    -   columnName: UserAssignedEmail
        identifier: FullName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: 6e60e742-aef0-47aa-95e5-36a100a4272d
kind: Scheduled
name: SAP - (Experimental) Critical authorizations assignment - New Authorization
    Value
query: "// SAP - Medium - Critical authorizations assignment - New Authorization Value\r\
    \n// time span for audit events\r\nlet TimeAgo= 6h;\r\n// New Assigned Objects\r\
    \nlet ObjectClassRoles = 'PFCG';\r\nlet TableName = 'CD1251';\r\nlet UsersRoles\
    \ = 'AGR_USERS';\r\nlet Insert = \"I\";\r\nlet NotInUse = 'NOT_IN_USE';\r\nlet\
    \ logsThreshold = 3600; // 3600 seconds\r\n// Audit Log Classes - Authorizations\
    \ for user changed\r\nlet AuditClasses = dynamic(['AUR','AUT']); // Authorization/Authorization\
    \ Profile &B created / changed.\r\n// Roles Change Documents - Extract Auth Object\
    \ and Obj Field\r\nlet allHistory = ago(0d);\r\nlet alertSched = ago(6h); // Please\
    \ maintain according to schedule\r\nlet ChangeDocs = SAPChangeDocsLog;\r\nlet\
    \ UsersEmails = SAPUsersHeader()| summarize by User, Email, SystemID, Client |\
    \ project-rename ClientID = Client;\r\nlet RolesAuthObject = ChangeDocs\r\n  \
    \  | where TimeGenerated > ago(TimeAgo)  \r\n    | where TimeGenerated >= alertSched\r\
    \n    | where ObjectClass == ObjectClassRoles and TableName == TableName // Role-Obj-Profile-ObjField\r\
    \n    | where TypeofChange_Item in ('J', 'I', 'U') //  Insert\r\n    | extend\
    \ RoleObjProfileObjFieldVer = ChangedTableKey, Role = ObjectID\r\n    | extend\
    \ ObjFieldValue = ValueNew    \r\n    | extend ObjField = trim(@\"\\s*?\", extract(@\"\
    (^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 4, RoleObjProfileObjFieldVer,\
    \ typeof(string)))\r\n    | extend AuthObject = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\\
    s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 2, RoleObjProfileObjFieldVer,\
    \ typeof(string)))\r\n    | extend TimeGenRoleAuth = TimeGenerated;\r\nlet ComplexAuth\
    \ = _GetWatchlist('SAP - Critical Authorizations');\r\nlet SimpleAuth = _GetWatchlist('SAP\
    \ - Critical Authorizations');\r\nlet usersinRole = \r\n    ChangeDocs \r\n  \
    \  | where TimeGenerated > ago(TimeAgo)    \r\n    | where TimeGenerated <= allHistory\r\
    \n    | where ObjectClass == ObjectClassRoles // Roles\r\n        and TableName\
    \ == UsersRoles // Users Roles\r\n        and TypeofChange_Item == Insert // Insert\
    \ \r\n    | extend UserAssigned = extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\"\
    , 1, ChangedTableKey)\r\n    | extend Role = ObjectID\r\n    | summarize by SystemID,\
    \ Role, UserAssigned;\r\nlet RolesAuthObjectCheck =     \r\n        RolesAuthObject\
    \     \r\n        | extend ObjFieldVal = ObjFieldValue\r\n        | lookup kind\
    \ = leftouter \r\n            (RolesAuthObject \r\n            | extend ActivityVal\
    \ = ObjFieldValue)\r\n            on Role, AuthObject;\r\nlet complexScenario\
    \ = ComplexAuth\r\n    | where ActivityField != NotInUse\r\n    | summarize by\
    \ AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField,\
    \ Activity\r\n    | lookup kind = inner (RolesAuthObjectCheck)\r\n        on $left.AuthorizationObject\
    \ == $right.AuthObject \r\n        and $left.AuthorizationField == $right.ObjField\
    \ \r\n        and $left.AuthorizationValue == $right.ObjFieldValue\r\n       \
    \ and $left.ActivityField == $right.ObjField1\r\n        and $left.Activity ==\
    \ $right.ActivityVal;\r\nlet simpleScenario = SimpleAuth\r\n    | where ActivityField\
    \ == NotInUse\r\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue,\
    \ ActivityField, Activity \r\n    | lookup  kind = inner (RolesAuthObject)\r\n\
    \        on $left.AuthorizationObject == $right.AuthObject \r\n        and $left.AuthorizationField\
    \ == $right.ObjField \r\n        and $left.AuthorizationValue == $right.ObjFieldValue;\r\
    \nlet GetEntities =\r\n    SAPAuditLog \r\n    | where MessageID in (AuditClasses)\r\
    \n    | where TimeGenerated > ago(TimeAgo)  \r\n    | summarize by TimeGenerated,\
    \ ClientID, TerminalIPv6, User, Host, Email\r\n    | extend TimeGenAudit = TimeGenerated;\r\
    \nunion complexScenario, simpleScenario\r\n| lookup kind = inner (usersinRole)\
    \ on SystemID, Role\r\n| lookup kind = leftouter (GetEntities) on User\r\n| where\
    \ abs(datetime_diff('second', TimeGenRoleAuth, TimeGenAudit)) <= logsThreshold\
    \ or\r\nisnull(TimeGenAudit)\r\n| lookup UsersEmails on SystemID, ClientID, User\r\
    \n| project \r\nTimeGenRoleAuth, SystemID, ClientID, Role, User, UserAssigned,\
    \ AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField,\
    \ Activity, Email, TerminalIPv6, Host, UserAssignedEmail=Email1"
queryFrequency: 6h
queryPeriod: 2d
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPUsersHeader
    - SAPAuditLog
    - SAPChangeDocsLog
severity: Medium
tactics:
- PrivilegeEscalation
triggerOperator: gt
triggerThreshold: 0
version: 2.0.15
