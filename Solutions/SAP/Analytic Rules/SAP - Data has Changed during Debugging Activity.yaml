id: 9a55136c-fa19-46d4-9376-17c8f96cc2b8
name: SAP - Data has Changed during Debugging Activity
description: |-
  'Identifies changes for runtime data during a debugging activity.
  Source Action: Activate Debug ("/h"), Select a field for change and update it's value.

  **Recommended for Production only**

  *Data Sources: SAPcon -  Audit Log*
  '
severity: High
requiredDataConnectors:
- connectorId: SAP
  dataTypes:
  - SAPAuditLog
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
- Execution
- LateralMovement
relevantTechniques: ''
query: |-
  let Role = 'Production';
  let AuditClasses = dynamic(['CUL']); // Audit Log Classes - Debug Change
  let allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles
  let allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages
  // Get Relevant Systems from WatchList
  let systemID = _GetWatchlist('SAP - Systems');
  let fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)
  // Maintain these if WatchList is not available
      ["S4H","Production","ERP",
      "XXX","Sandbox","BW"]
  ;
  let UnitedSystem =
  union systemID, fixedSID
  | summarize by SystemID, SystemRole, SystemUsage
  | where SystemRole == Role; // Recommended  is Production only
  //| where SystemRole in (allSystemRoles); // Use this for all system roles
  SAPAuditLog
  | where MessageID in (AuditClasses)
  | project-rename SystemIDTemp = SystemID
  | project-rename SystemID= SystemIDTemp
  | project-rename SystemID= SystemID
  | lookup kind = inner    (UnitedSystem) on SystemID
  | extend  ChangeDetails = pack_array(Variable1, Variable2, Variable3, Variable4)
  | project TimeGenerated,ClientID, Instance, User, MessageText, ChangeDetails, ABAPProgramName, TransactionCode, SystemID, SystemRole, SystemUsage, Email,TerminalIPv6, Host
  | extend AlertRuleUniqueName = 'datahaschangedduringdebuggingactivity'
alertDetailsOverride: null
customDetails:
  SAP_User: User
  AlertRuleUniqueName: AlertRuleUniqueName
entityMappings:
- entityType: Account
  fieldMappings:
  - identifier: FullName
    columnName: Email
- entityType: IP
  fieldMappings:
  - identifier: Address
    columnName: TerminalIPv6
- entityType: Host
  fieldMappings:
  - identifier: FullName
    columnName: Host
- entityType: CloudApplication
  fieldMappings:
  - identifier: Name
    columnName: SystemID
  - identifier: AppId
    columnName: ClientID
  - identifier: InstanceName
    columnName: Instance
eventGroupingSettings:
  aggregationKind: AlertPerResult
kind: Scheduled
version: 2.0.29
