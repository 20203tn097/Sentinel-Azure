alertDetailsOverride: null
customDetails:
    SAP_User: User
description: |
    Identifies generic table access by RFC logon

    Source Action: Open table contents using SE11/SE16/SE16N.

    **Recommended for Production only**

    Tables should be maintained in "SAP - Sensitive Tables" Watchlist.

    *Data Sources: SAPcon -  Audit Log*
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: 2521fd74-79f3-4adc-8350-edf4036913b3
kind: Scheduled
name: SAP - Sensitive Tables Direct Access By RFC Logon
query: |
    // Define variables
    let Role = "Production";
    let AuditClasses = dynamic(['CUZ']); // RFC, Audit Log Classes - Generic Table Access
    let allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles
    let allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages
    // Get Relevant Systems from WatchList
    let systemID = _GetWatchlist('SAP - Systems');
    let fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)
    // Maintain these if WatchList is not available
        ["S4H","Production","ERP",
        "XXX","Sandbox","BW"]
    ;
    // Get Relevant Tables
    let SensitiveTables = _GetWatchlist('SAP - Sensitive Tables');
    let fixedTables = datatable(Table:string)
    // Maintain these if WatchList is not available
        ["USR02"]
    ;
    let RelSystemID = union systemID, fixedSID // Create a variable that stores relevent Systems
    | where SystemRole == Role // Recommended is Production only
    //| where SystemRole in (allSystemRoles); // Use this for all system roles
    | summarize by SystemID;
    let SensitiveUnionTables = union SensitiveTables, fixedTables // Create a variable that stores relevent sensitive tables
        | summarize by Table;
    // Query logic
    SAPAuditLog
        | project-rename Table = Variable1, Activity = Variable2
        | where MessageID in (AuditClasses)
        | where SystemID in (RelSystemID)
        | where Table in (SensitiveUnionTables)
        | order by TimeGenerated asc
        | project TimeGenerated,Instance, SystemID, ClientID, User, TransactionCode, ABAPProgramName, Table,   Activity, MessageText, MessageID,
    Email, TerminalIPv6, Host
queryFrequency: 12h
queryPeriod: 12h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
severity: Medium
tactics:
- Collection
- Exfiltration
- CredentialAccess
triggerOperator: gt
triggerThreshold: 0
version: 2.0.19
