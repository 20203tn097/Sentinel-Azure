id: fd655ec6-cb11-4e79-a825-0935a66596c8
name: SAP - Dynamic ABAP Program
description: |-
  'Identifies execution of dynamic ABAP programming. For example, ABAP code was dynamically created/changed/deleted. Source Action: Create an ABAP Report which uses ABAP program generation commands such as "INSERT REPORT" and execute it. Excluded Transaction Codes can be maintained in "SAP - Transactions for ABAP Generations" watchlist. *Data Sources: SAPcon - Audit Log*
  '
severity: Low
requiredDataConnectors:
- connectorId: SAP
  dataTypes:
  - SAPUsersGetVIP
  - SAPAuditLog
queryFrequency: 6h
queryPeriod: 6h
triggerOperator: gt
triggerThreshold: 0
tactics:
- Discovery
- CommandAndControl
- Impact
relevantTechniques: ''
query: |-
  // Define variables
  // here you can exclude system users which are OK to execute a Dynamic ABAP Program
  // by adding those users in the SAP_User_Config watchlist with a tag of 'DynamicABAPProgramOK'
  // can also specify SAP Roles or Profiles to exclude
  let excludeUsersTags= dynamic(['DynamicABAPProgramOK','SAP_ALL']);
  let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;
  let AuditClasses = dynamic(['BU4']); // Message of dynamic ABAP program
  let TranForABAPGen = _GetWatchlist("SAP - Transactions for ABAP Generations"); // Transactions to exclude
  // Maintain if watchlist is not available
  let fixedTran = datatable(TransactionCode:string)['SE11','SE12', "SE16", "SE16N"];
  let UnitedTransactions =
  toscalar(union TranForABAPGen, fixedTran
  | summarize Transactions = make_set(TransactionCode));
  // Query logic
  SAPAuditLog
  | where MessageID in (AuditClasses)
  | join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude
  | where TransactionCode !in (UnitedTransactions) // Exclude transactions
  | project TimeGenerated, Instance, User, SystemID, ClientID, Email, TerminalIPv6, Host, ABAPProgramName
  | extend AlertRuleUniqueName = 'dynamicabapprogram'
alertDetailsOverride: null
customDetails:
  SAP_User: User
  AlertRuleUniqueName: AlertRuleUniqueName
entityMappings:
- entityType: Account
  fieldMappings:
  - identifier: FullName
    columnName: Email
- entityType: IP
  fieldMappings:
  - identifier: Address
    columnName: TerminalIPv6
- entityType: Host
  fieldMappings:
  - identifier: HostName
    columnName: Host
- entityType: CloudApplication
  fieldMappings:
  - identifier: Name
    columnName: SystemID
  - identifier: AppId
    columnName: ClientID
  - identifier: InstanceName
    columnName: Instance
eventGroupingSettings:
  aggregationKind: SingleAlert
kind: Scheduled
version: 2.0.54
