alertDetailsOverride: null
customDetails:
    SAP_User: User
description: |
    Identifies unlocking of a transaction.

    Source Action: Unlock a transaction code using SM01/SM01_DEV/SM01_CUS.

    *Data Sources: SAPcon -  Audit Log*
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientTR
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: 35ff4cf7-ed01-4ec2-92e5-ffcbf88fb294
kind: Scheduled
name: SAP - Transaction is unlocked
query: |+
    // Audit Log Classes - Transaction UnLock Events
    // AUP - Transaction Locked
    let AuditClasses = dynamic(['AUQ']); // AUQ - Transaction Unlocked
    SAPAuditLog
    | where MessageID in (AuditClasses)
    | project-rename TransactionCodeTemp = TransactionCode
    | project-rename TransactionCode= Variable1
    | parse TransactionCode with "( TR ) " _TCODE " - " ClientTR // Parse to _TCODE and ClientTR
    // Specific Client Action (SM01_CUS) / Cross Client (SM01_DEV)
    | extend TransactionCode = iif(_TCODE != "",_TCODE, TransactionCode) // Check if _TCODE is not empty
    | extend ClientTR = iif(ClientTR != "",ClientTR, "CrossClient") // Check if ClientTR is not empty
    | project
    // Details
    TimeGenerated, Instance, SystemID, User, MessageText,TransactionCode, ClientTR,
    Email, TerminalIPv6, Host

queryFrequency: 1d
queryPeriod: 1d
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
severity: Medium
tactics:
- Persistence
- Execution
triggerOperator: gt
triggerThreshold: 0
version: 2.0.19
