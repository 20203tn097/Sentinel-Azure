alertDetailsOverride:
    alertDescriptionFormat: 'Identifies new assignments for a sensitive role to a
        user.


        Source Action: Assign a role to a User using SU01 / PFCG.


        Sensitive roles should be maintained in watchlist "SAP -  Sensitive Roles"


        *Data Sources: SAPcon -  Change Documents Log, Audit Log*

        {{PackedDetails}}

        '
    alertDisplayNameFormat: '{{AlertDescription}}'
    alertSeverityColumnName: Dummy
    alertTacticsColumnName: Dummy
customDetails:
    SAP_User: User
description: 'Identifies new assignments for a sensitive role to a user.


    Source Action: Assign a role to a User using SU01 / PFCG.


    Sensitive roles should be maintained in watchlist "SAP -  Sensitive Roles"


    *Data Sources: SAPcon -  Change Documents Log, Audit Log*'
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: HostName
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: AlertPerResult
id: 03b9a2cf-8434-44ad-b42f-9a35701f1c2a
kind: Scheduled
name: SAP - (Experimental) Assignment of a sensitive role
query: "// Assignment of a sensitive role\r\n// Define Variables\r\nlet Roles = 'PFCG';\r\
    \nlet UsersRoles = 'AGR_USERS';\r\nlet Insert = \"I\";\r\nlet logsThreshold =\
    \ 3600; // 3600 seconds\r\n// Audit Log Classes - Authorizations for user changed\r\
    \nlet AuditClasses = dynamic(['AUB', 'AUD']); // Authorizations for user &A changed.\r\
    \n// Maintain these if WatchList is not available\r\nlet SensitiveRoles =  _GetWatchlist('SAP\
    \ - Sensitive Roles');\r\nlet fixedRoles = datatable(Role: string)['SAP_BC_BASIS_ADMIN',\
    \ 'SAP_BC_AUTH_PROFILE_ADMIN'];\r\nlet UnitedRoles =\r\ntoscalar(union fixedRoles,\
    \ SensitiveRoles\r\n| summarize Roles = make_list(Role));\r\nlet ChangeCheck =\r\
    \nSAPChangeDocsLog  \r\n| where ObjectClass == Roles // Roles\r\n    and TableName\
    \ == UsersRoles // Users Roles\r\n    and TypeofChange_Item == Insert // Insert\
    \ \r\n| extend UserAssigned = trim_end(@\"[^\\w]+\" ,extract(@\"^.{1,33}\\s*?(.{1,12})\\\
    s*?\\d{16}\", 1, ChangedTableKey))\r\n| extend Role = ObjectID\r\n| where Role\
    \ in (UnitedRoles);\r\n// Query logic\r\nSAPAuditLog \r\n| where MessageID in\
    \ (AuditClasses)\r\n| summarize by TimeGenerated, TerminalIPv6, User, Host, Email,\
    \ ClientID, SystemID\r\n| extend User= trim_end(@\"[^\\w]+\" , User)\r\n| lookup\
    \ kind = inner (ChangeCheck) on User, ClientID, SystemID\r\n| where Role in (UnitedRoles)\r\
    \n| project-rename TimeGenAudit = TimeGenerated1\r\n| where abs(datetime_diff('second',\
    \ TimeGenerated, TimeGenAudit)) <= logsThreshold\r\nor isnull(TimeGenAudit)\r\n\
    | project \r\n    // Details\r\n    TimeGenerated, Instance , SystemID, ClientID,\
    \ Role, User, UserAssigned,\r\n    Email, TerminalIPv6, Host\r\n| extend AlertDescription=\
    \ strcat('User ', UserAssigned, ' has Assigned a sensitive role to User ', User),\
    \ Dummy=' '\r\n| extend PackedDetails= pack_all()"
queryFrequency: 12h
queryPeriod: 12h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
    - SAPChangeDocsLog
severity: Medium
tactics:
- PrivilegeEscalation
triggerOperator: gt
triggerThreshold: 0
version: 2.0.15
