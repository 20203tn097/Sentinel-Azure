alertDetailsOverride: null
customDetails:
    SAP_User: User
description: 'Identifies multiple spools for a user within a specific timerange.


    Source Action: Create and execute multiple Spool Jobs from any type by a user.
    (SP01)


    *Data Sources: SAPcon -  Spool Log*'
entityMappings:
-   entityType: Account
    fieldMappings:
    -   columnName: Email
        identifier: FullName
-   entityType: Host
    fieldMappings:
    -   columnName: Host
        identifier: FullName
-   entityType: IP
    fieldMappings:
    -   columnName: TerminalIPv6
        identifier: Address
-   entityType: CloudApplication
    fieldMappings:
    -   columnName: SystemID
        identifier: Name
    -   columnName: ClientID
        identifier: AppId
    -   columnName: Instance
        identifier: InstanceName
eventGroupingSettings:
    aggregationKind: SingleAlert
id: c123a8d7-f72f-4ba0-8b06-ba5e12043432
kind: Scheduled
name: SAP - Multiple Spool Output Executions
query: "// Define variables\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messeges\
    \ of connect with user\r\nlet NumberOfPrints = 3; // Number of prints as threshold\r\
    \nlet HoursBucket = 2h; // // How much time between buckets\r\n// Query logic\r\
    \nlet LastLogin =\r\nSAPAuditLog\r\n| where MessageID in (AuditLogIn)\r\n| summarize\
    \ arg_max(TimeGenerated, *) by SystemID, ClientID, User, Instance; // Get last\
    \ connection date for user\r\nSAPSpoolOutputLog // Get all spool outputs\r\n|\
    \ summarize UserPrints = count() by bin(TimeGenerated, HoursBucket), SystemID,\
    \ ClientID, User, Instance\r\n| where UserPrints >= NumberOfPrints // User requested\
    \ to print more than threshold\r\n| lookup kind=inner LastLogin on User // Get\
    \ IP of last login\r\n| project TimeGenerated, Instance, SystemID, ClientID, User,\
    \ Email, TerminalIPv6,  Host, UserPrints"
queryFrequency: 12h
queryPeriod: 12h
relevantTechniques: ''
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPAuditLog
    - SAPSpoolOutputLog
severity: Medium
tactics:
- CredentialAccess
- Collection
- Exfiltration
triggerOperator: gt
triggerThreshold: 0
version: 2.0.15
