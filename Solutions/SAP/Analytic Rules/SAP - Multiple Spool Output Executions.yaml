id: c123a8d7-f72f-4ba0-8b06-ba5e12043432
name: SAP - Multiple Spool Output Executions
description: |
    'Identifies multiple spools for a user within a specific timerange.
    Source Action: Create and execute multiple Spool Jobs from any type by a user. (SP01)
    *Data Sources: SAPcon -  Spool Log*'
severity: Medium
requiredDataConnectors:
 -   connectorId: SAP
queryFrequency: 12h
queryPeriod: 12h
triggerOperator: gt
triggerThreshold: 0
tactics:
 - CredentialAccess
 - Collection
 - Exfiltration
query: |
    // Define variables
    let AuditLogIn = dynamic(['AU1', 'AU5']); // Messeges of connect with user
    let NumberOfPrints = 3; // Number of prints as threshold
    let HoursBucket = 2h; // // How much time between buckets
    // Query logic
    let LastLogin =
    SAPAuditLog
    | where MessageID in (AuditLogIn)
    | summarize arg_max(TimeGenerated, *) by SystemID, ClientID, User, Instance; // Get last connection date for user
    SAPSpoolOutputLog // Get all spool outputs
    | summarize UserPrints = count() by bin(TimeGenerated, HoursBucket), SystemID, ClientID, User, Instance
    | where UserPrints >= NumberOfPrints // User requested to print more than threshold
    | lookup kind=inner LastLogin on User // Get IP of last login
    | project TimeGenerated, Instance, SystemID, ClientID, User, Email, TerminalIPv6,  Host, UserPrints
customDetails:
    SAP_User: User
entityMappings:
 -  entityType: Account
    fieldMappings:
     -  identifier: FullName
        columnName: Email
 -  entityType: Host
    fieldMappings:
     -  identifier: FullName
        columnName: Host
 -  entityType: IP
    fieldMappings:
     -  identifier: Address
        columnName: TerminalIPv6
 -  entityType: CloudApplication
    fieldMappings:
     -  identifier: Name
        columnName: SystemID
     -  identifier: AppId
        columnName: ClientID
     -  identifier: InstanceName
        columnName: Instance
eventGroupingSettings:
    aggregationKind: SingleAlert
kind: Scheduled
version: 2.0.19
