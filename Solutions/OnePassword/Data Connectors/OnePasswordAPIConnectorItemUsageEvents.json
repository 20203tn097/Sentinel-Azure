{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "string",
            "defaultValue": ""
        }
    },
    "resources": [
        {
            "id": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/', 'itemusage', guid(subscription().subscriptionId))]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', 'itemusage', guid(subscription().subscriptionId))]",
            "apiVersion": "2021-03-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
            "kind": "APIPolling",
            "properties": {
                "connectorUiConfig": {
                    "id": "OnePasswordItemUsage",
                    "title": "1Password ItemUsage Events",
                    "publisher": "Masero",
                    "descriptionMarkdown": "The 1Password ItemUsage Events connector allows the user to ingest 1Password Sigin events into Microsoft Sentinel.",
                    "graphQueriesTableName": "OnePasswordItemUsageEvents_CL",
                    "graphQueries": [
                        {
                            "metricName": "Total data received",
                            "legend": "OnePasswordItemUsageEvents",
                            "baseQuery": "{{graphQueriesTableName}}"
                        }
                    ],
                    "sampleQueries": [
                        {
                            "description" : "Top 10 something",
                            "query": "{{graphQueriesTableName}}\n |  summarize count() by action_s\n | top 10 by count_"
                        }
                    ],
                    "dataTypes": [
                        {
                            "name": "{{graphQueriesTableName}}",
                            "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                        }
                    ],
                    "connectivityCriterias": [
                        {
                            "type": "SentinelKindsV2",
                            "value": [
                                "APIPolling"
                            ]
                        }
                    ],
                    "availability": {
                        "status": 1,
                        "isPreview": true
                    },
                    "permissions": {
                        "resourceProvider": [
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces",
                                "permissionsDisplayText": "Read and write permissions on the workspace are required.",
                                "providerDisplayName": "Workspace",
                                "scope": "Workspace",
                                "requiredPermissions": {
                                    "write": true,
                                    "read": true,
                                    "delete": true
                                }
                            }
                        ],
                        "customs": [
                            {
                                "name": "1Password API token",
                                "description": "A 1Password API Token is required. See the [1Password documentation](https://support.1password.com/events-reporting/#appendix-issue-or-revoke-bearer-tokens) on how to create an API token."
                            }
                        ]
                    },
                    "instructionSteps": [
                        {
                            "title": "",
                            "description": "**STEP 1 - Create a 1Password API token** \n\n Follow the [1Password documentation](https://support.1password.com/events-reporting/#appendix-issue-or-revoke-bearer-tokens) for guidance on this step." 
                        },
                        {
                            "title": "",
                            "description": "**STEP 2 - Choose the correct base URL** \n\n There are multiple 1Password servers which might host your events. The correct server depends on your license and region. Follow the [1Password documentation](https://developer.1password.com/docs/events-api/reference/#servers) to choose the correct server. Input the base URL as displayed by the documentation (including 'https://' and without a trailing '/')." 
                        },
                        {
                            "title": "",
                            "description": "**STEP 3 - Enter your 1Password Details** \n\n Enter the 1Password base URL & API Token below:",
                            "instructions":[
                                {
                                    "parameters": {
                                        "enable": "true",
                                        "userRequestPlaceHoldersInput": [
                                            {
                                                "displayText": "1Password Base URL",
                                                "requestObjectKey": "apiEndpoint",
                                                "placeHolderName": "{{BaseUr}}",
                                                "placeHolderValue": ""
                                            }
                                        ]
                                    },
                                    "type": "APIKey"
                                }
                            ]
                        }
                    ],
                    "metadata": {
                        "version": "1.0.0",
                        "kind": "dataConnector",
                        "source": {
                            "kind": "community",
                            "name": "OnePassword Solution."
                        },
                        "author": {
                            "name": "Tim Groothuis"
                        },
                        "support": {
                            "tier": "community",
                            "name": "GitHub Issues",
                            "email": "",
                            "link":"https://github.com/Azure/Azure-Sentinel/issues"
                        }
                    }
                },
                "pollingConfig": {
                    "owner": "ASI",
                    "version": "2.0",
                    "source": "PaaS",
                    "auth": {
                        "authType": "APIKey",
                        "APIKeyName": "Authorization",
                        "APIKeyIdentifier": "Bearer "
                    },
                    "request": {
                        "apiEndpoint": "{{BaseUr}}/api/v1/itemusages",
                        "rateLimitQPS": 10,
                        "queryWindowInMin": 5,
                        "httpMethod": "Post",
                        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
                        "retryCount": 2,
                        "timeoutInSeconds": 60,
                        "headers": {
                            "Content-Type": "application/json"
                        },
                        "queryParametersTemplate": "{\"limit\": 1000, \"start_time\": \"{_QueryWindowStartTime}\", \"end_time\": \"{_QueryWindowEndTime}\" }",
                        "isPostPayloadJson": true
                    },
                    "paging": {
                        "pagingType": "NextPageToken",
                        "nextPageParaName": "cursor",
                        "nextPageTokenJsonPath": "$.cursor",
                        "hasNextFlagJsonPath": "$.has_more"
                    },
                    "response": {
                        "eventsJsonPaths": [
                            "$.items"
                        ]
                    }
                }
            }
        }
    ]
}
