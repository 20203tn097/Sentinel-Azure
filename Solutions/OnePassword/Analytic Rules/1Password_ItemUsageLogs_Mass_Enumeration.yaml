id: 86ef645a-5dce-42c9-ab96-a003ae1e6653
name: 1Password ItemUsage Logs Mass Enumeration
description: 
  "This rule detects a large amount of revealed/copied secrets from a vault. This can be an indicator that someone is trying to copy or enumerate all objects in OnePassword. The detection thresholds are customisable within the rule."
severity: Medium
requiredDataConnectors:
  - connectorId: OnePasswordItemUsage
    dataTypes:
      - OnePasswordItemUsageEvents_CL
queryFrequency: 30m
queryPeriod: 30m
triggerOperator: gt
triggerThreshold: 0
tactics:
  - CredentialAccess
relevantTechniques:
  - T1555
query: |
  // Tweak the parameters below to adjust the rule to your environment
  let EventThreshhold = 15; // Amount of actions a user needs to perform before showing up
  let ItemThreshhold = 10; // Amount of unique items a user needs to access before firing an alert
  let VaultThreshhold = 3; // Amount of unique vaults a user needs to access before firing an alert
  OnePasswordItemUsageEvents_CL 
  | where action == "server-fetch" or action == "reveal"
  | summarize EnumerationEvents = dcount(tostring(EventId)), UniqueItemsAccessed = dcount(tostring(item_uuid)), UniqueVaultsAccessed = dcount(tostring(vault_uuid)) by bin(TimeGenerated, 10m), tostring(user.uuid), tostring(user.name), tostring(user.email), tostring(client.ip_address)
  | where EnumerationEvents >= EventThreshhold and (UniqueItemsAccessed >= ItemThreshhold or UniqueVaultsAccessed >= VaultThreshhold)
  | extend Name = split(user_email, '@')[0], UPNSuffix = split(user_email, '@')[1] //added fields for entity mapping
  | project TimeGenerated, user_email, Name, UPNSuffix, user_name, user_uuid, client_ip_address, EnumerationEvents, UniqueItemsAccessed, UniqueVaultsAccessed
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: client_ip_address_s
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Name
      - identifier: UPNSuffix
        columnName: UPNSuffix
version: 1.0.0
kind: Scheduled