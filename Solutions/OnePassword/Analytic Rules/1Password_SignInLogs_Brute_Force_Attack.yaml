id: 50f8d608-3633-48cd-8120-e701c331203c
name: 1Password SignIn Logs Brute Force Attack
description: 
  "This rule detects possible brute force attacks agains OnePassword via the SigninLogs events. If you've linked OnePassword to an identity provider like Entra ID, this rule won't detect attacks, since authentication will take place at your identity provider."
severity: Medium
requiredDataConnectors:
  - connectorId: OnePasswordSignIn
    dataTypes:
      - OnePasswordSignInEvents_CL
queryFrequency: 12h
queryPeriod: 12h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - CredentialAccess
relevantTechniques:
  - T1110
query: |
  // Tweak the parameters below to adjust the rule to your environment
  let logintreshhold = 10; // The amount of login attempts before a user will be considered as a brute force victim
  let lookback = 12h; // Time the query looks back
  let loginPerIp = OnePasswordSignInEvents_CL 
  | where TimeGenerated between (ago(lookback) .. now())
  | summarize loginAttemptsPerIp = count(), failedLoginAttemptsPerIp = countif(SignInType !has "_ok") by tostring(client.ip_address), tostring(target_user.email);
  OnePasswordSignInEvents_CL
  | where TimeGenerated between (ago(lookback) .. now())
  | summarize loginAttempts = count() by tostring(target_user.email)
  | where loginAttempts >= logintreshhold
  | join kind=inner (
      loginPerIp
    ) on target_user_email
  | extend Name = split(target_user_email, '@')[0], UPNSuffix  = split(target_user_email, '@')[1]
  | where failedLoginAttemptsPerIp >= loginAttemptsPerIp
  | project target_user_email, Name, UPNSuffix, loginAttempts, client_ip_address, loginAttemptsPerIp, failedLoginAttemptsPerIp
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: client_ip_address_s
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Name
      - identifier: UPNSuffix
        columnName: UPNSuffix
version: 1.0.0
kind: Scheduled