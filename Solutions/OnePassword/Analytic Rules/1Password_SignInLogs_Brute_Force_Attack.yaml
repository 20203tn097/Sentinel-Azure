id: 50f8d608-3633-48cd-8120-e701c331203c
name: 1Password SignIn Logs Brute Force Attack
description: 
  "This rule detects brute force attacks agains OnePassword via the SigninLogs events. If you've linked OnePassword to an identity provider like Entra ID, this rule won't detect attacks."
severity: Medium
requiredDataConnectors:
  - connectorId: OnePasswordSignIn
    dataTypes:
      - OnePasswordSignInEvents_CL
queryFrequency: 30m
queryPeriod: 30m
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
relevantTechniques:
  - T1110
query: |
  let lookback = 30m;
  let loginPerIp = OnePasswordSignInEvents_CL 
  | extend todatetime(timestamp_s)
  | where timestamp_t between (ago(lookback) .. now())
  | summarize loginAttemptsPerIp = count(), failedLoginAttemptsPerIp = countif(type_s !contains "ok") by client_ip_address_s, target_user_email_s;
  OnePasswordSignInEvents_CL
  | extend todatetime(timestamp_s)
  | where timestamp_t between (ago(lookback) .. now())
  | summarize loginAttempts = count() by target_user_email_s
  | where loginAttempts > 10
  | join kind=inner (
      loginPerIp
    ) on target_user_email_s
  | extend Name = split(target_user_email_s, '@')[0], UPNSuffix  = split(target_user_email_s, '@')[1]
  | where failedLoginAttemptsPerIp >= loginAttemptsPerIp
  | project target_user_email_s, Name, UPNSuffix, loginAttempts, client_ip_address_s, loginAttemptsPerIp, failedLoginAttemptsPerIp
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: client_ip_address_s
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Name
      - identifier: UPNSuffix
        columnName: UPNSuffix
version: 1.0.0
kind: Scheduled