id: 55ce6b39-1498-4dae-a805-9f332516bb80
name: 1Password SignIn Logs Password Spray Attack
description: 
  "This rule detects possible password spray attacks agains OnePassword via the SigninLogs events. If you've linked OnePassword to an identity provider like Entra ID, this rule won't detect attacks, since authentication will take place at your identity provider."
severity: Low
requiredDataConnectors:
  - connectorId: OnePasswordSignIn
    dataTypes:
      - OnePasswordSignInEvents_CL
queryFrequency: 1h
queryPeriod: 14d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - CredentialAccess
relevantTechniques:
  - T1110
query: |
  OnePasswordSignInEvents_CL
  | summarize
    DistinctFailureCount = dcountif(tostring(target_user.email), category != "success"),
    DistinctSuccessCount = dcountif(tostring(target_user.email), category == "success"),
    SuccessAccounts = make_set(tostring(target_user.email), 250),
    arg_min(TimeGenerated, *)
    by tostring(client.ip_address)
  | where DistinctFailureCount > DistinctSuccessCount // to rule out things like office locations
  | mv-expand SuccessAccounts
  | extend Name = split(SuccessAccounts, '@')[0], UPNSuffix  = split(SuccessAccounts, '@')[1]
  | project TimeGenerated, client_ip_address, tostring(location.country), tostring(client.app_name), tostring(client.platform_name), session_uuid, DistinctFailureCount, DistinctSuccessCount, SuccessAccounts, Name, UPNSuffix 
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: client_ip_address_s
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Name
      - identifier: UPNSuffix
        columnName: UPNSuffix
version: 1.0.0
kind: Scheduled