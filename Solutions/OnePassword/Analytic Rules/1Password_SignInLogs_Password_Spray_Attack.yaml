id: OnePassSprayAtt
name: 1Password SignIn Logs Password Spray Attack
description: 
  'This rule detects password spray attacks agains OnePassword via the SigninLogs events. If you've linked OnePassword to an identity provider like Entra ID, this rule won't detect attacks.'
severity: Low
requiredDataConnectors:
  - connectorId: OnePasswordSignInEvents
    dataTypes:
      - OnePasswordSignInEvents_CL
queryFrequency: 1h
queryPeriod: 14d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
query: |
  OnePasswordSignInEvents_CL
  | summarize
    DistinctFailureCount = dcountif(target_user_email_s, Category != "success"),
    DistinctSuccessCount = dcountif(target_user_email_s, Category == "success"),
    SuccessAccounts = make_set(target_user_email_s, 250),
    arg_min(TimeGenerated, *)
    by client_ip_address_s
  | where DistinctFailureCount > DistinctSuccessCount // to rule out things like office locations
  | mv-expand SuccessAccounts
  | extend Name = split(SuccessAccounts, '@')[0], UPNSuffix  = split(SuccessAccounts, '@')[1]
  | project timestamp_s, client_ip_address_s, country_s, client_app_name_s, client_platform_name_s, session_uuid_s, DistinctFailureCount, DistinctSuccessCount, SuccessAccounts, Name, UPNSuffix 
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: client_ip_address_s
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Name
      - identifier: UPNSuffix
        columnName: UPNSuffix
version: 1.0.0
kind: Scheduled