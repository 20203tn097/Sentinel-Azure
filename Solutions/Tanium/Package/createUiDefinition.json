{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "isWizard": false,
      "basics": {
        "description": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Tanium.svg\" width=\"75px\" height=\"75px\">\n\n**Note:** _There may be [known issues](https://aka.ms/sentinelsolutionsknownissues) pertaining to this Solution, please refer to them before installing._\n\nThe [Tanium](https://www.tanium.com/) solution for Microsoft Sentinel enables you to ingest Tanium Threat Response alerts as Microsoft Sentinel incidents as well as incorporate Tanium's real-time endpoint data.\n\n**Workbooks:** 1, **Analytic Rules:** 1, **Playbooks:** 10\n\n[Learn more about Microsoft Sentinel](https://aka.ms/azuresentinel) | [Learn more about Solutions](https://aka.ms/azuresentinelsolutionsdoc)",
        "subscription": {
          "resourceProviders": [
            "Microsoft.OperationsManagement/solutions",
            "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "Microsoft.Insights/workbooks",
            "Microsoft.Logic/workflows"
          ]
        },
        "location": {
          "metadata": {
            "hidden": "Hiding location, we get it from the log analytics workspace"
          },
          "visible": false
        },
        "resourceGroup": {
          "allowExisting": true
        }
      }
    },
    "basics": [
      {
        "name": "getLAWorkspace",
        "type": "Microsoft.Solutions.ArmApiControl",
        "toolTip": "This filters by workspaces that exist in the Resource Group selected",
        "condition": "[greater(length(resourceGroup().name),0)]",
        "request": {
          "method": "GET",
          "path": "[concat(subscription().id,'/providers/Microsoft.OperationalInsights/workspaces?api-version=2020-08-01')]"
        }
      },
      {
        "name": "workspace",
        "type": "Microsoft.Common.DropDown",
        "label": "Workspace",
        "placeholder": "Select a workspace",
        "toolTip": "This dropdown will list only workspace that exists in the Resource Group selected",
        "constraints": {
          "allowedValues": "[map(filter(basics('getLAWorkspace').value, (filter) => contains(toLower(filter.id), toLower(resourceGroup().name))), (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
          "required": true
        },
        "visible": true
      }
    ],
    "steps": [
      {
        "name": "workbooks",
        "label": "Workbooks",
        "subLabel": {
          "preValidation": "Configure the workbooks",
          "postValidation": "Done"
        },
        "bladeTitle": "Workbooks",
        "elements": [
          {
            "name": "workbooks-text",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "The Workbooks provided by this solution depend on specific data sources setup from Tanium Connect. The Workbooks allow you to get insight into Tanium endpoint and module data directly from Microsoft Sentinel."
            }
          },
          {
            "name": "workbooks-link",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "link": {
                "label": "Learn more",
                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-monitor-your-data"
              }
            }
          },
          {
            "name": "workbook1",
            "type": "Microsoft.Common.Section",
            "label": "Tanium Workbook",
            "elements": [
              {
                "name": "workbook1-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "Visualize Tanium endpoint and module data"
                }
              }
            ]
          }
        ]
      },
      {
        "name": "analytics",
        "label": "Analytics",
        "subLabel": {
          "preValidation": "Configure the analytics",
          "postValidation": "Done"
        },
        "bladeTitle": "Analytics",
        "elements": [
          {
            "name": "analytics-text",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "This solution installs the following analytic rule templates. After installing the solution, create and enable analytic rules in Manage solution view."
            }
          },
          {
            "name": "analytics-link",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "link": {
                "label": "Learn more",
                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-detect-threats-custom?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef"
              }
            }
          },
          {
            "name": "analytic1",
            "type": "Microsoft.Common.Section",
            "label": "Tanium Threat Response Alerts",
            "elements": [
              {
                "name": "analytic1-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "Alerts from Tanium Threat Response (THR) that can be acted upon by Microsoft Sentinel Playbook"
                }
              }
            ]
          }
        ]
      },
      {
        "name": "playbooks",
        "label": "Playbooks",
        "subLabel": {
          "preValidation": "Configure the playbooks",
          "postValidation": "Done"
        },
        "bladeTitle": "Playbooks",
        "elements": [
          {
            "name": "playbooks-text",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "The Playbooks provided by this solution allow adding real-time Tanium endpoint data and control to hosts associated with Microsoft Sentinel incidents."
            }
          },
          {
            "name": "playbooks-link",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "link": {
                "label": "Learn more",
                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-respond-threats-playbook?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef"
              }
            }
          }
        ]
      },
      {
        "name": "taniumSentinelRealtime",
        "label": "Sentinel Realtime",
        "elements": [
          {
            "name": "resourceNamePrefix",
            "type": "Microsoft.Common.TextBox",
            "label": "Resource Name Prefix",
            "defaultValue": "tanium-realtime-",
            "toolTip": "Prefix to use for naming Azure resources created by this integration.",
            "visible": true,
            "constraints": {
              "required": true,
              "regex": "^[a-z][a-z0-9-]{2,23}$",
              "validationMessage": "Must be between 3 and 24 characters"
            }
          },
          {
            "name": "taniumServerHostName",
            "type": "Microsoft.Common.TextBox",
            "label": "Tanium Server Hostname",
            "toolTip": "The API hostname for your Tanium Server environment, e.g. COMPANY-api.cloud.tanium.com",
            "constraints": {
              "required": true
            }
          },
          {
            "name": "taniumApiToken",
            "type": "Microsoft.Common.PasswordBox",
            "toolTip": "The Tanium Service account API Token to use for read-only API Gateway queries.",
            "label": {
              "password": "Tanium API Token",
              "confirmPassword": "Confirm Tanium API Token"
            },
            "options": {
              "hideConfirmation": true
            },
            "constraints": {
              "required": true,
              "regex": "^token-[a-f0-9]{58,}$"
            }
          },
          {
            "name": "workspaceName",
            "label": "Log Analytics Workspace Name",
            "toolTip": "Name of the existing Log Analytics workspace that will receive Tanium endpoint data.",
            "type": "Microsoft.Common.TextBox",
            "constraints": {
              "required": true
            }
          },
          {
            "name": "workspaceResourceGroup",
            "label": "Log Analytics Workspace Resource Group",
            "toolTip": "Resource Group name of the existing Log Analytics workspace that will receive Tanium endpoint data.",
            "type": "Microsoft.Common.TextBox",
            "constraints": {
              "required": true
            }
          },
          {
            "name": "workspaceLocation",
            "label": "Log Analytics Workspace Location",
            "toolTip": "Location of the existing Log Analytics workspace that will receive Tanium endpoint data, e.g. westus",
            "type": "Microsoft.Common.TextBox",
            "constraints": {
              "required": true
            }
          },
          {
            "name": "integrationAccountName",
            "label": "Integration Account Name",
            "toolTip": "Name of the integration account to use to execute inline JavaScript in the ingest-sensor-data logic app. Must be in the same region as this deployment.",
            "type": "Microsoft.Common.TextBox",
            "constraints": {
              "required": true
            }
          },
          {
            "name": "integrationAccountResourceGroupName",
            "label": "Integration Account Resource Group Name",
            "toolTip": "Resource Group name of the integration account to use to execute inline JavaScript in the ingest-sensor-data logic app. Must be in the same region as this deployment.",
            "type": "Microsoft.Common.TextBox",
            "constraints": {
              "required": true
            }
          }
        ]
      }
    ],
    "outputs": {
      "workspace-location": "[first(map(filter(basics('getLAWorkspace').value, (filter) => and(contains(toLower(filter.id), toLower(resourceGroup().name)),equals(filter.name,basics('workspace')))), (item) => item.location))]",
      "location": "[location()]",
      "workspace": "[basics('workspace')]",
      "resourceNamePrefix": "[steps('taniumSentinelRealtime').resourceNamePrefix]",
      "taniumServerHostName": "[steps('taniumSentinelRealtime').taniumServerHostName]",
      "taniumApiToken": "[steps('taniumSentinelRealtime').taniumApiToken]",
      "workspaceName": "[steps('taniumSentinelRealtime').workspaceName]",
      "workspaceResourceGroup": "[steps('taniumSentinelRealtime').workspaceResourceGroup]",
      "workspaceLocation": "[steps('taniumSentinelRealtime').workspaceLocation]",
      "integrationAccountName": "[steps('taniumSentinelRealtime').integrationAccountName]",
      "integrationAccountResourceGroupName": "[steps('taniumSentinelRealtime').integrationAccountResourceGroupName]"
    }
  }
}
