id: ab8ddb26-050c-40aa-aaf0-bfb7e3eeb05f
name: Executable Files Created in Uncommon Locations
description: |
  This analytic rule detects any executable file creation in uncommon locations like temproray folders. This could be an indication of a persistence or defese evasion attempt by an adversary.
severity: High
status: Available 
tags:
  - Schema: imFileEvent
    SchemaVersion: 0.2.1
requiredDataConnectors:
- connectorId: CrowdStrikeFalconEndpointProtection
    dataTypes: 
      - CommonSecurityLog
  - connectorId: MicrosoftThreatProtection
    dataTypes:
      - SecurityAlert
  - connectorId: SentinelOne
    dataTypes:
      - SentinelOne
  - connectorId: VMwareCarbonBlack
    dataTypes:
      - CarbonBlackNotifications_CL
  - connectorId: CiscoSecureEndpoint
    dataTypes:
      - CiscoSecureEndpoint_CL
  - connectorId: TrendMicroApexOne
    dataTypes:
      - TMApexOneEvent
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Persistence
  - DefenseEvasion
relevantTechniques:
  - T1037
  - T1547
  - T1564
query: |
  // List of file extensions to monitor
  let executableExtensions = dynamic(['exe', 'bat', 'cmd', 'vbs', 'ps1', 'psm1', 'wsf']);
  // List of file locations to monitor
  let fileLocations = dynamic([
      '\\Windows\\System32\\',
      '\\Windows\\Temp\\',
      '\\AppData\\Local\\Temp\\',
      '\\Recycle Bin\\'
      ]);
  imFileEvent
  | where EventType == 'FileCreated'
  | extend FileExtension =  tostring(split(FileName, '.')[1])
  | where FileExtension in~ (executableExtensions) and FilePath has_any (fileLocations)
  | project DvcHostname, DvcDomain, User, ActingProcessId_string, ActingProcessName, CommandLine, FileName, FilePath, Hash, HashType
  | extend Username = iff(User contains '@', tostring(split(User, '@')[0]), User)
  | extend UPNSuffix = iff(User contains '@', tostring(split(User, '@')[1]), '')
  | extend Username = iff(User contains '\\', tostring(split(User, '\\')[1]), Username)
  | extend NTDomain = iff(User contains '\\', tostring(split(User, '\\')[0]), '')
entityMappings:
 - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: HostName
      - identifier: DnsDomain
        columnName: DnsDomain
      - identifier: NTDomain
        columnName: NTDomain
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Username
      - identifier: UPNSuffix
        columnName: UPNSuffix
      - identifier: NTDomain
        columnName: NTDomain
  - entityType: File
    fieldMappings:
      - identifier: Name
        columnName: FileName
      - identifier: Directory
        columnName: FilePath
  - entityType: FileHash
    fieldMappings:
      - identifier: Algorithm
        columnName: HashType
      - identifier: Value
        columnName: Hash
  - entityType: Process
    fieldMappings:
      - identifier: ProcessId
        columnName: ActingProcessId_string
      - identifier: CommandLine
        columnName: CommandLine
eventGroupingSettings:
  aggregationKind: AlertPerResult
alertDetailsOverride:
  alertDisplayNameFormat: "Executable File Created in Uncommon Location on {{HostName}} ({{DvcIpAddr}}) by ({{User}})"
  alertDescriptionFormat: "Executable file {{FileName}} was created in {{FilePath}} on {{HostName}} ({{DvcIpAddr}}) by {{User}}."
version: 1.0.0
kind: Scheduled