id: 6fd69768-fdf1-4cfd-805f-b243be3f0c6d
name: Remote Desktop Network Traffic(ASIM Network Session schema)
description: |
  'This hunting query looks for network traffic on TCP/3389, the default port used
  by remote desktop. While remote desktop traffic is not uncommon on a network, it
  is usually associated with known hosts. This search will ignore common RDP sources
  and common RDP destinations so you can focus on the uncommon uses of remote desktop
  on your network.'
tags:
  - Schema: ASimNetworkSessions
    SchemaVersion: 0.2.4
requiredDataConnectors: []
tactics:
  - Lateral Movement
relevantTechniques:
  - T1021
  - T1021.001
query: |
  _Im_NetworkSession
  // Filter events from the last day that were not failures
  | where TimeGenerated > ago(1d) and EventResult != "Failure"
  // Filter events where the source IP is private, the destination IP is not private, and the source and destination IPs are not the same
  | where ipv4_is_private(SrcIpAddr) and not(ipv4_is_private(DstIpAddr)) and SrcIpAddr != DstIpAddr
  // Filter events where the destination port number is 3389 (commonly used for Microsoft Remote Desktop (RDP))
  | where tostring(DstPortNumber) has_any ("3389")
  // Summarize the data by source IP, destination IP, destination port number, network protocol, and event result
  // For each group, calculate the start time, end time, event count, and a set of up to 10 event vendors
  | summarize Starttime= min(TimeGenerated),EndTime= max(TimeGenerated),Eventscount=sum(EventCount), EventVendors=make_set(EventVendor,10) by SrcIpAddr,DstIpAddr,DstPortNumber,NetworkProtocol,EventResult
