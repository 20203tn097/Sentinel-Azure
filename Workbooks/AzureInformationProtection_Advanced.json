{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "AIP advanced workbook",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "sentinel",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/397cdfbc-d326-412f-acdd-f3a40db4aaee/resourcegroups/oi-default-east-us/providers/microsoft.operationalinsights/workspaces/briandel",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "variables": {
    "workbookContent": {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "711cb938-61db-401f-86cd-d9d4a60320f2",
                "version": "KqlParameterItem/1.0",
                "name": "ObservedPeriod",
                "label": "Observed Period",
                "type": 4,
                "isRequired": true,
                "isGlobal": true,
                "value": {
                  "durationMs": 41986800000,
                  "endTime": "2022-05-31T09:06:00.000Z"
                },
                "typeSettings": {
                  "selectableValues": [
                    {
                      "durationMs": 300000
                    },
                    {
                      "durationMs": 900000
                    },
                    {
                      "durationMs": 1800000
                    },
                    {
                      "durationMs": 3600000
                    },
                    {
                      "durationMs": 14400000
                    },
                    {
                      "durationMs": 43200000
                    },
                    {
                      "durationMs": 86400000
                    },
                    {
                      "durationMs": 172800000
                    },
                    {
                      "durationMs": 259200000
                    },
                    {
                      "durationMs": 604800000
                    },
                    {
                      "durationMs": 1209600000
                    },
                    {
                      "durationMs": 2419200000
                    },
                    {
                      "durationMs": 2592000000
                    },
                    {
                      "durationMs": 5184000000
                    },
                    {
                      "durationMs": 7776000000
                    }
                  ],
                  "allowCustom": true
                },
                "timeContext": {
                  "durationMs": 86400000
                }
              }
            ],
            "style": "above",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          "name": "parameters - 2"
        },
        {
          "type": 11,
          "content": {
            "version": "LinkItem/1.0",
            "style": "tabs",
            "links": [
              {
                "id": "1de513e4-3a36-4da3-b3ea-c0e7e13f03a7",
                "cellValue": "Tab",
                "linkTarget": "parameter",
                "linkLabel": "Most Active Users",
                "subTarget": "MostActiveUsers",
                "style": "link"
              },
              {
                "id": "f1d23d76-ead4-4e35-96bf-64d235844720",
                "cellValue": "Tab",
                "linkTarget": "parameter",
                "linkLabel": "Access Denied Events",
                "subTarget": "AccessDeniedEvents",
                "style": "link"
              },
              {
                "id": "ace57ba4-e4b2-4104-b88e-23d6dfd92818",
                "cellValue": "Tab",
                "linkTarget": "parameter",
                "linkLabel": "Most Accessed Files",
                "subTarget": "MostAccessedFiles",
                "style": "link"
              },
              {
                "id": "e1b334e6-21a3-44ba-9910-ddce239c7087",
                "cellValue": "Tab",
                "linkTarget": "parameter",
                "linkLabel": "Files with the Most Access Failures",
                "subTarget": "MostFailedFiles",
                "style": "link"
              },
              {
                "id": "756fe0c9-8744-44ff-9d79-04f4848c5edf",
                "cellValue": "Tab",
                "linkTarget": "parameter",
                "linkLabel": "New Labels created",
                "subTarget": "NewLabels",
                "style": "link"
              },
              {
                "id": "ec22e088-d05f-4f96-b691-0bb9b9ea02bc",
                "cellValue": "Tab",
                "linkTarget": "parameter",
                "linkLabel": "New Files Protected by Extension",
                "subTarget": "NewFilesbyExtension",
                "style": "link"
              }
            ]
          },
          "name": "links - 0"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "Most Active Users",
            "items": [
              {
                "type": 1,
                "content": {
                  "json": "Select user"
                },
                "name": "text - 2"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InformationProtectionLogs_CL\r\n| where Operation_s != \"Heartbeat\"\r\n| summarize Count=count() by UserId_s\r\n| sort by Count desc\r\n| limit 10 ",
                  "size": 1,
                  "timeContextFromParameter": "ObservedPeriod",
                  "exportFieldName": "UserId_s",
                  "exportParameterName": "username",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "gridSettings": {
                    "sortBy": [
                      {
                        "itemKey": "UserId_s",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "sortBy": [
                    {
                      "itemKey": "UserId_s",
                      "sortOrder": 1
                    }
                  ]
                },
                "name": "query - 0"
              },
              {
                "type": 1,
                "content": {
                  "json": "Users's events:"
                },
                "name": "text - 3"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InformationProtectionLogs_CL\r\n| where Operation_s != \"Heartbeat\"\r\n| where UserId_s == \"{username}\"\r\n| project UserId_s,MachineName_s,ObjectId_s,Activity_s,Platform_s,ApplicationName_s, ProductVersion_s ",
                  "size": 0,
                  "timeContextFromParameter": "ObservedPeriod",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "conditionalVisibility": {
                  "parameterName": "username",
                  "comparison": "isNotEqualTo"
                },
                "name": "query - 1"
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "Tab",
            "comparison": "isEqualTo",
            "value": "MostActiveUsers"
          },
          "name": "MostActiveUsers"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "Access Denied Events",
            "items": [
              {
                "type": 1,
                "content": {
                  "json": "Use below time chart to narrow down the time range"
                },
                "name": "text - 2"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InformationProtectionLogs_CL\r\n| where Activity_s == \"AccessDenied\"\r\n| summarize Count=count() by UserId_s, Date=bin(TimeGenerated, 30m)\r\n| render timechart\r\n",
                  "size": 0,
                  "timeContextFromParameter": "ObservedPeriod",
                  "timeBrushParameterName": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "gridSettings": {
                    "sortBy": [
                      {
                        "itemKey": "UserId_s",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "sortBy": [
                    {
                      "itemKey": "UserId_s",
                      "sortOrder": 1
                    }
                  ]
                },
                "name": "query - 0"
              },
              {
                "type": 1,
                "content": {
                  "json": "Select user's event below within {TimeRange}"
                },
                "name": "text - 4"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InformationProtectionLogs_CL\r\n| where Activity_s == \"AccessDenied\"\r\n| summarize Count=count() by UserId_s, Date=bin(TimeGenerated, 30m)\r\n",
                  "size": 0,
                  "timeContextFromParameter": "TimeRange",
                  "exportedParameters": [
                    {
                      "fieldName": "UserId_s",
                      "parameterName": "username",
                      "parameterType": 1,
                      "defaultValue": ""
                    },
                    {
                      "fieldName": "Date",
                      "parameterName": "Date",
                      "parameterType": 1,
                      "defaultValue": ""
                    }
                  ],
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "events"
              },
              {
                "type": 12,
                "content": {
                  "version": "NotebookGroup/1.0",
                  "groupType": "editable",
                  "items": [
                    {
                      "type": 1,
                      "content": {
                        "json": "Event details for user {username} at {Date}"
                      },
                      "name": "text - 5"
                    },
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "InformationProtectionLogs_CL\r\n| where Activity_s == \"AccessDenied\"\r\n| where (UserId_s == \"{username}\") and (bin(TimeGenerated,30m) == \"{Date}\")",
                        "size": 0,
                        "timeContextFromParameter": "ObservedPeriod",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      },
                      "name": "query - 1"
                    }
                  ]
                },
                "conditionalVisibilities": [
                  {
                    "parameterName": "username",
                    "comparison": "isNotEqualTo"
                  },
                  {
                    "parameterName": "Date",
                    "comparison": "isNotEqualTo"
                  }
                ],
                "name": "eventdetails"
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "Tab",
            "comparison": "isEqualTo",
            "value": "AccessDeniedEvents"
          },
          "name": "AccessDeniedEvents"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "Most Accessed Files",
            "items": [
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "parameters": [
                    {
                      "id": "a14972e7-7331-4073-a270-ee1571a02b14",
                      "version": "KqlParameterItem/1.0",
                      "name": "TopX",
                      "label": "Limit results to",
                      "type": 2,
                      "isRequired": true,
                      "typeSettings": {
                        "additionalResourceOptions": []
                      },
                      "jsonData": "[[\r\n    {\"value\":1,\"label\":\"1\"},\r\n    {\"value\":2,\"label\":\"2\"},\r\n    {\"value\":3,\"label\":\"3\"},\r\n    {\"value\":4,\"label\":\"4\"},\r\n    {\"value\":5,\"label\":\"5\"},\r\n    {\"value\":6,\"label\":\"6\"},\r\n    {\"value\":7,\"label\":\"7\"},\r\n    {\"value\":8,\"label\":\"8\"},\r\n    {\"value\":9,\"label\":\"9\"},\r\n    {\"value\":10,\"label\":\"10\",\"selected\":true}\r\n]",
                      "timeContext": {
                        "durationMs": 86400000
                      }
                    }
                  ],
                  "style": "above",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "parameters - 8"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InformationProtectionLogs_CL\r\n| where Activity_s == \"Access\"\r\n| summarize Count=count() by ObjectId_s\r\n| sort by Count desc\r\n| limit {TopX}\r\n| render piechart ",
                  "size": 0,
                  "timeContextFromParameter": "ObservedPeriod",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "query - 1"
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "Tab",
            "comparison": "isEqualTo",
            "value": "MostAccessedFiles"
          },
          "name": "MostAccessedFiles"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "Files with the Most Access Failures",
            "items": [
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "parameters": [
                    {
                      "id": "6cd9272c-1fac-46ff-9241-bf54203f20cc",
                      "version": "KqlParameterItem/1.0",
                      "name": "TopX",
                      "label": "Limit results to",
                      "type": 2,
                      "isRequired": true,
                      "value": "1",
                      "typeSettings": {
                        "additionalResourceOptions": []
                      },
                      "jsonData": "[[\r\n    {\"value\":1,\"label\":\"1\"},\r\n    {\"value\":2,\"label\":\"2\"},\r\n    {\"value\":3,\"label\":\"3\"},\r\n    {\"value\":4,\"label\":\"4\"},\r\n    {\"value\":5,\"label\":\"5\"},\r\n    {\"value\":6,\"label\":\"6\"},\r\n    {\"value\":7,\"label\":\"7\"},\r\n    {\"value\":8,\"label\":\"8\"},\r\n    {\"value\":9,\"label\":\"9\"},\r\n    {\"value\":10,\"label\":\"10\",\"selected\":true}\r\n]",
                      "timeContext": {
                        "durationMs": 86400000
                      }
                    }
                  ],
                  "style": "above",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "parameters - 8 - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InformationProtectionLogs_CL\r\n| where Activity_s == \"AccessDenied\"\r\n| summarize Count=count() by ObjectId_s\r\n| sort by Count desc\r\n| limit {TopX} \r\n| render piechart ",
                  "size": 0,
                  "timeContextFromParameter": "ObservedPeriod",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "query - 1 - Copy"
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "Tab",
            "comparison": "isEqualTo",
            "value": "MostFailedFiles"
          },
          "name": "MostFailedFiles"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "New Labels created",
            "items": [
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InformationProtectionLogs_CL\r\n| where Activity_s == \"NewLabel\"",
                  "size": 0,
                  "timeContextFromParameter": "ObservedPeriod",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "query - 0"
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "Tab",
            "comparison": "isEqualTo",
            "value": "NewLabels"
          },
          "name": "NewLabels"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "New Files Protected by Extension",
            "items": [
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "parameters": [
                    {
                      "id": "71c5e47a-aad1-41f3-a82e-9d01d7e1294b",
                      "version": "KqlParameterItem/1.0",
                      "name": "ChosenExtension",
                      "label": "Choose File Extension",
                      "type": 2,
                      "isRequired": true,
                      "query": "InformationProtectionLogs_CL\r\n| where Activity_s == \"Discover\"\r\n| extend file_extension = extract(\"(\\\\.[^.\\\\/:*?\\\"<>|\\r\\n]+$)\", 1, ObjectId_s)\r\n| distinct file_extension ",
                      "value": ".zip",
                      "typeSettings": {
                        "additionalResourceOptions": []
                      },
                      "timeContext": {
                        "durationMs": 0
                      },
                      "timeContextFromParameter": "ObservedPeriod",
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    }
                  ],
                  "style": "above",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "parameters - 1"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InformationProtectionLogs_CL\r\n| where Activity_s == \"Discover\"\r\n| extend file_extension = extract(\"(\\\\.[^.\\\\/:*?\\\"<>|\\r\\n]+$)\", 1, ObjectId_s)\r\n| where file_extension == \"{ChosenExtension}\"\r\n| project ObjectId_s, file_extension, Location_s, UserId_s, MachineName_s,LastModifiedBy_s, LastModifiedDate_t",
                  "size": 0,
                  "timeContextFromParameter": "ObservedPeriod",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "conditionalVisibility": {
                  "parameterName": "ChosenExtension",
                  "comparison": "isNotEqualTo"
                },
                "name": "query - 0"
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "Tab",
            "comparison": "isEqualTo",
            "value": "NewFilesbyExtension"
          },
          "name": "NewFilesbyExtension"
        }
      ],
      "isLocked": false,
      "fallbackResourceIds": [
        "/subscriptions/397cdfbc-d326-412f-acdd-f3a40db4aaee/resourcegroups/oi-default-east-us/providers/microsoft.operationalinsights/workspaces/briandel"
      ],
      "fromTemplateId": "sentinel-UserWorkbook"
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2021-03-08",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "[string(variables('workbookContent'))]",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}